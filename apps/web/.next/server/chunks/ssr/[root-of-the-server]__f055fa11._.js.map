{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/constants.ts"],"sourcesContent":["// Constants shared between client and server components\n\n// Daily transfer limit for free users\nexport const FREE_TIER_LIMIT = 500;\nexport const PREMIUM_TIER_LIMIT = 5000;\n"],"names":[],"mappings":"AAAA,wDAAwD;AAExD,sCAAsC;;;;;;;AAC/B,MAAM,kBAAkB;AACxB,MAAM,qBAAqB","debugId":null}},
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/auth/constants.ts"],"sourcesContent":["export const AUTH_STORAGE_KEYS = {\n  SOURCE: {\n    TOKEN: \"nonna_source_token\",\n    STATE: \"nonna_source_state\",\n    SERVICE: \"nonna_source_service\",\n    CODE_VERIFIER: \"nonna_source_code_verifier\",\n  },\n  TARGET: {\n    TOKEN: \"nonna_target_token\",\n    STATE: \"nonna_target_state\",\n    SERVICE: \"nonna_target_service\",\n    CODE_VERIFIER: \"nonna_target_code_verifier\",\n  },\n} as const;\n\nexport interface AuthData {\n  accessToken: string;\n  refreshToken?: string;\n  expiresIn: number;\n  timestamp: number;\n  userId: string;\n  tokenType: string;\n  role: \"source\" | \"target\";\n  serviceId: string;\n}\n\n// Helper functions for managing auth storage\nexport function getAuthData(role: \"source\" | \"target\"): AuthData | null {\n  const key = role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.TOKEN : AUTH_STORAGE_KEYS.TARGET.TOKEN;\n  const data = localStorage.getItem(key);\n  return data ? JSON.parse(data) : null;\n}\n\nexport function setAuthData(role: \"source\" | \"target\", data: AuthData): void {\n  const key = role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.TOKEN : AUTH_STORAGE_KEYS.TARGET.TOKEN;\n  localStorage.setItem(key, JSON.stringify(data));\n}\n\nexport function clearAuthData(role: \"source\" | \"target\"): void {\n  const keys = role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE : AUTH_STORAGE_KEYS.TARGET;\n  Object.values(keys).forEach(key => localStorage.removeItem(key));\n}\n\nexport function getServiceType(role: \"source\" | \"target\"): string {\n  const key =\n    role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.SERVICE : AUTH_STORAGE_KEYS.TARGET.SERVICE;\n  const serviceType = localStorage.getItem(key);\n\n  if (!serviceType) {\n    throw new Error(`No service type found for role: ${role}`);\n  }\n\n  return serviceType;\n}\n\nexport function setServiceType(role: \"source\" | \"target\", serviceId: string): void {\n  const key =\n    role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.SERVICE : AUTH_STORAGE_KEYS.TARGET.SERVICE;\n  localStorage.setItem(key, serviceId);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAO,MAAM,oBAAoB;IAC/B,QAAQ;QACN,OAAO;QACP,OAAO;QACP,SAAS;QACT,eAAe;IACjB;IACA,QAAQ;QACN,OAAO;QACP,OAAO;QACP,SAAS;QACT,eAAe;IACjB;AACF;AAcO,SAAS,YAAY,IAAyB;IACnD,MAAM,MAAM,SAAS,WAAW,kBAAkB,MAAM,CAAC,KAAK,GAAG,kBAAkB,MAAM,CAAC,KAAK;IAC/F,MAAM,OAAO,aAAa,OAAO,CAAC;IAClC,OAAO,OAAO,KAAK,KAAK,CAAC,QAAQ;AACnC;AAEO,SAAS,YAAY,IAAyB,EAAE,IAAc;IACnE,MAAM,MAAM,SAAS,WAAW,kBAAkB,MAAM,CAAC,KAAK,GAAG,kBAAkB,MAAM,CAAC,KAAK;IAC/F,aAAa,OAAO,CAAC,KAAK,KAAK,SAAS,CAAC;AAC3C;AAEO,SAAS,cAAc,IAAyB;IACrD,MAAM,OAAO,SAAS,WAAW,kBAAkB,MAAM,GAAG,kBAAkB,MAAM;IACpF,OAAO,MAAM,CAAC,MAAM,OAAO,CAAC,CAAA,MAAO,aAAa,UAAU,CAAC;AAC7D;AAEO,SAAS,eAAe,IAAyB;IACtD,MAAM,MACJ,SAAS,WAAW,kBAAkB,MAAM,CAAC,OAAO,GAAG,kBAAkB,MAAM,CAAC,OAAO;IACzF,MAAM,cAAc,aAAa,OAAO,CAAC;IAEzC,IAAI,CAAC,aAAa;QAChB,MAAM,IAAI,MAAM,CAAC,gCAAgC,EAAE,MAAM;IAC3D;IAEA,OAAO;AACT;AAEO,SAAS,eAAe,IAAyB,EAAE,SAAiB;IACzE,MAAM,MACJ,SAAS,WAAW,kBAAkB,MAAM,CAAC,OAAO,GAAG,kBAAkB,MAAM,CAAC,OAAO;IACzF,aAAa,OAAO,CAAC,KAAK;AAC5B","debugId":null}},
    {"offset": {"line": 75, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/hooks/useTransferLimits.ts"],"sourcesContent":["import { useState, useEffect, useCallback } from \"react\";\nimport { FREE_TIER_LIMIT, PREMIUM_TIER_LIMIT } from \"@/lib/constants\";\nimport { getAuthData } from \"@/lib/auth/constants\";\n\nexport interface UserStatus {\n  isPremium: boolean;\n  currentUsage: number;\n  resetInSeconds?: number;\n}\n\nexport interface TransferLimits extends UserStatus {\n  dailyLimit: number;\n  availableToday: number;\n  resetInSeconds?: number;\n}\n\nexport interface UseTransferLimitsReturn {\n  status: TransferLimits | null;\n  loading: boolean;\n  error: Error | null;\n  updateUsage: (count: number) => Promise<boolean>;\n  checkLimit: (count: number) => Promise<boolean>;\n  refreshStatus: () => Promise<void>;\n  isLimitExceededModalOpen: boolean;\n  setIsLimitExceededModalOpen: (isOpen: boolean) => void;\n  selectedCountForModal: number;\n}\n\nexport function useTransferLimits(): UseTransferLimitsReturn {\n  const [status, setStatus] = useState<TransferLimits | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<Error | null>(null);\n  const [isLimitExceededModalOpen, setIsLimitExceededModalOpen] = useState(false);\n  const [selectedCountForModal, setSelectedCountForModal] = useState(0);\n\n  // Helper function to calculate full status with limits\n  const calculateFullStatus = (baseStatus: UserStatus): TransferLimits => {\n    const dailyLimit = baseStatus.isPremium ? PREMIUM_TIER_LIMIT : FREE_TIER_LIMIT;\n    return {\n      ...baseStatus,\n      dailyLimit,\n      availableToday: Math.max(0, dailyLimit - baseStatus.currentUsage),\n    };\n  };\n\n  // Helper function to get the current user ID\n  const getCurrentUserId = (): string => {\n    const targetAuth = getAuthData(\"target\");\n    if (!targetAuth) {\n      throw new Error(\"No target service authentication found\");\n    }\n    return `${targetAuth.serviceId}:${targetAuth.userId}`;\n  };\n\n  const fetchUserStatus = useCallback(async () => {\n    try {\n      setLoading(true);\n      const userId = getCurrentUserId();\n      const response = await fetch(\"/api/user/status\", {\n        headers: {\n          \"x-user-id\": userId,\n        },\n      });\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch user status\");\n      }\n      const data = await response.json();\n      setStatus(calculateFullStatus(data));\n      setError(null);\n    } catch (err) {\n      // Fall back to free tier limits\n      const fallbackStatus = {\n        isPremium: false,\n        dailyLimit: FREE_TIER_LIMIT,\n        currentUsage: 0,\n        availableToday: FREE_TIER_LIMIT,\n      };\n      setStatus(fallbackStatus);\n      setError(err instanceof Error ? err : new Error(\"Unknown error\"));\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    fetchUserStatus();\n  }, [fetchUserStatus]);\n\n  const checkLimit = useCallback(\n    async (count: number): Promise<boolean> => {\n      try {\n        const userId = getCurrentUserId();\n        const response = await fetch(\"/api/user/status\", {\n          headers: {\n            \"x-user-id\": userId,\n          },\n        });\n\n        if (!response.ok) {\n          throw new Error(\"Failed to check usage limit\");\n        }\n\n        const data = await response.json();\n        const { isPremium, currentUsage, resetInSeconds } = data;\n        const dailyLimit = isPremium ? PREMIUM_TIER_LIMIT : FREE_TIER_LIMIT;\n        const newUsage = currentUsage + count;\n\n        if (newUsage > dailyLimit) {\n          if (status) {\n            setSelectedCountForModal(count);\n            setIsLimitExceededModalOpen(true);\n\n            // Update local status with current usage and resetInSeconds\n            const newStatus = calculateFullStatus({\n              isPremium,\n              currentUsage,\n              resetInSeconds,\n            });\n            setStatus(newStatus);\n          }\n          return false;\n        }\n\n        return true;\n      } catch (err) {\n        console.error(\"Error checking usage limit:\", err);\n        return false;\n      }\n    },\n    [status]\n  );\n\n  const updateUsage = useCallback(\n    async (count: number): Promise<boolean> => {\n      try {\n        const userId = getCurrentUserId();\n        const response = await fetch(\"/api/transfer/usage\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"x-user-id\": userId,\n          },\n          body: JSON.stringify({ count }),\n        });\n\n        if (!response.ok) {\n          const errorData = await response.json();\n          console.error(\"Error updating usage:\", errorData);\n\n          if (response.status === 403) {\n            if (status) {\n              setSelectedCountForModal(count);\n              setIsLimitExceededModalOpen(true);\n\n              // Update local status\n              const newStatus = calculateFullStatus({\n                isPremium: status.isPremium,\n                currentUsage: errorData.currentUsage,\n                resetInSeconds: errorData.resetInSeconds,\n              });\n              setStatus(newStatus);\n            }\n            return false;\n          }\n\n          throw new Error(\"Failed to update usage\");\n        }\n\n        const data = await response.json();\n        // Update local status\n        if (status) {\n          const newStatus = calculateFullStatus({\n            isPremium: status.isPremium,\n            currentUsage: data.currentUsage,\n          });\n          setStatus(newStatus);\n        }\n\n        return true;\n      } catch (err) {\n        console.error(\"Error updating usage count:\", err);\n        return false;\n      }\n    },\n    [status]\n  );\n\n  return {\n    status,\n    loading,\n    error,\n    updateUsage,\n    checkLimit,\n    refreshStatus: fetchUserStatus,\n    isLimitExceededModalOpen,\n    setIsLimitExceededModalOpen,\n    selectedCountForModal,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 244, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/TransferLimitModal.tsx"],"sourcesContent":["\"use client\";\n\nimport React from \"react\";\nimport { TransferLimits } from \"@/hooks/useTransferLimits\";\nimport { FREE_TIER_LIMIT, PREMIUM_TIER_LIMIT } from \"@/lib/constants\";\n\ninterface TransferLimitModalProps {\n  selectedCount: number;\n  userStatus: TransferLimits;\n}\n\nexport function TransferLimitModal({ selectedCount, userStatus }: TransferLimitModalProps) {\n  const { dailyLimit, availableToday, resetInSeconds } = userStatus;\n  const hasAvailableTransfers = availableToday > 0;\n  const isSelectionOverLimit = selectedCount > availableToday;\n\n  // Format reset time if available\n  const resetTimeText = resetInSeconds\n    ? `${Math.floor(resetInSeconds / 3600)}h ${Math.floor((resetInSeconds % 3600) / 60)}m`\n    : null;\n\n  return (\n    <div className=\"flex flex-col gap-6\">\n      {/* Status Message */}\n      {(isSelectionOverLimit || !hasAvailableTransfers) && (\n        <div className=\"flex items-center gap-4 rounded-lg bg-gradient-to-r from-indigo-500/10 to-indigo-600/5 p-6 text-gray-700 dark:text-gray-300\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"space-y-1\">\n              {/**\n                Status message logic:\n                - If user has available transfers and selection exceeds limit, show warning\n                - If user has available transfers and selection is within limit, show nothing\n                - If no available transfers, show daily limit reached\n              */}\n              {hasAvailableTransfers ? (\n                isSelectionOverLimit ? (\n                  // Warning: selection exceeds available transfers\n                  <>\n                    <p className=\"text-lg\">\n                      You&apos;ve selected <span className=\"font-semibold\">{selectedCount}</span>{\" \"}\n                      tracks but can only transfer{\" \"}\n                      <span className=\"font-semibold text-indigo-600 dark:text-indigo-400\">\n                        {availableToday}\n                      </span>{\" \"}\n                      more today.\n                    </p>\n                    {/* Show reset time only with warning */}\n                    {resetTimeText && (\n                      <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                        Your transfer limit will reset in {resetTimeText}\n                      </p>\n                    )}\n                  </>\n                ) : null // No message or reset time if selection is within limit\n              ) : (\n                // No available transfers: daily limit reached\n                <>\n                  <p className=\"text-lg font-medium text-amber-600 dark:text-amber-400\">\n                    Daily Limit Reached\n                  </p>\n                  <p className=\"text-base\">\n                    You&apos;ve used all <span className=\"font-semibold\">{dailyLimit}</span>{\" \"}\n                    transfers available in your free plan today\n                  </p>\n                  {/* Show reset time only with daily limit reached */}\n                  {resetTimeText && (\n                    <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                      Your transfer limit will reset in {resetTimeText}\n                    </p>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Current Free Plan */}\n      <div className=\"relative overflow-hidden rounded-lg border border-gray-100 bg-white p-6 dark:border-gray-900 dark:bg-gray-950/30\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-900/50\">\n            <svg\n              className=\"mt-1 h-5 w-5 text-gray-600 dark:text-gray-400\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\"\n              />\n            </svg>\n          </div>\n          <div className=\"flex flex-col items-start\">\n            <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">Free Plan</h3>\n            <span className=\"mt-2 rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 dark:bg-gray-800 dark:text-gray-400\">\n              Current Plan\n            </span>\n          </div>\n        </div>\n        <ul className=\"mb-4 mt-4 space-y-2 text-gray-600 dark:text-gray-300\">\n          <li className=\"flex items-center gap-2.5\">\n            <div className=\"flex h-5 w-5 items-center justify-center\">\n              <svg className=\"h-4 w-4 text-gray-400\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n            </div>\n            {FREE_TIER_LIMIT} daily transfers\n          </li>\n        </ul>\n      </div>\n\n      {/* Premium Plan - Coming Soon */}\n      <div className=\"relative overflow-hidden rounded-lg border border-indigo-100 bg-gradient-to-br from-indigo-50 to-white p-6 dark:border-indigo-900 dark:from-indigo-950/30 dark:to-indigo-900/10\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"mt-1 flex h-10 w-10 items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-900/50\">\n            <svg\n              className=\"h-5 w-5 text-indigo-600 dark:text-indigo-400\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z\"\n              />\n            </svg>\n          </div>\n          <div className=\"flex flex-col items-start\">\n            <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">Premium Plan</h3>\n            <span className=\"mt-2 rounded-full bg-indigo-100 px-2.5 py-0.5 text-xs font-medium text-indigo-600 dark:bg-indigo-900/50 dark:text-indigo-400\">\n              Coming Soon\n            </span>\n          </div>\n        </div>\n        <p className=\"mt-4 text-sm text-gray-500 dark:text-gray-400\">\n          Upgrade to Premium for a higher limit\n        </p>\n        <ul className=\"mb-4 mt-3 space-y-2 text-gray-600 dark:text-gray-300\">\n          <li className=\"flex items-center gap-2.5\">\n            <div className=\"flex h-5 w-5 items-center justify-center\">\n              <svg className=\"h-4 w-4 text-emerald-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n            </div>\n            <span className=\"flex items-center gap-1.5\">\n              <span>{PREMIUM_TIER_LIMIT} daily transfers</span>\n            </span>\n          </li>\n        </ul>\n        <button\n          disabled\n          className=\"w-full cursor-not-allowed rounded-lg bg-gray-100 px-6 py-2.5 text-center font-medium text-gray-400 dark:bg-gray-800 dark:text-gray-500\"\n        >\n          Coming Soon\n        </button>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 643, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/Dialog.tsx"],"sourcesContent":["import React, { useRef, useEffect } from \"react\";\nimport type { JSX } from \"react\";\n\ninterface DialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  title: string;\n  children: React.ReactNode;\n  closeOnBackdropClick?: boolean;\n  // maxWidthClass prop removed as sizing is now handled directly in the className for Tailwind v4\n}\n\n/**\n * A reusable modal dialog component with light/dark theme support using Tailwind's indigo color scheme\n *\n * @param isOpen - Controls whether the dialog is visible\n * @param onClose - Function to call when the dialog should close\n * @param title - The title displayed in the dialog header\n * @param children - Content to render inside the dialog\n * @param closeOnBackdropClick - Whether clicking outside the dialog should close it (defaults to true)\n */\nexport default function Dialog({\n  isOpen,\n  onClose,\n  title,\n  children,\n  closeOnBackdropClick = true,\n}: DialogProps): JSX.Element | null {\n  const dialogRef = useRef<HTMLDivElement>(null);\n\n  // Handle clicking outside to close\n  useEffect(() => {\n    function handleClickOutside(event: MouseEvent): void {\n      if (\n        closeOnBackdropClick &&\n        dialogRef.current &&\n        !dialogRef.current.contains(event.target as Node)\n      ) {\n        onClose();\n      }\n    }\n\n    // Handle escape key press to close\n    function handleKeyDown(event: KeyboardEvent): void {\n      if (event.key === \"Escape\") {\n        onClose();\n      }\n    }\n\n    // Only add the event listeners if the dialog is open\n    if (isOpen) {\n      document.addEventListener(\"mousedown\", handleClickOutside);\n      document.addEventListener(\"keydown\", handleKeyDown);\n    }\n\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n      document.removeEventListener(\"keydown\", handleKeyDown);\n    };\n  }, [isOpen, onClose, closeOnBackdropClick]);\n\n  // Prevent scrolling when dialog is open\n  useEffect(() => {\n    if (isOpen) {\n      document.body.style.overflow = \"hidden\";\n    } else {\n      document.body.style.overflow = \"\";\n    }\n\n    return () => {\n      document.body.style.overflow = \"\";\n    };\n  }, [isOpen]);\n\n  if (!isOpen) return null;\n\n  return (\n    <div\n      // Use a very light black overlay (10% opacity) with minimal blur for a subtle, modern effect in both light and dark mode\n      className=\"fixed inset-0 isolate z-[9999] flex items-center justify-center bg-black/10 backdrop-blur-sm\"\n      aria-modal=\"true\"\n      role=\"dialog\"\n    >\n      <div\n        ref={dialogRef}\n        // Dialog box: fullscreen on mobile, modal on sm+\n        // Use flex-col so header stays fixed and content scrolls if needed\n        // Increased dark mode background opacity from 80% to 95% for better readability\n        className=\"dark:bg-[var(--color-indigo-990)]/95 lg:dark:bg-[var(--color-indigo-990)]/95 mx-0 flex h-full max-h-none w-full max-w-none flex-col rounded-none border-none\n          bg-white p-0 shadow-none lg:mx-4 lg:h-auto lg:max-h-[85vh] lg:max-w-2xl lg:rounded-xl lg:border lg:border-gray-200 lg:bg-white lg:p-0 lg:shadow\"\n      >\n        {/* Dialog header: matches Header height and close button on mobile */}\n        <div className=\"flex h-14 items-center justify-between border-b border-gray-100 px-4 py-0 lg:h-16 lg:px-6 dark:border-gray-800\">\n          <h2 className=\"text-xl font-semibold tracking-tight text-gray-900 dark:text-white\">\n            {title}\n          </h2>\n          <button\n            onClick={onClose}\n            // On mobile: match menu button (rounded-full, p-2, size-6). On desktop: original style.\n            className=\"rounded-full p-0 text-gray-500 transition-colors hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 lg:rounded-lg lg:p-1 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-gray-200 dark:focus:ring-indigo-400\"\n            aria-label=\"Close dialog\"\n          >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              className=\"size-6 lg:h-5 lg:w-5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n        {/*\n          Content area is now flex-1 and scrollable, with max height minus header (64px).\n          This ensures content never overflows the modal and scrolls if too tall.\n        */}\n        <div className=\"min-h-0 flex-1 overflow-y-auto px-6 py-6 text-gray-700 lg:max-h-[calc(85vh-64px)] dark:text-gray-200\">\n          {children}\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAAA;;;AAqBe,SAAS,OAAO,EAC7B,MAAM,EACN,OAAO,EACP,KAAK,EACL,QAAQ,EACR,uBAAuB,IAAI,EACf;IACZ,MAAM,YAAY,IAAA,8ZAAM,EAAiB;IAEzC,mCAAmC;IACnC,IAAA,iaAAS,EAAC;QACR,SAAS,mBAAmB,KAAiB;YAC3C,IACE,wBACA,UAAU,OAAO,IACjB,CAAC,UAAU,OAAO,CAAC,QAAQ,CAAC,MAAM,MAAM,GACxC;gBACA;YACF;QACF;QAEA,mCAAmC;QACnC,SAAS,cAAc,KAAoB;YACzC,IAAI,MAAM,GAAG,KAAK,UAAU;gBAC1B;YACF;QACF;QAEA,qDAAqD;QACrD,IAAI,QAAQ;YACV,SAAS,gBAAgB,CAAC,aAAa;YACvC,SAAS,gBAAgB,CAAC,WAAW;QACvC;QAEA,OAAO;YACL,SAAS,mBAAmB,CAAC,aAAa;YAC1C,SAAS,mBAAmB,CAAC,WAAW;QAC1C;IACF,GAAG;QAAC;QAAQ;QAAS;KAAqB;IAE1C,wCAAwC;IACxC,IAAA,iaAAS,EAAC;QACR,IAAI,QAAQ;YACV,SAAS,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG;QACjC,OAAO;YACL,SAAS,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG;QACjC;QAEA,OAAO;YACL,SAAS,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG;QACjC;IACF,GAAG;QAAC;KAAO;IAEX,IAAI,CAAC,QAAQ,OAAO;IAEpB,qBACE,6bAAC;QACC,yHAAyH;QACzH,WAAU;QACV,cAAW;QACX,MAAK;kBAEL,cAAA,6bAAC;YACC,KAAK;YACL,iDAAiD;YACjD,mEAAmE;YACnE,gFAAgF;YAChF,WAAU;;8BAIV,6bAAC;oBAAI,WAAU;;sCACb,6bAAC;4BAAG,WAAU;sCACX;;;;;;sCAEH,6bAAC;4BACC,SAAS;4BACT,wFAAwF;4BACxF,WAAU;4BACV,cAAW;sCAEX,cAAA,6bAAC;gCACC,OAAM;gCACN,WAAU;gCACV,MAAK;gCACL,SAAQ;gCACR,QAAO;0CAEP,cAAA,6bAAC;oCACC,eAAc;oCACd,gBAAe;oCACf,aAAa;oCACb,GAAE;;;;;;;;;;;;;;;;;;;;;;8BASV,6bAAC;oBAAI,WAAU;8BACZ;;;;;;;;;;;;;;;;;AAKX","debugId":null}},
    {"offset": {"line": 778, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/contexts/TransferContext.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { createContext, useContext, ReactNode } from \"react\";\nimport { useTransferLimits, TransferLimits } from \"@/hooks/useTransferLimits\";\nimport { TransferLimitModal } from \"@/components/shared/TransferLimitModal\";\nimport Dialog from \"@/components/shared/Dialog\";\n\ninterface TransferContextProps {\n  children: ReactNode;\n}\n\ninterface TransferContextType {\n  userStatus: TransferLimits | null;\n  isLoading: boolean;\n  error: Error | null;\n  updateUsage: (count: number) => Promise<boolean>;\n  checkLimit: (count: number) => Promise<boolean>;\n  refreshStatus: () => Promise<void>;\n}\n\nconst TransferContext = createContext<TransferContextType | undefined>(undefined);\n\nexport function TransferProvider({ children }: TransferContextProps) {\n  const {\n    status,\n    loading,\n    error,\n    updateUsage,\n    checkLimit,\n    refreshStatus,\n    isLimitExceededModalOpen,\n    setIsLimitExceededModalOpen,\n    selectedCountForModal,\n  } = useTransferLimits();\n\n  // Handle the \"Continue anyway\" action for the modal\n  const handleCloseModal = () => {\n    setIsLimitExceededModalOpen(false);\n  };\n\n  return (\n    <TransferContext.Provider\n      value={{\n        userStatus: status,\n        isLoading: loading,\n        error,\n        updateUsage,\n        checkLimit,\n        refreshStatus,\n      }}\n    >\n      {children}\n\n      {/* Render the modal conditionally based on status and modal state */}\n      {status && isLimitExceededModalOpen && (\n        <Dialog isOpen={true} onClose={handleCloseModal} title=\"Transfer Limit\">\n          <TransferLimitModal selectedCount={selectedCountForModal} userStatus={status} />\n        </Dialog>\n      )}\n    </TransferContext.Provider>\n  );\n}\n\nexport function useTransfer(): TransferContextType {\n  const context = useContext(TransferContext);\n\n  if (context === undefined) {\n    throw new Error(\"useTransfer must be used within a TransferProvider\");\n  }\n\n  return context;\n}\n"],"names":[],"mappings":";;;;;;;AAEA;AACA;AACA;AACA;AALA;;;;;;AAoBA,MAAM,gCAAkB,IAAA,qaAAa,EAAkC;AAEhE,SAAS,iBAAiB,EAAE,QAAQ,EAAwB;IACjE,MAAM,EACJ,MAAM,EACN,OAAO,EACP,KAAK,EACL,WAAW,EACX,UAAU,EACV,aAAa,EACb,wBAAwB,EACxB,2BAA2B,EAC3B,qBAAqB,EACtB,GAAG,IAAA,qKAAiB;IAErB,oDAAoD;IACpD,MAAM,mBAAmB;QACvB,4BAA4B;IAC9B;IAEA,qBACE,6bAAC,gBAAgB,QAAQ;QACvB,OAAO;YACL,YAAY;YACZ,WAAW;YACX;YACA;YACA;YACA;QACF;;YAEC;YAGA,UAAU,0CACT,6bAAC,gKAAM;gBAAC,QAAQ;gBAAM,SAAS;gBAAkB,OAAM;0BACrD,cAAA,6bAAC,uLAAkB;oBAAC,eAAe;oBAAuB,YAAY;;;;;;;;;;;;;;;;;AAKhF;AAEO,SAAS;IACd,MAAM,UAAU,IAAA,kaAAU,EAAC;IAE3B,IAAI,YAAY,WAAW;QACzB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 848, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/TransferUsageDisplay.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { useTransfer } from \"@/contexts/TransferContext\";\nimport { TransferLimitModal } from \"./TransferLimitModal\";\nimport Dialog from \"./Dialog\";\n\nexport function TransferUsageDisplay() {\n  const { userStatus: status, isLoading: loading, error } = useTransfer();\n  const [isModalOpen, setIsModalOpen] = useState(false);\n\n  if (loading) {\n    return (\n      <div className=\"flex h-full animate-pulse items-center text-xs text-gray-400\">\n        Loading usage...\n      </div>\n    );\n  }\n\n  if (error || !status) {\n    return null;\n  }\n\n  return (\n    <>\n      <button\n        onClick={() => setIsModalOpen(true)}\n        className=\"group relative flex cursor-pointer flex-col items-center gap-1.5 rounded-full border border-indigo-100 bg-gradient-to-b from-white to-indigo-50/50 px-4 py-2.5 transition-all duration-300 hover:border-indigo-200 active:scale-[0.98] dark:border-indigo-500/20 dark:from-gray-900 dark:to-indigo-950/30 dark:hover:border-indigo-500/30\"\n      >\n        <span className=\"bg-gradient-to-r from-indigo-600 to-indigo-500 bg-clip-text text-sm font-semibold text-transparent transition-colors group-hover:from-indigo-500 group-hover:to-indigo-400 dark:from-indigo-400 dark:to-indigo-300\">\n          Go Premium\n        </span>\n      </button>\n\n      {isModalOpen &&\n        createPortal(\n          <Dialog isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title=\"Plans\">\n            <TransferLimitModal selectedCount={0} userStatus={status} />\n          </Dialog>,\n          document.body\n        )}\n    </>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AANA;;;;;;;AAQO,SAAS;IACd,MAAM,EAAE,YAAY,MAAM,EAAE,WAAW,OAAO,EAAE,KAAK,EAAE,GAAG,IAAA,iKAAW;IACrE,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,gaAAQ,EAAC;IAE/C,IAAI,SAAS;QACX,qBACE,6bAAC;YAAI,WAAU;sBAA+D;;;;;;IAIlF;IAEA,IAAI,SAAS,CAAC,QAAQ;QACpB,OAAO;IACT;IAEA,qBACE;;0BACE,6bAAC;gBACC,SAAS,IAAM,eAAe;gBAC9B,WAAU;0BAEV,cAAA,6bAAC;oBAAK,WAAU;8BAAqN;;;;;;;;;;;YAKtO,6BACC,IAAA,2aAAY,gBACV,6bAAC,gKAAM;gBAAC,QAAQ;gBAAa,SAAS,IAAM,eAAe;gBAAQ,OAAM;0BACvE,cAAA,6bAAC,uLAAkB;oBAAC,eAAe;oBAAG,YAAY;;;;;;;;;;sBAEpD,SAAS,IAAI;;;AAIvB","debugId":null}},
    {"offset": {"line": 923, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/layout/header/ThemeToggle.tsx"],"sourcesContent":["\"use client\";\n\nimport React from \"react\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\nimport { useEffect, useState } from \"react\";\n\nexport function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n  const [mounted, setMounted] = useState(false);\n\n  // Avoid hydration mismatch by only rendering after mount\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  if (!mounted) {\n    return <div className=\"h-[30px] w-[60px]\" />; // Placeholder with same dimensions\n  }\n\n  return (\n    <button\n      onClick={toggleTheme}\n      data-testid=\"theme-toggle\"\n      className={`\n        relative inline-flex h-[30px] w-[60px] items-center justify-between rounded-full p-0.5\n        ${\n          theme === \"light\"\n            ? \"bg-gray-300/60 hover:bg-gray-300\"\n            : \"bg-indigo-950/60 hover:bg-indigo-950\"\n        }\n        focus-visible:ring-primary-500/70 cursor-pointer\n        border-0 transition-colors duration-200\n        focus:outline-none focus-visible:ring-2\n      `}\n      aria-label={theme === \"dark\" ? \"Switch to light theme\" : \"Switch to dark theme\"}\n    >\n      {/* Sliding background */}\n      <span\n        className={`\n          absolute h-[26px] w-[26px] rounded-full\n          ${theme === \"light\" ? \"translate-x-0 bg-gray-100\" : \"translate-x-[30px] bg-indigo-900\"}\n          transform transition-all duration-200 ease-out\n        `}\n      />\n\n      {/* Sun icon - left side */}\n      <svg\n        xmlns=\"http://www.w3.org/2000/svg\"\n        width=\"14\"\n        height=\"14\"\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n        className={`\n          relative z-10 ml-1.5\n          ${theme === \"light\" ? \"text-gray-800\" : \"text-gray-500\"}\n          transition-colors duration-200\n        `}\n      >\n        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n      </svg>\n\n      {/* Moon icon - right side */}\n      <svg\n        xmlns=\"http://www.w3.org/2000/svg\"\n        width=\"14\"\n        height=\"14\"\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n        className={`\n          relative z-10 mr-1.5\n          ${theme === \"light\" ? \"text-gray-400\" : \"text-indigo-200\"}\n          transition-colors duration-200\n        `}\n      >\n        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n      </svg>\n    </button>\n  );\n}\n"],"names":[],"mappings":";;;;;AAGA;AACA;AAJA;;;;AAMO,SAAS;IACd,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,GAAG,IAAA,2JAAQ;IACvC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,gaAAQ,EAAC;IAEvC,yDAAyD;IACzD,IAAA,iaAAS,EAAC;QACR,WAAW;IACb,GAAG,EAAE;IAEL,IAAI,CAAC,SAAS;QACZ,qBAAO,6bAAC;YAAI,WAAU;;;;;kBAAwB,mCAAmC;IACnF;IAEA,qBACE,6bAAC;QACC,SAAS;QACT,eAAY;QACZ,WAAW,CAAC;;QAEV,EACE,UAAU,UACN,qCACA,uCACL;;;;MAIH,CAAC;QACD,cAAY,UAAU,SAAS,0BAA0B;;0BAGzD,6bAAC;gBACC,WAAW,CAAC;;UAEV,EAAE,UAAU,UAAU,8BAA8B,mCAAmC;;QAEzF,CAAC;;;;;;0BAIH,6bAAC;gBACC,OAAM;gBACN,OAAM;gBACN,QAAO;gBACP,SAAQ;gBACR,MAAK;gBACL,QAAO;gBACP,aAAY;gBACZ,eAAc;gBACd,gBAAe;gBACf,WAAW,CAAC;;UAEV,EAAE,UAAU,UAAU,kBAAkB,gBAAgB;;QAE1D,CAAC;;kCAED,6bAAC;wBAAO,IAAG;wBAAK,IAAG;wBAAK,GAAE;;;;;;kCAC1B,6bAAC;wBAAK,IAAG;wBAAK,IAAG;wBAAI,IAAG;wBAAK,IAAG;;;;;;kCAChC,6bAAC;wBAAK,IAAG;wBAAK,IAAG;wBAAK,IAAG;wBAAK,IAAG;;;;;;kCACjC,6bAAC;wBAAK,IAAG;wBAAO,IAAG;wBAAO,IAAG;wBAAO,IAAG;;;;;;kCACvC,6bAAC;wBAAK,IAAG;wBAAQ,IAAG;wBAAQ,IAAG;wBAAQ,IAAG;;;;;;kCAC1C,6bAAC;wBAAK,IAAG;wBAAI,IAAG;wBAAK,IAAG;wBAAI,IAAG;;;;;;kCAC/B,6bAAC;wBAAK,IAAG;wBAAK,IAAG;wBAAK,IAAG;wBAAK,IAAG;;;;;;kCACjC,6bAAC;wBAAK,IAAG;wBAAO,IAAG;wBAAQ,IAAG;wBAAO,IAAG;;;;;;kCACxC,6bAAC;wBAAK,IAAG;wBAAQ,IAAG;wBAAO,IAAG;wBAAQ,IAAG;;;;;;;;;;;;0BAI3C,6bAAC;gBACC,OAAM;gBACN,OAAM;gBACN,QAAO;gBACP,SAAQ;gBACR,MAAK;gBACL,QAAO;gBACP,aAAY;gBACZ,eAAc;gBACd,gBAAe;gBACf,WAAW,CAAC;;UAEV,EAAE,UAAU,UAAU,kBAAkB,kBAAkB;;QAE5D,CAAC;0BAED,cAAA,6bAAC;oBAAK,GAAE;;;;;;;;;;;;;;;;;AAIhB","debugId":null}},
    {"offset": {"line": 1122, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/layout/header/LanguageSwitch.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useRef, useEffect } from \"react\";\n\nconst languages = [\n  { code: \"en\", name: \"English\" },\n  { code: \"zh\", name: \"简体中文\" },\n  { code: \"pt\", name: \"Português\" },\n  { code: \"ru\", name: \"Русский\" },\n  { code: \"es\", name: \"Español\" },\n  { code: \"ko\", name: \"한국어\" },\n  { code: \"fa\", name: \"فارسی\" },\n];\n\nexport const LanguageSwitch = () => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedLang, setSelectedLang] = useState(\"en\");\n  const dropdownRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const handleLanguageSelect = (langCode: string) => {\n    setSelectedLang(langCode);\n    setIsOpen(false);\n    // todo: handle language change\n  };\n\n  const selectedLanguage = languages.find(lang => lang.code === selectedLang);\n\n  return (\n    <div className=\"relative\" ref={dropdownRef} style={{ zIndex: 100 }}>\n      <button\n        onClick={() => setIsOpen(!isOpen)}\n        data-testid=\"language-switch\"\n        className=\"flex cursor-pointer items-center gap-2 rounded-lg px-3 py-1.5 text-sm text-gray-800 transition-colors hover:text-gray-950 dark:text-indigo-300 dark:hover:text-indigo-200\"\n      >\n        <svg\n          width=\"20\"\n          height=\"20\"\n          viewBox=\"0 0 512 512\"\n          fill=\"currentColor\"\n          role=\"graphics-symbol\"\n          aria-label={`Selected language: ${selectedLanguage?.name}`}\n        >\n          <path d=\"M363,176,246,464h47.24l24.49-58h90.54l24.49,58H480ZM336.31,362,363,279.85,389.69,362Z\"></path>\n          <path d=\"M272,320c-.25-.19-20.59-15.77-45.42-42.67,39.58-53.64,62-114.61,71.15-143.33H352V90H214V48H170V90H32v44H251.25c-9.52,26.95-27.05,69.5-53.79,108.36-32.68-43.44-47.14-75.88-47.33-76.22L143,152l-38,22,6.87,13.86c.89,1.56,17.19,37.9,54.71,86.57.92,1.21,1.85,2.39,2.78,3.57-49.72,56.86-89.15,79.09-89.66,79.47L64,368l23,36,19.3-11.47c2.2-1.67,41.33-24,92-80.78,24.52,26.28,43.22,40.83,44.3,41.67L255,362Z\"></path>\n        </svg>\n        <svg\n          className={`h-4 w-4 transition-transform duration-200 ${isOpen ? \"rotate-180\" : \"\"}`}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          viewBox=\"0 0 24 24\"\n        >\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n        </svg>\n      </button>\n\n      {isOpen && (\n        <div\n          data-testid=\"language-dropdown\"\n          className=\"absolute right-0 top-full mt-2 w-40 rounded-xl border border-gray-100 bg-white py-2 shadow-lg backdrop-blur-lg dark:border-gray-800/50 dark:bg-gray-900/95\"\n        >\n          {languages.map(lang => (\n            <button\n              key={lang.code}\n              onClick={() => handleLanguageSelect(lang.code)}\n              className={`w-full px-4 py-2 text-left text-sm transition-colors\n                ${\n                  lang.code === selectedLang\n                    ? \"bg-indigo-50/50 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400\"\n                    : \"text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-white/5\"\n                }`}\n            >\n              {lang.name}\n            </button>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAEA;AAFA;;;AAIA,MAAM,YAAY;IAChB;QAAE,MAAM;QAAM,MAAM;IAAU;IAC9B;QAAE,MAAM;QAAM,MAAM;IAAO;IAC3B;QAAE,MAAM;QAAM,MAAM;IAAY;IAChC;QAAE,MAAM;QAAM,MAAM;IAAU;IAC9B;QAAE,MAAM;QAAM,MAAM;IAAU;IAC9B;QAAE,MAAM;QAAM,MAAM;IAAM;IAC1B;QAAE,MAAM;QAAM,MAAM;IAAQ;CAC7B;AAEM,MAAM,iBAAiB;IAC5B,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,gaAAQ,EAAC;IACrC,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,gaAAQ,EAAC;IACjD,MAAM,cAAc,IAAA,8ZAAM,EAAiB;IAE3C,IAAA,iaAAS,EAAC;QACR,MAAM,qBAAqB,CAAC;YAC1B,IAAI,YAAY,OAAO,IAAI,CAAC,YAAY,OAAO,CAAC,QAAQ,CAAC,MAAM,MAAM,GAAW;gBAC9E,UAAU;YACZ;QACF;QAEA,SAAS,gBAAgB,CAAC,aAAa;QACvC,OAAO,IAAM,SAAS,mBAAmB,CAAC,aAAa;IACzD,GAAG,EAAE;IAEL,MAAM,uBAAuB,CAAC;QAC5B,gBAAgB;QAChB,UAAU;IACV,+BAA+B;IACjC;IAEA,MAAM,mBAAmB,UAAU,IAAI,CAAC,CAAA,OAAQ,KAAK,IAAI,KAAK;IAE9D,qBACE,6bAAC;QAAI,WAAU;QAAW,KAAK;QAAa,OAAO;YAAE,QAAQ;QAAI;;0BAC/D,6bAAC;gBACC,SAAS,IAAM,UAAU,CAAC;gBAC1B,eAAY;gBACZ,WAAU;;kCAEV,6bAAC;wBACC,OAAM;wBACN,QAAO;wBACP,SAAQ;wBACR,MAAK;wBACL,MAAK;wBACL,cAAY,CAAC,mBAAmB,EAAE,kBAAkB,MAAM;;0CAE1D,6bAAC;gCAAK,GAAE;;;;;;0CACR,6bAAC;gCAAK,GAAE;;;;;;;;;;;;kCAEV,6bAAC;wBACC,WAAW,CAAC,0CAA0C,EAAE,SAAS,eAAe,IAAI;wBACpF,MAAK;wBACL,QAAO;wBACP,SAAQ;kCAER,cAAA,6bAAC;4BAAK,eAAc;4BAAQ,gBAAe;4BAAQ,aAAa;4BAAG,GAAE;;;;;;;;;;;;;;;;;YAIxE,wBACC,6bAAC;gBACC,eAAY;gBACZ,WAAU;0BAET,UAAU,GAAG,CAAC,CAAA,qBACb,6bAAC;wBAEC,SAAS,IAAM,qBAAqB,KAAK,IAAI;wBAC7C,WAAW,CAAC;gBACV,EACE,KAAK,IAAI,KAAK,eACV,+EACA,2EACJ;kCAEH,KAAK,IAAI;uBATL,KAAK,IAAI;;;;;;;;;;;;;;;;AAgB5B","debugId":null}},
    {"offset": {"line": 1275, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/layout/header/MobileMenu.tsx"],"sourcesContent":["import { useState } from \"react\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\nimport Dialog from \"@/components/shared/Dialog\";\nimport { createPortal } from \"react-dom\";\n\nconst GITHUB_BASE_URL = \"https://github.com/tony-co/nonna.fm/blob/main\";\nconst GITHUB_REPO = \"https://github.com/tony-co/nonna.fm\";\n\nconst languages = [\n  { code: \"en\", name: \"English\" },\n  { code: \"zh\", name: \"简体中文\" },\n  { code: \"pt\", name: \"Português\" },\n  { code: \"ru\", name: \"Русский\" },\n  { code: \"es\", name: \"Español\" },\n  { code: \"ko\", name: \"한국어\" },\n  { code: \"fa\", name: \"فارسی\" },\n];\n\ninterface MobileMenuProps {\n  isOpen: boolean;\n  onOpenChange: (isOpen: boolean) => void;\n}\n\nexport const MobileMenu = ({ isOpen, onOpenChange }: MobileMenuProps) => {\n  const [selectedLang, setSelectedLang] = useState(\"en\");\n  const { theme, toggleTheme } = useTheme();\n\n  const handleLanguageSelect = (langCode: string) => {\n    setSelectedLang(langCode);\n    // todo: handle language change\n  };\n\n  return (\n    <>\n      {/* Menu button: opens the dialog */}\n      <button\n        onClick={() => onOpenChange(true)}\n        className=\"rounded-full p-2 transition-colors duration-200 hover:bg-gray-100 dark:text-white dark:hover:bg-white/10\"\n        aria-label=\"Open menu\"\n      >\n        <svg\n          className=\"size-6\"\n          fill=\"none\"\n          strokeLinecap=\"round\"\n          strokeLinejoin=\"round\"\n          strokeWidth=\"2\"\n          viewBox=\"0 0 24 24\"\n          stroke=\"currentColor\"\n        >\n          <path d=\"M4 6h16M4 12h16M4 18h16\" />\n        </svg>\n      </button>\n\n      {/* Portal for Dialog modal for mobile menu */}\n      {isOpen &&\n        createPortal(\n          <Dialog isOpen={isOpen} onClose={() => onOpenChange(false)} title=\"Settings\">\n            {/* Menu Items */}\n            <div className=\"flex flex-col px-4\">\n              {/* Language Selection */}\n              <div className=\"my-1 rounded-lg px-2 py-4\">\n                <div className=\"mb-2 flex items-center gap-3 text-gray-900 dark:text-white\">\n                  <svg className=\"size-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={1.5}\n                      d=\"M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129\"\n                    />\n                  </svg>\n                  <span className=\"text-[17px]\">Language</span>\n                </div>\n                <select\n                  value={selectedLang}\n                  onChange={e => handleLanguageSelect(e.target.value)}\n                  className=\"w-full rounded-lg bg-gray-100 px-3 py-2 text-[15px] text-gray-900 transition-colors hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-white/5 dark:text-white dark:hover:bg-white/10\"\n                  aria-label=\"Select language\"\n                >\n                  {languages.map(lang => (\n                    <option\n                      key={lang.code}\n                      value={lang.code}\n                      className=\"bg-white text-gray-900 dark:bg-[#0A0A1B] dark:text-white\"\n                    >\n                      {lang.name}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              {/* Theme Selection */}\n              <div className=\"my-1 rounded-lg px-2 py-4\">\n                <div className=\"mb-4 flex items-center gap-3 text-gray-900 dark:text-white\">\n                  <svg className=\"size-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={1.5}\n                      d=\"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z\"\n                    />\n                  </svg>\n                  <span className=\"text-[17px]\">Theme</span>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <button\n                    onClick={() => theme !== \"light\" && toggleTheme()}\n                    className={`relative overflow-hidden rounded-xl border-2 p-4 transition-all duration-200 ${\n                      theme === \"light\"\n                        ? \"border-indigo-600 bg-gray-100\"\n                        : \"border-transparent bg-gray-50 hover:bg-gray-100 dark:bg-white/5 dark:hover:bg-white/10\"\n                    }`}\n                  >\n                    <div className=\"flex aspect-[4/3] items-center justify-center rounded-lg bg-white\">\n                      <span className=\"text-2xl font-medium text-gray-900\">Aa</span>\n                    </div>\n                    <p className=\"mt-2 text-center text-[15px] font-medium text-gray-900 dark:text-white\">\n                      Light\n                    </p>\n                  </button>\n\n                  <button\n                    onClick={() => theme !== \"dark\" && toggleTheme()}\n                    className={`relative overflow-hidden rounded-xl border-2 p-4 transition-all duration-200 ${\n                      theme === \"dark\"\n                        ? \"border-indigo-600 bg-white/10\"\n                        : \"border-transparent bg-gray-50 hover:bg-gray-100 dark:bg-white/5 dark:hover:bg-white/10\"\n                    }`}\n                  >\n                    <div className=\"flex aspect-[4/3] items-center justify-center rounded-lg bg-[#1c1c1c]\">\n                      <span className=\"text-2xl font-medium text-white\">Aa</span>\n                    </div>\n                    <p className=\"mt-2 text-center text-[15px] font-medium text-gray-900 dark:text-white\">\n                      Dark\n                    </p>\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* Done Button */}\n            <div className=\"p-8\">\n              <button\n                className=\"w-full rounded-full bg-indigo-600 py-3.5 text-center text-[17px] font-medium text-white transition-colors duration-200 hover:bg-indigo-700\"\n                onClick={() => onOpenChange(false)}\n              >\n                Done\n              </button>\n            </div>\n\n            {/* Footer Links */}\n            <div className=\"border-t border-gray-200 px-4 py-8 dark:border-white/10\">\n              <div className=\"flex flex-row justify-between\">\n                <a\n                  href={`${GITHUB_BASE_URL}/PRIVACY.md`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"group flex flex-col items-center rounded-lg px-3 py-2 text-zinc-600 transition-all hover:bg-indigo-50/50 hover:text-indigo-600 dark:text-stone-400 dark:hover:bg-indigo-950/30 dark:hover:text-indigo-400\"\n                >\n                  <svg\n                    className=\"mb-1.5 h-5 w-5 opacity-70 transition-opacity group-hover:opacity-100\"\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z\"\n                    />\n                  </svg>\n                  <span className=\"text-sm\">Privacy</span>\n                </a>\n                <a\n                  href={`${GITHUB_BASE_URL}/TERMS.md`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"group flex flex-col items-center rounded-lg px-3 py-2 text-zinc-600 transition-all hover:bg-indigo-50/50 hover:text-indigo-600 dark:text-stone-400 dark:hover:bg-indigo-950/30 dark:hover:text-indigo-400\"\n                >\n                  <svg\n                    className=\"mb-1.5 h-5 w-5 opacity-70 transition-opacity group-hover:opacity-100\"\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    strokeWidth={1.5}\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      d=\"M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z\"\n                    />\n                  </svg>\n                  <span className=\"text-sm\">Terms</span>\n                </a>\n                <a\n                  href={GITHUB_REPO}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"group flex flex-col items-center rounded-lg px-3 py-2 text-zinc-600 transition-all hover:bg-indigo-50/50 hover:text-indigo-600 dark:text-stone-400 dark:hover:bg-indigo-950/30 dark:hover:text-indigo-400\"\n                >\n                  <svg\n                    className=\"mb-1.5 h-5 w-5 opacity-70 transition-opacity group-hover:opacity-100\"\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"currentColor\"\n                    viewBox=\"0 0 24 24\"\n                  >\n                    <path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\" />\n                  </svg>\n                  <span className=\"text-sm\">GitHub</span>\n                </a>\n              </div>\n            </div>\n          </Dialog>,\n          document.body\n        )}\n    </>\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1723, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/NonnaLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface NonnaLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const NonnaLogo: React.FC<NonnaLogoProps> = ({ className = \"\", size = 50 }) => {\n  return (\n    <div className={`relative ${className}`} style={{ width: size, height: size }}>\n      <svg\n        xmlns=\"http://www.w3.org/2000/svg\"\n        viewBox=\"0 0 100 100\"\n        className=\"h-full w-full transition-all duration-200\"\n        fill=\"currentColor\"\n      >\n        <g>\n          <path d=\"M74.4,30.4c1.3-3.9-0.1-9.5-1.5-12.1c-0.6-1-0.9-1.2-1.2-1.3c-0.8-0.2-3.4,1.5-5.9,3.5c-1.5-5-5.3-8.3-9.5-8.3   c-5.3,0-9.6,5-10.1,11.5c-3-3.3-7.4-4.8-9.1-5c-0.4,0-0.7,0-0.8,0.1c-0.3,0.3,0.6,8.5,1,10.3c-1.9,1.9-5.2,7.4-5.8,10.9   c-1.9-1.1-4.1-1.7-6.4-1.6c-3.2,0.1-6.2,1.5-8.5,3.8c-2.2,2.4-3.4,5.5-3.3,8.7c0.2,6.5,5.6,11.7,12.1,11.7c0.1,0,0.3,0,0.4,0   c0.7,0,1.4-0.1,2-0.2l0.7,2.9c-2.1,0.4-3.5,1.4-3.7,3.3c-0.1,3.1,0.4,5.8,2.2,7.8c1.8,1.9,4.4,3,7.4,3.1c-0.5,0.9-2.2,3.8-5.5,7.7   c-0.5,0.6,0.2,1.3,0.8,0.7C31.7,85.6,42.8,73,41,60.3l5.8,2.2l2.5,4.8c0,13.7-5.3,19.1-5.4,19.2c-0.5,0.5-0.1,1.3,0.7,0.7   c0.3-0.2,5.6-5.7,5.7-19.9l2.4-4.7l31.7-8c4.9,15-2.1,32.5-2.1,32.7c-0.3,0.9,0.6,1.3,0.9,0.4C85.6,80,94.6,58.2,74.4,30.4z    M56.4,13.1c3.9,0,7.4,3.2,8.7,8c-1.5,1.2-2.8,2.5-3.5,3.3c-2.7-1-9.4-1.9-14.4-0.4C47.6,17.9,51.5,13.1,56.4,13.1z M46.7,25.2   c4.4-1.7,11-1,14,0c-1.8,1.3-6.8,4.6-11.8,4.3c-2.4-0.1-3.9-0.7-4.1-1.5C44.6,27.3,45.4,26.1,46.7,25.2z M36.3,37.3   c0.9-3.9,3.6-6.2,6.8-5.8c1.1,0.2,2.2,0.8,2.9,1.9c1,1.5,1.4,3.6,0.9,5.6c-0.6,2.7-2.5,4.3-4.9,4.3c-0.5,0-0.9,0-1.5-0.2   C36.2,42.1,35.8,39.4,36.3,37.3z M32.2,41.6c0.3,0.2,0.5,0.5,0.8,0.7c2.2,2,3.4,4.8,3.5,7.8c0,0.7,0,1.4-0.1,2.1   C33.4,48.9,32,45.3,32.2,41.6z M25.8,61.6c-6.1,0.2-11.3-4.6-11.5-10.8c-0.1-3,1-5.8,3-8c2-2.2,4.8-3.4,7.8-3.5h0.4   c2.1,0,4.1,0.6,5.9,1.7c-0.4,4.4,1.2,8.6,4.9,12.4c-0.5,1.7-1.4,3.3-2.6,4.7C31.5,60.2,28.8,61.5,25.8,61.6z M35.2,78.3   c-3,0-5.5-1-7.2-2.8c-1.2-1.4-1.9-3.1-2-5.1c0.9,0.8,2.8,1.5,4.4,1.3l0.8,3c0.2,0.8,1.1,0.5,1-0.2l-0.7-2.8c0.2,0,0.3-0.1,0.5-0.1   c2.6,1.9,6.1-0.2,6.9-1C37.6,73.6,36.2,76.5,35.2,78.3z M39.7,66.4c-0.6,3.1-4.1,5.9-6.8,4.6c1.3-0.6,2.1-1.7,2.1-2.8   c0-0.9-1.6-3.7-5.5-3.2l-0.8-3c2.1-0.6,3.9-1.7,5.5-3.4c1.2-1.3,2.1-2.9,2.7-4.6c0,0,0.1,0.1,0.1,0.1C40.2,57.5,40.6,62,39.7,66.4z    M53.7,55.3c-2.6,0-4.9-1.5-5.9-2.9c-0.7,1.5-2.6,2.7-4.7,2.7c-1.9,0-4.2-0.9-5.1-3.8c-0.1-0.6,0.8-0.7,1-0.3   c1,2.6,2.9,3.3,4.7,3.1c1.7-0.3,3.5-2.7,3.5-3.5c-0.8-0.1-1.6-1.8-1.4-2.5c0.1-0.4,0.6-0.9,1.9-0.9c1.3,0,1.7,0.6,1.8,0.9   c0.2,0.5-0.2,2.3-1.3,2.5c0,0.8,2.3,3.4,4.9,3.7c1.3,0.1,3.3-0.2,4.2-3.3c0.2-0.7,1.1-0.4,1,0.2C57.8,53.8,56.1,55.3,53.7,55.3z    M64.7,42.3c-0.7,0.6-1.7,0.9-3.1,0.9c-0.6,0-1.3-0.1-2.1-0.1c-2.9-0.5-6.2-1-6.2-4.8c0-3.5,2.9-6.4,6.4-6.4s6.4,2.9,6.4,6.4   C66.1,40.2,65.6,41.5,64.7,42.3z\" />\n        </g>\n      </svg>\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,YAAsC,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IAC/E,qBACE,6bAAC;QAAI,WAAW,CAAC,SAAS,EAAE,WAAW;QAAE,OAAO;YAAE,OAAO;YAAM,QAAQ;QAAK;kBAC1E,cAAA,6bAAC;YACC,OAAM;YACN,SAAQ;YACR,WAAU;YACV,MAAK;sBAEL,cAAA,6bAAC;0BACC,cAAA,6bAAC;oBAAK,GAAE;;;;;;;;;;;;;;;;;;;;;AAKlB","debugId":null}},
    {"offset": {"line": 1768, "column": 0}, "map": {"version":3,"sources":["turbopack:///[next]/internal/font/google/inter_53f63fe4.module.css [app-ssr] (css module)"],"sourcesContent":["__turbopack_context__.v({\n  \"className\": \"inter_53f63fe4-module__E0dXtq__className\",\n});\n"],"names":[],"mappings":"AAAA;AACA;AACA","ignoreList":[0]}},
    {"offset": {"line": 1775, "column": 0}, "map": {"version":3,"sources":["turbopack:///[next]/internal/font/google/inter_53f63fe4.js"],"sourcesContent":["import cssModule from \"@vercel/turbopack-next/internal/font/google/cssmodule.module.css?{%22path%22:%22Header.tsx%22,%22import%22:%22Inter%22,%22arguments%22:[{%22subsets%22:[%22latin%22],%22weight%22:[%22900%22]}],%22variableName%22:%22inter%22}\";\nconst fontData = {\n    className: cssModule.className,\n    style: {\n        fontFamily: \"'Inter', 'Inter Fallback'\",\n        fontWeight: 900,\nfontStyle: \"normal\",\n\n    },\n};\n\nif (cssModule.variable != null) {\n    fontData.variable = cssModule.variable;\n}\n\nexport default fontData;\n"],"names":[],"mappings":";;;;AAAA;;AACA,MAAM,WAAW;IACb,WAAW,gKAAS,CAAC,SAAS;IAC9B,OAAO;QACH,YAAY;QACZ,YAAY;QACpB,WAAW;IAEP;AACJ;AAEA,IAAI,gKAAS,CAAC,QAAQ,IAAI,MAAM;IAC5B,SAAS,QAAQ,GAAG,gKAAS,CAAC,QAAQ;AAC1C;uCAEe","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 1797, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/contexts/ItemTitleContext.tsx"],"sourcesContent":["\"use client\";\nimport { createContext, useContext, useState, ReactNode, Dispatch, SetStateAction } from \"react\";\n\n// Context value type: title, minimal header flag, show title flag and their setters\ninterface ItemTitleContextValue {\n  itemTitle: string | null;\n  setItemTitle: Dispatch<SetStateAction<string | null>>;\n  minimalMobileHeader: boolean;\n  setMinimalMobileHeader: Dispatch<SetStateAction<boolean>>;\n  showTitle: boolean;\n  setShowTitle: Dispatch<SetStateAction<boolean>>;\n}\n\n// Create context with default values\nconst ItemTitleContext = createContext<ItemTitleContextValue>({\n  itemTitle: null,\n  setItemTitle: () => {},\n  minimalMobileHeader: false,\n  setMinimalMobileHeader: () => {},\n  showTitle: false,\n  setShowTitle: () => {},\n});\n\n// Provider component for item title and minimal header\nexport function ItemTitleProvider({ children }: { children: ReactNode }) {\n  const [itemTitle, setItemTitle] = useState<string | null>(null);\n  const [minimalMobileHeader, setMinimalMobileHeader] = useState<boolean>(false);\n  const [showTitle, setShowTitle] = useState<boolean>(false);\n\n  return (\n    <ItemTitleContext.Provider\n      value={{\n        itemTitle,\n        setItemTitle,\n        minimalMobileHeader,\n        setMinimalMobileHeader,\n        showTitle,\n        setShowTitle,\n      }}\n    >\n      {children}\n    </ItemTitleContext.Provider>\n  );\n}\n\n// Hook to use the context (returns all values and setters)\nexport function useItemTitle() {\n  return useContext(ItemTitleContext);\n}\n"],"names":[],"mappings":";;;;;;;AACA;AADA;;;AAaA,qCAAqC;AACrC,MAAM,iCAAmB,IAAA,qaAAa,EAAwB;IAC5D,WAAW;IACX,cAAc,KAAO;IACrB,qBAAqB;IACrB,wBAAwB,KAAO;IAC/B,WAAW;IACX,cAAc,KAAO;AACvB;AAGO,SAAS,kBAAkB,EAAE,QAAQ,EAA2B;IACrE,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,gaAAQ,EAAgB;IAC1D,MAAM,CAAC,qBAAqB,uBAAuB,GAAG,IAAA,gaAAQ,EAAU;IACxE,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,gaAAQ,EAAU;IAEpD,qBACE,6bAAC,iBAAiB,QAAQ;QACxB,OAAO;YACL;YACA;YACA;YACA;YACA;YACA;QACF;kBAEC;;;;;;AAGP;AAGO,SAAS;IACd,OAAO,IAAA,kaAAU,EAAC;AACpB","debugId":null}},
    {"offset": {"line": 1844, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/layout/Header.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { usePathname, useParams } from \"next/navigation\";\nimport { TransferUsageDisplay } from \"../shared/TransferUsageDisplay\";\nimport { ThemeToggle } from \"./header/ThemeToggle\";\nimport { LanguageSwitch } from \"./header/LanguageSwitch\";\nimport { MobileMenu } from \"./header/MobileMenu\";\nimport { NonnaLogo } from \"../icons/NonnaLogo\";\nimport { Inter } from \"next/font/google\";\nimport Link from \"next/link\";\nimport { useItemTitle } from \"@/contexts/ItemTitleContext\";\n\nconst inter = Inter({\n  subsets: [\"latin\"],\n  weight: [\"900\"],\n});\n\n// Remove props for minimal mobile header\n// interface HeaderProps {\n//   minimalMobileHeader?: boolean; // Show minimal header on mobile\n//   itemTitle?: string; // Title to display in minimal header\n//   backHref?: string; // Back link URL\n// }\n\n// Remove props from Header\nexport const Header = () => {\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n  const pathname = usePathname();\n  const isLibraryPage = pathname?.startsWith(\"/library\");\n  const { itemTitle, minimalMobileHeader, showTitle } = useItemTitle();\n  const params = useParams();\n  const source = params?.source as string;\n  const target = params?.target as string;\n  // Compute backHref for detail pages\n  const backHref = source && target ? `/library/${source}/${target}` : \"/library\";\n\n  // If minimalMobileHeader is true, render both headers and use CSS to show/hide\n  if (minimalMobileHeader) {\n    return (\n      <>\n        {/* Mobile Minimal Header (Visible by default, hidden on lg screens) */}\n        <header className=\"relative w-full backdrop-blur-xl transition-colors duration-200 ease-in-out lg:hidden\">\n          <div className=\"container mx-auto\">\n            <div className=\"relative flex h-14 w-full items-center justify-center\">\n              <Link\n                href={backHref}\n                className=\"absolute left-0 flex items-center px-4 text-gray-900 hover:underline focus:outline-none dark:text-white\"\n                aria-label=\"Back\"\n                data-testid=\"back-to-library\"\n              >\n                <svg\n                  className=\"mr-2 size-6\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  strokeWidth={2}\n                  viewBox=\"0 0 24 24\"\n                  aria-hidden=\"true\"\n                >\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M15 19l-7-7 7-7\" />\n                </svg>\n                <span className=\"sr-only\">Back</span>\n              </Link>\n              <span\n                className={`\n                  mx-auto max-w-[65%] overflow-hidden truncate text-ellipsis whitespace-nowrap text-center text-lg font-semibold\n                  transition duration-300 ease-out\n                  ${showTitle ? \"pointer-events-auto translate-y-0 opacity-100\" : \"pointer-events-none -translate-y-2 opacity-0\"}\n                `}\n                title={itemTitle || \"Item\"}\n              >\n                {itemTitle || \"Item\"}\n              </span>\n            </div>\n          </div>\n        </header>\n\n        {/* Desktop Header (Hidden by default, shown on lg screens) */}\n        <header\n          className={`\n            relative hidden w-full backdrop-blur-xl\n            transition-colors duration-200 ease-in-out lg:block\n        `}\n        >\n          <div className=\"container mx-auto px-2\">\n            {/* Use lg:h-16 for desktop height */}\n            <div className=\"relative flex h-14 items-center justify-between lg:h-16\">\n              <div className=\"flex items-center gap-4 lg:gap-8\">\n                <div className=\"flex items-center gap-1.5 lg:gap-2\">\n                  {/* Use lg:size-8 for desktop logo */}\n                  <NonnaLogo className=\"size-6 font-black lg:size-8 dark:text-white\" />\n                  <div className=\"flex items-center gap-1 pt-0.5 lg:gap-2\">\n                    <span\n                      // Keep existing lg:text-xl\n                      className={`${inter.className} text-md font-black uppercase italic leading-none text-gray-900 lg:text-xl dark:text-white`}\n                    >\n                      nonna.fm\n                    </span>\n                    {/* Use lg:inline-block for desktop beta badge */}\n                    <span className=\"hidden rounded bg-indigo-100 px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wider text-indigo-700 lg:inline-block dark:bg-indigo-900/50 dark:text-indigo-300\">\n                      Beta\n                    </span>\n                  </div>\n                </div>\n              </div>\n\n              {/* Desktop Navigation (Hidden by default, shown on lg screens) */}\n              <div className=\"hidden items-center gap-8 lg:flex\">\n                {/* Show TransferUsageDisplay only on library page and desktop */}\n                {isLibraryPage && <TransferUsageDisplay />}\n                <LanguageSwitch />\n                <ThemeToggle />\n              </div>\n\n              {/* Mobile Menu + TransferUsageDisplay (Shown by default, hidden on lg screens) */}\n              {/* Note: This section might be redundant if the minimal header handles mobile menu, review needed */}\n              {/* Keeping it for now, but applying lg:hidden */}\n              <div className=\"flex items-center gap-2 lg:hidden\">\n                {/* Show TransferUsageDisplay only on library page and mobile */}\n                {isLibraryPage && <TransferUsageDisplay />}\n                <MobileMenu onOpenChange={setIsMenuOpen} isOpen={isMenuOpen} />\n              </div>\n            </div>\n          </div>\n        </header>\n      </>\n    );\n  }\n\n  // Default Header (when minimalMobileHeader is false)\n  return (\n    <header\n      className={`\n        relative w-full backdrop-blur-xl\n        transition-colors duration-200 ease-in-out\n      `}\n    >\n      <div className=\"container mx-auto px-2\">\n        {/* Use lg:h-16 for desktop height */}\n        <div className=\"relative flex h-14 items-center justify-between lg:h-16\">\n          {/* Use lg:gap-8 for desktop */}\n          <div className=\"flex items-center gap-4 lg:gap-8\">\n            {/* Use lg:gap-2 for desktop */}\n            <div className=\"flex items-center gap-1.5 lg:gap-2\">\n              {/* Use lg:size-8 for desktop */}\n              <NonnaLogo className=\"size-6 font-black lg:size-8 dark:text-white\" />\n              {/* Use lg:gap-2 for desktop */}\n              <div className=\"flex items-center gap-1 pt-0.5 lg:gap-2\">\n                <span\n                  // Keep existing lg:text-xl\n                  className={`${inter.className} text-md font-black uppercase italic leading-none text-gray-900 lg:text-xl dark:text-white`}\n                >\n                  nonna.fm\n                </span>\n                {/* Use lg:inline-block for desktop */}\n                <span className=\"hidden rounded bg-indigo-100 px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wider text-indigo-700 lg:inline-block dark:bg-indigo-900/50 dark:text-indigo-300\">\n                  Beta\n                </span>\n              </div>\n            </div>\n          </div>\n\n          {/* Desktop Navigation (Hidden by default, shown on lg screens) */}\n          <div className=\"hidden items-center gap-8 lg:flex\">\n            {/* Show TransferUsageDisplay only on library page and desktop */}\n            {isLibraryPage && <TransferUsageDisplay />}\n            <LanguageSwitch />\n            <ThemeToggle />\n          </div>\n\n          {/* Mobile Menu + TransferUsageDisplay (Shown by default, hidden on lg screens) */}\n          <div className=\"flex items-center gap-2 lg:hidden\">\n            {/* Show TransferUsageDisplay only on library page and mobile */}\n            {isLibraryPage && <TransferUsageDisplay />}\n            <MobileMenu onOpenChange={setIsMenuOpen} isOpen={isMenuOpen} />\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2213, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/contexts/LibraryContext.matchingState.ts"],"sourcesContent":["import type { MatchingState } from \"@/types\";\n\nexport const initialMatchingState: MatchingState = {\n  isLoading: false,\n  error: null,\n  progress: {},\n  currentTask: null,\n};\n"],"names":[],"mappings":";;;;AAEO,MAAM,uBAAsC;IACjD,WAAW;IACX,OAAO;IACP,UAAU,CAAC;IACX,aAAa;AACf","debugId":null}},
    {"offset": {"line": 2227, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/contexts/LibraryContext.matchingReducer.ts"],"sourcesContent":["import type { MatchingState, LibraryAction } from \"@/types\";\n\n// Reducer for matching-related state\nexport function matchingReducer(state: MatchingState, action: LibraryAction): MatchingState {\n  switch (action.type) {\n    case \"MATCHING_START\":\n      // Start a new matching task\n      return {\n        ...state,\n        isLoading: true,\n        error: null,\n        currentTask: action.payload,\n      };\n    case \"MATCHING_PROGRESS\":\n      // Update progress for a specific task key\n      return {\n        ...state,\n        progress: {\n          ...state.progress,\n          [action.payload.key]: action.payload.value,\n        },\n      };\n    case \"MATCHING_ERROR\":\n      // Set error and stop loading\n      return {\n        ...state,\n        isLoading: false,\n        error: action.payload,\n        currentTask: null,\n      };\n    case \"MATCHING_COMPLETE\":\n      // Mark task as complete, set progress to 100, stop loading\n      return {\n        ...state,\n        isLoading: false,\n        currentTask: null,\n        progress: {\n          ...state.progress,\n          [action.payload]: 100,\n        },\n      };\n    case \"MATCHING_CANCEL\": {\n      // Compute the key for the cancelled task\n      const key =\n        action.payload.type === \"playlist\" && action.payload.id\n          ? `playlist:${action.payload.id}`\n          : action.payload.type;\n      // Remove the cancelled task's progress entry using destructuring\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { [key]: _removed, ...rest } = state.progress;\n\n      // Only clear isLoading/currentTask if the cancelled task is the current running task\n      const isCurrentTask =\n        state.currentTask &&\n        state.currentTask.type === action.payload.type &&\n        (action.payload.type !== \"playlist\" ||\n          (action.payload.id &&\n            state.currentTask.type === \"playlist\" &&\n            state.currentTask.playlist.id === action.payload.id));\n\n      // If cancelling the current running task, clear isLoading/currentTask\n      // If cancelling a queued task, just remove its progress entry\n      return {\n        ...state,\n        isLoading: isCurrentTask ? false : state.isLoading,\n        currentTask: isCurrentTask ? null : state.currentTask,\n        progress: rest,\n      };\n    }\n    default:\n      return state;\n  }\n}\n"],"names":[],"mappings":";;;;AAGO,SAAS,gBAAgB,KAAoB,EAAE,MAAqB;IACzE,OAAQ,OAAO,IAAI;QACjB,KAAK;YACH,4BAA4B;YAC5B,OAAO;gBACL,GAAG,KAAK;gBACR,WAAW;gBACX,OAAO;gBACP,aAAa,OAAO,OAAO;YAC7B;QACF,KAAK;YACH,0CAA0C;YAC1C,OAAO;gBACL,GAAG,KAAK;gBACR,UAAU;oBACR,GAAG,MAAM,QAAQ;oBACjB,CAAC,OAAO,OAAO,CAAC,GAAG,CAAC,EAAE,OAAO,OAAO,CAAC,KAAK;gBAC5C;YACF;QACF,KAAK;YACH,6BAA6B;YAC7B,OAAO;gBACL,GAAG,KAAK;gBACR,WAAW;gBACX,OAAO,OAAO,OAAO;gBACrB,aAAa;YACf;QACF,KAAK;YACH,2DAA2D;YAC3D,OAAO;gBACL,GAAG,KAAK;gBACR,WAAW;gBACX,aAAa;gBACb,UAAU;oBACR,GAAG,MAAM,QAAQ;oBACjB,CAAC,OAAO,OAAO,CAAC,EAAE;gBACpB;YACF;QACF,KAAK;YAAmB;gBACtB,yCAAyC;gBACzC,MAAM,MACJ,OAAO,OAAO,CAAC,IAAI,KAAK,cAAc,OAAO,OAAO,CAAC,EAAE,GACnD,CAAC,SAAS,EAAE,OAAO,OAAO,CAAC,EAAE,EAAE,GAC/B,OAAO,OAAO,CAAC,IAAI;gBACzB,iEAAiE;gBACjE,6DAA6D;gBAC7D,MAAM,EAAE,CAAC,IAAI,EAAE,QAAQ,EAAE,GAAG,MAAM,GAAG,MAAM,QAAQ;gBAEnD,qFAAqF;gBACrF,MAAM,gBACJ,MAAM,WAAW,IACjB,MAAM,WAAW,CAAC,IAAI,KAAK,OAAO,OAAO,CAAC,IAAI,IAC9C,CAAC,OAAO,OAAO,CAAC,IAAI,KAAK,cACtB,OAAO,OAAO,CAAC,EAAE,IAChB,MAAM,WAAW,CAAC,IAAI,KAAK,cAC3B,MAAM,WAAW,CAAC,QAAQ,CAAC,EAAE,KAAK,OAAO,OAAO,CAAC,EAAE,AAAC;gBAE1D,sEAAsE;gBACtE,8DAA8D;gBAC9D,OAAO;oBACL,GAAG,KAAK;oBACR,WAAW,gBAAgB,QAAQ,MAAM,SAAS;oBAClD,aAAa,gBAAgB,OAAO,MAAM,WAAW;oBACrD,UAAU;gBACZ;YACF;QACA;YACE,OAAO;IACX;AACF","debugId":null}},
    {"offset": {"line": 2295, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/contexts/LibraryContext.tsx"],"sourcesContent":["\"use client\";\n\nimport { createContext, useReducer, useContext, useMemo } from \"react\";\nimport type { LibraryState, LibraryAction, ITrack, IAlbum, IPlaylist } from \"@/types\";\nimport { initialMatchingState } from \"./LibraryContext.matchingState\";\nimport { matchingReducer } from \"./LibraryContext.matchingReducer\";\n\n// Initial state\nconst initialLibraryState: LibraryState = {\n  likedSongs: new Set(),\n  albums: new Set(),\n  playlists: new Map(),\n  selectedItems: {\n    tracks: new Set(),\n    albums: new Set(),\n    playlists: new Set(),\n  },\n  status: {\n    isLoading: false,\n    error: null,\n  },\n  matching: initialMatchingState,\n};\n\n// Context type\ninterface LibraryContextType {\n  state: LibraryState;\n  dispatch: React.Dispatch<LibraryAction>;\n  actions: {\n    // Selection actions\n    selectAllTracks: () => void;\n    deselectAllTracks: () => void;\n    selectPlaylist: (playlistId: string) => void;\n    deselectPlaylist: (playlistId: string) => void;\n    selectAllAlbums: () => void;\n    deselectAllAlbums: () => void;\n    selectAllPlaylists: () => void;\n    deselectAllPlaylists: () => void;\n    resetSelection: () => void;\n\n    // Library data actions\n    setLikedSongs: (songs: Set<ITrack>) => void;\n    setAlbums: (albums: Set<IAlbum>) => void;\n    setPlaylists: (\n      playlists: Map<string, IPlaylist> | ((prev: Map<string, IPlaylist>) => Map<string, IPlaylist>)\n    ) => void;\n    updatePlaylist: (playlist: IPlaylist) => void;\n    updateLibrary: (\n      data: Partial<Pick<LibraryState, \"likedSongs\" | \"albums\" | \"playlists\">>\n    ) => void;\n\n    // Status actions\n    setLoading: (isLoading: boolean) => void;\n    setError: (error: string | null) => void;\n  };\n}\n\n// Create context\nexport const LibraryContext = createContext<LibraryContextType | null>(null);\n\n// Reducer function\nfunction libraryReducer(state: LibraryState, action: LibraryAction): LibraryState {\n  // Delegate matching actions to matchingReducer\n  switch (action.type) {\n    case \"MATCHING_START\":\n    case \"MATCHING_PROGRESS\":\n    case \"MATCHING_ERROR\":\n    case \"MATCHING_COMPLETE\":\n    case \"MATCHING_CANCEL\":\n      return {\n        ...state,\n        matching: matchingReducer(state.matching, action),\n      };\n    // Selection actions\n    case \"SELECT_ALL_TRACKS\":\n      return {\n        ...state,\n        selectedItems: {\n          ...state.selectedItems,\n          tracks: new Set([...(state.likedSongs ?? [])].map(track => track.id)),\n        },\n      };\n    case \"DESELECT_ALL_TRACKS\":\n      return {\n        ...state,\n        selectedItems: { ...state.selectedItems, tracks: new Set() },\n      };\n    case \"SELECT_PLAYLIST\": {\n      const newPlaylists = new Set(state.selectedItems.playlists);\n      newPlaylists.add(action.payload);\n      return {\n        ...state,\n        selectedItems: { ...state.selectedItems, playlists: newPlaylists },\n      };\n    }\n    case \"DESELECT_PLAYLIST\": {\n      const newPlaylists = new Set(state.selectedItems.playlists);\n      newPlaylists.delete(action.payload);\n      return {\n        ...state,\n        selectedItems: { ...state.selectedItems, playlists: newPlaylists },\n      };\n    }\n    case \"SELECT_ALL_ALBUMS\":\n      return {\n        ...state,\n        selectedItems: {\n          ...state.selectedItems,\n          albums: new Set([...(state.albums ?? [])].map(album => album.id)),\n        },\n      };\n    case \"DESELECT_ALL_ALBUMS\":\n      return {\n        ...state,\n        selectedItems: { ...state.selectedItems, albums: new Set() },\n      };\n    case \"SELECT_ALL_PLAYLISTS\":\n      return {\n        ...state,\n        selectedItems: {\n          ...state.selectedItems,\n          playlists: new Set([...(state.playlists?.keys() ?? [])]),\n        },\n      };\n    case \"DESELECT_ALL_PLAYLISTS\":\n      return {\n        ...state,\n        selectedItems: { ...state.selectedItems, playlists: new Set() },\n      };\n    case \"RESET_SELECTION\":\n      return {\n        ...state,\n        selectedItems: {\n          tracks: new Set(),\n          albums: new Set(),\n          playlists: new Set(),\n        },\n      };\n\n    // Library data actions\n    case \"SET_LIKED_SONGS\":\n      return { ...state, likedSongs: action.payload };\n    case \"SET_ALBUMS\":\n      return { ...state, albums: action.payload };\n    case \"SET_PLAYLISTS\":\n      return { ...state, playlists: action.payload };\n    case \"SET_PLAYLISTS_FUNCTIONAL\": {\n      const next = action.payload(state.playlists ?? new Map());\n      return { ...state, playlists: new Map(next) };\n    }\n    case \"UPDATE_PLAYLIST\": {\n      const newPlaylists = new Map(state.playlists);\n      newPlaylists.set(action.payload.id, action.payload);\n      return { ...state, playlists: newPlaylists };\n    }\n    case \"UPDATE_LIBRARY\":\n      return { ...state, ...action.payload };\n\n    // Status actions\n    case \"SET_LOADING\":\n      return { ...state, status: { ...state.status, isLoading: action.payload } };\n    case \"SET_ERROR\":\n      return { ...state, status: { ...state.status, error: action.payload } };\n\n    default:\n      return state;\n  }\n}\n\n// Provider component\nexport function LibraryProvider({ children }: { children: React.ReactNode }) {\n  const [state, dispatch] = useReducer(libraryReducer, initialLibraryState);\n\n  const actions = useMemo(\n    () => ({\n      // Selection actions\n      selectAllTracks: () => dispatch({ type: \"SELECT_ALL_TRACKS\" }),\n      deselectAllTracks: () => dispatch({ type: \"DESELECT_ALL_TRACKS\" }),\n      selectPlaylist: (playlistId: string) =>\n        dispatch({ type: \"SELECT_PLAYLIST\", payload: playlistId }),\n      deselectPlaylist: (playlistId: string) =>\n        dispatch({ type: \"DESELECT_PLAYLIST\", payload: playlistId }),\n      selectAllAlbums: () => dispatch({ type: \"SELECT_ALL_ALBUMS\" }),\n      deselectAllAlbums: () => dispatch({ type: \"DESELECT_ALL_ALBUMS\" }),\n      selectAllPlaylists: () => dispatch({ type: \"SELECT_ALL_PLAYLISTS\" }),\n      deselectAllPlaylists: () => dispatch({ type: \"DESELECT_ALL_PLAYLISTS\" }),\n      resetSelection: () => dispatch({ type: \"RESET_SELECTION\" }),\n\n      // Library data actions\n      setLikedSongs: (songs: Set<ITrack>) => dispatch({ type: \"SET_LIKED_SONGS\", payload: songs }),\n      setAlbums: (albums: Set<IAlbum>) => dispatch({ type: \"SET_ALBUMS\", payload: albums }),\n      setPlaylists: (\n        playlistsOrUpdater:\n          | Map<string, IPlaylist>\n          | ((prev: Map<string, IPlaylist>) => Map<string, IPlaylist>)\n      ) => {\n        if (typeof playlistsOrUpdater === \"function\") {\n          dispatch({ type: \"SET_PLAYLISTS_FUNCTIONAL\", payload: playlistsOrUpdater });\n        } else {\n          dispatch({ type: \"SET_PLAYLISTS\", payload: playlistsOrUpdater });\n        }\n      },\n      updatePlaylist: (playlist: IPlaylist) =>\n        dispatch({ type: \"UPDATE_PLAYLIST\", payload: playlist }),\n      updateLibrary: (data: Partial<Pick<LibraryState, \"likedSongs\" | \"albums\" | \"playlists\">>) =>\n        dispatch({ type: \"UPDATE_LIBRARY\", payload: data }),\n\n      // Status actions\n      setLoading: (isLoading: boolean) => dispatch({ type: \"SET_LOADING\", payload: isLoading }),\n      setError: (error: string | null) => dispatch({ type: \"SET_ERROR\", payload: error }),\n    }),\n    [dispatch]\n  );\n\n  return (\n    <LibraryContext.Provider value={{ state, dispatch, actions }}>\n      {children}\n    </LibraryContext.Provider>\n  );\n}\n\n// Hooks\nexport function useLibrary() {\n  const context = useContext(LibraryContext);\n  if (!context) {\n    throw new Error(\"useLibrary must be used within a LibraryProvider\");\n  }\n  return context;\n}\n\nexport function useLibrarySelection() {\n  const { state, actions } = useLibrary();\n  return {\n    selectedItems: state.selectedItems,\n    ...actions,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2597, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/music-service.ts"],"sourcesContent":["import { z } from \"zod\";\n\nexport const MusicServiceSchema = z.enum([\"spotify\", \"apple\", \"youtube\", \"deezer\"]);\nexport type MusicService = z.infer<typeof MusicServiceSchema>;\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,qBAAqB,mOAAC,CAAC,IAAI,CAAC;IAAC;IAAW;IAAS;IAAW;CAAS","debugId":null}},
    {"offset": {"line": 2613, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/matching-status.ts"],"sourcesContent":["import { z } from \"zod\";\n\n// Matching status values used throughout the app\nexport const MATCHING_STATUS = {\n  PENDING: \"pending\",\n  MATCHED: \"matched\",\n  UNMATCHED: \"unmatched\",\n} as const;\n\n// Zod schema for matching status\nexport const MatchingStatusSchema = z.enum(Object.values(MATCHING_STATUS));\nexport type MatchingStatus = z.infer<typeof MatchingStatusSchema>;\n"],"names":[],"mappings":";;;;;;AAAA;;AAGO,MAAM,kBAAkB;IAC7B,SAAS;IACT,SAAS;IACT,WAAW;AACb;AAGO,MAAM,uBAAuB,mOAAC,CAAC,IAAI,CAAC,OAAO,MAAM,CAAC","debugId":null}},
    {"offset": {"line": 2631, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/track.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { MatchingStatusSchema } from \"./matching-status\";\n\nexport const TrackSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  artist: z.string(),\n  album: z.string().optional(),\n  artwork: z.url().optional(),\n  targetId: z.string().optional(),\n  videoId: z.string().optional(),\n  status: MatchingStatusSchema.optional(),\n  selected: z.boolean().optional(),\n});\nexport type ITrack = z.infer<typeof TrackSchema>;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,cAAc,mOAAC,CAAC,MAAM,CAAC;IAClC,IAAI,mOAAC,CAAC,MAAM;IACZ,MAAM,mOAAC,CAAC,MAAM;IACd,QAAQ,mOAAC,CAAC,MAAM;IAChB,OAAO,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC1B,SAAS,mOAAC,CAAC,GAAG,GAAG,QAAQ;IACzB,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC7B,SAAS,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC5B,QAAQ,yKAAoB,CAAC,QAAQ;IACrC,UAAU,mOAAC,CAAC,OAAO,GAAG,QAAQ;AAChC","debugId":null}},
    {"offset": {"line": 2654, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/album.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { MatchingStatusSchema } from \"./matching-status\";\n\nexport const AlbumSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  artist: z.string(),\n  targetId: z.string().optional(),\n  status: MatchingStatusSchema.optional(),\n  selected: z.boolean().optional(),\n  artwork: z.url().optional(),\n});\nexport type IAlbum = z.infer<typeof AlbumSchema>;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,cAAc,mOAAC,CAAC,MAAM,CAAC;IAClC,IAAI,mOAAC,CAAC,MAAM;IACZ,MAAM,mOAAC,CAAC,MAAM;IACd,QAAQ,mOAAC,CAAC,MAAM;IAChB,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC7B,QAAQ,yKAAoB,CAAC,QAAQ;IACrC,UAAU,mOAAC,CAAC,OAAO,GAAG,QAAQ;IAC9B,SAAS,mOAAC,CAAC,GAAG,GAAG,QAAQ;AAC3B","debugId":null}},
    {"offset": {"line": 2675, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/playlist.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { TrackSchema } from \"./track\";\n\nexport const PlaylistSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  description: z.string().optional(),\n  trackCount: z.number().nullable(),\n  ownerId: z.string(),\n  tracks: z.array(TrackSchema),\n  selected: z.boolean().optional(),\n  artwork: z.url().optional(),\n  targetId: z.string().optional(),\n});\nexport type IPlaylist = z.infer<typeof PlaylistSchema>;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,iBAAiB,mOAAC,CAAC,MAAM,CAAC;IACrC,IAAI,mOAAC,CAAC,MAAM;IACZ,MAAM,mOAAC,CAAC,MAAM;IACd,aAAa,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAChC,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ;IAC/B,SAAS,mOAAC,CAAC,MAAM;IACjB,QAAQ,mOAAC,CAAC,KAAK,CAAC,mJAAW;IAC3B,UAAU,mOAAC,CAAC,OAAO,GAAG,QAAQ;IAC9B,SAAS,mOAAC,CAAC,GAAG,GAAG,QAAQ;IACzB,UAAU,mOAAC,CAAC,MAAM,GAAG,QAAQ;AAC/B","debugId":null}},
    {"offset": {"line": 2698, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/matching.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { TrackSchema } from \"./track\";\nimport { AlbumSchema } from \"./album\";\nimport { PlaylistSchema } from \"./playlist\";\nimport { MusicServiceSchema } from \"./music-service\";\n\nexport interface MatchingState {\n  isLoading: boolean;\n  error: string | null;\n  progress: Record<string, number>;\n  currentTask: QueueTask | null;\n}\n\nexport const QueueTaskSchema = z.discriminatedUnion(\"type\", [\n  z.object({\n    type: z.literal(\"likedSongs\"),\n    tracks: z.array(TrackSchema),\n    targetService: MusicServiceSchema,\n  }),\n  z.object({\n    type: z.literal(\"albums\"),\n    albums: z.array(AlbumSchema),\n    targetService: MusicServiceSchema,\n  }),\n  z.object({\n    type: z.literal(\"playlist\"),\n    playlist: PlaylistSchema,\n    targetService: MusicServiceSchema,\n  }),\n]);\nexport type QueueTask = z.infer<typeof QueueTaskSchema>;\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AASO,MAAM,kBAAkB,mOAAC,CAAC,kBAAkB,CAAC,QAAQ;IAC1D,mOAAC,CAAC,MAAM,CAAC;QACP,MAAM,mOAAC,CAAC,OAAO,CAAC;QAChB,QAAQ,mOAAC,CAAC,KAAK,CAAC,mJAAW;QAC3B,eAAe,qKAAkB;IACnC;IACA,mOAAC,CAAC,MAAM,CAAC;QACP,MAAM,mOAAC,CAAC,OAAO,CAAC;QAChB,QAAQ,mOAAC,CAAC,KAAK,CAAC,mJAAW;QAC3B,eAAe,qKAAkB;IACnC;IACA,mOAAC,CAAC,MAAM,CAAC;QACP,MAAM,mOAAC,CAAC,OAAO,CAAC;QAChB,UAAU,yJAAc;QACxB,eAAe,qKAAkB;IACnC;CACD","debugId":null}},
    {"offset": {"line": 2733, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/library.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { TrackSchema, ITrack } from \"./track\";\nimport { AlbumSchema, IAlbum } from \"./album\";\nimport { PlaylistSchema, IPlaylist } from \"./playlist\";\nimport { MatchingState, QueueTask } from \"./matching\";\nimport { MusicService } from \"./music-service\";\n\nexport const LibraryDataSchema = z.object({\n  likedSongs: z.array(TrackSchema),\n  albums: z.array(AlbumSchema),\n  playlists: z.array(PlaylistSchema),\n});\nexport type ILibraryData = z.infer<typeof LibraryDataSchema>;\n\nexport interface ISelectionState {\n  playlists: Map<string, Set<ITrack>>;\n  likedSongs: Set<ITrack>;\n  albums: Set<IAlbum>;\n}\n\nexport interface LibraryState {\n  // Library Data\n  likedSongs: Set<ITrack> | undefined;\n  albums: Set<IAlbum> | undefined;\n  playlists: Map<string, IPlaylist> | undefined;\n\n  // Selection State\n  selectedItems: {\n    tracks: Set<string>; // Track IDs\n    albums: Set<string>; // Album IDs\n    playlists: Set<string>; // Playlist IDs\n  };\n\n  // UI State\n  status: {\n    isLoading: boolean;\n    error: string | null;\n  };\n\n  matching: MatchingState;\n}\n\nexport type LibraryAction =\n  // Selection Actions\n  | { type: \"SELECT_ALL_TRACKS\" }\n  | { type: \"DESELECT_ALL_TRACKS\" }\n  | { type: \"SELECT_PLAYLIST\"; payload: string }\n  | { type: \"DESELECT_PLAYLIST\"; payload: string }\n  | { type: \"SELECT_ALL_ALBUMS\" }\n  | { type: \"DESELECT_ALL_ALBUMS\" }\n  | { type: \"SELECT_ALL_PLAYLISTS\" }\n  | { type: \"DESELECT_ALL_PLAYLISTS\" }\n  | { type: \"RESET_SELECTION\" }\n\n  // Library Data Actions\n  | { type: \"SET_LIKED_SONGS\"; payload: Set<ITrack> }\n  | { type: \"SET_ALBUMS\"; payload: Set<IAlbum> }\n  | { type: \"SET_PLAYLISTS\"; payload: Map<string, IPlaylist> }\n  | {\n      type: \"SET_PLAYLISTS_FUNCTIONAL\";\n      payload: (prev: Map<string, IPlaylist>) => Map<string, IPlaylist>;\n    }\n  | { type: \"UPDATE_PLAYLIST\"; payload: IPlaylist }\n  | {\n      type: \"UPDATE_LIBRARY\";\n      payload: Partial<Pick<LibraryState, \"likedSongs\" | \"albums\" | \"playlists\">>;\n    }\n\n  // Status Actions\n  | { type: \"SET_LOADING\"; payload: boolean }\n  | { type: \"SET_ERROR\"; payload: string | null }\n\n  // Matching Actions\n  | { type: \"MATCHING_START\"; payload: QueueTask }\n  | { type: \"MATCHING_PROGRESS\"; payload: { key: string; value: number } }\n  | { type: \"MATCHING_ERROR\"; payload: string }\n  | { type: \"MATCHING_COMPLETE\"; payload: string }\n  | { type: \"MATCHING_CANCEL\"; payload: { type: string; id?: string } };\n\nexport interface UseMatchingReturn {\n  isLoading: boolean;\n  error: string | null;\n  matchLikedSongs: (tracks: ITrack[], targetService: MusicService) => Promise<void>;\n  matchAlbums: (albums: IAlbum[], targetService: MusicService) => Promise<void>;\n  matchPlaylistTracks: (playlist: IPlaylist, targetService: MusicService) => Promise<void>;\n  cancelMatching: (type: \"likedSongs\" | \"albums\" | \"playlist\", id?: string) => void;\n  getProgress: (type: \"likedSongs\" | \"albums\" | \"playlist\", id?: string) => number;\n  currentTask: QueueTask | null;\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAIO,MAAM,oBAAoB,mOAAC,CAAC,MAAM,CAAC;IACxC,YAAY,mOAAC,CAAC,KAAK,CAAC,mJAAW;IAC/B,QAAQ,mOAAC,CAAC,KAAK,CAAC,mJAAW;IAC3B,WAAW,mOAAC,CAAC,KAAK,CAAC,yJAAc;AACnC","debugId":null}},
    {"offset": {"line": 2754, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/services.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { TrackSchema, ITrack } from \"./track\";\nimport { AlbumSchema, IAlbum } from \"./album\";\nimport { ILibraryData } from \"./library\";\nimport { MusicService } from \"./music-service\";\n\nexport const SearchResultSchema = z.object({\n  matched: z.number(),\n  unmatched: z.number(),\n  total: z.number(),\n  tracks: z.array(TrackSchema).optional(),\n  albums: z.array(AlbumSchema).optional(),\n});\nexport type SearchResult = z.infer<typeof SearchResultSchema>;\n\nexport const TransferResultSchema = z.object({\n  added: z.number(),\n  failed: z.number(),\n  total: z.number(),\n  playlistId: z.string().nullable(),\n});\nexport type TransferResult = z.infer<typeof TransferResultSchema>;\n\nexport interface IMusicServiceProvider {\n  search: (tracks: Array<ITrack>, onProgress?: (progress: number) => void) => Promise<SearchResult>;\n\n  searchAlbums: (\n    albums: Array<IAlbum>,\n    onProgress?: (progress: number) => void\n  ) => Promise<SearchResult>;\n\n  addTracksToLibrary: (tracks: Array<ITrack>) => Promise<TransferResult>;\n\n  addAlbumsToLibrary: (albums: Set<IAlbum>) => Promise<TransferResult>;\n\n  createPlaylistWithTracks: (\n    name: string,\n    tracks: Array<ITrack>,\n    description?: string\n  ) => Promise<TransferResult>;\n\n  fetchUserLibrary: () => Promise<ILibraryData>;\n\n  fetchPlaylistTracks: (\n    playlistId: string,\n    onProgress?: (tracks: ITrack[], progress: number) => void\n  ) => Promise<ITrack[]>;\n}\n\nexport interface IServiceFactory {\n  getProvider(service: MusicService): IMusicServiceProvider;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAIO,MAAM,qBAAqB,mOAAC,CAAC,MAAM,CAAC;IACzC,SAAS,mOAAC,CAAC,MAAM;IACjB,WAAW,mOAAC,CAAC,MAAM;IACnB,OAAO,mOAAC,CAAC,MAAM;IACf,QAAQ,mOAAC,CAAC,KAAK,CAAC,mJAAW,EAAE,QAAQ;IACrC,QAAQ,mOAAC,CAAC,KAAK,CAAC,mJAAW,EAAE,QAAQ;AACvC;AAGO,MAAM,uBAAuB,mOAAC,CAAC,MAAM,CAAC;IAC3C,OAAO,mOAAC,CAAC,MAAM;IACf,QAAQ,mOAAC,CAAC,MAAM;IAChB,OAAO,mOAAC,CAAC,MAAM;IACf,YAAY,mOAAC,CAAC,MAAM,GAAG,QAAQ;AACjC","debugId":null}},
    {"offset": {"line": 2783, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/types/index.ts"],"sourcesContent":["export * from \"./music-service\";\nexport * from \"./matching\";\nexport * from \"./track\";\nexport * from \"./album\";\nexport * from \"./playlist\";\nexport * from \"./library\";\nexport * from \"./services\";\nexport * from \"./matching-status\";\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","debugId":null}},
    {"offset": {"line": 2810, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/auth/crypto.ts"],"sourcesContent":["import { AES, enc } from \"crypto-js\";\n\nconst ENCRYPTION_KEY_STORAGE = \"encryption_key\";\nconst STATE_STORAGE = \"spotify_auth_state\";\n\n// We'll generate this key on app start and keep it in memory and localStorage\n// This provides a basic level of encryption for the current session\nlet ENCRYPTION_KEY: string;\n\nexport function initializeEncryption(): void {\n  // Try to get existing key from localStorage\n  const storedKey = localStorage.getItem(ENCRYPTION_KEY_STORAGE);\n  if (storedKey) {\n    ENCRYPTION_KEY = storedKey;\n  } else {\n    // Generate new key if none exists\n    ENCRYPTION_KEY = generateRandomString(32);\n    localStorage.setItem(ENCRYPTION_KEY_STORAGE, ENCRYPTION_KEY);\n  }\n}\n\nexport function encrypt(text: string): string {\n  if (!ENCRYPTION_KEY) {\n    throw new Error(\"Encryption not initialized\");\n  }\n  return AES.encrypt(text, ENCRYPTION_KEY).toString();\n}\n\nexport function decrypt(ciphertext: string): string {\n  if (!ENCRYPTION_KEY) {\n    initializeEncryption(); // Try to initialize if not already done\n  }\n  const bytes = AES.decrypt(ciphertext, ENCRYPTION_KEY);\n  return bytes.toString(enc.Utf8);\n}\n\nexport function generateRandomString(length: number): string {\n  const possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n  const values = crypto.getRandomValues(new Uint8Array(length));\n  return values.reduce((acc, x) => acc + possible[x % possible.length], \"\");\n}\n\n// For PKCE\nexport async function generateCodeChallenge(codeVerifier: string): Promise<string> {\n  const encoder = new TextEncoder();\n  const data = encoder.encode(codeVerifier);\n  const digest = await crypto.subtle.digest(\"SHA-256\", data);\n\n  return btoa(String.fromCharCode(...new Uint8Array(digest)))\n    .replace(/=/g, \"\")\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\");\n}\n\nexport function clearEncryption(): void {\n  ENCRYPTION_KEY = \"\";\n  localStorage.removeItem(ENCRYPTION_KEY_STORAGE);\n  localStorage.removeItem(STATE_STORAGE);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEA,MAAM,yBAAyB;AAC/B,MAAM,gBAAgB;AAEtB,8EAA8E;AAC9E,oEAAoE;AACpE,IAAI;AAEG,SAAS;IACd,4CAA4C;IAC5C,MAAM,YAAY,aAAa,OAAO,CAAC;IACvC,IAAI,WAAW;QACb,iBAAiB;IACnB,OAAO;QACL,kCAAkC;QAClC,iBAAiB,qBAAqB;QACtC,aAAa,OAAO,CAAC,wBAAwB;IAC/C;AACF;AAEO,SAAS,QAAQ,IAAY;IAClC,IAAI,CAAC,gBAAgB;QACnB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,qMAAG,CAAC,OAAO,CAAC,MAAM,gBAAgB,QAAQ;AACnD;AAEO,SAAS,QAAQ,UAAkB;IACxC,IAAI,CAAC,gBAAgB;QACnB,wBAAwB,wCAAwC;IAClE;IACA,MAAM,QAAQ,qMAAG,CAAC,OAAO,CAAC,YAAY;IACtC,OAAO,MAAM,QAAQ,CAAC,qMAAG,CAAC,IAAI;AAChC;AAEO,SAAS,qBAAqB,MAAc;IACjD,MAAM,WAAW;IACjB,MAAM,SAAS,OAAO,eAAe,CAAC,IAAI,WAAW;IACrD,OAAO,OAAO,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,QAAQ,CAAC,IAAI,SAAS,MAAM,CAAC,EAAE;AACxE;AAGO,eAAe,sBAAsB,YAAoB;IAC9D,MAAM,UAAU,IAAI;IACpB,MAAM,OAAO,QAAQ,MAAM,CAAC;IAC5B,MAAM,SAAS,MAAM,OAAO,MAAM,CAAC,MAAM,CAAC,WAAW;IAErD,OAAO,KAAK,OAAO,YAAY,IAAI,IAAI,WAAW,UAC/C,OAAO,CAAC,MAAM,IACd,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO;AACpB;AAEO,SAAS;IACd,iBAAiB;IACjB,aAAa,UAAU,CAAC;IACxB,aAAa,UAAU,CAAC;AAC1B","debugId":null}},
    {"offset": {"line": 2875, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/apple/auth.ts"],"sourcesContent":["import { decrypt, initializeEncryption } from \"@/lib/auth/crypto\";\nimport {\n  AUTH_STORAGE_KEYS,\n  AuthData,\n  setAuthData,\n  getAuthData,\n  clearAuthData,\n  setServiceType,\n} from \"@/lib/auth/constants\";\n\ninterface AppleTokenResponse {\n  access_token: string;\n  token_type: string;\n  expires_in: number;\n  refresh_token: string;\n  scope: string;\n}\n\nexport function getAppleMusicAuthData(role: \"source\" | \"target\"): AuthData | null {\n  try {\n    const authData = getAuthData(role);\n    if (!authData || authData.serviceId !== \"apple\") {\n      return null;\n    }\n\n    // Check if the token is expired\n    if (Date.now() >= authData.timestamp + authData.expiresIn * 1000) {\n      clearAuthData(role);\n      return null;\n    }\n\n    return authData;\n  } catch {\n    console.error(\"Error retrieving Apple Music auth data\");\n    return null;\n  }\n}\n\nexport function setAppleMusicAuthData(\n  role: \"source\" | \"target\",\n  data: Omit<AuthData, \"role\" | \"serviceId\">\n): void {\n  try {\n    const authData: AuthData = {\n      ...data,\n      role,\n      serviceId: \"apple\",\n    };\n    setAuthData(role, authData);\n    setServiceType(role, \"apple\");\n  } catch {\n    console.error(\"Error storing Apple Music auth data\");\n  }\n}\n\nexport function clearAppleMusicAuth(role?: \"source\" | \"target\"): void {\n  if (role) {\n    clearAuthData(role);\n  } else {\n    clearAuthData(\"source\");\n    clearAuthData(\"target\");\n  }\n}\n\nexport async function handleAppleCallback(\n  searchParams: string\n): Promise<{ success: boolean; role?: \"source\" | \"target\" }> {\n  console.log(\"Starting Apple callback handling...\");\n\n  // Initialize encryption before handling callback\n  initializeEncryption();\n\n  if (!searchParams) {\n    console.error(\"No search params provided\");\n    return { success: false };\n  }\n\n  const params = new URLSearchParams(searchParams);\n  const code = params.get(\"code\");\n  const receivedState = params.get(\"state\");\n  const error = params.get(\"error\");\n\n  if (error) {\n    console.error(\"Apple auth error occurred\");\n    return { success: false };\n  }\n\n  // Verify state\n  let storedState: { role: \"source\" | \"target\" } | null = null;\n  try {\n    const encryptedState =\n      localStorage.getItem(AUTH_STORAGE_KEYS.SOURCE.STATE) ||\n      localStorage.getItem(AUTH_STORAGE_KEYS.TARGET.STATE);\n    if (encryptedState) {\n      storedState = JSON.parse(decrypt(encryptedState));\n    }\n  } catch (error) {\n    console.error(\"Failed to decrypt stored state:\", error);\n    return { success: false };\n  }\n\n  if (!storedState || !receivedState) {\n    console.error(\"State validation failed\");\n    return { success: false };\n  }\n\n  try {\n    const parsedReceivedState = JSON.parse(receivedState);\n    if (parsedReceivedState.role !== storedState.role) {\n      console.error(\"State role validation failed\");\n      return { success: false };\n    }\n  } catch (error) {\n    console.error(\"Failed to parse received state:\", error);\n    return { success: false };\n  }\n\n  // Get stored code verifier from cookies\n  let codeVerifier: string | null = null;\n  try {\n    const cookies = document.cookie.split(\";\");\n    const verifierCookie = cookies.find(\n      cookie =>\n        cookie.trim().startsWith(AUTH_STORAGE_KEYS.SOURCE.CODE_VERIFIER) ||\n        cookie.trim().startsWith(AUTH_STORAGE_KEYS.TARGET.CODE_VERIFIER)\n    );\n    if (verifierCookie) {\n      codeVerifier = verifierCookie.split(\"=\")[1].trim();\n    }\n  } catch (error) {\n    console.error(\"Failed to get code verifier from cookies:\", error);\n    return { success: false };\n  }\n\n  if (!codeVerifier || !code) {\n    console.error(\"Missing verifier or code\");\n    return { success: false };\n  }\n\n  // Exchange code for token with retry logic\n  let tokenResponse: Response | undefined;\n  let retryCount = 0;\n  const maxRetries = 3;\n  const backoffMs = 1000;\n\n  while (retryCount < maxRetries) {\n    try {\n      tokenResponse = await fetch(\"https://appleid.apple.com/auth/token\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: new URLSearchParams({\n          client_id: process.env.NEXT_PUBLIC_APPLE_CLIENT_ID || \"\",\n          client_secret: process.env.APPLE_CLIENT_SECRET || \"\",\n          grant_type: \"authorization_code\",\n          code,\n          redirect_uri: process.env.NEXT_PUBLIC_APPLE_REDIRECT_URI || \"\",\n          code_verifier: codeVerifier,\n        }),\n      });\n\n      if (tokenResponse.ok) {\n        break;\n      }\n\n      const errorText = await tokenResponse.text();\n      console.warn(`Token exchange attempt ${retryCount + 1} failed:`, {\n        status: tokenResponse.status,\n        statusText: tokenResponse.statusText,\n        error: errorText,\n      });\n\n      // If we get a 400 error, the code might be invalid/expired - no point retrying\n      if (tokenResponse.status === 400) {\n        console.error(\"Token exchange failed with 400 - code might be invalid or expired\");\n        return { success: false };\n      }\n\n      retryCount++;\n      if (retryCount < maxRetries) {\n        console.log(`Retrying in ${backoffMs / 1000} seconds...`);\n        await new Promise(resolve => setTimeout(resolve, backoffMs * retryCount));\n      }\n    } catch (error) {\n      console.error(`Network error during token exchange attempt ${retryCount + 1}:`, error);\n      retryCount++;\n      if (retryCount < maxRetries) {\n        console.log(`Retrying in ${backoffMs / 1000} seconds...`);\n        await new Promise(resolve => setTimeout(resolve, backoffMs * retryCount));\n      } else {\n        console.error(\"Max retries reached for token exchange\");\n        return { success: false };\n      }\n    }\n  }\n\n  if (!tokenResponse || !tokenResponse.ok) {\n    console.error(\"All token exchange attempts failed\");\n    return { success: false };\n  }\n\n  let tokenData: AppleTokenResponse;\n  try {\n    tokenData = await tokenResponse.json();\n  } catch (error) {\n    console.error(\"Failed to parse token response:\", error);\n    return { success: false };\n  }\n\n  // Clear state and verifier\n  clearAuthData(storedState.role);\n\n  // Store auth data\n  try {\n    // Fetch user profile\n    const userProfile = await fetchAppleMusicUserProfile();\n\n    const authData: AuthData = {\n      accessToken: tokenData.access_token,\n      refreshToken: tokenData.refresh_token,\n      expiresIn: tokenData.expires_in,\n      timestamp: Date.now(),\n      userId: userProfile.id,\n      tokenType: tokenData.token_type,\n      role: storedState.role,\n      serviceId: \"apple\",\n    };\n\n    setAuthData(storedState.role, authData);\n    setServiceType(storedState.role, \"apple\");\n    return { success: true, role: storedState.role };\n  } catch (error) {\n    console.error(\"Failed to store auth data:\", error);\n    return { success: false };\n  }\n}\n\nexport async function getAppleAuthData(role: \"source\" | \"target\"): Promise<AuthData | null> {\n  if (typeof window === \"undefined\") return null;\n\n  const authData = getAuthData(role);\n  if (!authData || authData.serviceId !== \"apple\") {\n    return null;\n  }\n\n  // Check if token is expired or will expire in less than 5 minutes\n  const expirationTime = authData.timestamp + authData.expiresIn * 1000;\n  const now = Date.now();\n  const timeToExpiry = expirationTime - now;\n\n  if (timeToExpiry <= 300000 && authData.refreshToken) {\n    // 5 minutes in milliseconds\n    return refreshAppleToken(authData.refreshToken, role);\n  }\n\n  return authData;\n}\n\nexport async function refreshAppleToken(\n  refreshToken: string,\n  role: \"source\" | \"target\"\n): Promise<AuthData | null> {\n  try {\n    const response = await fetch(\"https://appleid.apple.com/auth/token\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n      body: new URLSearchParams({\n        grant_type: \"refresh_token\",\n        refresh_token: refreshToken,\n        client_id: process.env.NEXT_PUBLIC_APPLE_CLIENT_ID || \"\",\n        client_secret: process.env.APPLE_CLIENT_SECRET || \"\",\n      }),\n    });\n\n    if (!response.ok) {\n      console.error(\"Failed to refresh token:\", response.statusText);\n      return null;\n    }\n\n    const tokenData: AppleTokenResponse = await response.json();\n    const authData: AuthData = {\n      accessToken: tokenData.access_token,\n      refreshToken: tokenData.refresh_token || refreshToken, // Use old refresh token if new one is not provided\n      expiresIn: tokenData.expires_in,\n      timestamp: Date.now(),\n      userId: \"\",\n      tokenType: tokenData.token_type,\n      role: role,\n      serviceId: \"apple\",\n    };\n\n    setAuthData(role, authData);\n    return authData;\n  } catch (error) {\n    console.error(\"Error refreshing token:\", error);\n    return null;\n  }\n}\n\nexport function clearAppleAuth(role?: \"source\" | \"target\"): void {\n  if (role) {\n    clearAuthData(role);\n  } else {\n    clearAuthData(\"source\");\n    clearAuthData(\"target\");\n  }\n}\n\nasync function fetchAppleMusicUserProfile(): Promise<{ id: string }> {\n  try {\n    const music = window.MusicKit.getInstance();\n    // Get the current user's info which includes their unique identifier\n    const userInfo = await music.authorize();\n\n    return {\n      id: userInfo, // MusicKit.authorize() returns the user token which serves as a unique identifier\n    };\n  } catch (error) {\n    console.error(\"Error fetching Apple Music user profile:\", error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3177, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/utils/batch-processor.ts"],"sourcesContent":["/**\n * Utility for processing items in batches with consistent error handling and logging\n */\n\nexport interface BatchProcessorOptions<T> {\n  items: T[];\n  batchSize: number;\n  delayBetweenBatches?: number;\n  onBatchStart?: (batchNumber: number, totalBatches: number) => void;\n  onBatchComplete?: (successCount: number, failureCount: number) => void;\n  onError?: (error: Error, batch: T[]) => void;\n}\n\nexport interface BatchProcessorResult {\n  added: number;\n  failed: number;\n  total: number;\n}\n\n/**\n * Generic batch processor that handles common patterns like:\n * - Processing items in batches of a fixed size\n * - Adding delays between batches\n * - Handling API responses\n * - Tracking success/failure counts\n * - Error handling\n */\nexport async function processInBatches<T, R>(\n  processBatch: (batch: T[]) => Promise<R>,\n  options: BatchProcessorOptions<T>\n): Promise<BatchProcessorResult> {\n  const {\n    items,\n    batchSize = 5,\n    delayBetweenBatches = 100,\n    onBatchStart,\n    onBatchComplete,\n    onError = (error, batch) => {\n      throw new Error(`Batch processing error: ${error.message}`, { cause: { error, batch } });\n    },\n  } = options;\n\n  let added = 0;\n  let failed = 0;\n  const totalBatches = Math.ceil(items.length / batchSize);\n\n  for (let i = 0; i < items.length; i += batchSize) {\n    const batchNumber = Math.floor(i / batchSize) + 1;\n    const batch = items.slice(i, i + batchSize);\n\n    try {\n      onBatchStart?.(batchNumber, totalBatches);\n\n      await processBatch(batch);\n      added += batch.length;\n\n      onBatchComplete?.(batch.length, 0);\n    } catch (error) {\n      failed += batch.length;\n      onError?.(error as Error, batch);\n\n      // If error is AbortError, stop processing\n      if (\n        (error instanceof DOMException && error.name === \"AbortError\") ||\n        (error instanceof Error && error.message === \"Aborted\")\n      ) {\n        console.log(\"Batch processing aborted due to AbortError\");\n        break;\n      }\n    }\n\n    // Add delay between batches if not the last batch\n    if (i + batchSize < items.length) {\n      await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));\n    }\n  }\n\n  return {\n    added,\n    failed,\n    total: items.length,\n  };\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;AAyBM,eAAe,iBACpB,YAAwC,EACxC,OAAiC;IAEjC,MAAM,EACJ,KAAK,EACL,YAAY,CAAC,EACb,sBAAsB,GAAG,EACzB,YAAY,EACZ,eAAe,EACf,UAAU,CAAC,OAAO;QAChB,MAAM,IAAI,MAAM,CAAC,wBAAwB,EAAE,MAAM,OAAO,EAAE,EAAE;YAAE,OAAO;gBAAE;gBAAO;YAAM;QAAE;IACxF,CAAC,EACF,GAAG;IAEJ,IAAI,QAAQ;IACZ,IAAI,SAAS;IACb,MAAM,eAAe,KAAK,IAAI,CAAC,MAAM,MAAM,GAAG;IAE9C,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,KAAK,UAAW;QAChD,MAAM,cAAc,KAAK,KAAK,CAAC,IAAI,aAAa;QAChD,MAAM,QAAQ,MAAM,KAAK,CAAC,GAAG,IAAI;QAEjC,IAAI;YACF,eAAe,aAAa;YAE5B,MAAM,aAAa;YACnB,SAAS,MAAM,MAAM;YAErB,kBAAkB,MAAM,MAAM,EAAE;QAClC,EAAE,OAAO,OAAO;YACd,UAAU,MAAM,MAAM;YACtB,UAAU,OAAgB;YAE1B,0CAA0C;YAC1C,IACE,AAAC,iBAAiB,gBAAgB,MAAM,IAAI,KAAK,gBAChD,iBAAiB,SAAS,MAAM,OAAO,KAAK,WAC7C;gBACA,QAAQ,GAAG,CAAC;gBACZ;YACF;QACF;QAEA,kDAAkD;QAClD,IAAI,IAAI,YAAY,MAAM,MAAM,EAAE;YAChC,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;QACnD;IACF;IAEA,OAAO;QACL;QACA;QACA,OAAO,MAAM,MAAM;IACrB;AACF","debugId":null}},
    {"offset": {"line": 3227, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/utils/matching.ts"],"sourcesContent":["import { ITrack, IAlbum } from \"@/types\";\n\n// Types for matching configuration\nexport interface MatchWeights {\n  name: number;\n  artist: number;\n  album?: number;\n}\n\nexport interface MatchThresholds {\n  minimum: number;\n  boost: number;\n}\n\nexport interface MatchScoreDetails {\n  nameScore: number;\n  artistScore: number;\n  albumScore?: number;\n}\n\nexport interface MatchResult {\n  score: number;\n  details: MatchScoreDetails;\n}\n\nexport interface MatchConfig {\n  weights: MatchWeights;\n  thresholds: MatchThresholds;\n}\n\n// Default configurations\nexport const DEFAULT_TRACK_CONFIG: MatchConfig = {\n  weights: {\n    name: 0.45,\n    artist: 0.45,\n    album: 0.1,\n  },\n  thresholds: {\n    minimum: 0.6,\n    boost: 0.7,\n  },\n};\n\nexport const DEFAULT_ALBUM_CONFIG: MatchConfig = {\n  weights: {\n    name: 0.65,\n    artist: 0.35,\n  },\n  thresholds: {\n    minimum: 0.6,\n    boost: 0.85,\n  },\n};\n\n// Helper function to normalize strings for comparison\nexport function normalizeString(str: string): string {\n  const result = str\n    .toLowerCase()\n    .normalize(\"NFKD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // Remove diacritics\n    .replace(/\\s*-\\s*/g, \" \") // Convert all hyphens to spaces\n    .replace(/[.,\\/#!$%\\^&\\*;:{}=_`~()[\\]'\"']/g, \"\") // Remove punctuation\n    .replace(/\\s+/g, \" \") // Normalize spaces\n    .trim();\n\n  return result;\n}\n\n// Helper function to split artist string into array of artists\nexport function splitArtists(artistStr: string): string[] {\n  return artistStr\n    .split(/\\s*(?:,|\\band\\b|&)\\s*/)\n    .map(artist => artist.trim())\n    .filter(Boolean);\n}\n\n// Calculate similarity score between two strings (0-1)\nexport function calculateStringSimilarity(str1: string, str2: string): number {\n  const norm1 = normalizeString(str1);\n  const norm2 = normalizeString(str2);\n\n  // Exact match after normalization\n  if (norm1 === norm2) return 1;\n\n  // Calculate word match ratio\n  const words1 = norm1.split(\" \");\n  const words2 = norm2.split(\" \");\n  const commonWords = words1.filter(word => words2.includes(word));\n  return (2 * commonWords.length) / (words1.length + words2.length);\n}\n\n// Helper to compare artist arrays for better matching\n/**\n * Calculates similarity between two artist strings by splitting them into arrays and checking for overlap.\n * - Returns 1 if any artist in target is present in source (or vice versa).\n * - Otherwise, returns the best string similarity between any pair.\n */\nfunction calculateArtistArraySimilarity(sourceArtist: string, targetArtist: string): number {\n  const sourceArtists = splitArtists(sourceArtist).map(normalizeString);\n  const targetArtists = splitArtists(targetArtist).map(normalizeString);\n\n  // If any target artist is in source artists, consider it a strong match\n  for (const t of targetArtists) {\n    if (sourceArtists.includes(t)) return 1;\n  }\n  // If any source artist is in target artists, also strong match\n  for (const s of sourceArtists) {\n    if (targetArtists.includes(s)) return 1;\n  }\n  // Otherwise, return the best string similarity between any pair\n  let best = 0;\n  for (const s of sourceArtists) {\n    for (const t of targetArtists) {\n      best = Math.max(best, calculateStringSimilarity(s, t));\n    }\n  }\n  return best;\n}\n\n// Calculate match score for a track\nexport async function calculateTrackMatchScore(\n  sourceTrack: ITrack,\n  targetTrack: {\n    name: string;\n    artist: string;\n    album?: string;\n  },\n  config: MatchConfig = DEFAULT_TRACK_CONFIG\n): Promise<MatchResult> {\n  const { weights } = config;\n\n  // Calculate individual scores\n  const nameScore = calculateStringSimilarity(sourceTrack.name, targetTrack.name);\n  const artistScore = calculateStringSimilarity(sourceTrack.artist, targetTrack.artist);\n  const albumScore = targetTrack.album\n    ? calculateStringSimilarity(sourceTrack.album ?? \"\", targetTrack.album)\n    : undefined;\n\n  // Calculate total score\n  let totalScore = nameScore * weights.name + artistScore * weights.artist;\n  if (weights.album && albumScore !== undefined) {\n    totalScore += albumScore * weights.album;\n  }\n\n  // If we have a YouTube video ID and the score is low, try additional matching strategies\n  if (!!sourceTrack.videoId && totalScore < 0.5) {\n    // First try: Compare source name against combined target name + artist\n    const combinedTargetTitle = `${targetTrack.name} ${targetTrack.artist}`;\n    const combinedNameScore = calculateStringSimilarity(sourceTrack.name, combinedTargetTitle);\n\n    // If the combined score is significantly better, use it\n    if (combinedNameScore > totalScore + 0.2) {\n      console.log(`[MATCHING] Improved score using combined name+artist: ${combinedNameScore}`);\n      return {\n        score: combinedNameScore,\n        details: {\n          nameScore: combinedNameScore,\n          artistScore: 1, // We consider artist matched since it was part of the combined match\n          ...(albumScore !== undefined && { albumScore }),\n        },\n      };\n    }\n  }\n\n  return {\n    score: totalScore,\n    details: {\n      nameScore,\n      artistScore,\n      ...(albumScore !== undefined && { albumScore }),\n    },\n  };\n}\n\n// Calculate match score for an album\nexport function calculateAlbumMatchScore(\n  sourceAlbum: IAlbum,\n  targetAlbum: {\n    name: string;\n    artist: string;\n  },\n  config: MatchConfig = DEFAULT_ALBUM_CONFIG\n): MatchResult {\n  const { weights } = config;\n\n  const nameScore = calculateStringSimilarity(sourceAlbum.name, targetAlbum.name);\n  // Use improved artist similarity\n  let artistScore = calculateArtistArraySimilarity(sourceAlbum.artist, targetAlbum.artist);\n\n  // Special handling for OSTs with Multi-artists\n  const isOst =\n    sourceAlbum.name.toLowerCase().includes(\"music from\") ||\n    targetAlbum.name.toLowerCase().includes(\"music from\") ||\n    sourceAlbum.name.toLowerCase().includes(\"motion picture\") ||\n    targetAlbum.name.toLowerCase().includes(\"motion picture\");\n\n  if (isOst) {\n    const isMultiArtist =\n      sourceAlbum.artist.toLowerCase().startsWith(\"multi\") ||\n      targetAlbum.artist.toLowerCase().startsWith(\"multi\") ||\n      sourceAlbum.artist.toLowerCase().startsWith(\"various\") ||\n      targetAlbum.artist.toLowerCase().startsWith(\"various\");\n\n    if (isMultiArtist) {\n      artistScore = Math.max(artistScore, 0.9);\n    }\n  }\n\n  const totalScore = nameScore * weights.name + artistScore * weights.artist;\n\n  return {\n    score: totalScore,\n    details: {\n      nameScore,\n      artistScore,\n    },\n  };\n}\n\n// Helper function to clean search terms for better music service search results\nexport function cleanSearchTerm(str: string): string {\n  return str\n    .normalize(\"NFKD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\") // Remove diacritics\n    .replace(/\\s*-\\s*/g, \" \") // Convert all hyphens to spaces\n    .replace(/[.,\\/#!$%\\^&\\*;:{}=_`~()[\\]'\"']/g, \"\") // Remove punctuation\n    .replace(/\\s+/g, \" \") // Normalize spaces\n    .trim();\n}\n\n// Clean up a track title for better cross-service matching.\nexport function cleanTrackTitle(title: string): string {\n  return (\n    title\n      // Remove all content in square brackets, parentheses, or curly braces\n      .replace(/[\\[\\(\\{][^\\]\\)\\}]*[\\]\\)\\}]/g, \"\")\n      // Remove featuring artist indicators\n      .replace(/\\s*\\(feat\\..*?\\)/gi, \"\")\n      .replace(/\\s*\\(ft\\..*?\\)/gi, \"\")\n      .replace(/\\s+ft\\..*$/gi, \"\")\n      .replace(/\\s+feat\\..*$/gi, \"\")\n      .replace(/\\s+ft\\s+.*$/gi, \"\")\n      .replace(/\\s+feat\\s+.*$/gi, \"\")\n      // Remove (Single)\n      .replace(/\\s*\\(single\\)\\s*/gi, \" \")\n      // Remove remix, edit, version, acoustic, instrumental, bonus, cover tags\n      .replace(/\\s*\\((remix|edit|version|acoustic|instrumental|bonus track|cover)\\)/gi, \"\")\n      .replace(/\\s*-?\\s*(remix|edit|version|acoustic|instrumental|bonus track|cover)\\b/gi, \"\")\n      // Remove trailing/leading dashes\n      .replace(/\\s*-\\s*$/, \"\")\n      .replace(/^\\s*-\\s*/, \"\")\n      // Normalize spaces\n      .replace(/\\s+/g, \" \")\n      .trim()\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3579, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/utils/sentry-logger.ts"],"sourcesContent":["import * as Sentry from \"@sentry/nextjs\";\n\n// Check if Sentry is properly configured\nconst isSentryConfigured = (): boolean => {\n  return !!process.env.NEXT_PUBLIC_SENTRY_DSN;\n};\n\n/**\n * Centralized Sentry logging utility with fallback to console\n * Provides consistent error capture throughout the application\n */\nexport const sentryLogger = {\n  /**\n   * Log warning messages to Sentry and console\n   */\n  warn: (message: string, extra?: Record<string, unknown>) => {\n    if (isSentryConfigured()) {\n      Sentry.addBreadcrumb({\n        message,\n        level: \"warning\",\n        data: extra,\n      });\n    }\n\n    // Always log to console in development\n    if (process.env.NODE_ENV !== \"production\") {\n      console.warn(\"[Sentry][warn]\", message, extra);\n    }\n  },\n\n  /**\n   * Log error messages to Sentry and console\n   */\n  error: (error: Error | string, extra?: Record<string, unknown>) => {\n    if (isSentryConfigured()) {\n      if (error instanceof Error) {\n        Sentry.captureException(error, { extra });\n      } else {\n        Sentry.captureMessage(error, \"error\");\n        Sentry.addBreadcrumb({\n          message: error,\n          level: \"error\",\n          data: extra,\n        });\n      }\n    }\n\n    // Always log to console in development or if Sentry fails\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"[Sentry][error]\", error, extra);\n    }\n  },\n\n  /**\n   * Capture matching errors with proper context and tags\n   */\n  captureMatchingError: (\n    operation: \"track_search\" | \"album_search\",\n    targetService: string,\n    error: unknown,\n    extra?: Record<string, unknown>\n  ) => {\n    if (isSentryConfigured()) {\n      try {\n        Sentry.captureException(error, {\n          tags: {\n            category: \"matching\",\n            operation,\n            targetService,\n          },\n          extra: {\n            operation,\n            targetService,\n            ...extra,\n          },\n          level: \"error\",\n        });\n      } catch (sentryError) {\n        // If Sentry fails, at least log to console\n        console.error(\"[Sentry Error - fallback to console]\", {\n          originalError: error,\n          sentryError,\n          operation,\n          targetService,\n          extra,\n        });\n      }\n    } else {\n      // Log to console when Sentry is not configured\n      console.error(`[${operation}] Error in ${targetService}:`, error, extra);\n    }\n  },\n\n  /**\n   * Capture general exceptions with context\n   */\n  captureException: (\n    error: Error | unknown,\n    context?: {\n      tags?: Record<string, string>;\n      extra?: Record<string, unknown>;\n      level?: \"fatal\" | \"error\" | \"warning\" | \"info\" | \"debug\";\n    }\n  ) => {\n    if (isSentryConfigured()) {\n      try {\n        Sentry.captureException(error, {\n          tags: context?.tags,\n          extra: context?.extra,\n          level: context?.level || \"error\",\n        });\n      } catch (sentryError) {\n        console.error(\"[Sentry Error - fallback to console]\", {\n          originalError: error,\n          sentryError,\n          context,\n        });\n      }\n    } else {\n      console.error(\"[Exception]\", error, context);\n    }\n  },\n\n  /**\n   * Add breadcrumb for debugging context\n   */\n  addBreadcrumb: (message: string, data?: Record<string, unknown>) => {\n    if (isSentryConfigured()) {\n      Sentry.addBreadcrumb({\n        message,\n        data,\n        level: \"info\",\n        timestamp: Date.now() / 1000,\n      });\n    }\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;;AAEA,yCAAyC;AACzC,MAAM,qBAAqB;IACzB,OAAO,CAAC;AACV;AAMO,MAAM,eAAe;IAC1B;;GAEC,GACD,MAAM,CAAC,SAAiB;QACtB,IAAI,sBAAsB;YACxB,6XAAoB,CAAC;gBACnB;gBACA,OAAO;gBACP,MAAM;YACR;QACF;QAEA,uCAAuC;QACvC,wCAA2C;YACzC,QAAQ,IAAI,CAAC,kBAAkB,SAAS;QAC1C;IACF;IAEA;;GAEC,GACD,OAAO,CAAC,OAAuB;QAC7B,IAAI,sBAAsB;YACxB,IAAI,iBAAiB,OAAO;gBAC1B,gYAAuB,CAAC,OAAO;oBAAE;gBAAM;YACzC,OAAO;gBACL,8XAAqB,CAAC,OAAO;gBAC7B,6XAAoB,CAAC;oBACnB,SAAS;oBACT,OAAO;oBACP,MAAM;gBACR;YACF;QACF;QAEA,0DAA0D;QAC1D,wCAA2C;YACzC,QAAQ,KAAK,CAAC,mBAAmB,OAAO;QAC1C;IACF;IAEA;;GAEC,GACD,sBAAsB,CACpB,WACA,eACA,OACA;QAEA,IAAI,sBAAsB;YACxB,IAAI;gBACF,gYAAuB,CAAC,OAAO;oBAC7B,MAAM;wBACJ,UAAU;wBACV;wBACA;oBACF;oBACA,OAAO;wBACL;wBACA;wBACA,GAAG,KAAK;oBACV;oBACA,OAAO;gBACT;YACF,EAAE,OAAO,aAAa;gBACpB,2CAA2C;gBAC3C,QAAQ,KAAK,CAAC,wCAAwC;oBACpD,eAAe;oBACf;oBACA;oBACA;oBACA;gBACF;YACF;QACF;;IAIF;IAEA;;GAEC,GACD,kBAAkB,CAChB,OACA;QAMA,IAAI,sBAAsB;YACxB,IAAI;gBACF,gYAAuB,CAAC,OAAO;oBAC7B,MAAM,SAAS;oBACf,OAAO,SAAS;oBAChB,OAAO,SAAS,SAAS;gBAC3B;YACF,EAAE,OAAO,aAAa;gBACpB,QAAQ,KAAK,CAAC,wCAAwC;oBACpD,eAAe;oBACf;oBACA;gBACF;YACF;QACF;;IAGF;IAEA;;GAEC,GACD,eAAe,CAAC,SAAiB;QAC/B,IAAI,sBAAsB;YACxB,6XAAoB,CAAC;gBACnB;gBACA;gBACA,OAAO;gBACP,WAAW,KAAK,GAAG,KAAK;YAC1B;QACF;IACF;AACF","debugId":null}},
    {"offset": {"line": 3695, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/utils/retry.ts"],"sourcesContent":["import { sentryLogger } from \"./sentry-logger\";\n\n/**\n * Configuration options for retry behavior\n */\nexport interface RetryOptions {\n  /** Maximum number of retry attempts */\n  maxRetries?: number;\n  /** Initial delay between retries in milliseconds */\n  initialRetryDelay?: number;\n  /** Maximum delay between retries in milliseconds */\n  maxRetryDelay?: number;\n  /** Factor to add jitter to delay (0-1) */\n  jitterFactor?: number;\n  /** Additional status codes to retry (beyond the defaults) */\n  additionalRetryStatusCodes?: number[];\n  /** Allow handling of 404s as empty content for specific paths */\n  treat404AsEmpty?: boolean;\n}\n\n/**\n * Default retry configuration values\n */\nconst DEFAULT_RETRY_OPTIONS: Required<RetryOptions> = {\n  maxRetries: 5,\n  initialRetryDelay: 1000, // 1 second\n  maxRetryDelay: 64000, // 64 seconds\n  jitterFactor: 0.1, // 10% jitter\n  additionalRetryStatusCodes: [],\n  treat404AsEmpty: false,\n};\n\n/**\n * Adds jitter to a delay value to prevent thundering herd problems\n */\nfunction addJitter(delay: number, factor: number): number {\n  const jitter = delay * factor;\n  return delay + (Math.random() * 2 - 1) * jitter;\n}\n\n/**\n * Type definition for YouTube API error object\n */\ninterface YouTubeErrorObject {\n  domain: string;\n  reason: string;\n  message?: string;\n}\n\n/**\n * Utility function to retry a fetch request with exponential backoff\n * Handles rate limiting (429) and other retryable errors\n * Uses Sentry logger for all logging operations\n *\n * @param fetchFn - Function that returns a Promise<Response>\n * @param options - Retry configuration options\n * @returns Promise<T> - The response data of type T\n */\nexport async function retryWithExponentialBackoff<T>(\n  fetchFn: () => Promise<Response>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const {\n    maxRetries = DEFAULT_RETRY_OPTIONS.maxRetries,\n    initialRetryDelay = DEFAULT_RETRY_OPTIONS.initialRetryDelay,\n    maxRetryDelay = DEFAULT_RETRY_OPTIONS.maxRetryDelay,\n    jitterFactor = DEFAULT_RETRY_OPTIONS.jitterFactor,\n    additionalRetryStatusCodes = DEFAULT_RETRY_OPTIONS.additionalRetryStatusCodes,\n    treat404AsEmpty = DEFAULT_RETRY_OPTIONS.treat404AsEmpty,\n  } = options;\n\n  let attempt = 0;\n  let delay = initialRetryDelay;\n\n  // Default status codes that should be retried (4xx/5xx excluding specific ones below)\n  const retryableStatusCodes = new Set([\n    408,\n    409,\n    425,\n    429,\n    500,\n    502,\n    503,\n    504,\n    ...additionalRetryStatusCodes,\n  ]);\n  // Status codes that should never be retried\n  const nonRetryableStatusCodes = new Set([401, 403, 404]);\n\n  while (attempt < maxRetries) {\n    try {\n      const response = await fetchFn();\n\n      // If the response is ok, parse and return the data\n      if (response.ok) {\n        if (response.status === 204) {\n          return {} as T;\n        }\n        // Handle both JSON and text responses\n        const contentType = response.headers.get(\"content-type\");\n        if (contentType && contentType.includes(\"application/json\")) {\n          return await response.json();\n        }\n        return (await response.text()) as T;\n      }\n\n      // If we get a 429, use the Retry-After header if available\n      if (response.status === 429) {\n        const retryAfter = response.headers.get(\"Retry-After\");\n        if (retryAfter) {\n          delay = parseInt(retryAfter, 10) * 1000; // Convert to milliseconds\n        }\n      }\n\n      // If it's a 409 (often used for YouTube's SERVICE_UNAVAILABLE), check error contents\n      if (response.status === 409) {\n        try {\n          const contentType = response.headers.get(\"content-type\");\n          if (contentType && contentType.includes(\"application/json\")) {\n            // Clone the response to read it twice (once here, once for the content)\n            const clonedResponse = response.clone();\n            const errorData = await clonedResponse.json();\n\n            // Check if it's a YouTube SERVICE_UNAVAILABLE error\n            const isYouTubeServiceUnavailable = errorData?.error?.errors?.some(\n              (e: YouTubeErrorObject) => e.reason === \"SERVICE_UNAVAILABLE\"\n            );\n\n            if (isYouTubeServiceUnavailable) {\n              sentryLogger.warn(\"YouTube SERVICE_UNAVAILABLE detected, retrying...\");\n\n              // Log the retry attempt\n              sentryLogger.warn(`API request failed (attempt ${attempt + 1}/${maxRetries})`, {\n                status: response.status,\n                statusText: response.statusText,\n                reason: \"SERVICE_UNAVAILABLE\",\n                retryIn: delay,\n              });\n\n              // Wait before retrying\n              await new Promise(resolve => setTimeout(resolve, addJitter(delay, jitterFactor)));\n\n              // Exponential backoff for next attempt\n              delay = Math.min(delay * 2, maxRetryDelay);\n              attempt++;\n              continue;\n            }\n          }\n        } catch (e) {\n          // If we couldn't parse the error JSON, just continue with normal error handling\n          sentryLogger.warn(\"Could not parse response JSON for 409 error\", { error: e });\n        }\n      }\n\n      // For errors that we don't want to retry, throw immediately\n      if (nonRetryableStatusCodes.has(response.status)) {\n        // Special handling for 404 responses that should be treated as empty\n        if (response.status === 404 && treat404AsEmpty) {\n          return { data: [] } as T;\n        }\n        const error = new Error(\n          `Request failed with status ${response.status}: ${response.statusText}`\n        );\n        sentryLogger.captureException(error, {\n          tags: {\n            category: \"api\",\n            statusCode: response.status.toString(),\n            retryable: \"false\",\n          },\n          extra: {\n            status: response.status,\n            statusText: response.statusText,\n          },\n        });\n        throw error;\n      }\n\n      // For errors with status codes that should be retried\n      if (retryableStatusCodes.has(response.status)) {\n        // Log the retry attempt\n        sentryLogger.warn(`API request failed (attempt ${attempt + 1}/${maxRetries})`, {\n          status: response.status,\n          statusText: response.statusText,\n          retryIn: delay,\n        });\n\n        // Wait before retrying\n        await new Promise(resolve => setTimeout(resolve, addJitter(delay, jitterFactor)));\n\n        // Exponential backoff for next attempt\n        delay = Math.min(delay * 2, maxRetryDelay);\n        attempt++;\n        continue;\n      }\n\n      // For any other status code, throw an error\n      throw new Error(`Request failed with status ${response.status}: ${response.statusText}`);\n    } catch (error) {\n      // Check if this is an error we explicitly threw for non-retryable status codes\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      const isNonRetryableStatusCode = Array.from(nonRetryableStatusCodes).some(code =>\n        errorMessage.includes(`Request failed with status ${code}`)\n      );\n\n      // Don't retry if it's a non-retryable status code\n      if (isNonRetryableStatusCode) {\n        sentryLogger.captureException(error);\n        throw error;\n      }\n\n      // If it's the last attempt, throw the error\n      if (attempt === maxRetries - 1) {\n        sentryLogger.captureException(error, {\n          tags: {\n            category: \"api\",\n            finalAttempt: \"true\",\n          },\n          extra: {\n            attempt: attempt + 1,\n            maxRetries,\n          },\n        });\n        throw error;\n      }\n\n      sentryLogger.warn(`API request error (attempt ${attempt + 1}/${maxRetries})`, {\n        error: error instanceof Error ? error.message : String(error),\n        attempt: attempt + 1,\n        maxRetries,\n      } as Record<string, unknown>);\n      await new Promise(resolve => setTimeout(resolve, addJitter(delay, jitterFactor)));\n      delay = Math.min(delay * 2, maxRetryDelay);\n      attempt++;\n    }\n  }\n\n  throw new Error(`Failed after ${maxRetries} retries`);\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3873, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/SpotifyLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface SpotifyLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const SpotifyLogo: React.FC<SpotifyLogoProps> = ({ className = \"\", size = 24 }) => {\n  return (\n    <svg\n      viewBox=\"0 0 256 256\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      preserveAspectRatio=\"xMidYMid\"\n      className={className}\n    >\n      <path\n        d=\"M128 0C57.308 0 0 57.309 0 128c0 70.696 57.309 128 128 128 70.697 0 128-57.304 128-128C256 57.314 198.697.007 127.998.007l.001-.006Zm58.699 184.614c-2.293 3.76-7.215 4.952-10.975 2.644-30.053-18.357-67.885-22.515-112.44-12.335a7.981 7.981 0 0 1-9.552-6.007 7.968 7.968 0 0 1 6-9.553c48.76-11.14 90.583-6.344 124.323 14.276 3.76 2.308 4.952 7.215 2.644 10.975Zm15.667-34.853c-2.89 4.695-9.034 6.178-13.726 3.289-34.406-21.148-86.853-27.273-127.548-14.92-5.278 1.594-10.852-1.38-12.454-6.649-1.59-5.278 1.386-10.842 6.655-12.446 46.485-14.106 104.275-7.273 143.787 17.007 4.692 2.89 6.175 9.034 3.286 13.72v-.001Zm1.345-36.293C162.457 88.964 94.394 86.71 55.007 98.666c-6.325 1.918-13.014-1.653-14.93-7.978-1.917-6.328 1.65-13.012 7.98-14.935C93.27 62.027 168.434 64.68 215.929 92.876c5.702 3.376 7.566 10.724 4.188 16.405-3.362 5.69-10.73 7.565-16.4 4.187h-.006Z\"\n        fill=\"#1ED760\"\n      />\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,cAA0C,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IACnF,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,qBAAoB;QACpB,WAAW;kBAEX,cAAA,6bAAC;YACC,GAAE;YACF,MAAK;;;;;;;;;;;AAIb","debugId":null}},
    {"offset": {"line": 3905, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/YouTubeMusicLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface YouTubeMusicLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const YouTubeMusicLogo: React.FC<YouTubeMusicLogoProps> = ({\n  className = \"\",\n  size = 24,\n}) => {\n  return (\n    <svg\n      viewBox=\"0 0 176 176\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className={className}\n    >\n      <g>\n        <circle fill=\"#FF0000\" cx=\"88\" cy=\"88\" r=\"88\" />\n        <path\n          fill=\"#FFFFFF\"\n          d=\"M88,46c23.1,0,42,18.8,42,42s-18.8,42-42,42s-42-18.8-42-42S64.9,46,88,46 M88,42 c-25.4,0-46,20.6-46,46s20.6,46,46,46s46-20.6,46-46S113.4,42,88,42L88,42z\"\n        />\n        <polygon fill=\"#FFFFFF\" points=\"72,111 111,87 72,65\" />\n      </g>\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,mBAAoD,CAAC,EAChE,YAAY,EAAE,EACd,OAAO,EAAE,EACV;IACC,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,WAAW;kBAEX,cAAA,6bAAC;;8BACC,6bAAC;oBAAO,MAAK;oBAAU,IAAG;oBAAK,IAAG;oBAAK,GAAE;;;;;;8BACzC,6bAAC;oBACC,MAAK;oBACL,GAAE;;;;;;8BAEJ,6bAAC;oBAAQ,MAAK;oBAAU,QAAO;;;;;;;;;;;;;;;;;AAIvC","debugId":null}},
    {"offset": {"line": 3962, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/DeezerLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface DeezerLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const DeezerLogo: React.FC<DeezerLogoProps> = ({ className = \"\", size = 24 }) => {\n  return (\n    <svg\n      viewBox=\"0 0 1433 1431\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      preserveAspectRatio=\"xMidYMid\"\n      className={className}\n    >\n      <path\n        fillRule=\"evenodd\"\n        fill=\"#A238FF\"\n        d=\"m1201.8 218.3c13.2-76.7 32.7-125 54.2-125.1h0.1c40.2 0.2 72.7 167.5 72.7 374.1 0 206.7-32.6 374.1-72.8 374.1-16.5 0-31.7-28.4-44-76.1-19.3 174.5-59.5 294.4-106 294.4-36 0-68.3-72-90-185.6-14.8 216-52.1 369.3-95.6 369.3-27.3 0-52.3-60.7-70.7-159.6-22.2 204.1-73.5 347.2-133.2 347.2-59.8 0-111.1-143-133.2-347.2-18.3 98.9-43.3 159.6-70.7 159.6-43.6 0-80.8-153.3-95.6-369.3-21.7 113.6-53.9 185.6-90 185.6-46.5 0-86.7-119.9-106.1-294.4-12.1 47.8-27.4 76.1-43.9 76.1-40.3 0-72.9-167.4-72.9-374.1 0-206.6 32.6-374.1 72.9-374.1 21.6 0 40.9 48.4 54.3 125.1 21.4-132.3 56.3-218.3 95.7-218.3 46.8 0 87.3 121.6 106.5 298.2 18.8-128.5 47.2-210.4 79.1-210.4 44.7 0 82.7 161.1 96.8 385.9 26.4-115.2 64.8-187.5 107.2-187.5 42.4 0 80.7 72.3 107.1 187.5 14.1-224.8 52.1-385.9 96.8-385.9 31.8 0 60.2 81.9 79.1 210.4 19.1-176.6 59.7-298.2 106.5-298.2 39.2 0 74.2 86 95.7 218.3zm-1160.5 379.5c-22.8 0-41.3-74.8-41.3-167.3 0-92.5 18.5-167.2 41.3-167.2 22.9 0 41.4 74.7 41.4 167.2 0 92.5-18.5 167.3-41.4 167.3zm1350.3 0c-22.9 0-41.3-74.8-41.3-167.3 0-92.5 18.4-167.2 41.3-167.2 22.8 0 41.3 74.7 41.3 167.2 0 92.5-18.5 167.3-41.3 167.3z\"\n      />\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,aAAwC,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IACjF,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,qBAAoB;QACpB,WAAW;kBAEX,cAAA,6bAAC;YACC,UAAS;YACT,MAAK;YACL,GAAE;;;;;;;;;;;AAIV","debugId":null}},
    {"offset": {"line": 3995, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/AppleMusicLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface AppleMusicLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const AppleMusicLogo: React.FC<AppleMusicLogoProps> = ({ className = \"\", size = 24 }) => {\n  return (\n    <svg\n      viewBox=\"0 0 361 361\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      preserveAspectRatio=\"xMidYMid\"\n      className={className}\n    >\n      <linearGradient\n        id=\"apple-music-gradient\"\n        x1=\"180\"\n        x2=\"180\"\n        y1=\"358.605\"\n        y2=\"7.759\"\n        gradientUnits=\"userSpaceOnUse\"\n      >\n        <stop offset=\"0\" style={{ stopColor: \"#fa233b\" }} />\n        <stop offset=\"1\" style={{ stopColor: \"#fb5c74\" }} />\n      </linearGradient>\n      <path\n        d=\"M360 112.61c0-4.3 0-8.6-.02-12.9-.02-3.62-.06-7.24-.16-10.86-.21-7.89-.68-15.84-2.08-23.64-1.42-7.92-3.75-15.29-7.41-22.49a75.633 75.633 0 0 0-33.06-33.05c-7.19-3.66-14.56-5.98-22.47-7.41C287 .86 279.04.39 271.15.18c-3.62-.1-7.24-.14-10.86-.16-4.3-.02-8.6-.02-12.9-.02H112.61c-4.3 0-8.6 0-12.9.02-3.62.02-7.24.06-10.86.16C80.96.4 73 .86 65.2 2.27c-7.92 1.42-15.28 3.75-22.47 7.41A75.633 75.633 0 0 0 9.67 42.73c-3.66 7.2-5.99 14.57-7.41 22.49C.86 73.02.39 80.98.18 88.86.08 92.48.04 96.1.02 99.72 0 104.01 0 108.31 0 112.61v134.77c0 4.3 0 8.6.02 12.9.02 3.62.06 7.24.16 10.86.21 7.89.68 15.84 2.08 23.64 1.42 7.92 3.75 15.29 7.41 22.49a75.633 75.633 0 0 0 33.06 33.05c7.19 3.66 14.56 5.98 22.47 7.41 7.8 1.4 15.76 1.87 23.65 2.08 3.62.1 7.24.14 10.86.16 4.3.03 8.6.02 12.9.02h134.77c4.3 0 8.6 0 12.9-.02 3.62-.02 7.24-.06 10.86-.16 7.89-.21 15.85-.68 23.65-2.08 7.92-1.42 15.28-3.75 22.47-7.41a75.633 75.633 0 0 0 33.06-33.05c3.66-7.2 5.99-14.57 7.41-22.49 1.4-7.8 1.87-15.76 2.08-23.64.1-3.62.14-7.24.16-10.86.03-4.3.02-8.6.02-12.9V112.61z\"\n        fill=\"url(#apple-music-gradient)\"\n      />\n      <path\n        d=\"M254.5 55c-.87.08-8.6 1.45-9.53 1.64l-107 21.59-.04.01c-2.79.59-4.98 1.58-6.67 3-2.04 1.71-3.17 4.13-3.6 6.95-.09.6-.24 1.82-.24 3.62v133.92c0 3.13-.25 6.17-2.37 8.76s-4.74 3.37-7.81 3.99l-6.99 1.41c-8.84 1.78-14.59 2.99-19.8 5.01-4.98 1.93-8.71 4.39-11.68 7.51-5.89 6.17-8.28 14.54-7.46 22.38.7 6.69 3.71 13.09 8.88 17.82 3.49 3.2 7.85 5.63 12.99 6.66 5.33 1.07 11.01.7 19.31-.98 4.42-.89 8.56-2.28 12.5-4.61 3.9-2.3 7.24-5.37 9.85-9.11 2.62-3.75 4.31-7.92 5.24-12.35.96-4.57 1.19-8.7 1.19-13.26V142.81c0-6.22 1.76-7.86 6.78-9.08 0 0 88.94-17.94 93.09-18.75 5.79-1.11 8.52.54 8.52 6.61v79.29c0 3.14-.03 6.32-2.17 8.92-2.12 2.59-4.74 3.37-7.81 3.99l-6.99 1.41c-8.84 1.78-14.59 2.99-19.8 5.01-4.98 1.93-8.71 4.39-11.68 7.51-5.89 6.17-8.49 14.54-7.67 22.38.7 6.69 3.92 13.09 9.09 17.82 3.49 3.2 7.85 5.56 12.99 6.6 5.33 1.07 11.01.69 19.31-.98 4.42-.89 8.56-2.22 12.5-4.55 3.9-2.3 7.24-5.37 9.85-9.11 2.62-3.75 4.31-7.92 5.24-12.35.96-4.57 1-8.7 1-13.26V64.46c.02-6.16-3.23-9.96-9.02-9.46z\"\n        fill=\"#fff\"\n      />\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,iBAAgD,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IACzF,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,qBAAoB;QACpB,WAAW;;0BAEX,6bAAC;gBACC,IAAG;gBACH,IAAG;gBACH,IAAG;gBACH,IAAG;gBACH,IAAG;gBACH,eAAc;;kCAEd,6bAAC;wBAAK,QAAO;wBAAI,OAAO;4BAAE,WAAW;wBAAU;;;;;;kCAC/C,6bAAC;wBAAK,QAAO;wBAAI,OAAO;4BAAE,WAAW;wBAAU;;;;;;;;;;;;0BAEjD,6bAAC;gBACC,GAAE;gBACF,MAAK;;;;;;0BAEP,6bAAC;gBACC,GAAE;gBACF,MAAK;;;;;;;;;;;;AAIb","debugId":null}},
    {"offset": {"line": 4071, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/AmazonMusicLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface AmazonMusicLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const AmazonMusicLogo: React.FC<AmazonMusicLogoProps> = ({ className = \"\", size = 24 }) => {\n  return (\n    <svg\n      viewBox=\"0 0 89.016 52\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      preserveAspectRatio=\"xMidYMid\"\n      className={className}\n    >\n      <defs>\n        <linearGradient id=\"amazon-music-gradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n          <stop offset=\"0\" stopColor=\"#0C6CB3\" />\n          <stop offset=\"0.2911\" stopColor=\"#1E84C4\" />\n          <stop offset=\"0.8873\" stopColor=\"#4CC0EF\" />\n          <stop offset=\"1\" stopColor=\"#4CC0EF\" />\n        </linearGradient>\n      </defs>\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m59.7 22.5c-.6.4-1.5.7-2.6.7-1.7 0-3.3-.2-4.9-.7-.4-.1-.7-.2-.9-.2-.3 0-.4.2-.4.6v1c0 .3.1.5.2.7.1.1.3.3.6.4 1.6.7 3.4 1 5.4 1 2.1 0 3.7-.5 5-1.5 1.3-1 1.9-2.3 1.9-4 0-1.2-.3-2.1-.9-2.9-.6-.7-1.6-1.4-3-1.9l-2.8-1.1c-1.1-.4-1.9-.8-2.2-1.2-.4-.4-.6-.8-.6-1.5 0-1.5 1.1-2.3 3.4-2.3 1.3 0 2.6.2 3.8.6.4.1.7.2.8.2.3 0 .5-.2.5-.6v-1c0-.3-.1-.5-.2-.7-.1-.2-.3-.3-.6-.4-1.5-.5-3-.8-4.5-.8-1.9 0-3.5.5-4.7 1.4-1.2.9-1.8 2.2-1.8 3.7 0 2.3 1.3 4 3.9 5l3 1.1c1 .4 1.6.7 2 1.1.4.4.5.8.5 1.4 0 .8-.3 1.5-.9 1.9z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m44 8.1v13.3c-1.7 1.1-3.4 1.7-5.1 1.7-1.1 0-1.9-.3-2.4-.9-.5-.6-.7-1.5-.7-2.8V8.1c0-.5-.2-.7-.7-.7h-2.1c-.5 0-.7.2-.7.7v12.4c0 1.7.4 3.1 1.3 4 .9.9 2.2 1.4 3.9 1.4 2.3 0 4.6-.8 6.8-2.4l.2 1.2c0 .3.1.4.3.5.1.1.3.1.6.1h1.5c.5 0 .7-.2.7-.7V8.1c0-.5-.2-.7-.7-.7h-2.1c-.6 0-.8.3-.8.7z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m25 25.4h2.1c.5 0 .7-.2.7-.7V12.2c0-1.7-.4-3-1.3-3.9-.9-.9-2.1-1.4-3.8-1.4-2.3 0-4.7.8-7 2.5-.8-1.7-2.3-2.5-4.5-2.5-2.2 0-4.4.8-6.6 2.3l-.2-.9c0-.3-.1-.4-.3-.5-.1-.1-.3-.1-.5-.1h-1.6c-.5 0-.7.2-.7.7v16.6c0 .5.2.7.7.7h2.1c.5 0 .7-.2.7-.7V11.3c1.7-1 3.4-1.6 5.2-1.6 1 0 1.7.3 2.1.9.4.6.7 1.4.7 2.6v11.5c0 .5.2.7.7.7h2.1c.5 0 .7-.2.7-.7V12.4 11.8c0-.2 0-.4 0-.5 1.8-1.1 3.5-1.6 5.2-1.6 1 0 1.7.3 2.1.9.4.6.7 1.4.7 2.6v11.5c0 .5.2.7.7.7z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m79.5 38.7c-10.9 4.6-22.8 6.9-33.6 6.9-16 0-31.5-4.4-44-11.7-.2-.1-.4-.2-.6-.2-.7 0-1.1.8-.4 1.5 11.6 10.5 27 16.8 44 16.8 12.2 0 26.3-3.8 36-11 1.7-1.2.3-3-1.4-2.3z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m79.2 11.4c.9-1 2.3-1.5 4.3-1.5 1 0 2 .1 2.9.4.3.1.4.1.6.1.3 0 .5-.2.5-.7v-1c0-.3-.1-.6-.2-.7-.1-.1-.3-.3-.5-.4-1.3-.3-2.6-.6-3.8-.6-2.8 0-4.9.8-6.5 2.5-1.5 1.6-2.3 4-2.3 7 0 3 .7 5.3 2.2 6.9 1.5 1.6 3.6 2.4 6.4 2.4 1.5 0 2.9-.2 4-.7.3-.1.5-.2.6-.4.1-.1.1-.4.1-.7v-1c0-.5-.2-.7-.5-.7-.1 0-.3 0-.5.1-1.1.3-2.2.5-3.2.5-1.9 0-3.3-.5-4.2-1.5-.9-1-1.3-2.6-1.3-4.7v-.5c.1-2.2.5-3.8 1.4-4.8z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m83.7 48.1c5.2-4.4 6.6-13.5 5.5-14.9-.5-.6-2.9-1.2-5.9-1.2-3.2 0-7 .7-9.9 2.7-.9.6-.7 1.4.2 1.3 3.1-.4 10.1-1.2 11.4.4 1.2 1.6-1.4 8.2-2.6 11.1-.3.9.4 1.2 1.3.6z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m69.8 7.4h-2.1c-.5 0-.7.2-.7.7v16.6c0 .5.2.7.7.7h2.1c.5 0 .7-.2.7-.7V8.1c0-.4-.2-.7-.7-.7z\"\n      />\n      <path\n        fill=\"url(#amazon-music-gradient)\"\n        d=\"m70.4.6c-.4-.4-1-.6-1.7-.6-.7 0-1.2.2-1.6.6-.4.4-.6.9-.6 1.5 0 .6.2 1.2.6 1.5.4.4.9.6 1.6.6.7 0 1.2-.2 1.6-.6.4-.4.6-.9.6-1.5 0-.6-.1-1.2-.5-1.5z\"\n      />\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,kBAAkD,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IAC3F,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,qBAAoB;QACpB,WAAW;;0BAEX,6bAAC;0BACC,cAAA,6bAAC;oBAAe,IAAG;oBAAwB,IAAG;oBAAK,IAAG;oBAAK,IAAG;oBAAO,IAAG;;sCACtE,6bAAC;4BAAK,QAAO;4BAAI,WAAU;;;;;;sCAC3B,6bAAC;4BAAK,QAAO;4BAAS,WAAU;;;;;;sCAChC,6bAAC;4BAAK,QAAO;4BAAS,WAAU;;;;;;sCAChC,6bAAC;4BAAK,QAAO;4BAAI,WAAU;;;;;;;;;;;;;;;;;0BAG/B,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;;;;;;;AAIV","debugId":null}},
    {"offset": {"line": 4212, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/TidalLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface TidalLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const TidalLogo: React.FC<TidalLogoProps> = ({ className = \"\", size = 24 }) => {\n  return (\n    <svg\n      viewBox=\"0 0 50 50\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className={className}\n    >\n      <path\n        fill=\"currentColor\"\n        d=\"M9 12C8.7615 12 8.5237969 12.091437 8.3417969 12.273438L1.2734375 19.341797C0.9094375 19.705797 0.9094375 20.294203 1.2734375 20.658203L8.3417969 27.726562C8.7057969 28.090563 9.2942031 28.090563 9.6582031 27.726562L16.726562 20.658203C16.908563 20.476203 17 20.2385 17 20C17 19.7615 16.908563 19.523797 16.726562 19.341797L9.6582031 12.273438C9.4762031 12.091437 9.2385 12 9 12zM17 20C17 20.2385 17.091438 20.476203 17.273438 20.658203L24.341797 27.726562C24.523797 27.908563 24.7615 28 25 28C25.2385 28 25.476203 27.908563 25.658203 27.726562L32.726562 20.658203C32.908563 20.476203 33 20.2385 33 20C33 19.7615 32.908563 19.523797 32.726562 19.341797L25.658203 12.273438C25.294203 11.909437 24.705797 11.909437 24.341797 12.273438L17.273438 19.341797C17.091437 19.523797 17 19.7615 17 20zM33 20C33 20.2385 33.091437 20.476203 33.273438 20.658203L40.341797 27.726562C40.705797 28.090563 41.294203 28.090563 41.658203 27.726562L48.726562 20.658203C49.090563 20.294203 49.090563 19.705797 48.726562 19.341797L41.658203 12.273438C41.294203 11.909437 40.705797 11.909437 40.341797 12.273438L33.273438 19.341797C33.091437 19.523797 33 19.7615 33 20zM25 28C24.7615 28 24.523797 28.091437 24.341797 28.273438L17.273438 35.341797C16.909437 35.705797 16.909437 36.294203 17.273438 36.658203L24.341797 43.726562C24.705797 44.090562 25.294203 44.090562 25.658203 43.726562L32.726562 36.658203C33.090563 36.294203 33.090563 35.705797 32.726562 35.341797L25.658203 28.273438C25.476203 28.091437 25.2385 28 25 28z\"\n      />\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,YAAsC,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IAC/E,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,WAAW;kBAEX,cAAA,6bAAC;YACC,MAAK;YACL,GAAE;;;;;;;;;;;AAIV","debugId":null}},
    {"offset": {"line": 4243, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/PandoraLogo.tsx"],"sourcesContent":["import React from \"react\";\n\ninterface PandoraLogoProps {\n  className?: string;\n  size?: number;\n}\n\nexport const PandoraLogo: React.FC<PandoraLogoProps> = ({ className = \"\", size = 24 }) => {\n  return (\n    <svg\n      viewBox=\"0 0 48 48\"\n      width={size}\n      height={size}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      preserveAspectRatio=\"xMidYMid\"\n      className={className}\n    >\n      <path\n        fill=\"#f2494c\"\n        d=\"M36.466,28.216c-0.225,0.225-0.461,0.439-0.709,0.653c-0.191,0.157-0.394,0.315-0.596,0.461 c-0.225,0.169-0.45,0.326-0.686,0.472c-0.124,0.09-0.27,0.169-0.405,0.236c-0.18,0.112-0.349,0.214-0.54,0.304l-0.135,0.068 c-0.522,0.261-1.065,0.48-1.622,0.655c-0.175,0.055-0.353,0.109-0.538,0.155c-0.315,0.09-0.641,0.169-0.979,0.225 c-0.675,0.124-1.361,0.18-2.07,0.18h-3.943c-0.155-0.099-0.318-0.205-0.474-0.305c-0.317-0.699-0.608-1.348-1.41-2.26 c-0.146-0.18-0.337-0.382-0.551-0.596c-0.911-0.911-1.586-1.339-2.216-1.665c-0.169-0.09-0.337-0.169-0.506-0.248 c-0.27-0.135-0.54-0.259-0.833-0.428c-0.529-0.304-1.114-0.731-1.856-1.474c-1.159-1.159-1.53-1.935-1.924-2.711 C14.159,21.264,13.833,20.6,13,19.678V9.125C13,8.504,13.504,8,14.125,8h2.914c0.36,0.495,0.563,0.934,0.788,1.361 c0.36,0.788,0.731,1.541,1.89,2.7s1.935,1.53,2.722,1.913c0.765,0.371,1.541,0.754,2.689,1.901c1.159,1.159,1.53,1.935,1.924,2.711 c0.36,0.788,0.731,1.541,1.89,2.7c1.159,1.159,1.935,1.53,2.722,1.913c0.765,0.371,1.541,0.754,2.689,1.901 c1.159,1.159,1.53,1.935,1.924,2.711C36.331,27.946,36.399,28.081,36.466,28.216z\"\n      />\n      <path fill=\"#db1a58\" d=\"M13,8v32h8c1.105,0,2-0.895,2-2v-6h6c0,0,11-1,11-11S34,8,29,8H13z\" />\n      <path\n        fill=\"#3231c7\"\n        d=\"M16.51,40H13v-2.34l0.034,0.034c1.159,1.159,1.935,1.53,2.722,1.912 C16.004,39.719,16.251,39.842,16.51,40z\"\n      />\n      <path\n        fill=\"#e4273e\"\n        d=\"M39.832,23.05c-0.068,0.236-0.351,5.743-7.712,8.232c-0.472-0.292-1.874-0.748-2.515-1.39 c-1.159-1.159-1.541-1.935-1.924-2.711c-0.236-0.484-0.472-0.968-0.889-1.541c-0.259-0.337-0.585-0.72-1.013-1.147 c-0.844-0.844-1.485-1.271-2.07-1.586c-0.214-0.124-0.427-0.236-0.641-0.337c-0.157-0.079-0.315-0.146-0.472-0.236 c-0.63-0.326-1.305-0.754-2.216-1.665c-1.159-1.159-1.541-1.935-1.924-2.711c-0.371-0.776-0.754-1.541-1.901-2.689 c-1.159-1.159-1.935-1.541-2.711-1.924c-0.281-0.124-0.551-0.259-0.844-0.439V8h10.62h0.001c1.202,1.219,1.996,1.611,2.789,2.001 c0.776,0.371,1.53,0.742,2.689,1.901s1.541,1.924,1.913,2.7c0.383,0.776,0.754,1.541,1.913,2.7c1.159,1.159,1.946,1.541,2.723,1.924 c0.765,0.382,1.541,0.754,2.678,1.901C38.954,21.759,39.54,22.589,39.832,23.05z\"\n      />\n      <path\n        fill=\"#f2494c\"\n        d=\"M36.679,28.76C33.947,31.097,31.905,32,29,32c-2.152,0-4.775-0.088-4.854-0.097 c-0.317-0.699-0.984-1.93-1.786-2.843c-0.146-0.18-0.337-0.382-0.551-0.596c-0.911-0.911-1.586-1.339-2.216-1.665 c-0.169-0.09-0.337-0.169-0.506-0.248c-0.27-0.135-0.54-0.259-0.833-0.428c-0.529-0.304-0.495-1.579-1.238-2.322 c-1.159-1.159-1.808-1.946-2.202-2.723C14.5,20.404,13.833,20.6,13,19.678V8h4.039c0.36,0.495,0.563,0.934,0.788,1.361 c0.36,0.788,0.731,1.541,1.89,2.7s1.935,1.53,2.722,1.913c0.765,0.371,1.541,0.754,2.689,1.901c1.159,1.159,1.53,1.935,1.924,2.711 c0.36,0.788,0.731,1.541,1.89,2.7c1.159,1.159,1.935,1.53,2.722,1.913c0.765,0.371,1.541,0.754,2.689,1.901 c1.159,1.159,1.53,1.935,1.924,2.711C36.331,27.946,36.612,28.625,36.679,28.76z\"\n      />\n      <path\n        fill=\"#b11e93\"\n        d=\"M23,38L23,38c0,1.105-0.895,2-2,2h-0.125H13V28.131c0.056,0.045-0.067-0.199,0-0.131 c0.259,0.259,0.82,0.775,1,1c0,0,0-0.011,0,0c0.653,0.776,0.811,1.415,1.104,2.022c0.382,0.765,0.754,1.553,1.913,2.7 c1.159,1.159,1.946,1.541,2.723,1.924c0.765,0.371,1.53,0.743,2.678,1.89C22.675,37.795,22.82,37.786,23,38z\"\n      />\n      <path\n        fill=\"#3231c7\"\n        d=\"M23,35.641v1.609V38c0,1.105-0.895,2-2,2h0c0,0,0.756-1.756-0.497-3.009 c-0.405-0.394-0.81-0.686-1.406-1.046c-0.585-0.36-1.226-0.821-1.733-1.327c-1.001-1.013-1.868-2.115-2.396-3.431 c-0.112-0.281-0.214-0.551-0.304-0.821c-0.135-0.349-0.259-0.675-0.428-1.001C14.09,29.082,13.203,28.259,13,28 c0.517,0.416,1.146,0.599,1.585,1.128c0.428,0.517,0.776,1.136,1.125,1.665c0.045,0.068,0.079,0.124,0.135,0.18 c0.675,0.945,1.609,1.71,2.565,2.329c0.045,0.023,0.079,0.056,0.124,0.068c0.472,0.292,0.945,0.495,1.496,0.686 c0.596,0.191,1.361,0.517,2.002,0.923C22.381,35.191,22.696,35.416,23,35.641z\"\n      />\n      <path\n        fill=\"#3231c7\"\n        d=\"M40,21c-0.011,0.236,0,2.317-0.635,3.942l-0.257-0.387l-0.641-0.833l-1.305-1.597 c-0.405-0.506-0.81-0.934-1.316-1.294c-0.484-0.382-1.193-0.742-1.845-1.271c-0.641-0.506-1.17-1.091-1.654-1.688 c-0.472-0.596-0.911-1.249-1.237-1.958c-0.214-0.472-0.36-0.934-0.529-1.373c-0.079-0.225-0.169-0.45-0.27-0.664 c-0.304-0.63-0.589-1.237-1.039-1.8c0.563,0.45,0.983,0.956,1.444,1.553c0.371,0.484,0.675,1.013,0.99,1.485 c0.079,0.112,0.146,0.214,0.225,0.315c0.754,0.956,1.789,1.811,2.824,2.385c0.101,0.056,0.191,0.101,0.281,0.146 c0.563,0.281,1.215,0.45,1.98,0.788c0.765,0.337,1.496,0.821,2.126,1.316C39.457,20.326,40,21,40,21z\"\n      />\n      <path\n        fill=\"#3231c7\"\n        d=\"M37.687,27.752c-0.13,0.17-1.285,1.309-2.267,2.03l-0.31-0.69c-0.23-0.59-0.38-0.99-0.67-1.44 c-0.26-0.44-0.63-0.9-0.99-1.3c-0.38-0.41-0.75-0.74-1.23-1.05c-0.47-0.3-1.11-0.65-1.63-1.11c-0.52-0.45-0.95-0.94-1.35-1.45 c-0.4-0.51-0.77-1.07-1.03-1.68c-0.14-0.35-0.26-0.69-0.38-1.01c-0.09-0.24-0.306-0.517-0.426-0.747 c-0.27-0.54-0.427-1.112-0.817-1.592c0.48,0.39,0.853,0.939,1.243,1.439c0.33,0.42,0.61,0.91,0.88,1.34 c0.05,0.08,0.09,0.15,0.14,0.22c0.66,0.93,1.63,1.73,2.59,2.29c0.05,0.03,0.1,0.06,0.16,0.08c0.43,0.23,0.89,0.38,1.45,0.6 c0.63,0.24,1.28,0.6,1.84,1.01c0.55,0.42,1.06,0.84,1.56,1.37C36.9,26.522,37.387,27.262,37.687,27.752z\"\n      />\n      <path\n        fill=\"#e4273e\"\n        d=\"M28.419,29.365c-1.02-1.02-1.7-1.36-2.39-1.69c-0.69-0.34-0.845-1.023-1.875-2.053 c-1.02-1.02-1.726-2.602-2.056-3.293c-0.34-0.69-0.416-1.098-1.446-2.128c-1.02-1.02-1.7-1.36-2.39-1.69 c-0.69-0.34-1.611-0.732-2.641-1.762c-1.02-1.02-1.562-1.639-1.892-2.329c-0.2-0.41-0.379-0.948-0.729-1.428V21 c0.49,0.35,0.879,0.523,1.289,0.733c0.65,0.3,1.091,0.899,1.991,1.769l0.03,0.03c0.06,0.04,0.13,0.11,0.2,0.18 c1.03,1.03,1.539,2.702,1.879,3.402c0.33,0.68,0.67,1.37,1.69,2.39c1.03,1.03,1.72,1.36,2.41,1.71 c0.27,0.12,0.523,0.565,0.803,0.725c0,0,1.1,0.065,2.708,0.06c0.313-0.001,1,0,1,0s2.166,0.049,2.999-0.029 C29.719,31.481,29.109,30.055,28.419,29.365z\"\n      />\n      <path\n        fill=\"#0288d1\"\n        d=\"M27,32h-4l-0.01,0.157c-0.157-0.112-0.337-0.225-0.529-0.337c-0.585-0.36-1.226-0.821-1.733-1.327 c-1.001-1.013-1.868-2.115-2.396-3.431c-0.079-0.191-0.146-0.382-0.214-0.563c-0.157-0.439-0.315-0.855-0.517-1.26 c-0.225-0.428-0.495-0.844-0.788-1.237l-0.034-0.034c-0.079-0.124-0.18-0.236-0.27-0.36c0.517,0.416,1.001,0.866,1.44,1.395 c0.428,0.517,0.776,1.136,1.125,1.665c0.112,0.18,0.248,0.349,0.382,0.506c0.653,0.799,1.474,1.451,2.318,2.002 c0.146,0.09,0.304,0.18,0.45,0.259c0.371,0.191,0.754,0.349,1.17,0.495c0.596,0.191,1.361,0.517,2.002,0.923 C25.96,31.201,27.14,32.063,27,32z\"\n      />\n      <path\n        fill=\"#0288d1\"\n        d=\"M33.286,31.079C32.533,31.63,30.252,32.031,29.99,32c-0.079-0.135-0.158-0.27-0.236-0.394 c-0.349-0.574-0.63-0.956-1.069-1.451c-0.405-0.472-0.821-0.855-1.339-1.204c-0.517-0.337-1.249-0.754-1.834-1.271 c-0.596-0.517-1.091-1.08-1.541-1.654c-0.461-0.585-0.877-1.237-1.17-1.924c-0.18-0.416-0.315-0.821-0.472-1.215 c-0.09-0.248-0.191-0.495-0.315-0.731c-0.292-0.619-0.697-1.193-1.136-1.744c0.551,0.439,1.069,0.934,1.519,1.496 c0.405,0.495,0.72,1.069,1.046,1.553c0.045,0.068,0.09,0.135,0.135,0.202c0.776,1.035,1.868,1.924,2.948,2.531 c0.011,0,0.011,0.011,0.022,0.011c0.551,0.304,1.103,0.472,1.834,0.754c0.731,0.281,1.474,0.72,2.104,1.181 c0.619,0.428,1.271,1.091,1.733,1.665C32.543,30.189,33.004,30.674,33.286,31.079z\"\n      />\n      <path\n        fill=\"#b11e93\"\n        d=\"M38.852,14.415c-0.96-2.195-2.23-3.842-4.295-5.009c0.585,1.057,0.856,1.924,2.352,3.42 C37.73,13.648,38.278,14.111,38.852,14.415z\"\n      />\n      <path\n        fill=\"#3231c7\"\n        d=\"M16.364,40H13v-2.474l0.032,0.036c1.11,1.225,1.854,1.617,2.609,2.022 C15.879,39.703,16.116,39.833,16.364,40z\"\n      />\n    </svg>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAOO,MAAM,cAA0C,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,EAAE;IACnF,qBACE,6bAAC;QACC,SAAQ;QACR,OAAO;QACP,QAAQ;QACR,OAAM;QACN,qBAAoB;QACpB,WAAW;;0BAEX,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBAAK,MAAK;gBAAU,GAAE;;;;;;0BACvB,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;0BAEJ,6bAAC;gBACC,MAAK;gBACL,GAAE;;;;;;;;;;;;AAIV","debugId":null}},
    {"offset": {"line": 4381, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/config/services.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { SpotifyLogo } from \"@/components/icons/SpotifyLogo\";\nimport { YouTubeMusicLogo } from \"@/components/icons/YouTubeMusicLogo\";\nimport { DeezerLogo } from \"@/components/icons/DeezerLogo\";\nimport { AppleMusicLogo } from \"@/components/icons/AppleMusicLogo\";\nimport { AmazonMusicLogo } from \"@/components/icons/AmazonMusicLogo\";\nimport { TidalLogo } from \"@/components/icons/TidalLogo\";\nimport { PandoraLogo } from \"@/components/icons/PandoraLogo\";\nimport { FC } from \"react\";\n\n// Status constants for service availability\nexport const SERVICE_STATUS = {\n  OFF: \"OFF\",\n  DEV: \"DEV\",\n  AVAILABLE: \"AVAILABLE\",\n  MAINTENANCE: \"MAINTENANCE\",\n} as const;\n\nexport type ServiceStatus = (typeof SERVICE_STATUS)[keyof typeof SERVICE_STATUS];\n\nexport const ServiceConfigSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  image: z.custom<FC<{ className: string; size: number }>>(val => typeof val === \"function\"),\n  color: z.string(),\n  status: z.literal([\n    SERVICE_STATUS.OFF,\n    SERVICE_STATUS.DEV,\n    SERVICE_STATUS.AVAILABLE,\n    SERVICE_STATUS.MAINTENANCE,\n  ]),\n  getPlaylistUrl: z.custom<(id: string) => string>(val => typeof val === \"function\"),\n  getLikedSongsUrl: z.custom<() => string>(val => typeof val === \"function\"),\n  getAlbumsUrl: z.custom<() => string>(val => typeof val === \"function\"),\n  apiBaseUrl: z.url(),\n});\n\nexport type ServiceConfig = z.infer<typeof ServiceConfigSchema>;\n\nconst ServicesSchema = z.record(z.string(), ServiceConfigSchema);\n\nconst rawServices = {\n  spotify: {\n    id: \"spotify\",\n    name: \"Spotify\",\n    image: SpotifyLogo,\n    color: \"#1ed760\",\n    status: SERVICE_STATUS.AVAILABLE,\n    apiBaseUrl: \"https://api.spotify.com/v1\",\n    getPlaylistUrl: (id: string) => `https://open.spotify.com/playlist/${id}`,\n    getLikedSongsUrl: () => \"https://open.spotify.com/collection/tracks\",\n    getAlbumsUrl: () => \"https://open.spotify.com/\",\n  },\n  youtube: {\n    id: \"youtube\",\n    name: \"YouTube Music\",\n    image: YouTubeMusicLogo,\n    color: \"#FF0000\",\n    status: SERVICE_STATUS.DEV,\n    apiBaseUrl: \"https://www.googleapis.com/youtube/v3\",\n    getPlaylistUrl: (id: string) => `https://music.youtube.com/playlist?list=${id}`,\n    getLikedSongsUrl: () => \"https://music.youtube.com/playlist?list=LM\",\n    getAlbumsUrl: () => null,\n  },\n  deezer: {\n    id: \"deezer\",\n    name: \"Deezer\",\n    image: DeezerLogo,\n    color: \"#A238FF\",\n    status: SERVICE_STATUS.DEV,\n    apiBaseUrl: \"https://api.deezer.com\",\n    getPlaylistUrl: (id: string) => `https://www.deezer.com/playlist/${id}`,\n    getLikedSongsUrl: () => {\n      if (typeof window === \"undefined\") return null;\n      const userId = localStorage.getItem(\"deezer_user_id\");\n      return userId ? `https://www.deezer.com/fr/profile/${userId}/loved` : null;\n    },\n    getAlbumsUrl: () => {\n      if (typeof window === \"undefined\") return null;\n      const userId = localStorage.getItem(\"deezer_user_id\");\n      return userId ? `https://www.deezer.com/fr/profile/${userId}/albums` : null;\n    },\n  },\n  apple: {\n    id: \"apple\",\n    name: \"Apple Music\",\n    image: AppleMusicLogo,\n    color: \"#FA243C\",\n    status: SERVICE_STATUS.AVAILABLE,\n    apiBaseUrl: \"https://api.music.apple.com\", // no version as Apple gives relative pagination urls\n    getPlaylistUrl: (id: string) => {\n      try {\n        if (typeof window !== \"undefined\" && window.MusicKit) {\n          const music = window.MusicKit.getInstance();\n          const storefrontId = music?.storefrontId;\n          if (storefrontId) {\n            return `https://music.apple.com/${storefrontId}/library/playlist/${id}`;\n          }\n        }\n      } catch (error) {\n        console.error(\"Error retrieving Apple Music storefront ID:\", error);\n      }\n      return `https://music.apple.com/library/playlist/${id}`;\n    },\n    getLikedSongsUrl: () => \"https://music.apple.com/fr/library/songs\",\n    getAlbumsUrl: () => \"https://music.apple.com/fr/library/albums\",\n  },\n  amazonMusic: {\n    id: \"amazonMusic\",\n    name: \"Amazon Music\",\n    image: AmazonMusicLogo,\n    color: \"#00A8E1\",\n    status: SERVICE_STATUS.OFF,\n    apiBaseUrl: \"https://api.music.amazon.com\",\n    getPlaylistUrl: (id: string) => `https://music.amazon.com/playlists/${id}`,\n    getLikedSongsUrl: () => null,\n    getAlbumsUrl: () => null,\n  },\n  tidal: {\n    id: \"tidal\",\n    name: \"Tidal\",\n    image: TidalLogo,\n    color: \"#000000\",\n    status: SERVICE_STATUS.DEV,\n    apiBaseUrl: \"https://openapi.tidal.com/v2\",\n    getPlaylistUrl: (id: string) => `https://tidal.com/playlist/${id}`,\n    getLikedSongsUrl: () => null,\n    getAlbumsUrl: () => null,\n  },\n  pandora: {\n    id: \"pandora\",\n    name: \"Pandora\",\n    image: PandoraLogo,\n    color: \"#3668FF\",\n    status: SERVICE_STATUS.OFF,\n    apiBaseUrl: \"https://api.pandora.com/v1\",\n    getPlaylistUrl: (id: string) => `https://www.pandora.com/playlist/${id}`,\n    getLikedSongsUrl: () => null,\n    getAlbumsUrl: () => null,\n  },\n} as const;\n\n// Validate and export the services configuration\nexport const SERVICES: Record<string, ServiceConfig> = (() => {\n  try {\n    return ServicesSchema.parse(rawServices);\n  } catch (error) {\n    console.error(\"Services configuration validation failed:\", error);\n    throw new Error(\"Invalid services configuration. Please check the service definitions.\");\n  }\n})();\n\n// Helper function to get available services with validation\n// In non-production environments, also includes DEV services for testing\nexport const getAvailableServices = (): ServiceConfig[] => {\n  try {\n    const isProduction = process.env.NODE_ENV === \"production\";\n\n    const availableServices = Object.values(SERVICES).filter(service => {\n      if (service.status === SERVICE_STATUS.AVAILABLE) {\n        return true;\n      }\n      // Include DEV services when not in production\n      // if (!isProduction && service.status === SERVICE_STATUS.DEV) {\n      //   return true;\n      // }\n      return false;\n    });\n\n    if (availableServices.length === 0) {\n      console.warn(\"No available services found\");\n    }\n\n    return availableServices;\n  } catch (error) {\n    console.error(\"Error getting available services:\", error);\n    return [];\n  }\n};\n\n// Helper function to get offline services with validation\nexport const getOfflineServices = (): ServiceConfig[] => {\n  try {\n    return Object.values(SERVICES).filter(service => service.status === SERVICE_STATUS.OFF);\n  } catch (error) {\n    console.error(\"Error getting offline services:\", error);\n    return [];\n  }\n};\n\n// Helper function to get services in development with validation\nexport const getDevServices = (): ServiceConfig[] => {\n  try {\n    return Object.values(SERVICES).filter(service => service.status === SERVICE_STATUS.DEV);\n  } catch (error) {\n    console.error(\"Error getting dev services:\", error);\n    return [];\n  }\n};\n\n// Helper function to get services in maintenance with validation\nexport const getMaintenanceServices = (): ServiceConfig[] => {\n  try {\n    return Object.values(SERVICES).filter(service => service.status === SERVICE_STATUS.MAINTENANCE);\n  } catch (error) {\n    console.error(\"Error getting maintenance services:\", error);\n    return [];\n  }\n};\n\n// Helper function to get coming soon services with validation (kept for backward compatibility)\nexport const getComingSoonServices = (): ServiceConfig[] => {\n  try {\n    return Object.values(SERVICES).filter(service => service.status === SERVICE_STATUS.OFF);\n  } catch (error) {\n    console.error(\"Error getting coming soon services:\", error);\n    return [];\n  }\n};\n\n// Helper function to get service by ID with validation\nexport const getServiceById = (id: string): ServiceConfig | undefined => {\n  if (!id || typeof id !== \"string\") {\n    console.error(`Invalid service ID \"${id}\": must be a non-empty string`);\n    return undefined;\n  }\n  return SERVICES[id];\n};\n\n// Helper function to validate a service configuration\nexport const validateServiceConfig = (config: unknown): ServiceConfig => {\n  return ServiceConfigSchema.parse(config);\n};\n\n// Helper function to safely get playlist URL with validation\nexport const getPlaylistUrl = (serviceId: string, playlistId: string): string | null => {\n  try {\n    const service = getServiceById(serviceId);\n    if (!service) {\n      throw new Error(`Service \"${serviceId}\" not found`);\n    }\n\n    // Validate playlist ID\n    if (!playlistId || playlistId.trim().length === 0) {\n      throw new Error(\"Playlist ID cannot be empty\");\n    }\n\n    return service.getPlaylistUrl(playlistId.trim());\n  } catch (error) {\n    console.error(`Error getting playlist URL for service \"${serviceId}\":`, error);\n    return null;\n  }\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4633, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/apple/api.ts"],"sourcesContent":["import { SearchResult, TransferResult, ITrack, ILibraryData, IAlbum, IPlaylist } from \"@/types\";\nimport { getAppleAuthData } from \"./auth\";\nimport { processInBatches } from \"@/lib/utils/batch-processor\";\nimport {\n  calculateTrackMatchScore,\n  calculateAlbumMatchScore,\n  DEFAULT_TRACK_CONFIG,\n  DEFAULT_ALBUM_CONFIG,\n  cleanSearchTerm,\n  cleanTrackTitle,\n} from \"@/lib/utils/matching\";\nimport { retryWithExponentialBackoff, type RetryOptions } from \"@/lib/utils/retry\";\nimport { AUTH_STORAGE_KEYS, type AuthData, setServiceType } from \"@/lib/auth/constants\";\nimport { sentryLogger } from \"@/lib/utils/sentry-logger\";\nimport { MATCHING_STATUS } from \"@/types/matching-status\";\nimport { SERVICES } from \"@/config/services\";\n\nconst BASE_URL = SERVICES.apple.apiBaseUrl!;\n\ninterface MusicKitInstance {\n  authorize: () => Promise<string>;\n  storefrontId?: string;\n  api: {\n    search: (\n      term: string,\n      options: { types: string }\n    ) => Promise<{\n      songs?: {\n        data: Array<{\n          id: string;\n          attributes: {\n            name: string;\n            artistName: string;\n            albumName: string;\n            artwork?: {\n              url: string;\n            };\n          };\n          relationships?: {\n            album?: {\n              data: Array<{\n                id: string;\n              }>;\n            };\n          };\n        }>;\n      };\n      albums?: {\n        data: Array<{\n          id: string;\n          attributes: {\n            name: string;\n            artistName: string;\n          };\n        }>;\n      };\n    }>;\n    library: {\n      add: (options: { songs: string[] }) => Promise<void>;\n      playlists: {\n        create: (options: { name: string; description?: string }) => Promise<{ id: string }>;\n        addTracks: (playlistId: string, options: { songs: string[] }) => Promise<void>;\n      };\n    };\n  };\n}\n\ninterface MusicKitGlobal {\n  configure: (options: {\n    developerToken: string;\n    app: {\n      name: string;\n      build: string;\n    };\n  }) => Promise<void>;\n  getInstance: () => MusicKitInstance;\n}\n\ndeclare global {\n  interface Window {\n    MusicKit: MusicKitGlobal;\n  }\n}\n\ninterface AppleMusicSong {\n  id: string;\n  attributes: {\n    name: string;\n    artistName: string;\n    albumName: string;\n    artwork?: {\n      url: string;\n    };\n  };\n  relationships?: {\n    album?: {\n      data?: Array<{ id: string }>;\n    };\n  };\n}\n\ninterface AppleAlbum {\n  id: string;\n  attributes: {\n    name: string;\n    artistName: string;\n    artwork?: {\n      url: string;\n    };\n  };\n}\n\ninterface AppleMusicSearchResponse {\n  results: {\n    songs?: {\n      data: AppleMusicSong[];\n    };\n    albums?: {\n      data: AppleAlbum[];\n    };\n  };\n}\n\n// Define Apple-specific retry options\nconst APPLE_RETRY_OPTIONS: RetryOptions = {\n  maxRetries: 5,\n  initialRetryDelay: 200, // Start with a bit faster retry than default\n  maxRetryDelay: 32000,\n  jitterFactor: 0.1,\n};\n\n// Helper function to fetch Apple Music API with authentication\nasync function fetchAppleMusic(\n  url: string | URL,\n  options: RequestInit = {},\n  authData: AuthData\n): Promise<Response> {\n  const finalUrl = url instanceof URL ? url.toString() : url;\n  const headers = {\n    ...options.headers,\n    Authorization: `Bearer ${process.env.NEXT_PUBLIC_APPLE_MUSIC_DEVELOPER_TOKEN}`,\n    \"Music-User-Token\": authData.accessToken,\n  };\n\n  return fetch(finalUrl, {\n    ...options,\n    headers,\n  });\n}\n\nexport async function initializeAppleMusic(\n  injectedMusicKit?: MusicKitGlobal\n): Promise<MusicKitInstance> {\n  try {\n    // Use the injected MusicKit if provided, otherwise use window.MusicKit\n    let musicKit =\n      injectedMusicKit ?? (typeof window !== \"undefined\" ? window.MusicKit : undefined);\n\n    if (!musicKit) {\n      // Retry logic as before\n      let attempts = 0;\n      while (attempts < 10) {\n        await new Promise(resolve => setTimeout(resolve, 500 * (attempts + 1)));\n        musicKit =\n          injectedMusicKit ?? (typeof window !== \"undefined\" ? window.MusicKit : undefined);\n        if (musicKit) {\n          break;\n        }\n        attempts++;\n      }\n      if (!musicKit) {\n        throw new Error(\"MusicKit failed to load after multiple attempts\");\n      }\n    }\n\n    await musicKit.configure({\n      developerToken: process.env.NEXT_PUBLIC_APPLE_MUSIC_DEVELOPER_TOKEN || \"\",\n      app: {\n        name: \"Nonna.fm\",\n        build: \"1.0.0\",\n      },\n    });\n\n    return musicKit.getInstance();\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function authorizeAppleMusic(\n  role: \"source\" | \"target\",\n  injectedMusicKit?: MusicKitGlobal\n): Promise<string> {\n  try {\n    const music = await initializeAppleMusic(injectedMusicKit);\n    const musicUserToken = await music.authorize();\n\n    // Store auth data in localStorage\n    const authData: AuthData = {\n      accessToken: musicUserToken,\n      refreshToken: \"\", // MusicKit handles token refresh internally\n      expiresIn: 3600, // 1 hour default\n      timestamp: Date.now(),\n      userId: musicUserToken, // Use the user token as ID since it's unique per user\n      tokenType: \"Bearer\",\n      role,\n      serviceId: \"apple\",\n    };\n\n    // Store in localStorage\n    localStorage.setItem(\n      role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.TOKEN : AUTH_STORAGE_KEYS.TARGET.TOKEN,\n      JSON.stringify(authData)\n    );\n    setServiceType(role, \"apple\");\n\n    return musicUserToken;\n  } catch (error) {\n    throw error;\n  }\n}\n\n// Helper function to perform the actual search and matching for Apple Music\nasync function performSearch(\n  track: ITrack,\n  searchTerm: string,\n  authData: AuthData\n): Promise<{ songId: string | null; albumId: string | null }> {\n  const result = await retryWithExponentialBackoff<AppleMusicSearchResponse>(async () => {\n    const url = new URL(`${BASE_URL}/v1/catalog/fr/search`);\n    url.searchParams.set(\"term\", searchTerm);\n    url.searchParams.set(\"types\", \"songs\");\n    url.searchParams.set(\"limit\", \"3\");\n    url.searchParams.set(\"fields[songs]\", \"name,artistName,albumName\");\n    url.searchParams.set(\"include\", \"albums\");\n    return fetchAppleMusic(url, { method: \"GET\" }, authData);\n  }, APPLE_RETRY_OPTIONS);\n\n  if (!result.results?.songs?.data?.length) {\n    return { songId: null, albumId: null };\n  }\n\n  const matches = await Promise.all(\n    result.results.songs.data.map(async song => ({\n      song,\n      ...(await calculateTrackMatchScore(\n        track,\n        {\n          name: song.attributes.name,\n          artist: song.attributes.artistName,\n          album: song.attributes.albumName,\n        },\n        DEFAULT_TRACK_CONFIG\n      )),\n    }))\n  );\n\n  matches.sort((a: { score: number }, b: { score: number }) => b.score - a.score);\n\n  const filteredMatches = matches.filter(\n    (match: { score: number }) => match.score >= DEFAULT_TRACK_CONFIG.thresholds.minimum\n  );\n\n  if (filteredMatches.length > 0) {\n    const bestMatch = filteredMatches[0].song;\n    const albumId = bestMatch.relationships?.album?.data?.[0]?.id || null;\n    return {\n      songId: bestMatch.id,\n      albumId,\n    };\n  }\n\n  return { songId: null, albumId: null };\n}\n\n// Refactored findBestMatch to use performSearch and retry logic like Spotify\nasync function findBestMatch(\n  track: ITrack & { id: string },\n  authData: AuthData\n): Promise<{ songId: string | null; albumId: string | null }> {\n  try {\n    // Clean the track name for better matching\n    const cleanedTrack = { ...track, name: cleanTrackTitle(track.name) };\n    // First attempt with full search query\n    const searchQuery = `${cleanedTrack.name} ${track.artist}`;\n    let bestMatch = await performSearch(cleanedTrack, searchQuery, authData);\n\n    // If no good match found and track is from YouTube, retry with just the cleaned track name\n    if (!bestMatch.songId && track.videoId) {\n      const retrySearchQuery = cleanedTrack.name;\n      bestMatch = await performSearch(cleanedTrack, retrySearchQuery, authData);\n    }\n\n    return bestMatch;\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"track_search\", \"apple\", error, {\n      trackName: track.name,\n      trackArtist: track.artist,\n    });\n    return { songId: null, albumId: null };\n  }\n}\n\nexport async function search(\n  tracks: Array<ITrack>,\n  onProgress: ((progress: number) => void) | undefined\n): Promise<SearchResult> {\n  try {\n    const authData = await getAppleAuthData(\"target\");\n    if (!authData) {\n      throw new Error(\"Not authenticated with Apple Music\");\n    }\n\n    const results: Array<ITrack> = [];\n    let matched = 0;\n    let unmatched = 0;\n    let processedCount = 0;\n\n    await processInBatches(\n      async batch => {\n        const trackResults = await Promise.all(\n          batch.map(async track => {\n            const { songId, albumId } = await findBestMatch(track, authData);\n            processedCount++;\n            if (onProgress) {\n              onProgress(processedCount / tracks.length);\n            }\n            return {\n              ...track,\n              targetId: songId || undefined,\n              albumId: albumId || undefined,\n              status: songId ? MATCHING_STATUS.MATCHED : MATCHING_STATUS.UNMATCHED,\n            };\n          })\n        );\n\n        results.push(...trackResults);\n        matched += trackResults.filter(r => r.targetId).length;\n        unmatched += trackResults.filter(r => !r.targetId).length;\n      },\n      {\n        items: tracks,\n        batchSize: 10,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      matched,\n      unmatched,\n      total: tracks.length,\n      tracks: results,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function createPlaylistWithTracks(\n  name: string,\n  tracks: Array<ITrack>,\n  description?: string\n): Promise<TransferResult> {\n  try {\n    const authData = await getAppleAuthData(\"target\");\n    if (!authData) {\n      throw new Error(\"Not authenticated with Apple Music\");\n    }\n\n    // Create the playlist with retry\n    const playlistData = await retryWithExponentialBackoff<{ data: Array<{ id: string }> }>(\n      () =>\n        fetchAppleMusic(\n          `${BASE_URL}/v1/me/library/playlists`,\n          {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify({\n              attributes: {\n                name,\n                description: description || `Imported on ${new Date().toLocaleDateString()}`,\n              },\n            }),\n          },\n          authData\n        ),\n      APPLE_RETRY_OPTIONS\n    );\n\n    const playlistId = playlistData.data?.[0]?.id;\n\n    if (!playlistId) {\n      throw new Error(\"Failed to create playlist - no ID returned\");\n    }\n\n    // Filter tracks with IDs\n    const tracksWithIds = tracks.filter(\n      (track): track is ITrack & { targetId: string } => !!track.targetId\n    );\n\n    if (tracksWithIds.length === 0) {\n      return {\n        added: 0,\n        failed: tracks.length,\n        total: tracks.length,\n        playlistId,\n      };\n    }\n\n    // Add tracks to playlist\n    await retryWithExponentialBackoff(\n      () =>\n        fetchAppleMusic(\n          `${BASE_URL}/v1/me/library/playlists/${playlistId}/tracks`,\n          {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify({\n              data: tracksWithIds.map(track => ({\n                id: track.targetId,\n                type: \"songs\",\n              })),\n            }),\n          },\n          authData\n        ),\n      APPLE_RETRY_OPTIONS\n    );\n\n    return {\n      added: tracksWithIds.length,\n      failed: tracks.length - tracksWithIds.length,\n      total: tracks.length,\n      playlistId,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function addTracksToLibrary(tracks: Array<ITrack>): Promise<TransferResult> {\n  try {\n    const authData = await getAppleAuthData(\"target\");\n    if (!authData) {\n      throw new Error(\"Not authenticated with Apple Music\");\n    }\n\n    // Filter tracks with valid targetIds\n    const tracksWithIds = tracks.filter(\n      (track): track is ITrack & { targetId: string } => !!track.targetId\n    );\n\n    if (tracksWithIds.length === 0) {\n      return {\n        added: 0,\n        failed: tracks.length,\n        total: tracks.length,\n        playlistId: null,\n      };\n    }\n\n    // Add tracks to library with retry\n    await retryWithExponentialBackoff(\n      () =>\n        fetchAppleMusic(\n          `${BASE_URL}/v1/me/library`,\n          {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify({\n              data: tracksWithIds.map(track => ({\n                id: track.targetId,\n                type: \"songs\",\n              })),\n            }),\n          },\n          authData\n        ),\n      APPLE_RETRY_OPTIONS\n    );\n\n    return {\n      added: tracksWithIds.length,\n      failed: tracks.length - tracksWithIds.length,\n      total: tracks.length,\n      playlistId: null,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function addAlbumsToLibrary(albums: Set<IAlbum>): Promise<TransferResult> {\n  try {\n    const authData = await getAppleAuthData(\"target\");\n    if (!authData) {\n      throw new Error(\"Not authenticated with Apple Music\");\n    }\n\n    if (albums.size === 0) {\n      return {\n        added: 0,\n        failed: albums.size,\n        total: albums.size,\n        playlistId: null,\n      };\n    }\n\n    // Construct the URL with comma-separated album IDs\n    const albumIds = Array.from(albums)\n      .map(album => album.targetId)\n      .join(\",\");\n    const url = `${BASE_URL}/v1/me/library?ids[albums]=${albumIds}`;\n\n    // Add albums to library with retry\n    await retryWithExponentialBackoff(\n      () =>\n        fetchAppleMusic(\n          url,\n          {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\",\n            },\n          },\n          authData\n        ),\n      APPLE_RETRY_OPTIONS\n    );\n\n    return {\n      added: albums.size,\n      failed: 0, // All were added if no error\n      total: albums.size,\n      playlistId: null,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nasync function findBestAlbumMatch(\n  album: IAlbum,\n  authData: AuthData\n): Promise<{ albumId: string | null }> {\n  try {\n    // Clean search terms\n    const searchTerm = `${cleanSearchTerm(album.name)} ${cleanSearchTerm(album.artist)}`;\n\n    const result = await retryWithExponentialBackoff<{\n      results?: { albums?: { data: AppleAlbum[] } };\n    }>(async () => {\n      const url = new URL(`${BASE_URL}/v1/catalog/fr/search`);\n      url.searchParams.set(\"term\", searchTerm);\n      url.searchParams.set(\"types\", \"albums\");\n      url.searchParams.set(\"limit\", \"3\");\n      url.searchParams.set(\"fields[albums]\", \"name,artistName\");\n\n      return fetchAppleMusic(url, { method: \"GET\" }, authData);\n    }, APPLE_RETRY_OPTIONS);\n\n    // Process initial search results\n    if (!result.results?.albums?.data?.length) {\n      sentryLogger.captureMatchingError(\n        \"album_search\",\n        \"apple\",\n        new Error(`No search results found for album \"${album.name}\" by ${album.artist}`),\n        {\n          albumName: album.name,\n          albumArtist: album.artist,\n        }\n      );\n      return { albumId: null };\n    }\n\n    const matches = result.results.albums.data\n      .map((appleAlbum: AppleAlbum) => ({\n        album: appleAlbum,\n        ...calculateAlbumMatchScore(\n          album,\n          {\n            name: appleAlbum.attributes.name,\n            artist: appleAlbum.attributes.artistName,\n          },\n          DEFAULT_ALBUM_CONFIG\n        ),\n      }))\n      .sort((a: { score: number }, b: { score: number }) => b.score - a.score);\n\n    // Return best match if it meets the threshold\n    if (matches[0].score >= DEFAULT_ALBUM_CONFIG.thresholds.minimum) {\n      return { albumId: matches[0].album.id };\n    }\n\n    return { albumId: null };\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"album_search\", \"apple\", error, {\n      albumName: album.name,\n      albumArtist: album.artist,\n    });\n    return { albumId: null };\n  }\n}\n\nexport async function searchAlbums(\n  albums: Array<IAlbum>,\n  onProgress: ((progress: number) => void) | undefined\n): Promise<SearchResult> {\n  try {\n    const authData = await getAppleAuthData(\"target\");\n    if (!authData) {\n      throw new Error(\"Not authenticated with Apple Music\");\n    }\n\n    const results: Array<IAlbum> = [];\n    let matched = 0;\n    let unmatched = 0;\n    let processedCount = 0;\n\n    await processInBatches(\n      async batch => {\n        const albumResults = await Promise.all(\n          batch.map(async album => {\n            const { albumId } = await findBestAlbumMatch(album, authData);\n            processedCount++;\n            if (onProgress) {\n              onProgress(processedCount / albums.length);\n            }\n            return {\n              ...album,\n              targetId: albumId || undefined,\n              status: albumId ? MATCHING_STATUS.MATCHED : MATCHING_STATUS.UNMATCHED,\n            };\n          })\n        );\n\n        results.push(...albumResults);\n        matched += albumResults.filter(r => r.targetId).length;\n        unmatched += albumResults.filter(r => !r.targetId).length;\n      },\n      {\n        items: albums,\n        batchSize: 10,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      matched,\n      unmatched,\n      total: albums.length,\n      albums: results,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\ninterface AppleResponse<T> {\n  data: T[];\n  next?: string;\n}\n\ninterface ApplePlaylist {\n  id: string;\n  attributes: {\n    name: string;\n    trackCount: number;\n    artwork?: {\n      url: string;\n    };\n  };\n}\n\ninterface AppleSong {\n  id: string;\n  attributes: {\n    name: string;\n    artistName: string;\n    albumName: string;\n    artwork?: {\n      url: string;\n    };\n  };\n}\n\nexport async function fetchUserLibrary(): Promise<ILibraryData> {\n  const authData = await getAppleAuthData(\"source\");\n  if (!authData) throw new Error(\"Not authenticated with Apple Music\");\n\n  // Base URL for Apple Music API\n  const baseUrl = `${BASE_URL}/v1/me/library`;\n\n  // Helper function to format artwork URL\n  const formatArtworkUrl = (url: string | undefined): string | undefined => {\n    if (!url) return undefined;\n    // Replace {w} and {h} with actual dimensions\n    return url.replace(\"{w}\", \"192\").replace(\"{h}\", \"192\");\n  };\n\n  // Fetch playlists\n  const playlists: IPlaylist[] = [];\n  let nextUrl = `${baseUrl}/playlists?limit=50`;\n\n  do {\n    const data = await retryWithExponentialBackoff<AppleResponse<ApplePlaylist>>(\n      () => fetchAppleMusic(nextUrl, { method: \"GET\" }, authData),\n      APPLE_RETRY_OPTIONS\n    );\n\n    const playlistItems = data.data.map(playlist => ({\n      id: playlist.id,\n      name: playlist.attributes.name,\n      trackCount: playlist.attributes.trackCount,\n      ownerId: authData.userId,\n      artwork: formatArtworkUrl(playlist.attributes.artwork?.url),\n      tracks: [], // We'll fetch tracks when needed\n    }));\n\n    playlists.push(...playlistItems);\n    nextUrl = data.next ? `${BASE_URL}${data.next}` : \"\";\n\n    if (!nextUrl) break;\n  } while (nextUrl);\n\n  // Fetch songs from library\n  const songs = [];\n  nextUrl = `${baseUrl}/songs?limit=50`;\n\n  do {\n    const data = await retryWithExponentialBackoff<AppleResponse<AppleSong>>(\n      () => fetchAppleMusic(nextUrl, { method: \"GET\" }, authData),\n      APPLE_RETRY_OPTIONS\n    );\n\n    const songItems = data.data.map(song => ({\n      id: song.id,\n      name: song.attributes.name,\n      artist: song.attributes.artistName,\n      album: song.attributes.albumName,\n      artwork: formatArtworkUrl(song.attributes.artwork?.url),\n    }));\n\n    songs.push(...songItems);\n    nextUrl = data.next ? `${BASE_URL}${data.next}` : \"\";\n\n    if (!nextUrl) break;\n  } while (nextUrl);\n\n  // Fetch albums\n  const albums: IAlbum[] = [];\n  nextUrl = `${baseUrl}/albums?limit=50`;\n\n  do {\n    const data = await retryWithExponentialBackoff<AppleResponse<AppleAlbum>>(\n      () => fetchAppleMusic(nextUrl, { method: \"GET\" }, authData),\n      APPLE_RETRY_OPTIONS\n    );\n\n    const albumItems = data.data.map(album => ({\n      id: album.id,\n      name: album.attributes.name,\n      artist: album.attributes.artistName,\n      artwork: formatArtworkUrl(album.attributes.artwork?.url),\n    }));\n\n    albums.push(...albumItems);\n    nextUrl = data.next ? `${BASE_URL}${data.next}` : \"\";\n\n    if (!nextUrl) break;\n  } while (nextUrl);\n\n  return {\n    playlists,\n    likedSongs: songs,\n    albums,\n  };\n}\n\nexport async function fetchPlaylistTracks(\n  playlistId: string,\n  onProgress?: (tracks: ITrack[], progress: number) => void\n): Promise<ITrack[]> {\n  // Helper function to format artwork URL\n  const formatArtworkUrl = (url: string | undefined): string | undefined => {\n    if (!url) return undefined;\n    // Replace {w} and {h} with actual dimensions\n    return url.replace(\"{w}\", \"48\").replace(\"{h}\", \"48\");\n  };\n\n  const authData = await getAppleAuthData(\"source\");\n  if (!authData) throw new Error(\"Not authenticated with Apple Music\");\n\n  const tracks: ITrack[] = [];\n  let nextUrl = `${BASE_URL}/v1/me/library/playlists/${playlistId}/tracks?limit=50`;\n\n  while (nextUrl) {\n    const data = await retryWithExponentialBackoff<AppleResponse<AppleSong>>(\n      () => fetchAppleMusic(nextUrl, { method: \"GET\" }, authData),\n      {\n        ...APPLE_RETRY_OPTIONS,\n        treat404AsEmpty: true,\n      }\n    );\n\n    // Apple API does not return total, so we estimate progress by assuming 100 per page\n    const trackItems = data.data.map(item => ({\n      id: item.id,\n      name: item.attributes.name,\n      artist: item.attributes.artistName,\n      album: item.attributes.albumName,\n      artwork: formatArtworkUrl(item.attributes.artwork?.url),\n    }));\n\n    tracks.push(...trackItems);\n\n    // Call onProgress after each page\n    if (onProgress) {\n      // Estimate progress: if no nextUrl, we're done\n      const progress = data.next ? 0.99 : 1;\n      onProgress([...tracks], progress);\n    }\n\n    nextUrl = data.next ? `${BASE_URL}${data.next}` : \"\";\n  }\n\n  return tracks;\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5190, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/spotify/auth.ts"],"sourcesContent":["import {\n  encrypt,\n  decrypt,\n  generateRandomString,\n  generateCodeChallenge,\n  initializeEncryption,\n} from \"@/lib/auth/crypto\";\nimport {\n  AUTH_STORAGE_KEYS,\n  AuthData,\n  setAuthData,\n  getAuthData,\n  clearAuthData,\n  setServiceType,\n} from \"@/lib/auth/constants\";\n\nconst SOURCE_SPOTIFY_SCOPES = [\n  \"playlist-read-private\",\n  \"playlist-read-collaborative\",\n  \"user-library-read\",\n];\n\nconst TARGET_SPOTIFY_SCOPES = [\n  \"playlist-read-private\",\n  \"playlist-read-collaborative\",\n  \"user-library-read\",\n  \"playlist-modify-public\",\n  \"playlist-modify-private\",\n  \"user-library-modify\",\n];\n\ninterface SpotifyTokenResponse {\n  access_token: string;\n  token_type: string;\n  expires_in: number;\n  refresh_token: string;\n  scope: string;\n}\n\nasync function fetchSpotifyUserProfile(accessToken: string): Promise<{ id: string }> {\n  try {\n    const response = await fetch(\"https://api.spotify.com/v1/me\", {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(\"Failed to fetch user profile\");\n    }\n\n    const data = await response.json();\n    return {\n      id: data.id,\n    };\n  } catch (error) {\n    console.error(\"Error fetching user profile:\", error);\n    throw error;\n  }\n}\n\nexport async function initiateSpotifyAuth(role: \"source\" | \"target\"): Promise<void> {\n  initializeEncryption();\n\n  // Clear any existing auth data for this role\n  clearAuthData(role);\n\n  const state = {\n    value: generateRandomString(16),\n    role,\n  };\n\n  const codeVerifier = generateRandomString(64);\n  const codeChallenge = await generateCodeChallenge(codeVerifier);\n\n  // Store state and code verifier\n  const stateKey =\n    role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.STATE : AUTH_STORAGE_KEYS.TARGET.STATE;\n  const verifierKey =\n    role === \"source\"\n      ? AUTH_STORAGE_KEYS.SOURCE.CODE_VERIFIER\n      : AUTH_STORAGE_KEYS.TARGET.CODE_VERIFIER;\n\n  try {\n    localStorage.setItem(stateKey, encrypt(JSON.stringify(state)));\n    document.cookie = `${verifierKey}=${codeVerifier}; path=/; max-age=3600; SameSite=Lax`;\n  } catch (error) {\n    console.error(\"Failed to store auth data:\", error);\n    throw new Error(\"Failed to initialize authentication\");\n  }\n\n  const scopes = role === \"source\" ? SOURCE_SPOTIFY_SCOPES : TARGET_SPOTIFY_SCOPES;\n\n  const params = new URLSearchParams({\n    client_id: process.env.NEXT_PUBLIC_SPOTIFY_CLIENT_ID || \"\",\n    response_type: \"code\",\n    redirect_uri: `${process.env.NEXT_PUBLIC_APP_URL}/callback/spotify`,\n    state: JSON.stringify(state),\n    scope: scopes.join(\" \"),\n    code_challenge_method: \"S256\",\n    code_challenge: codeChallenge,\n    show_dialog: \"true\",\n  });\n\n  window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;\n}\n\nexport async function handleSpotifyCallback(\n  searchParams: string\n): Promise<{ success: boolean; role?: \"source\" | \"target\" }> {\n  console.log(\"Starting Spotify callback handling in auth.ts...\");\n\n  // Initialize encryption before handling callback\n  initializeEncryption();\n\n  if (!searchParams) {\n    console.error(\"No search params provided\");\n    return { success: false };\n  }\n\n  const params = new URLSearchParams(searchParams);\n  const code = params.get(\"code\");\n  const receivedState = params.get(\"state\");\n  const error = params.get(\"error\");\n\n  console.log(\"Received params:\", {\n    hasCode: !!code,\n    hasState: !!receivedState,\n    error: error || \"none\",\n  });\n\n  if (error) {\n    console.error(\"Spotify auth error:\", error);\n    return { success: false };\n  }\n\n  // Verify state\n  let storedState: { role: \"source\" | \"target\" } | null = null;\n  try {\n    const encryptedState =\n      localStorage.getItem(AUTH_STORAGE_KEYS.SOURCE.STATE) ||\n      localStorage.getItem(AUTH_STORAGE_KEYS.TARGET.STATE);\n    if (encryptedState) {\n      storedState = JSON.parse(decrypt(encryptedState));\n    }\n  } catch (error) {\n    console.error(\"Failed to decrypt stored state:\", error);\n    return { success: false };\n  }\n\n  if (!storedState || !receivedState) {\n    console.error(\"State missing\", {\n      hasStoredState: !!storedState,\n      hasReceivedState: !!receivedState,\n    });\n    return { success: false };\n  }\n\n  try {\n    const parsedReceivedState = JSON.parse(receivedState);\n    if (parsedReceivedState.role !== storedState.role) {\n      console.error(\"State role mismatch\");\n      return { success: false };\n    }\n  } catch (error) {\n    console.error(\"Failed to parse received state:\", error);\n    return { success: false };\n  }\n\n  // Get stored code verifier from cookies\n  let codeVerifier: string | null = null;\n  try {\n    const cookies = document.cookie.split(\";\");\n    const verifierKey =\n      storedState.role === \"source\"\n        ? AUTH_STORAGE_KEYS.SOURCE.CODE_VERIFIER\n        : AUTH_STORAGE_KEYS.TARGET.CODE_VERIFIER;\n    const verifierCookie = cookies.find(cookie => cookie.trim().startsWith(`${verifierKey}=`));\n    if (verifierCookie) {\n      // Extract everything after the equals sign, properly handling URL encoding\n      codeVerifier = decodeURIComponent(verifierCookie.split(\"=\")[1].trim());\n    }\n  } catch (error) {\n    console.error(\"Failed to get code verifier from cookies:\", error);\n    return { success: false };\n  }\n\n  if (!codeVerifier || !code) {\n    console.error(\"Missing verifier or code\", {\n      hasCodeVerifier: !!codeVerifier,\n      hasCode: !!code,\n    });\n    return { success: false };\n  }\n\n  console.log(\"State and verifier validation successful\");\n\n  // Exchange code for token with retry logic\n  console.log(\"Exchanging code for token...\");\n  let tokenResponse: Response | undefined;\n  let retryCount = 0;\n  const maxRetries = 3;\n  const backoffMs = 1000; // Start with 1 second delay\n\n  while (retryCount < maxRetries) {\n    try {\n      tokenResponse = await fetch(\"https://accounts.spotify.com/api/token\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: new URLSearchParams({\n          client_id: process.env.NEXT_PUBLIC_SPOTIFY_CLIENT_ID || \"\",\n          grant_type: \"authorization_code\",\n          code,\n          redirect_uri: process.env.NEXT_PUBLIC_SPOTIFY_REDIRECT_URI || \"\",\n          code_verifier: codeVerifier,\n        }),\n      });\n\n      if (tokenResponse.ok) {\n        break;\n      }\n\n      const errorText = await tokenResponse.text();\n      console.warn(`Token exchange attempt ${retryCount + 1} failed:`, {\n        status: tokenResponse.status,\n        statusText: tokenResponse.statusText,\n        error: errorText,\n      });\n\n      // If we get a 400 error, the code might be invalid/expired - no point retrying\n      if (tokenResponse.status === 400) {\n        console.error(\"Token exchange failed with 400 - code might be invalid or expired\");\n        return { success: false };\n      }\n\n      retryCount++;\n      if (retryCount < maxRetries) {\n        console.log(`Retrying in ${backoffMs / 1000} seconds...`);\n        await new Promise(resolve => setTimeout(resolve, backoffMs * retryCount));\n      }\n    } catch (error) {\n      console.error(`Network error during token exchange attempt ${retryCount + 1}:`, error);\n      retryCount++;\n      if (retryCount < maxRetries) {\n        console.log(`Retrying in ${backoffMs / 1000} seconds...`);\n        await new Promise(resolve => setTimeout(resolve, backoffMs * retryCount));\n      } else {\n        console.error(\"Max retries reached for token exchange\");\n        return { success: false };\n      }\n    }\n  }\n\n  if (!tokenResponse || !tokenResponse.ok) {\n    console.error(\"All token exchange attempts failed\");\n    return { success: false };\n  }\n\n  console.log(\"Token exchange successful\");\n  let tokenData: SpotifyTokenResponse;\n  try {\n    tokenData = await tokenResponse.json();\n  } catch (error) {\n    console.error(\"Failed to parse token response:\", error);\n    return { success: false };\n  }\n\n  // Clear state and verifier\n  clearAuthData(storedState.role);\n\n  // Store auth data\n  try {\n    // Fetch user profile\n    const userProfile = await fetchSpotifyUserProfile(tokenData.access_token);\n\n    const authData: AuthData = {\n      accessToken: tokenData.access_token,\n      refreshToken: tokenData.refresh_token,\n      expiresIn: tokenData.expires_in,\n      timestamp: Date.now(),\n      userId: userProfile.id,\n      tokenType: tokenData.token_type,\n      role: storedState.role,\n      serviceId: \"spotify\",\n    };\n\n    setAuthData(storedState.role, authData);\n    setServiceType(storedState.role, \"spotify\");\n    return { success: true, role: storedState.role };\n  } catch (error) {\n    console.error(\"Failed to store auth data:\", error);\n    return { success: false };\n  }\n}\n\nexport async function getSpotifyAuthData(role: \"source\" | \"target\"): Promise<AuthData | null> {\n  if (typeof window === \"undefined\") return null;\n\n  const authData = getAuthData(role);\n  if (!authData || authData.serviceId !== \"spotify\") {\n    return null;\n  }\n\n  // Check if token is expired or will expire in less than 5 minutes\n  const expirationTime = authData.timestamp + authData.expiresIn * 1000;\n  const now = Date.now();\n  const timeToExpiry = expirationTime - now;\n\n  if (timeToExpiry <= 300000 && authData.refreshToken) {\n    // 5 minutes in milliseconds\n    return refreshSpotifyToken(authData.refreshToken, role);\n  }\n\n  return authData;\n}\n\nexport async function refreshSpotifyToken(\n  refreshToken: string,\n  role: \"source\" | \"target\",\n  directRequest = false\n): Promise<AuthData | null> {\n  try {\n    if (!refreshToken || refreshToken.trim() === \"\") {\n      throw new Error(\"Empty refresh token provided\");\n    }\n\n    console.log(\"Attempting to refresh token with refresh token length:\", refreshToken?.length);\n\n    let responseData;\n    // Get existing auth data to preserve user info\n    const existingAuthData = getAuthData(role);\n\n    // For test environments, allow direct requests to Spotify API\n    if (directRequest) {\n      const clientId = process.env.NEXT_PUBLIC_SPOTIFY_CLIENT_ID;\n      const clientSecret = process.env.SPOTIFY_CLIENT_SECRET;\n\n      if (!clientId || !clientSecret) {\n        throw new Error(\"Missing Spotify client credentials\");\n      }\n\n      // Create Basic Auth header\n      const buffer = Buffer.from(`${clientId}:${clientSecret}`);\n      const base64Auth = buffer.toString(\"base64\");\n\n      const response = await fetch(\"https://accounts.spotify.com/api/token\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n          Authorization: `Basic ${base64Auth}`,\n        },\n        body: new URLSearchParams({\n          grant_type: \"refresh_token\",\n          refresh_token: refreshToken,\n          client_id: clientId,\n        }).toString(),\n      });\n\n      if (!response.ok) {\n        console.error(\"Direct Spotify API request failed:\", response.status, response.statusText);\n        return null;\n      }\n\n      responseData = await response.json();\n    } else {\n      // Use our server API endpoint (default approach)\n      const refreshUrl = `${process.env.NEXT_PUBLIC_APP_URL}/api/spotify/refresh`;\n\n      const response = await fetch(refreshUrl, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ refreshToken }),\n      });\n\n      try {\n        responseData = await response.json();\n      } catch (error) {\n        console.error(\"Failed to parse response as JSON:\", error);\n        return null;\n      }\n\n      if (!response.ok) {\n        console.error(\"Failed to refresh token:\", response.status, response.statusText);\n        console.error(\"Error details:\", responseData);\n        return null;\n      }\n    }\n\n    if (!responseData.access_token) {\n      console.error(\"Invalid token response - missing access_token:\", responseData);\n      return null;\n    }\n\n    const authData: AuthData = {\n      accessToken: responseData.access_token,\n      refreshToken: responseData.refresh_token || refreshToken, // Use old refresh token if new one is not provided\n      expiresIn: responseData.expires_in,\n      timestamp: Date.now(),\n      userId: existingAuthData?.userId || \"\",\n      tokenType: responseData.token_type || \"Bearer\",\n      role: role,\n      serviceId: \"spotify\",\n    };\n\n    setAuthData(role, authData);\n    return authData;\n  } catch (error) {\n    console.error(\"Error refreshing token:\", error);\n    return null;\n  }\n}\n\nexport function clearSpotifyAuth(role?: \"source\" | \"target\"): void {\n  if (role) {\n    clearAuthData(role);\n  } else {\n    clearAuthData(\"source\");\n    clearAuthData(\"target\");\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AAOA;;;AASA,MAAM,wBAAwB;IAC5B;IACA;IACA;CACD;AAED,MAAM,wBAAwB;IAC5B;IACA;IACA;IACA;IACA;IACA;CACD;AAUD,eAAe,wBAAwB,WAAmB;IACxD,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,iCAAiC;YAC5D,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,aAAa;YACxC;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,OAAO;YACL,IAAI,KAAK,EAAE;QACb;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF;AAEO,eAAe,oBAAoB,IAAyB;IACjE,IAAA,mKAAoB;IAEpB,6CAA6C;IAC7C,IAAA,+JAAa,EAAC;IAEd,MAAM,QAAQ;QACZ,OAAO,IAAA,mKAAoB,EAAC;QAC5B;IACF;IAEA,MAAM,eAAe,IAAA,mKAAoB,EAAC;IAC1C,MAAM,gBAAgB,MAAM,IAAA,oKAAqB,EAAC;IAElD,gCAAgC;IAChC,MAAM,WACJ,SAAS,WAAW,mKAAiB,CAAC,MAAM,CAAC,KAAK,GAAG,mKAAiB,CAAC,MAAM,CAAC,KAAK;IACrF,MAAM,cACJ,SAAS,WACL,mKAAiB,CAAC,MAAM,CAAC,aAAa,GACtC,mKAAiB,CAAC,MAAM,CAAC,aAAa;IAE5C,IAAI;QACF,aAAa,OAAO,CAAC,UAAU,IAAA,sJAAO,EAAC,KAAK,SAAS,CAAC;QACtD,SAAS,MAAM,GAAG,GAAG,YAAY,CAAC,EAAE,aAAa,oCAAoC,CAAC;IACxF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,SAAS,SAAS,WAAW,wBAAwB;IAE3D,MAAM,SAAS,IAAI,gBAAgB;QACjC,WAAW,wEAA6C;QACxD,eAAe;QACf,cAAc,kEAAmC,iBAAiB,CAAC;QACnE,OAAO,KAAK,SAAS,CAAC;QACtB,OAAO,OAAO,IAAI,CAAC;QACnB,uBAAuB;QACvB,gBAAgB;QAChB,aAAa;IACf;IAEA,OAAO,QAAQ,CAAC,IAAI,GAAG,CAAC,uCAAuC,EAAE,OAAO,QAAQ,IAAI;AACtF;AAEO,eAAe,sBACpB,YAAoB;IAEpB,QAAQ,GAAG,CAAC;IAEZ,iDAAiD;IACjD,IAAA,mKAAoB;IAEpB,IAAI,CAAC,cAAc;QACjB,QAAQ,KAAK,CAAC;QACd,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,MAAM,SAAS,IAAI,gBAAgB;IACnC,MAAM,OAAO,OAAO,GAAG,CAAC;IACxB,MAAM,gBAAgB,OAAO,GAAG,CAAC;IACjC,MAAM,QAAQ,OAAO,GAAG,CAAC;IAEzB,QAAQ,GAAG,CAAC,oBAAoB;QAC9B,SAAS,CAAC,CAAC;QACX,UAAU,CAAC,CAAC;QACZ,OAAO,SAAS;IAClB;IAEA,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,eAAe;IACf,IAAI,cAAoD;IACxD,IAAI;QACF,MAAM,iBACJ,aAAa,OAAO,CAAC,mKAAiB,CAAC,MAAM,CAAC,KAAK,KACnD,aAAa,OAAO,CAAC,mKAAiB,CAAC,MAAM,CAAC,KAAK;QACrD,IAAI,gBAAgB;YAClB,cAAc,KAAK,KAAK,CAAC,IAAA,sJAAO,EAAC;QACnC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,IAAI,CAAC,eAAe,CAAC,eAAe;QAClC,QAAQ,KAAK,CAAC,iBAAiB;YAC7B,gBAAgB,CAAC,CAAC;YAClB,kBAAkB,CAAC,CAAC;QACtB;QACA,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,IAAI;QACF,MAAM,sBAAsB,KAAK,KAAK,CAAC;QACvC,IAAI,oBAAoB,IAAI,KAAK,YAAY,IAAI,EAAE;YACjD,QAAQ,KAAK,CAAC;YACd,OAAO;gBAAE,SAAS;YAAM;QAC1B;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,wCAAwC;IACxC,IAAI,eAA8B;IAClC,IAAI;QACF,MAAM,UAAU,SAAS,MAAM,CAAC,KAAK,CAAC;QACtC,MAAM,cACJ,YAAY,IAAI,KAAK,WACjB,mKAAiB,CAAC,MAAM,CAAC,aAAa,GACtC,mKAAiB,CAAC,MAAM,CAAC,aAAa;QAC5C,MAAM,iBAAiB,QAAQ,IAAI,CAAC,CAAA,SAAU,OAAO,IAAI,GAAG,UAAU,CAAC,GAAG,YAAY,CAAC,CAAC;QACxF,IAAI,gBAAgB;YAClB,2EAA2E;YAC3E,eAAe,mBAAmB,eAAe,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;QACrE;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6CAA6C;QAC3D,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,IAAI,CAAC,gBAAgB,CAAC,MAAM;QAC1B,QAAQ,KAAK,CAAC,4BAA4B;YACxC,iBAAiB,CAAC,CAAC;YACnB,SAAS,CAAC,CAAC;QACb;QACA,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,QAAQ,GAAG,CAAC;IAEZ,2CAA2C;IAC3C,QAAQ,GAAG,CAAC;IACZ,IAAI;IACJ,IAAI,aAAa;IACjB,MAAM,aAAa;IACnB,MAAM,YAAY,MAAM,4BAA4B;IAEpD,MAAO,aAAa,WAAY;QAC9B,IAAI;YACF,gBAAgB,MAAM,MAAM,0CAA0C;gBACpE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;gBAClB;gBACA,MAAM,IAAI,gBAAgB;oBACxB,WAAW,wEAA6C;oBACxD,YAAY;oBACZ;oBACA,cAAc,mFAAgD;oBAC9D,eAAe;gBACjB;YACF;YAEA,IAAI,cAAc,EAAE,EAAE;gBACpB;YACF;YAEA,MAAM,YAAY,MAAM,cAAc,IAAI;YAC1C,QAAQ,IAAI,CAAC,CAAC,uBAAuB,EAAE,aAAa,EAAE,QAAQ,CAAC,EAAE;gBAC/D,QAAQ,cAAc,MAAM;gBAC5B,YAAY,cAAc,UAAU;gBACpC,OAAO;YACT;YAEA,+EAA+E;YAC/E,IAAI,cAAc,MAAM,KAAK,KAAK;gBAChC,QAAQ,KAAK,CAAC;gBACd,OAAO;oBAAE,SAAS;gBAAM;YAC1B;YAEA;YACA,IAAI,aAAa,YAAY;gBAC3B,QAAQ,GAAG,CAAC,CAAC,YAAY,EAAE,YAAY,KAAK,WAAW,CAAC;gBACxD,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,YAAY;YAC/D;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,4CAA4C,EAAE,aAAa,EAAE,CAAC,CAAC,EAAE;YAChF;YACA,IAAI,aAAa,YAAY;gBAC3B,QAAQ,GAAG,CAAC,CAAC,YAAY,EAAE,YAAY,KAAK,WAAW,CAAC;gBACxD,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,YAAY;YAC/D,OAAO;gBACL,QAAQ,KAAK,CAAC;gBACd,OAAO;oBAAE,SAAS;gBAAM;YAC1B;QACF;IACF;IAEA,IAAI,CAAC,iBAAiB,CAAC,cAAc,EAAE,EAAE;QACvC,QAAQ,KAAK,CAAC;QACd,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,QAAQ,GAAG,CAAC;IACZ,IAAI;IACJ,IAAI;QACF,YAAY,MAAM,cAAc,IAAI;IACtC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO;YAAE,SAAS;QAAM;IAC1B;IAEA,2BAA2B;IAC3B,IAAA,+JAAa,EAAC,YAAY,IAAI;IAE9B,kBAAkB;IAClB,IAAI;QACF,qBAAqB;QACrB,MAAM,cAAc,MAAM,wBAAwB,UAAU,YAAY;QAExE,MAAM,WAAqB;YACzB,aAAa,UAAU,YAAY;YACnC,cAAc,UAAU,aAAa;YACrC,WAAW,UAAU,UAAU;YAC/B,WAAW,KAAK,GAAG;YACnB,QAAQ,YAAY,EAAE;YACtB,WAAW,UAAU,UAAU;YAC/B,MAAM,YAAY,IAAI;YACtB,WAAW;QACb;QAEA,IAAA,6JAAW,EAAC,YAAY,IAAI,EAAE;QAC9B,IAAA,gKAAc,EAAC,YAAY,IAAI,EAAE;QACjC,OAAO;YAAE,SAAS;YAAM,MAAM,YAAY,IAAI;QAAC;IACjD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;YAAE,SAAS;QAAM;IAC1B;AACF;AAEO,eAAe,mBAAmB,IAAyB;IAChE,wCAAmC,OAAO;;;IAE1C,MAAM;IAKN,kEAAkE;IAClE,MAAM;IACN,MAAM;IACN,MAAM;AAQR;AAEO,eAAe,oBACpB,YAAoB,EACpB,IAAyB,EACzB,gBAAgB,KAAK;IAErB,IAAI;QACF,IAAI,CAAC,gBAAgB,aAAa,IAAI,OAAO,IAAI;YAC/C,MAAM,IAAI,MAAM;QAClB;QAEA,QAAQ,GAAG,CAAC,0DAA0D,cAAc;QAEpF,IAAI;QACJ,+CAA+C;QAC/C,MAAM,mBAAmB,IAAA,6JAAW,EAAC;QAErC,8DAA8D;QAC9D,IAAI,eAAe;YACjB,MAAM;YACN,MAAM,eAAe,QAAQ,GAAG,CAAC,qBAAqB;YAEtD,IAAI,CAAC,YAAY,CAAC,cAAc;gBAC9B,MAAM,IAAI,MAAM;YAClB;YAEA,2BAA2B;YAC3B,MAAM,SAAS,OAAO,IAAI,CAAC,GAAG,SAAS,CAAC,EAAE,cAAc;YACxD,MAAM,aAAa,OAAO,QAAQ,CAAC;YAEnC,MAAM,WAAW,MAAM,MAAM,0CAA0C;gBACrE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe,CAAC,MAAM,EAAE,YAAY;gBACtC;gBACA,MAAM,IAAI,gBAAgB;oBACxB,YAAY;oBACZ,eAAe;oBACf,WAAW;gBACb,GAAG,QAAQ;YACb;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,QAAQ,KAAK,CAAC,sCAAsC,SAAS,MAAM,EAAE,SAAS,UAAU;gBACxF,OAAO;YACT;YAEA,eAAe,MAAM,SAAS,IAAI;QACpC,OAAO;YACL,iDAAiD;YACjD,MAAM,aAAa,kEAAmC,oBAAoB,CAAC;YAE3E,MAAM,WAAW,MAAM,MAAM,YAAY;gBACvC,QAAQ;gBACR,SAAS;oBACP,gBAAgB;gBAClB;gBACA,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAa;YACtC;YAEA,IAAI;gBACF,eAAe,MAAM,SAAS,IAAI;YACpC,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,qCAAqC;gBACnD,OAAO;YACT;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,QAAQ,KAAK,CAAC,4BAA4B,SAAS,MAAM,EAAE,SAAS,UAAU;gBAC9E,QAAQ,KAAK,CAAC,kBAAkB;gBAChC,OAAO;YACT;QACF;QAEA,IAAI,CAAC,aAAa,YAAY,EAAE;YAC9B,QAAQ,KAAK,CAAC,kDAAkD;YAChE,OAAO;QACT;QAEA,MAAM,WAAqB;YACzB,aAAa,aAAa,YAAY;YACtC,cAAc,aAAa,aAAa,IAAI;YAC5C,WAAW,aAAa,UAAU;YAClC,WAAW,KAAK,GAAG;YACnB,QAAQ,kBAAkB,UAAU;YACpC,WAAW,aAAa,UAAU,IAAI;YACtC,MAAM;YACN,WAAW;QACb;QAEA,IAAA,6JAAW,EAAC,MAAM;QAClB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO;IACT;AACF;AAEO,SAAS,iBAAiB,IAA0B;IACzD,IAAI,MAAM;QACR,IAAA,+JAAa,EAAC;IAChB,OAAO;QACL,IAAA,+JAAa,EAAC;QACd,IAAA,+JAAa,EAAC;IAChB;AACF","debugId":null}},
    {"offset": {"line": 5562, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/spotify/types.ts"],"sourcesContent":["import type { ITrack, IAlbum, IPlaylist } from \"@/types\";\n\n// Spotify API response types\nexport interface SpotifyTrackItem {\n  track: {\n    id: string;\n    name: string;\n    artists: Array<{ name: string }>;\n    album: {\n      name: string;\n      images?: Array<{ url: string }>;\n    };\n  };\n}\n\nexport interface SpotifyTrack {\n  id: string;\n  name: string;\n  artists: Array<{ name: string }>;\n  album: {\n    name: string;\n    images?: Array<{ url: string }>;\n  };\n}\n\nexport interface SpotifyAlbum {\n  id: string;\n  name: string;\n  artists: Array<{ name: string }>;\n  images?: Array<{ url: string }>;\n}\n\nexport interface SpotifyPlaylist {\n  id: string;\n  name: string;\n  tracks: {\n    total: number;\n  };\n  owner: {\n    id: string;\n    display_name: string;\n  };\n  images?: Array<{ url: string }>;\n}\n\n// Type transformers\nexport function transformSpotifyTrackToTrack(spotifyTrack: SpotifyTrackItem[\"track\"]): ITrack {\n  return {\n    id: spotifyTrack.id,\n    name: spotifyTrack.name,\n    artist: spotifyTrack.artists[0].name,\n    album: spotifyTrack.album.name,\n    artwork: spotifyTrack.album.images?.[0]?.url,\n  };\n}\n\nexport function transformSpotifyAlbumToAlbum(spotifyAlbum: SpotifyAlbum): IAlbum {\n  return {\n    id: spotifyAlbum.id,\n    name: spotifyAlbum.name,\n    artist: spotifyAlbum.artists[0].name,\n    artwork: spotifyAlbum.images?.[0]?.url,\n  };\n}\n\nexport function transformSpotifyPlaylistToPlaylist(spotifyPlaylist: SpotifyPlaylist): IPlaylist {\n  return {\n    id: spotifyPlaylist.id,\n    name: spotifyPlaylist.name,\n    trackCount: spotifyPlaylist.tracks.total,\n    ownerId: spotifyPlaylist.owner.id,\n    tracks: [],\n    artwork: spotifyPlaylist.images?.[0]?.url,\n  };\n}\n"],"names":[],"mappings":";;;;;;;;AA8CO,SAAS,6BAA6B,YAAuC;IAClF,OAAO;QACL,IAAI,aAAa,EAAE;QACnB,MAAM,aAAa,IAAI;QACvB,QAAQ,aAAa,OAAO,CAAC,EAAE,CAAC,IAAI;QACpC,OAAO,aAAa,KAAK,CAAC,IAAI;QAC9B,SAAS,aAAa,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;IAC3C;AACF;AAEO,SAAS,6BAA6B,YAA0B;IACrE,OAAO;QACL,IAAI,aAAa,EAAE;QACnB,MAAM,aAAa,IAAI;QACvB,QAAQ,aAAa,OAAO,CAAC,EAAE,CAAC,IAAI;QACpC,SAAS,aAAa,MAAM,EAAE,CAAC,EAAE,EAAE;IACrC;AACF;AAEO,SAAS,mCAAmC,eAAgC;IACjF,OAAO;QACL,IAAI,gBAAgB,EAAE;QACtB,MAAM,gBAAgB,IAAI;QAC1B,YAAY,gBAAgB,MAAM,CAAC,KAAK;QACxC,SAAS,gBAAgB,KAAK,CAAC,EAAE;QACjC,QAAQ,EAAE;QACV,SAAS,gBAAgB,MAAM,EAAE,CAAC,EAAE,EAAE;IACxC;AACF","debugId":null}},
    {"offset": {"line": 5601, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/spotify/api.ts"],"sourcesContent":["import { getSpotifyAuthData } from \"./auth\";\nimport type {\n  ITrack,\n  ILibraryData,\n  IAlbum,\n  IPlaylist,\n  SearchResult,\n  TransferResult,\n} from \"@/types\";\nimport type { AuthData } from \"@/lib/auth/constants\";\nimport { retryWithExponentialBackoff, type RetryOptions } from \"@/lib/utils/retry\";\nimport { sentryLogger } from \"@/lib/utils/sentry-logger\";\nimport {\n  SpotifyTrackItem,\n  SpotifyTrack,\n  SpotifyAlbum,\n  SpotifyPlaylist,\n  transformSpotifyTrackToTrack,\n  transformSpotifyAlbumToAlbum,\n  transformSpotifyPlaylistToPlaylist,\n} from \"./types\";\nimport {\n  calculateTrackMatchScore,\n  calculateAlbumMatchScore,\n  DEFAULT_TRACK_CONFIG,\n  DEFAULT_ALBUM_CONFIG,\n  cleanTrackTitle,\n} from \"@/lib/utils/matching\";\nimport { processInBatches } from \"@/lib/utils/batch-processor\";\nimport { MATCHING_STATUS } from \"@/types/matching-status\";\nimport { SERVICES } from \"@/config/services\";\n\n// Base URL for Spotify API from services configuration\nconst BASE_URL = SERVICES.spotify.apiBaseUrl;\n\n// Spotify-specific retry options for all API calls\n// These values can be tuned for Spotify's rate limits and error patterns\nconst SPOTIFY_RETRY_OPTIONS: RetryOptions = {\n  maxRetries: 5, // Reasonable default for Spotify API\n  initialRetryDelay: 500, // Start with a moderate delay\n  maxRetryDelay: 32000, // Cap the delay to avoid excessive waits\n  jitterFactor: 0.1, // Add jitter to avoid thundering herd\n};\n\n// Type definition for Spotify Search API response\ninterface SpotifySearchResponse {\n  tracks?: {\n    items: SpotifyTrack[];\n    total: number;\n    limit: number;\n    offset: number;\n  };\n}\n\n// Helper function to perform the actual search and matching\nasync function performSearch(\n  track: ITrack,\n  searchQuery: string,\n  authData: AuthData\n): Promise<string | null> {\n  // Use Spotify-specific retry options for all API calls\n  const data = await retryWithExponentialBackoff<SpotifySearchResponse>(\n    () =>\n      fetch(`${BASE_URL}/search?q=${searchQuery}&type=track&limit=3`, {\n        headers: {\n          Authorization: `Bearer ${authData.accessToken}`,\n        },\n      }),\n    SPOTIFY_RETRY_OPTIONS\n  );\n\n  if (!data.tracks?.items?.length) {\n    return null;\n  }\n\n  // Find the best match using our shared matching system\n  const matchPromises = data.tracks.items.map(async (spotifyTrack: SpotifyTrack) => ({\n    track: spotifyTrack,\n    ...(await calculateTrackMatchScore(\n      track,\n      {\n        name: cleanTrackTitle(spotifyTrack.name),\n        artist: spotifyTrack.artists[0].name,\n        album: spotifyTrack.album.name,\n      },\n      DEFAULT_TRACK_CONFIG\n    )),\n  }));\n\n  const matches = await Promise.all(matchPromises);\n  matches.sort((a, b) => b.score - a.score);\n\n  // Return the ID if we have a good match (score >= minimum threshold)\n  return matches[0].score >= DEFAULT_TRACK_CONFIG.thresholds.minimum ? matches[0].track.id : null;\n}\n\nexport async function fetchUserLibrary(): Promise<ILibraryData> {\n  const authData = await getSpotifyAuthData(\"source\");\n  if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n  // Fetch playlists with batching and retry\n  const initialPlaylistResponse = await retryWithExponentialBackoff<{ total: number }>(\n    () =>\n      fetch(`${BASE_URL}/me/playlists?limit=1`, {\n        headers: {\n          Authorization: `Bearer ${authData.accessToken}`,\n        },\n      }),\n    SPOTIFY_RETRY_OPTIONS\n  );\n\n  if (!initialPlaylistResponse.total) {\n    throw new Error(\"Failed to fetch playlists count\");\n  }\n\n  const totalPlaylists = initialPlaylistResponse.total;\n  const playlistBatchSize = 50;\n  const playlistBatchCount = Math.ceil(totalPlaylists / playlistBatchSize);\n\n  const playlistResults: IPlaylist[] = [];\n  await processInBatches(\n    async batch => {\n      const offset = batch[0] * playlistBatchSize;\n      const data = await retryWithExponentialBackoff<{ items: SpotifyPlaylist[] }>(\n        () =>\n          fetch(\n            `${BASE_URL}/me/playlists?limit=${playlistBatchSize}&offset=${offset}&fields=items(id,name,tracks(total),owner(id,display_name),images)`,\n            { headers: { Authorization: `Bearer ${authData.accessToken}` } }\n          ),\n        SPOTIFY_RETRY_OPTIONS\n      );\n\n      playlistResults.push(\n        ...data.items.map((playlist: SpotifyPlaylist) =>\n          transformSpotifyPlaylistToPlaylist(playlist)\n        )\n      );\n    },\n    {\n      items: Array.from({ length: playlistBatchCount }, (_, i) => i),\n      batchSize: playlistBatchSize,\n      onBatchStart: () => {},\n    }\n  );\n\n  const playlists = playlistResults;\n\n  // Fetch saved tracks (liked songs) with batching and retry\n\n  const initialResponse = await retryWithExponentialBackoff<{ total: number }>(\n    () =>\n      fetch(`${BASE_URL}/me/tracks?limit=1&fields=total`, {\n        headers: { Authorization: `Bearer ${authData.accessToken}` },\n      }),\n    SPOTIFY_RETRY_OPTIONS\n  );\n\n  if (!initialResponse.total) {\n    throw new Error(\"Failed to fetch saved tracks count\");\n  }\n\n  const { total: totalTracks } = initialResponse;\n  const batchSize = 50;\n  const batchCount = Math.ceil(totalTracks / batchSize);\n\n  const trackResults: ITrack[] = [];\n  await processInBatches(\n    async batch => {\n      // Process multiple offsets in parallel within each batch\n      const batchPromises = batch.map(async index => {\n        const offset = index * batchSize;\n        const data = await retryWithExponentialBackoff<{ items: SpotifyTrackItem[] }>(\n          () =>\n            fetch(\n              `${BASE_URL}/me/tracks?limit=${batchSize}&offset=${offset}&fields=items(track(id,name,artists(name),album(name,images)))`,\n              { headers: { Authorization: `Bearer ${authData.accessToken}` } }\n            ),\n          SPOTIFY_RETRY_OPTIONS\n        );\n\n        return data.items.map((item: SpotifyTrackItem) => transformSpotifyTrackToTrack(item.track));\n      });\n\n      // Wait for all requests in this batch to complete\n      const batchResults = await Promise.all(batchPromises);\n      trackResults.push(...batchResults.flat());\n    },\n    {\n      items: Array.from({ length: batchCount }, (_, i) => i),\n      batchSize: 3, // Process 5 API requests in parallel at a time\n      onBatchStart: () => {},\n    }\n  );\n\n  const likedSongs = trackResults;\n\n  // Fetch saved albums with batching and retry\n  const initialAlbumsResponse = await retryWithExponentialBackoff<{ total: number }>(\n    () =>\n      fetch(`${BASE_URL}/me/albums?limit=1`, {\n        headers: { Authorization: `Bearer ${authData.accessToken}` },\n      }),\n    SPOTIFY_RETRY_OPTIONS\n  );\n\n  if (!initialAlbumsResponse.total) {\n    throw new Error(\"Failed to fetch saved albums count\");\n  }\n\n  const { total: totalAlbums } = initialAlbumsResponse;\n  const albumBatchSize = 50; // Spotify's recommended batch size for albums\n  const albumBatchCount = Math.ceil(totalAlbums / albumBatchSize);\n  const albumResults: IAlbum[] = [];\n  await processInBatches(\n    async batch => {\n      // Process multiple offsets in parallel within each batch\n      const batchPromises = batch.map(async index => {\n        const offset = index * albumBatchSize;\n        const data = await retryWithExponentialBackoff<{ items: { album: SpotifyAlbum }[] }>(\n          () =>\n            fetch(\n              `${BASE_URL}/me/albums?limit=${albumBatchSize}&offset=${offset}&fields=items(album(id,name,artists(name),images))`,\n              { headers: { Authorization: `Bearer ${authData.accessToken}` } }\n            ),\n          SPOTIFY_RETRY_OPTIONS\n        );\n\n        return data.items.map((item: { album: SpotifyAlbum }) =>\n          transformSpotifyAlbumToAlbum(item.album)\n        );\n      });\n\n      // Wait for all requests in this batch to complete\n      const batchResults = await Promise.all(batchPromises);\n      albumResults.push(...batchResults.flat());\n    },\n    {\n      items: Array.from({ length: albumBatchCount }, (_, i) => i),\n      batchSize: 3, // Process 3 API requests in parallel at a time\n      onBatchStart: () => {},\n    }\n  );\n\n  return {\n    playlists,\n    likedSongs,\n    albums: albumResults,\n  };\n}\n\nexport async function fetchPlaylistTracks(\n  playlistId: string,\n  onProgress?: (tracks: ITrack[], progress: number) => void\n): Promise<ITrack[]> {\n  const authData = await getSpotifyAuthData(\"source\");\n  if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n  // Fetch initial playlist info with retry\n  const initialResponse = await retryWithExponentialBackoff<{ total: number }>(\n    () =>\n      fetch(`${BASE_URL}/playlists/${playlistId}/tracks?limit=1&fields=total`, {\n        headers: {\n          Authorization: `Bearer ${authData.accessToken}`,\n        },\n      }),\n    SPOTIFY_RETRY_OPTIONS\n  );\n\n  if (!initialResponse.total) {\n    throw new Error(\"Failed to fetch playlist tracks count\");\n  }\n\n  const { total } = initialResponse;\n  const batchSize = 50;\n  const batchCount = Math.ceil(total / batchSize);\n  const trackResults: ITrack[] = [];\n  let loadedCount = 0;\n  await processInBatches(\n    async batch => {\n      // Process multiple offsets in parallel within each batch\n      const batchPromises = batch.map(async index => {\n        const offset = index * batchSize;\n        const data = await retryWithExponentialBackoff<{ items: SpotifyTrackItem[] }>(\n          () =>\n            fetch(\n              `${BASE_URL}/playlists/${playlistId}/tracks?limit=${batchSize}&offset=${offset}&fields=items(track(id,name,artists(name),album(name,images)))`,\n              {\n                headers: {\n                  Authorization: `Bearer ${authData.accessToken}`,\n                },\n              }\n            ),\n          SPOTIFY_RETRY_OPTIONS\n        );\n\n        return data.items.map((item: SpotifyTrackItem) => transformSpotifyTrackToTrack(item.track));\n      });\n\n      // Wait for all requests in this batch to complete\n      const batchResults = await Promise.all(batchPromises);\n      const flatBatch = batchResults.flat();\n      trackResults.push(...flatBatch);\n      loadedCount += flatBatch.length;\n      // Call onProgress with a shallow copy of the loaded tracks and progress ratio\n      if (onProgress) {\n        onProgress([...trackResults], Math.min(loadedCount / total, 1));\n      }\n    },\n    {\n      items: Array.from({ length: batchCount }, (_, i) => i),\n      batchSize: 1, // Process 3 API requests in parallel at a time\n      onBatchStart: () => {},\n    }\n  );\n\n  return trackResults;\n}\n\nasync function findBestMatch(track: ITrack, authData: AuthData): Promise<string | null> {\n  try {\n    // Clean the source track name for better matching\n    const cleanedTrack = { ...track, name: cleanTrackTitle(track.name) };\n    // First attempt with full search query\n    const searchQuery = encodeURIComponent(`${cleanedTrack.name} ${track.artist}`);\n    let bestMatch = await performSearch(cleanedTrack, searchQuery, authData);\n\n    // If no good match found and track is from YouTube, retry with just the cleaned track name\n    if (bestMatch === null && track.videoId) {\n      const retrySearchQuery = encodeURIComponent(cleanedTrack.name);\n      bestMatch = await performSearch(cleanedTrack, retrySearchQuery, authData);\n    }\n\n    return bestMatch;\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"track_search\", \"spotify\", error, {\n      trackName: track.name,\n      trackArtist: track.artist,\n    });\n    return null;\n  }\n}\n\nexport async function search(\n  tracks: Array<ITrack>,\n  onProgress: ((progress: number) => void) | undefined\n): Promise<SearchResult> {\n  const authData = await getSpotifyAuthData(\"target\");\n  if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n  const results: Array<ITrack> = [];\n  let matched = 0;\n  let unmatched = 0;\n  let processedCount = 0;\n\n  // Process tracks in batches\n  await processInBatches(\n    async batch => {\n      const trackResults = await Promise.all(\n        batch.map(async track => {\n          const targetId = await findBestMatch(track, authData);\n          processedCount++;\n          if (onProgress) {\n            onProgress(processedCount / tracks.length);\n          }\n          return {\n            ...track,\n            targetId: targetId || undefined,\n            status: targetId ? MATCHING_STATUS.MATCHED : MATCHING_STATUS.UNMATCHED,\n          };\n        })\n      );\n\n      results.push(...trackResults);\n      matched += trackResults.filter(r => r.targetId).length;\n      unmatched += trackResults.filter(r => !r.targetId).length;\n    },\n    {\n      items: tracks,\n      batchSize: 4,\n      delayBetweenBatches: 200,\n      onBatchStart: () => {},\n    }\n  );\n\n  return {\n    matched,\n    unmatched,\n    total: tracks.length,\n    tracks: results,\n  };\n}\n\nexport async function createPlaylistWithTracks(\n  name: string,\n  tracks: Array<ITrack>,\n  description?: string\n): Promise<TransferResult> {\n  try {\n    const authData = await getSpotifyAuthData(\"target\");\n    if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n    // Create the playlist using retryWithExponentialBackoff\n    const playlistData = await retryWithExponentialBackoff<unknown>(\n      () =>\n        fetch(`${BASE_URL}/me/playlists`, {\n          method: \"POST\",\n          headers: {\n            Authorization: `Bearer ${authData.accessToken}`,\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify({\n            name,\n            description: description || `Imported on ${new Date().toLocaleDateString()}`,\n          }),\n        }),\n      SPOTIFY_RETRY_OPTIONS\n    );\n\n    // The util parses JSON if available, so we can safely cast\n    const playlistId = (playlistData as { id?: string }).id;\n    if (!playlistId) {\n      throw new Error(\"Failed to create playlist - no ID returned\");\n    }\n\n    // Filter tracks with valid targetIds\n    const tracksWithIds = tracks.filter(\n      (track): track is ITrack & { targetId: string } => !!track.targetId\n    );\n\n    if (tracksWithIds.length === 0) {\n      return {\n        added: 0,\n        failed: tracks.length,\n        total: tracks.length,\n        playlistId,\n      };\n    }\n\n    // Add tracks to playlist in batches using retryWithExponentialBackoff\n    const result = await processInBatches(\n      async batch => {\n        const uris = batch.map(track => `spotify:track:${track.targetId}`);\n        await retryWithExponentialBackoff<unknown>(\n          () =>\n            fetch(`${BASE_URL}/playlists/${playlistId}/tracks`, {\n              method: \"POST\",\n              headers: {\n                Authorization: `Bearer ${authData.accessToken}`,\n                \"Content-Type\": \"application/json\",\n              },\n              body: JSON.stringify({ uris }),\n            }),\n          SPOTIFY_RETRY_OPTIONS\n        );\n      },\n      {\n        items: tracksWithIds,\n        batchSize: 100,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      ...result,\n      playlistId,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function addTracksToLibrary(tracks: Array<ITrack>): Promise<TransferResult> {\n  try {\n    const authData = await getSpotifyAuthData(\"target\");\n    if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n    // Filter tracks with valid targetIds\n    const tracksWithIds = tracks.filter(\n      (track): track is ITrack & { targetId: string } => !!track.targetId\n    );\n\n    if (tracksWithIds.length === 0) {\n      return {\n        added: 0,\n        failed: tracks.length,\n        total: tracks.length,\n        playlistId: null,\n      };\n    }\n\n    // Add tracks to library in batches using retryWithExponentialBackoff\n    const result = await processInBatches(\n      async batch => {\n        const ids = batch.map(track => track.targetId);\n        await retryWithExponentialBackoff<unknown>(\n          () =>\n            fetch(`${BASE_URL}/me/tracks`, {\n              method: \"PUT\",\n              headers: {\n                Authorization: `Bearer ${authData.accessToken}`,\n                \"Content-Type\": \"application/json\",\n              },\n              body: JSON.stringify({ ids }),\n            }),\n          SPOTIFY_RETRY_OPTIONS\n        );\n      },\n      {\n        items: tracksWithIds,\n        batchSize: 50,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      ...result,\n      playlistId: null,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function addAlbumsToLibrary(albums: Set<IAlbum>): Promise<TransferResult> {\n  try {\n    const authData = await getSpotifyAuthData(\"target\");\n    if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n    // Convert Set/Array to Array and filter albums with valid targetIds\n    const albumsWithIds = (Array.isArray(albums) ? albums : Array.from(albums)).filter(\n      (album): album is IAlbum & { targetId: string } => !!album.targetId\n    );\n\n    if (albumsWithIds.length === 0) {\n      throw new Error(\"No albums with valid targetIds found\");\n    }\n\n    // Add albums to library in batches using retryWithExponentialBackoff\n    const result = await processInBatches(\n      async batch => {\n        const ids = batch.map(album => album.targetId);\n        await retryWithExponentialBackoff<unknown>(\n          () =>\n            fetch(`${BASE_URL}/me/albums`, {\n              method: \"PUT\",\n              headers: {\n                Authorization: `Bearer ${authData.accessToken}`,\n                \"Content-Type\": \"application/json\",\n              },\n              body: JSON.stringify({ ids }),\n            }),\n          SPOTIFY_RETRY_OPTIONS\n        );\n      },\n      {\n        items: albumsWithIds,\n        batchSize: 20,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      ...result,\n      playlistId: null,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nasync function findBestAlbumMatch(album: IAlbum, authData: AuthData): Promise<string | null> {\n  try {\n    // Clean and encode the search query\n    const searchQuery = encodeURIComponent(`${album.name} ${album.artist}`);\n\n    // Search for albums with retry\n    const response = await retryWithExponentialBackoff<{ albums: { items: SpotifyAlbum[] } }>(\n      () =>\n        fetch(`${BASE_URL}/search?q=${searchQuery}&type=album&limit=10`, {\n          headers: {\n            Authorization: `Bearer ${authData.accessToken}`,\n          },\n        }),\n      SPOTIFY_RETRY_OPTIONS\n    );\n\n    if (!response.albums?.items?.length) {\n      sentryLogger.captureMatchingError(\n        \"album_search\",\n        \"spotify\",\n        new Error(`No search results found for album \"${album.name}\" by ${album.artist}`),\n        {\n          albumName: album.name,\n          albumArtist: album.artist,\n        }\n      );\n      return null;\n    }\n\n    // Find the best match using our shared matching system\n    const matches = response.albums.items\n      .map((spotifyAlbum: SpotifyAlbum) => ({\n        album: spotifyAlbum,\n        ...calculateAlbumMatchScore(\n          album,\n          {\n            name: spotifyAlbum.name,\n            artist: spotifyAlbum.artists[0].name,\n          },\n          DEFAULT_ALBUM_CONFIG\n        ),\n      }))\n      .sort((a: { score: number }, b: { score: number }) => b.score - a.score);\n\n    // Return the ID if we have a good match (score >= minimum threshold)\n    return matches[0].score >= DEFAULT_ALBUM_CONFIG.thresholds.minimum ? matches[0].album.id : null;\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"album_search\", \"spotify\", error, {\n      albumName: album.name,\n      albumArtist: album.artist,\n    });\n    return null;\n  }\n}\n\nexport async function searchAlbums(\n  albums: Array<IAlbum>,\n  onProgress: ((progress: number) => void) | undefined\n): Promise<SearchResult> {\n  try {\n    const authData = await getSpotifyAuthData(\"target\");\n    if (!authData) throw new Error(\"Not authenticated with Spotify\");\n\n    const results: Array<IAlbum> = [];\n    let matched = 0;\n    let unmatched = 0;\n    let processedCount = 0;\n\n    // Process albums in batches\n    await processInBatches(\n      async batch => {\n        const albumResults = await Promise.all(\n          batch.map(async album => {\n            const spotifyId = await findBestAlbumMatch(album, authData);\n            processedCount++;\n            if (onProgress) {\n              onProgress(processedCount / albums.length);\n            }\n            return {\n              ...album,\n              targetId: spotifyId || undefined,\n              status: spotifyId ? MATCHING_STATUS.MATCHED : MATCHING_STATUS.UNMATCHED,\n            };\n          })\n        );\n\n        results.push(...albumResults);\n        matched += albumResults.filter(r => r.targetId).length;\n        unmatched += albumResults.filter(r => !r.targetId).length;\n      },\n      {\n        items: albums,\n        batchSize: 4,\n        delayBetweenBatches: 200,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      matched,\n      unmatched,\n      total: albums.length,\n      albums: results,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 6096, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/youtube/auth.ts"],"sourcesContent":["import {\n  encrypt,\n  decrypt,\n  generateRandomString,\n  generateCodeChallenge,\n  initializeEncryption,\n} from \"@/lib/auth/crypto\";\nimport {\n  AUTH_STORAGE_KEYS,\n  AuthData,\n  setAuthData,\n  getAuthData,\n  clearAuthData,\n  setServiceType,\n} from \"@/lib/auth/constants\";\n\n// Readonly scope for source role\nconst YOUTUBE_READ_SCOPES = [\"https://www.googleapis.com/auth/youtube.readonly\"].join(\" \");\n\n// Write scopes for target role\nconst YOUTUBE_WRITE_SCOPES = [\"https://www.googleapis.com/auth/youtube\"].join(\" \");\n\ninterface YouTubeTokenResponse {\n  access_token: string;\n  token_type: string;\n  expires_in: number;\n  refresh_token: string;\n  scope: string;\n}\n\nexport async function initiateYouTubeAuth(role: \"source\" | \"target\"): Promise<void> {\n  initializeEncryption();\n\n  // Clear any existing auth data for this role\n  clearAuthData(role);\n\n  const state = {\n    value: generateRandomString(16),\n    role,\n  };\n\n  const codeVerifier = generateRandomString(64);\n  const codeChallenge = await generateCodeChallenge(codeVerifier);\n\n  // Store state and code verifier\n  const stateKey =\n    role === \"source\" ? AUTH_STORAGE_KEYS.SOURCE.STATE : AUTH_STORAGE_KEYS.TARGET.STATE;\n  const verifierKey =\n    role === \"source\"\n      ? AUTH_STORAGE_KEYS.SOURCE.CODE_VERIFIER\n      : AUTH_STORAGE_KEYS.TARGET.CODE_VERIFIER;\n\n  try {\n    localStorage.setItem(stateKey, encrypt(JSON.stringify(state)));\n    document.cookie = `${verifierKey}=${codeVerifier}; path=/; max-age=3600; SameSite=Lax`;\n  } catch (error) {\n    console.error(\"Failed to store auth data:\", error);\n    throw new Error(\"Failed to initialize authentication\");\n  }\n\n  // Use appropriate scopes based on role\n  const scopes = role === \"source\" ? YOUTUBE_READ_SCOPES : YOUTUBE_WRITE_SCOPES;\n\n  const params = new URLSearchParams({\n    client_id: process.env.NEXT_PUBLIC_YOUTUBE_CLIENT_ID || \"\",\n    response_type: \"code\",\n    redirect_uri: `${process.env.NEXT_PUBLIC_APP_URL}/callback/youtube`,\n    state: JSON.stringify(state),\n    scope: scopes,\n    access_type: \"offline\",\n    code_challenge_method: \"S256\",\n    code_challenge: codeChallenge,\n    prompt: \"consent\",\n  });\n\n  if (!process.env.NEXT_PUBLIC_YOUTUBE_CLIENT_ID || !process.env.NEXT_PUBLIC_APP_URL) {\n    throw new Error(\"Missing required YouTube configuration\");\n  }\n\n  window.location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;\n}\n\nexport async function handleYouTubeCallback(\n  searchParams: string\n): Promise<{ success: boolean; role?: \"source\" | \"target\"; error?: string }> {\n  console.log(\"Starting YouTube callback handling...\");\n\n  initializeEncryption();\n\n  if (!searchParams) {\n    console.error(\"No search params provided\");\n    return { success: false };\n  }\n\n  const params = new URLSearchParams(searchParams);\n  const code = params.get(\"code\");\n  const receivedState = params.get(\"state\");\n  const error = params.get(\"error\");\n\n  console.log(\"Received callback request\");\n\n  if (error) {\n    console.error(\"YouTube auth error occurred\");\n    return { success: false };\n  }\n\n  // Verify state\n  let storedState: { role: \"source\" | \"target\" } | null = null;\n  try {\n    const encryptedState =\n      localStorage.getItem(AUTH_STORAGE_KEYS.SOURCE.STATE) ||\n      localStorage.getItem(AUTH_STORAGE_KEYS.TARGET.STATE);\n    if (encryptedState) {\n      storedState = JSON.parse(decrypt(encryptedState));\n    }\n  } catch {\n    console.error(\"State validation failed\");\n    return { success: false };\n  }\n\n  if (!storedState || !receivedState) {\n    console.error(\"State validation failed\");\n    return { success: false };\n  }\n\n  try {\n    const parsedReceivedState = JSON.parse(receivedState);\n    if (parsedReceivedState.role !== storedState.role) {\n      console.error(\"State role validation failed\");\n      return { success: false };\n    }\n  } catch {\n    console.error(\"State validation failed\");\n    return { success: false };\n  }\n\n  // Get stored code verifier from cookies\n  let codeVerifier: string | null = null;\n  try {\n    const cookies = document.cookie.split(\";\");\n    const verifierKey =\n      storedState.role === \"source\"\n        ? AUTH_STORAGE_KEYS.SOURCE.CODE_VERIFIER\n        : AUTH_STORAGE_KEYS.TARGET.CODE_VERIFIER;\n    const verifierCookie = cookies.find(cookie => cookie.trim().startsWith(`${verifierKey}=`));\n    if (verifierCookie) {\n      codeVerifier = verifierCookie.split(\"=\")[1].trim();\n    }\n  } catch (error) {\n    console.error(\"Failed to get code verifier from cookies:\", error);\n    return { success: false };\n  }\n\n  if (!codeVerifier || !code) {\n    console.error(\"Missing verifier or code\");\n    return { success: false };\n  }\n\n  console.log(\"State validation successful\");\n\n  // Exchange code for token\n  console.log(\"Starting token exchange...\");\n  let tokenResponse: Response;\n  try {\n    tokenResponse = await fetch(\"/api/auth/youtube/callback\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        code,\n        codeVerifier,\n      }),\n    });\n  } catch {\n    console.error(\"Network error during token exchange\");\n    return { success: false };\n  }\n\n  if (!tokenResponse.ok) {\n    await tokenResponse.text(); // Consume the response\n    console.error(\"Token exchange failed\");\n    return { success: false };\n  }\n\n  console.log(\"Token exchange successful\");\n  let tokenData: YouTubeTokenResponse;\n  try {\n    tokenData = await tokenResponse.json();\n  } catch (error) {\n    console.error(\"Failed to parse token response:\", error);\n    return { success: false };\n  }\n\n  // Clear state and verifier\n  clearAuthData(storedState.role);\n\n  // Store auth data and fetch user profile\n  try {\n    const userProfile = await fetchYouTubeUserProfile(tokenData.access_token);\n\n    const authData: AuthData = {\n      accessToken: tokenData.access_token,\n      refreshToken: tokenData.refresh_token,\n      expiresIn: tokenData.expires_in,\n      timestamp: Date.now(),\n      userId: userProfile.id,\n      tokenType: tokenData.token_type,\n      role: storedState.role,\n      serviceId: \"youtube\",\n    };\n\n    setAuthData(storedState.role, authData);\n    setServiceType(storedState.role, \"youtube\");\n    return { success: true, role: storedState.role };\n  } catch (error) {\n    console.error(\"Failed to store auth data or fetch user profile:\", error);\n\n    if (error instanceof Error && error.message === \"No channel found for user\") {\n      return {\n        success: false,\n        error: \"You don't have a YouTube channel. Please create one to continue.\",\n        role: storedState.role,\n      };\n    }\n\n    return { success: false };\n  }\n}\n\nexport async function refreshYouTubeToken(\n  refreshToken: string,\n  role: \"source\" | \"target\",\n  directRequest = false\n): Promise<AuthData | null> {\n  try {\n    if (!refreshToken || refreshToken.trim() === \"\") {\n      throw new Error(\"Empty refresh token provided\");\n    }\n\n    console.log(\n      \"Attempting to refresh YouTube token with refresh token length:\",\n      refreshToken?.length\n    );\n\n    // Get existing auth data to preserve user info\n    const existingAuthData = getAuthData(role);\n\n    let responseData;\n\n    if (directRequest) {\n      const clientId = process.env.NEXT_PUBLIC_YOUTUBE_CLIENT_ID;\n      const clientSecret = process.env.YOUTUBE_CLIENT_SECRET;\n\n      if (!clientId || !clientSecret) {\n        throw new Error(\"Missing YouTube client credentials\");\n      }\n\n      const response = await fetch(\"https://oauth2.googleapis.com/token\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: new URLSearchParams({\n          client_id: clientId,\n          client_secret: clientSecret,\n          refresh_token: refreshToken,\n          grant_type: \"refresh_token\",\n        }).toString(),\n      });\n\n      if (!response.ok) {\n        console.error(\"Direct YouTube API request failed:\", response.status, response.statusText);\n        return null;\n      }\n\n      responseData = await response.json();\n    } else {\n      const response = await fetch(\"/api/auth/youtube/refresh\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ refreshToken }),\n      });\n\n      if (!response.ok) {\n        console.error(\"Failed to refresh token:\", response.status, response.statusText);\n        return null;\n      }\n\n      responseData = await response.json();\n    }\n\n    if (!responseData.access_token) {\n      console.error(\"Invalid token response - missing access_token:\", responseData);\n      return null;\n    }\n\n    const authData: AuthData = {\n      accessToken: responseData.access_token,\n      refreshToken: responseData.refresh_token || refreshToken, // Use old refresh token if new one is not provided\n      expiresIn: responseData.expires_in,\n      timestamp: Date.now(),\n      userId: existingAuthData?.userId || \"\",\n      tokenType: responseData.token_type || \"Bearer\",\n      role: role,\n      serviceId: \"youtube\",\n    };\n\n    setAuthData(role, authData);\n    return authData;\n  } catch (error) {\n    console.error(\"Error refreshing token:\", error);\n    return null;\n  }\n}\n\nexport async function getYouTubeAuthData(role: \"source\" | \"target\"): Promise<AuthData | null> {\n  if (typeof window === \"undefined\") return null;\n\n  const authData = getAuthData(role);\n  if (!authData || authData.serviceId !== \"youtube\") {\n    return null;\n  }\n\n  // Check if token is expired or about to expire (within 5 minutes)\n  const expirationTime = authData.timestamp + authData.expiresIn * 1000;\n  const now = Date.now();\n  const expirationThreshold = 5 * 60 * 1000; // 5 minutes in milliseconds\n  const isExpired = now >= expirationTime - expirationThreshold;\n\n  // If token is expired and we have a refresh token, try to refresh\n  if (isExpired && authData.refreshToken) {\n    console.log(\"Starting token refresh...\");\n    const updatedAuthData = await refreshYouTubeToken(authData.refreshToken, role);\n\n    if (updatedAuthData) {\n      console.log(\"Token refresh successful\");\n      return updatedAuthData;\n    } else {\n      console.error(\"Token refresh failed, clearing auth data\");\n      clearAuthData(role);\n      return null;\n    }\n  } else if (isExpired) {\n    // Token is expired and we don't have a refresh token\n    console.log(\"Auth token expired, no refresh token available\");\n    clearAuthData(role);\n    return null;\n  }\n\n  // Token is still valid\n  return authData;\n}\n\nexport function clearYouTubeAuth(role?: \"source\" | \"target\"): void {\n  if (role) {\n    clearAuthData(role);\n  } else {\n    clearAuthData(\"source\");\n    clearAuthData(\"target\");\n  }\n}\n\nasync function fetchYouTubeUserProfile(accessToken: string): Promise<{ id: string }> {\n  try {\n    const response = await fetch(\n      \"https://www.googleapis.com/youtube/v3/channels?part=id&mine=true\",\n      {\n        headers: {\n          Authorization: `Bearer ${accessToken}`,\n        },\n      }\n    );\n\n    if (!response.ok) {\n      throw new Error(\"Failed to fetch user profile\");\n    }\n\n    const data = await response.json();\n    if (!data.items || data.items.length === 0) {\n      throw new Error(\"No channel found for user\");\n    }\n\n    return {\n      id: data.items[0].id,\n    };\n  } catch (error) {\n    console.error(\"Error fetching YouTube user profile:\", error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 6418, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/youtube/ytmusic-adapter.ts"],"sourcesContent":["import type { IAlbum, ITrack } from \"@/types\";\nimport { MATCHING_STATUS } from \"@/types\";\nimport { getYouTubeAuthData } from \"./auth\";\n\n// Define types for the search result items from ytmusic-api\ninterface YTMusicSearchItem {\n  videoId: string;\n  albumId?: string;\n  name: string;\n  artist?: { artistId: string | null; name: string };\n  album?: { name: string; albumId: string };\n  thumbnails?: Array<{ url: string; width: number; height: number }>;\n  type?: \"SONG\" | \"VIDEO\" | \"ALBUM\";\n}\n\ninterface YTMusicApiParams {\n  query?: string;\n  playlistId?: string;\n  albumId?: string;\n  [key: string]: unknown;\n}\n\ninterface YTMusicApiResponse<T> {\n  data: T;\n}\n\ninterface YouTubePlaylistItemsResponse {\n  items: Array<{\n    snippet: {\n      resourceId: {\n        videoId: string;\n      };\n      title: string;\n      channelTitle: string;\n      thumbnails: {\n        default?: { url: string };\n        medium?: { url: string };\n        high?: { url: string };\n      };\n    };\n  }>;\n}\n\n/**\n * Returns an absolute URL for the YouTube Music API proxy.\n * In Node.js (test) environments, fetch requires an absolute URL.\n * Uses NEXT_PUBLIC_APP_URL or defaults to http://localhost:3000.\n */\nfunction getYouTubeApiUrl(path: string): string {\n  // If already absolute, return as is\n  if (/^https?:\\/\\//.test(path)) return path;\n  // Use env or fallback\n\n  const base = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\";\n  // Ensure no double slashes\n  return base.replace(/\\/$/, \"\") + (path.startsWith(\"/\") ? path : \"/\" + path);\n}\n\n/**\n * Adapter that integrates with the YouTube Music API through a server-side proxy\n */\nexport class YTMusicAdapter {\n  private initialized: boolean = false;\n  private currentRole: \"source\" | \"target\" | null = null;\n\n  constructor() {}\n\n  /**\n   * Initialize connection to the YouTube Music API\n   */\n  async initialize(role: \"source\" | \"target\"): Promise<boolean> {\n    try {\n      const authData = await getYouTubeAuthData(role);\n      if (!authData) {\n        return false;\n      }\n\n      // Make a test API call to verify connectivity\n      const testResult = await this.makeApiCall<YTMusicSearchItem[]>(\n        \"search\",\n        { query: \"test\" },\n        authData.accessToken\n      );\n      if (!testResult) {\n        return false;\n      }\n\n      this.initialized = true;\n      this.currentRole = role;\n      return true;\n    } catch (error) {\n      console.error(\"Failed to initialize YTMusic:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Make a call to our YouTube Music API proxy\n   */\n  private async makeApiCall<T>(\n    method: string,\n    params: YTMusicApiParams,\n    token: string\n  ): Promise<T> {\n    try {\n      // Use absolute URL for Node.js compatibility\n      const url = getYouTubeApiUrl(\"/api/youtube/music\");\n\n      const response = await fetch(url, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          method,\n          params,\n          token,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`API call failed: ${errorText}`);\n      }\n\n      const result = (await response.json()) as YTMusicApiResponse<T>;\n      return result.data;\n    } catch (error) {\n      console.error(`Error in API call ${method}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Search for songs with improved YouTube Music results\n   */\n  async search(query: string): Promise<ITrack[]> {\n    if (!this.initialized) {\n      await this.initialize(\"source\");\n    }\n\n    try {\n      const authData = await getYouTubeAuthData(this.currentRole || \"source\");\n      if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n      const results = await this.makeApiCall<YTMusicSearchItem[]>(\n        \"search\",\n        { query },\n        authData.accessToken\n      );\n\n      // Map the YTMusic search results to our ITrack format\n      return results\n        .filter(item => item.type === \"SONG\")\n        .map((item: YTMusicSearchItem) => ({\n          id: item.videoId || \"\",\n          name: item.name || \"Unknown Track\",\n          artist: item.artist?.name || \"Unknown Artist\",\n          album: item.album?.name || \"Unknown Album\",\n          artwork: item.thumbnails?.[0]?.url,\n        }));\n    } catch (error) {\n      console.error(`Error searching for \"${query}\":`, error);\n      return [];\n    }\n  }\n\n  /**\n   * Get user's library with better structured data\n   */\n  async getLikedSongs(): Promise<ITrack[]> {\n    if (!this.initialized) {\n      await this.initialize(\"source\");\n    }\n\n    try {\n      const authData = await getYouTubeAuthData(this.currentRole || \"source\");\n      if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n      // Get liked songs using the YouTube Data API v3\n      const url = new URL(\"https://www.googleapis.com/youtube/v3/playlistItems\");\n      url.searchParams.append(\"part\", \"snippet\");\n      url.searchParams.append(\"playlistId\", \"LM\");\n      url.searchParams.append(\"maxResults\", \"50\");\n\n      const response = await fetch(url.toString(), {\n        headers: {\n          Authorization: `Bearer ${authData.accessToken}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch liked songs\");\n      }\n\n      const data = (await response.json()) as YouTubePlaylistItemsResponse;\n\n      // Map to our format\n      return (data.items || []).map(item => ({\n        id: item.snippet.resourceId.videoId || \"\",\n        name: item.snippet.title || \"Unknown Track\",\n        artist: item.snippet.channelTitle || \"Unknown Artist\",\n        album: \"YouTube Music\",\n        artwork:\n          item.snippet.thumbnails?.high?.url ||\n          item.snippet.thumbnails?.medium?.url ||\n          item.snippet.thumbnails?.default?.url,\n      }));\n    } catch (error) {\n      console.error(\"Error fetching liked songs:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get songs matching search criteria for a batch of tracks\n   * Used for matching source tracks to YouTube Music tracks\n   */\n  async findMatchingTracks(\n    tracks: Array<ITrack>\n  ): Promise<Array<ITrack & { targetId?: string; status?: \"matched\" | \"unmatched\" }>> {\n    if (!this.initialized) {\n      await this.initialize(\"target\");\n    }\n\n    const authData = await getYouTubeAuthData(this.currentRole || \"target\");\n    if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n    return Promise.all(\n      tracks.map(async track => {\n        try {\n          // Construct a search query combining track name and artist\n          const searchQuery = `${track.name} ${track.artist}`;\n          // Use searchSongs to get more accurate song matches\n          const searchResults = await this.makeApiCall<YTMusicSearchItem[]>(\n            \"searchSongs\",\n            { query: searchQuery },\n            authData.accessToken\n          );\n\n          // With searchSongs, we should already have only song results\n          const songMatch = searchResults.find(item => item.type === \"SONG\");\n\n          return {\n            ...track,\n            targetId: songMatch?.videoId || undefined,\n            status: songMatch?.videoId ? MATCHING_STATUS.MATCHED : MATCHING_STATUS.UNMATCHED,\n          };\n        } catch (error) {\n          console.error(`Error finding match for track \"${track.name}\":`, error);\n          return {\n            ...track,\n            status: MATCHING_STATUS.UNMATCHED,\n          };\n        }\n      })\n    );\n  }\n\n  /**\n   * Find matching albums in YouTube Music\n   * Used for matching source albums to YouTube Music albums\n   */\n  async findMatchingAlbums(albums: IAlbum[]): Promise<IAlbum[]> {\n    if (!this.initialized) {\n      await this.initialize(\"target\");\n    }\n\n    const authData = await getYouTubeAuthData(this.currentRole || \"target\");\n    if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n    return Promise.all(\n      albums.map(async album => {\n        try {\n          // Construct a search query combining album name and artist\n          const searchQuery = `${album.name} ${album.artist}`;\n\n          // Search for albums\n          const searchResults = await this.makeApiCall<YTMusicSearchItem[]>(\n            \"searchAlbums\",\n            { query: searchQuery },\n            authData.accessToken\n          );\n\n          // Find the best album match\n          const albumMatch = searchResults.find(\n            item => item.type === \"ALBUM\" && item.albumId // Ensure it has a browseId\n          );\n\n          const result = {\n            ...album,\n            targetId: albumMatch?.albumId || undefined,\n            status: albumMatch?.albumId ? MATCHING_STATUS.MATCHED : MATCHING_STATUS.UNMATCHED,\n          };\n\n          return result;\n        } catch (error) {\n          console.error(`Error finding match for album \"${album.name}\":`, error);\n          return {\n            ...album,\n            status: MATCHING_STATUS.UNMATCHED,\n          };\n        }\n      })\n    );\n  }\n}\n\n// Singleton instance\nexport const ytmusicAdapter = new YTMusicAdapter();\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 6631, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/youtube/api.ts"],"sourcesContent":["import { getYouTubeAuthData } from \"./auth\";\nimport { YTMusicAdapter } from \"./ytmusic-adapter\";\nimport type { ITrack, ILibraryData, IAlbum, SearchResult, TransferResult } from \"@/types\";\nimport { retryWithExponentialBackoff } from \"@/lib/utils/retry\";\nimport { processInBatches } from \"@/lib/utils/batch-processor\";\nimport { sentryLogger } from \"@/lib/utils/sentry-logger\";\n\n// Note: YouTube API uses internal API routes (/api/youtube/*) rather than direct API calls\n// The base URL from services configuration is available as SERVICES.youtube.apiBaseUrl if needed\n\ninterface YouTubePlaylistItem {\n  id?: string;\n  snippet: {\n    title: string;\n    description?: string;\n    channelTitle?: string;\n    thumbnails: {\n      default?: { url: string };\n      medium?: { url: string };\n      high?: { url: string };\n    };\n    resourceId?: {\n      videoId: string;\n    };\n    videoOwnerChannelTitle?: string;\n  };\n  contentDetails?: {\n    itemCount: number;\n  };\n  status?: {\n    privacyStatus: \"private\" | \"public\" | \"unlisted\";\n    uploadStatus: \"deleted\" | \"failed\" | \"processed\" | \"rejected\" | \"uploaded\";\n  };\n}\n\ninterface YouTubePlaylistResponse {\n  items: YouTubePlaylistItem[];\n  pageInfo: {\n    totalResults: number;\n  };\n  nextPageToken?: string;\n}\n\ninterface YouTubeSearchMatch {\n  score: number;\n  nameScore: number;\n  artistScore: number;\n  item: YouTubePlaylistItem;\n}\n\ninterface YouTubeSearchResponse {\n  matches: YouTubeSearchMatch[];\n}\n\ninterface YouTubePlaylistCreateResponse {\n  id: string;\n  snippet: {\n    title: string;\n  };\n}\n\ninterface YouTubePlaylistItemInsertResponse {\n  id: string;\n}\n\ninterface YouTubePlaylistItemsResponse {\n  items: Array<{\n    snippet: {\n      resourceId: {\n        videoId: string;\n      };\n      title: string;\n      channelTitle: string;\n      thumbnails: {\n        default?: { url: string };\n        medium?: { url: string };\n        high?: { url: string };\n      };\n    };\n    status?: {\n      privacyStatus: \"private\" | \"public\" | \"unlisted\";\n      uploadStatus: \"deleted\" | \"failed\" | \"processed\" | \"rejected\" | \"uploaded\";\n    };\n  }>;\n  nextPageToken?: string;\n}\n\n// YouTube-specific retry options for robust API error handling\nconst YOUTUBE_RETRY_OPTIONS = {\n  maxRetries: 5,\n  initialRetryDelay: 200, // Start with a bit faster retry than default\n  maxRetryDelay: 32000,\n  jitterFactor: 0.1,\n};\n\n/**\n * Find the best matching album from YouTube search results\n */\nasync function findBestAlbumMatch(album: Pick<ITrack, \"name\" | \"artist\">): Promise<string | null> {\n  try {\n    const authData = await getYouTubeAuthData(\"target\");\n    if (!authData) {\n      return null;\n    }\n\n    // Use retryWithExponentialBackoff for robust error handling and retries\n    const data = await retryWithExponentialBackoff<YouTubeSearchResponse>(\n      () =>\n        fetch(\"/api/youtube/search\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify({\n            query: `${album.name} ${album.artist}`,\n            token: authData.accessToken,\n          }),\n        }),\n      YOUTUBE_RETRY_OPTIONS\n    );\n\n    if (!data.matches?.length) {\n      sentryLogger.captureMatchingError(\n        \"album_search\",\n        \"youtube\",\n        new Error(`No search results found for album \"${album.name}\" by ${album.artist}`),\n        {\n          albumName: album.name,\n          albumArtist: album.artist,\n        }\n      );\n      return null;\n    }\n\n    // Sort matches by score\n    const matches = data.matches.sort((a, b) => b.score - a.score);\n\n    // Return the ID if we have a good match (score >= 0.7)\n    const bestMatch = matches[0];\n    if (bestMatch.score >= 0.7) {\n      return bestMatch.item.snippet.resourceId?.videoId || bestMatch.item.id || null;\n    }\n    return null;\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"album_search\", \"youtube\", error, {\n      albumName: album.name,\n      albumArtist: album.artist,\n    });\n    return null;\n  }\n}\n\n/**\n * Find matching YouTube videos for a batch of albums\n */\nexport async function findMatchingAlbums(\n  albums: IAlbum[]\n): Promise<Array<IAlbum & { targetId?: string }>> {\n  try {\n    const results = await Promise.all(\n      albums.map(async album => {\n        const targetId = await findBestAlbumMatch(album);\n        return {\n          ...album,\n          targetId: targetId || undefined,\n        };\n      })\n    );\n    return results;\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"album_search\", \"youtube\", error, {});\n    return albums.map(album => ({ ...album }));\n  }\n}\n\n/**\n * Search for tracks in YouTube Music\n */\nexport async function search(\n  tracks: ITrack[],\n  onProgress: ((progress: number) => void) | undefined\n): Promise<SearchResult> {\n  try {\n    const ytAdapter = new YTMusicAdapter();\n    await ytAdapter.initialize(\"target\");\n\n    const results: ITrack[] = [];\n    let matched = 0;\n    let unmatched = 0;\n\n    await processInBatches(\n      async batch => {\n        const batchResults = await Promise.all(\n          batch.map(async track => {\n            const result = await ytAdapter.findMatchingTracks([track]);\n            return result[0];\n          })\n        );\n\n        results.push(...batchResults);\n\n        const validTracks = batchResults.filter(track => track.targetId);\n        matched += validTracks.length;\n        unmatched += batch.length - validTracks.length;\n\n        if (onProgress) {\n          onProgress(results.length / tracks.length);\n        }\n      },\n      {\n        items: tracks,\n        batchSize: 5,\n        delayBetweenBatches: 200,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      matched,\n      unmatched,\n      total: tracks.length,\n      tracks: results,\n    };\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"track_search\", \"youtube\", error, {});\n    return {\n      matched: 0,\n      unmatched: tracks.length,\n      total: tracks.length,\n      tracks: tracks.map(track => ({ ...track })),\n    };\n  }\n}\n\n/**\n * Create a playlist with the given tracks\n */\nexport async function createPlaylistWithTracks(\n  name: string,\n  tracks: ITrack[],\n  description?: string\n): Promise<TransferResult> {\n  try {\n    const authData = await getYouTubeAuthData(\"target\");\n    if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n    const validTracks = tracks.filter(track => track.targetId);\n    if (validTracks.length === 0) {\n      return {\n        added: 0,\n        failed: tracks.length,\n        total: tracks.length,\n        playlistId: null,\n      };\n    }\n\n    // Create the playlist using retryWithExponentialBackoff for reliability\n    const playlistData = await retryWithExponentialBackoff<YouTubePlaylistCreateResponse>(\n      () =>\n        fetch(\"https://www.googleapis.com/youtube/v3/playlists?part=snippet\", {\n          method: \"POST\",\n          headers: {\n            Authorization: `Bearer ${authData.accessToken}`,\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify({\n            snippet: {\n              title: name,\n              description: description || \"\",\n              privacyStatus: \"private\",\n            },\n          }),\n        }),\n      YOUTUBE_RETRY_OPTIONS\n    );\n    const playlistId = playlistData.id;\n\n    // Add tracks to the playlist in batches, using retryWithExponentialBackoff for each request\n    const result = await processInBatches(\n      async batch => {\n        await Promise.all(\n          batch\n            .filter(track => track.targetId)\n            .map(async track => {\n              // Use retryWithExponentialBackoff for each add-track request\n              const data = await retryWithExponentialBackoff<YouTubePlaylistItemInsertResponse>(\n                () =>\n                  fetch(\"https://www.googleapis.com/youtube/v3/playlistItems?part=snippet\", {\n                    method: \"POST\",\n                    headers: {\n                      Authorization: `Bearer ${authData.accessToken}`,\n                      \"Content-Type\": \"application/json\",\n                    },\n                    body: JSON.stringify({\n                      snippet: {\n                        playlistId,\n                        resourceId: {\n                          kind: \"youtube#video\",\n                          videoId: track.targetId,\n                        },\n                      },\n                    }),\n                  }),\n                YOUTUBE_RETRY_OPTIONS\n              );\n              // If no data.id, treat as error\n              if (!data.id) {\n                throw new Error(\"Failed to add track to playlist: No item ID returned\");\n              }\n            })\n        );\n      },\n      {\n        items: validTracks,\n        batchSize: 1,\n        delayBetweenBatches: 200,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      ...result,\n      playlistId,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\n/**\n * Get playlist details\n */\nexport async function fetchPlaylistTracks(\n  playlistId: string,\n  onProgress?: (tracks: ITrack[], progress: number) => void\n): Promise<ITrack[]> {\n  try {\n    const authData = await getYouTubeAuthData(\"source\");\n    if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n    const tracks: ITrack[] = [];\n    let nextPageToken: string | undefined;\n    let total: number | undefined = undefined;\n\n    do {\n      const url = new URL(\"https://www.googleapis.com/youtube/v3/playlistItems\");\n      url.searchParams.append(\"part\", \"snippet,status\");\n      url.searchParams.append(\"playlistId\", playlistId);\n      url.searchParams.append(\"maxResults\", \"50\");\n      if (nextPageToken) {\n        url.searchParams.append(\"pageToken\", nextPageToken);\n      }\n\n      const response = await retryWithExponentialBackoff<\n        YouTubePlaylistItemsResponse & { pageInfo?: { totalResults?: number } }\n      >(\n        () =>\n          fetch(url.toString(), {\n            headers: {\n              Authorization: `Bearer ${authData.accessToken}`,\n            },\n          }),\n        YOUTUBE_RETRY_OPTIONS\n      );\n\n      // Set total from the first response\n      if (total === undefined && response.pageInfo?.totalResults) {\n        total = response.pageInfo.totalResults;\n      }\n\n      const data = response;\n\n      tracks.push(\n        ...(data.items || [])\n          .filter(item => {\n            // Only include tracks that have required data and are public\n            if (!item.snippet?.resourceId?.videoId || !item.snippet.title) {\n              return false;\n            }\n            return item.status?.privacyStatus === \"public\";\n          })\n          .map(item => {\n            const metadata = extractTrackMetadata(item);\n            return {\n              id: item.snippet.resourceId.videoId,\n              name: metadata.title,\n              artist: metadata.artist,\n              album: \"YouTube Music\",\n              videoId: item.snippet.resourceId.videoId,\n              artwork:\n                item.snippet.thumbnails?.high?.url ||\n                item.snippet.thumbnails?.medium?.url ||\n                item.snippet.thumbnails?.default?.url,\n            };\n          })\n      );\n\n      // Call onProgress after each page\n      if (onProgress && total) {\n        const progress = Math.min(tracks.length / total, 1);\n        onProgress([...tracks], progress);\n      }\n\n      nextPageToken = data.nextPageToken;\n    } while (nextPageToken);\n\n    return tracks;\n  } catch (error) {\n    throw error;\n  }\n}\n\n/**\n * Get user's library\n */\nexport async function fetchUserLibrary(): Promise<ILibraryData> {\n  const authData = await getYouTubeAuthData(\"source\");\n  if (!authData) throw new Error(\"Not authenticated with YouTube\");\n\n  // Fetch playlists\n  const playlists = [];\n  let nextPageToken: string | undefined;\n\n  do {\n    const url = new URL(\"https://www.googleapis.com/youtube/v3/playlists\");\n    url.searchParams.append(\"part\", \"snippet,contentDetails\");\n    url.searchParams.append(\"mine\", \"true\");\n    url.searchParams.append(\"maxResults\", \"50\");\n    if (nextPageToken) {\n      url.searchParams.append(\"pageToken\", nextPageToken);\n    }\n\n    const response = await retryWithExponentialBackoff<YouTubePlaylistResponse>(\n      () =>\n        fetch(url.toString(), {\n          headers: {\n            Authorization: `Bearer ${authData.accessToken}`,\n          },\n        }),\n      YOUTUBE_RETRY_OPTIONS\n    );\n\n    const data: YouTubePlaylistResponse = response;\n\n    playlists.push(\n      ...data.items.map(playlist => ({\n        id: playlist.id || `youtube-${Date.now()}-${Math.random()}`,\n        name: playlist.snippet.title,\n        trackCount: playlist.contentDetails?.itemCount || 0,\n        ownerId: authData.userId,\n        tracks: [],\n        artwork:\n          playlist.snippet.thumbnails?.high?.url ||\n          playlist.snippet.thumbnails?.medium?.url ||\n          playlist.snippet.thumbnails?.default?.url,\n      }))\n    );\n\n    nextPageToken = data.nextPageToken;\n  } while (nextPageToken);\n\n  // Fetch liked songs using the consolidated getPlaylist function\n  const likedSongs = await fetchPlaylistTracks(\"LM\");\n\n  // For now, return empty albums array as YouTube Music's album structure\n  // is different and will need special handling\n  const albums: Array<{\n    id: string;\n    name: string;\n    artist: string;\n    artwork?: string;\n    tracks: ITrack[];\n  }> = [];\n\n  return {\n    playlists,\n    likedSongs,\n    albums,\n  };\n}\n\n/**\n * Clean up YouTube title by removing common suffixes and prefixes\n */\nfunction cleanYouTubeTitle(title: string): string {\n  // First remove any duration timestamp at the end (e.g., \"4:46\", \"3:33\")\n  title = title.replace(/\\s+\\d{1,2}:\\d{2}\\s*$/, \"\");\n\n  // Remove channel/uploader attribution at the end\n  title = title.replace(/\\s+by\\s+[^()\\[\\]]+$/, \"\");\n\n  return (\n    title\n      // Remove all content in square brackets\n      .replace(/\\s*\\[[^\\]]*\\]/g, \"\")\n\n      // Remove official video/audio indicators\n      .replace(/\\s*\\(Official.*?\\)/gi, \"\")\n\n      // Remove live performance indicators\n      .replace(/\\s*\\(Live.*?\\)/gi, \"\")\n      .replace(/\\s*\\(.*?Live Session.*?\\)/gi, \"\")\n\n      // Remove lyric video indicators\n      .replace(/\\s*\\(Lyric.*?\\)/gi, \"\")\n      .replace(/\\s*\\(.*?lyrics.*?\\)/gi, \"\")\n\n      // Remove audio indicators\n      .replace(/\\s*\\(Audio.*?\\)/gi, \"\")\n      .replace(/\\s*\\(Acoustic.*?\\)/gi, \"\")\n\n      // Remove music video indicators\n      .replace(/\\s*\\(Music Video.*?\\)/gi, \"\")\n      .replace(/\\s*\\(Video.*?\\)/gi, \"\")\n\n      // Remove mix/version/edit indicators\n      .replace(/\\s*\\(.*?Mix.*?\\)/gi, \"\")\n      .replace(/\\s*\\(.*?Version.*?\\)/gi, \"\")\n      .replace(/\\s*\\(.*?Edit.*?\\)/gi, \"\")\n\n      // Remove cover song indicators\n      .replace(/\\s*\\(.*?Cover.*?\\)/gi, \"\")\n\n      // Remove featuring artist indicators\n      .replace(/\\s*\\(feat\\..*?\\)/gi, \"\")\n      .replace(/\\s*\\(ft\\..*?\\)/gi, \"\")\n      .replace(/\\s+ft\\..*$/gi, \"\") // Handle \"ft.\" at the end without parentheses\n      .replace(/\\s+ft\\s+.*$/gi, \"\") // Handle \"ft\" without dot at the end\n      .replace(/\\s+feat\\..*$/gi, \"\") // Handle \"feat.\" at the end without parentheses\n      .replace(/\\s+feat\\s+.*$/gi, \"\") // Handle \"feat\" without dot at the end\n\n      // Remove album indicators (usually at the end after artist)\n      .replace(/\\s+(?:From|on)\\s+.*?(?:Album|EP).*?$/i, \"\")\n\n      // Remove bonus track indicators\n      .replace(/\\s*\\(Bonus Track\\)/gi, \"\")\n\n      // Remove instrumental indicators\n      .replace(/\\s*\\(Instrumental\\)/gi, \"\")\n\n      // Remove uncensored indicators (with optional parentheses)\n      .replace(/\\s*(?:\\()?Uncensored(?:\\))?/gi, \"\")\n\n      // Remove location indicators\n      .replace(/\\s*\\(.*?at .*?\\)/gi, \"\")\n\n      // Remove quality/resolution tags\n      .replace(/\\s*\\(?(?:HD|4K|1080p|720p|Full HD|Ultra HD|UHD|HQ)\\)?/gi, \"\")\n      .replace(/\\s*\\((?:High Quality|High Definition)\\)/gi, \"\")\n      .replace(/\\s*\\[(?:HD|4K|1080p|720p|Full HD|Ultra HD|UHD|HQ)\\]/gi, \"\")\n\n      // Remove any remaining parentheses with short content (likely metadata)\n      .replace(/\\s*\\([^)]{1,20}\\)/g, \"\")\n\n      // Clean up apostrophes and quotes\n      .replace(/[''′`]/g, \"\") // Remove single quotes and similar characters\n      .replace(/[\"\"]/g, \"\") // Remove double quotes\n\n      // Clean up any leftover artifacts\n      .replace(/\\s*-\\s*$/, \"\") // Remove trailing dash\n      .replace(/^\\s*-\\s*/, \"\") // Remove leading dash\n      .replace(/\\s+/g, \" \") // Normalize spaces\n      .trim()\n  );\n}\n\n/**\n * Clean up YouTube artist name by removing common suffixes and collaborations\n */\nfunction cleanYouTubeArtist(artist: string): string {\n  return (\n    artist\n      // Remove featuring artists with more comprehensive patterns\n      .replace(/\\s+feat\\.?\\s+.*/i, \"\") // \"feat\" or \"feat.\"\n      .replace(/\\s+ft\\.?\\s+.*/i, \"\") // \"ft\" or \"ft.\"\n      .replace(/\\s+featuring\\s+.*/i, \"\") // \"featuring\"\n      .replace(/\\s*\\(feat\\.?\\s+[^)]*\\)/gi, \"\") // (feat. ...)\n      .replace(/\\s*\\(ft\\.?\\s+[^)]*\\)/gi, \"\") // (ft. ...)\n      .replace(/\\s*\\[feat\\.?\\s+[^]]*\\]/gi, \"\") // [feat. ...]\n      .replace(/\\s*\\[ft\\.?\\s+[^]]*\\]/gi, \"\") // [ft. ...]\n\n      // Remove \"- Topic\" suffix common in YouTube Music\n      .replace(/\\s*-\\s*Topic$/i, \"\")\n\n      // Remove \"VEVO\" suffix\n      .replace(/\\s*VEVO$/i, \"\")\n\n      // Remove common channel indicators\n      .replace(/\\s*\\(Official\\)$/i, \"\")\n      .replace(/\\s*\\(Official Channel\\)$/i, \"\")\n\n      // Clean up any leftover artifacts\n      .replace(/\\s+/g, \" \")\n      .trim()\n  );\n}\n\ninterface TrackMetadata {\n  title: string;\n  artist: string;\n}\n\n/**\n * Extract both title and artist information from a YouTube playlist item\n */\nfunction extractTrackMetadata(item: YouTubePlaylistItem): TrackMetadata {\n  const { snippet } = item;\n  const defaultResult = { title: cleanYouTubeTitle(snippet.title), artist: \"Unknown Artist\" };\n\n  // Helper function to validate artist name\n  const isValidArtistName = (name?: string): boolean => {\n    if (!name) return false;\n    const invalidTerms = [\"youtube\", \"vevo\", \"official\", \"music\", \"records\", \"topic\"];\n    return !invalidTerms.some(term => name.toLowerCase().includes(term));\n  };\n\n  // Helper function to extract artist and title from a string\n  const extractFromSeparator = (text: string): TrackMetadata | null => {\n    // Match the pattern: \"Artist feat. Someone - Title\" but only with spaced dashes\n    const featMatch = text.match(\n      /^(.+?)(?:\\s+(?:feat\\.?|ft\\.?|featuring)\\s+[^-]+)?(?:\\s+-\\s+.+)$/i\n    );\n    if (featMatch) {\n      const [, artist] = featMatch;\n      // Get the title part after the last spaced dash\n      const titlePart = text.split(/\\s+-\\s+/).pop() || \"\";\n      return {\n        artist: cleanYouTubeArtist(artist.trim()),\n        title: cleanYouTubeTitle(titlePart.trim()),\n      };\n    }\n\n    // If no featuring pattern, just split on spaced separators\n    const parts = text.split(/\\s+[-–—:]\\s+/).map(p => p.trim());\n    if (parts.length < 2) return null;\n\n    // Validate first part looks like an artist name (not too long, no special patterns)\n    const potentialArtist = parts[0];\n    if (\n      potentialArtist.split(\" \").length > 4 ||\n      potentialArtist.toLowerCase().includes(\"provided\") ||\n      !isValidArtistName(potentialArtist)\n    ) {\n      return null;\n    }\n\n    return {\n      artist: cleanYouTubeArtist(potentialArtist),\n      title: cleanYouTubeTitle(parts.slice(1).join(\" - \")),\n    };\n  };\n\n  // Try to extract from Topic channel\n  if (snippet.videoOwnerChannelTitle?.includes(\"- Topic\")) {\n    return {\n      artist: cleanYouTubeArtist(snippet.videoOwnerChannelTitle.split(\"- Topic\")[0].trim()),\n      title: cleanYouTubeTitle(snippet.title),\n    };\n  }\n\n  // Try to extract from description metadata\n  if (snippet.description?.includes(\"Provided to YouTube\")) {\n    const lines = snippet.description.split(\"\\n\");\n    let foundTitle = \"\";\n    let foundArtist = \"\";\n\n    for (const line of lines) {\n      if (!line.includes(\"·\")) continue;\n\n      const parts = line.split(\"·\").map(p => p.trim());\n\n      // Look for song title\n      if (parts[0].toLowerCase().includes(\"song\")) {\n        foundTitle = cleanYouTubeTitle(parts[0].replace(/song/i, \"\").trim());\n      }\n      // Look for track title\n      else if (line.toLowerCase().includes(\"title\") || line.toLowerCase().includes(\"track\")) {\n        foundTitle = cleanYouTubeTitle(parts[0].trim());\n      }\n\n      // Look for artist\n      if (line.toLowerCase().includes(\"performer\") || line.toLowerCase().includes(\"artist\")) {\n        foundArtist = cleanYouTubeArtist(parts[parts.length - 1]);\n      }\n    }\n\n    if (foundTitle || foundArtist) {\n      return {\n        title: foundTitle || defaultResult.title,\n        artist: foundArtist || defaultResult.artist,\n      };\n    }\n  }\n\n  // Try to extract from common title patterns\n  const extracted = extractFromSeparator(snippet.title);\n  if (extracted) return extracted;\n\n  // Try to extract from channel information\n  if (snippet.videoOwnerChannelTitle && isValidArtistName(snippet.videoOwnerChannelTitle)) {\n    return {\n      title: defaultResult.title,\n      artist: cleanYouTubeArtist(snippet.videoOwnerChannelTitle),\n    };\n  }\n\n  if (snippet.channelTitle && isValidArtistName(snippet.channelTitle)) {\n    return {\n      title: defaultResult.title,\n      artist: cleanYouTubeArtist(snippet.channelTitle),\n    };\n  }\n\n  // Fallback to default result with cleaned title\n  return defaultResult;\n}\n\n/**\n * Search for albums in YouTube Music\n */\nexport async function searchAlbums(\n  albums: IAlbum[],\n  onProgress: ((progress: number) => void) | undefined\n): Promise<SearchResult> {\n  try {\n    // Use the YTMusicAdapter for album matching, just like search uses it for tracks\n    const ytAdapter = new YTMusicAdapter();\n    await ytAdapter.initialize(\"target\");\n\n    const results: IAlbum[] = [];\n    let matched = 0;\n    let unmatched = 0;\n\n    await processInBatches(\n      async batch => {\n        // Use the adapter's findMatchingAlbums for each batch\n        const batchResults = await ytAdapter.findMatchingAlbums(batch);\n\n        // Map results to IAlbum with targetId\n        const mappedResults = batchResults.map((album, i) => ({\n          ...batch[i],\n          targetId: album.targetId,\n          status: album.status,\n        }));\n\n        results.push(...mappedResults);\n\n        const validAlbums = mappedResults.filter(album => album.targetId);\n        matched += validAlbums.length;\n        unmatched += batch.length - validAlbums.length;\n\n        if (onProgress) {\n          onProgress(results.length / albums.length);\n        }\n      },\n      {\n        items: albums,\n        batchSize: 3,\n        delayBetweenBatches: 300,\n        onBatchStart: () => {},\n      }\n    );\n\n    return {\n      matched,\n      unmatched,\n      total: albums.length,\n      albums: results,\n    };\n  } catch (error) {\n    sentryLogger.captureMatchingError(\"album_search\", \"youtube\", error, {});\n    return {\n      matched: 0,\n      unmatched: albums.length,\n      total: albums.length,\n      albums: albums.map(album => ({ ...album, tracks: [], targetId: undefined })),\n    };\n  }\n}\n\n/**\n * Add tracks to YouTube Music library\n */\nexport async function addTracksToLibrary(tracks: ITrack[]): Promise<TransferResult> {\n  try {\n    const authData = await getYouTubeAuthData(\"target\");\n    if (!authData) {\n      throw new Error(\"Not authenticated with YouTube\");\n    }\n\n    const validTracks = tracks.filter(track => track.targetId);\n    if (validTracks.length === 0) {\n      return {\n        added: 0,\n        failed: tracks.length,\n        total: tracks.length,\n        playlistId: null,\n      };\n    }\n\n    // Create a playlist for the tracks\n    const playlistName = `Imported from Nonna.fm - ${new Date().toLocaleDateString()}`;\n    const playlistId = await createPlaylistWithTracks(playlistName, validTracks);\n\n    return {\n      added: validTracks.length,\n      failed: tracks.length - validTracks.length,\n      total: tracks.length,\n      playlistId: playlistId.playlistId,\n    };\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport async function addAlbumsToLibrary(_albums: Set<IAlbum>): Promise<TransferResult> {\n  // no way to add albums to YouTube Music library yet\n  return {\n    added: 0,\n    failed: 0,\n    total: 0,\n    playlistId: null,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 7178, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/deezer/auth.ts"],"sourcesContent":["import { setServiceType, clearAuthData } from \"@/lib/auth/constants\";\nimport type { IPlaylist } from \"@/types\";\n\ninterface DeezerUser {\n  id: number;\n  name: string;\n  link: string;\n  picture: string;\n  picture_small: string;\n  picture_medium: string;\n  picture_big: string;\n  picture_xl: string;\n  country: string;\n  tracklist: string;\n  type: string;\n}\n\ninterface DeezerApiError {\n  error: string;\n}\n\n// Deezer API endpoints for reference (used in API routes)\nexport const DEEZER_ENDPOINTS = {\n  user: (userId: string) => `/user/${userId}`,\n  playlists: (userId: string) => `/user/${userId}/playlists`,\n  tracks: (userId: string) => `/user/${userId}/tracks`,\n  albums: (userId: string) => `/user/${userId}/albums`,\n  artists: (userId: string) => `/user/${userId}/artists`,\n};\n\n/**\n * Validates a Deezer user ID and returns user data if valid\n */\nexport const validateDeezerUser = async (userId: string): Promise<DeezerUser> => {\n  try {\n    const response = await fetch(`/api/deezer/user/${userId}`);\n    const data: DeezerUser | DeezerApiError = await response.json();\n\n    if (!response.ok) {\n      throw new Error((data as DeezerApiError).error || \"Failed to validate Deezer user\");\n    }\n\n    if (\"error\" in data) {\n      throw new Error(data.error);\n    }\n\n    return data as DeezerUser;\n  } catch (error) {\n    console.error(\"Error validating Deezer user:\", error);\n    throw new Error(\n      \"Failed to validate Deezer user. Make sure the profile is public and try again.\"\n    );\n  }\n};\n\n/**\n * Stores Deezer user ID and sets up source service\n */\nexport const storeDeezerUserId = (userId: string): void => {\n  localStorage.setItem(\"deezer_user_id\", userId);\n  setServiceType(\"source\", \"deezer\");\n};\n\n/**\n * Retrieves stored Deezer user ID\n */\nexport const getDeezerUserId = (): string | null => {\n  return localStorage.getItem(\"deezer_user_id\");\n};\n\n/**\n * Clears stored Deezer user ID and service type\n */\nexport const clearDeezerUserId = (): void => {\n  localStorage.removeItem(\"deezer_user_id\");\n  clearAuthData(\"source\"); // Clear any source service type\n};\n\n/**\n * Stores selected Deezer playlist in local storage\n */\nexport const storeDeezerPlaylist = (playlist: IPlaylist): void => {\n  localStorage.setItem(\"deezer_selected_playlist\", JSON.stringify(playlist));\n};\n\n/**\n * Retrieves stored Deezer playlist\n */\nexport const getDeezerPlaylist = (): IPlaylist | null => {\n  const playlist = localStorage.getItem(\"deezer_selected_playlist\");\n  return playlist ? JSON.parse(playlist) : null;\n};\n\n/**\n * Clears stored Deezer playlist\n */\nexport const clearDeezerPlaylist = (): void => {\n  localStorage.removeItem(\"deezer_selected_playlist\");\n};\n\n/**\n * Check if Deezer is currently set as the source service\n */\nexport const isDeezerSource = (): boolean => {\n  const serviceType = localStorage.getItem(\"nonna_source_service\");\n  return serviceType === \"deezer\";\n};\n\n/**\n * Handles the callback from Deezer OAuth flow\n */\nexport const handleDeezerCallback = async (\n  searchString: string\n): Promise<{ success: boolean; role: \"source\" | \"target\" }> => {\n  try {\n    const params = new URLSearchParams(searchString);\n    const userId = params.get(\"userId\");\n    const role = params.get(\"role\") as \"source\" | \"target\";\n\n    if (!userId) {\n      throw new Error(\"No user ID provided in callback\");\n    }\n\n    if (!role || ![\"source\", \"target\"].includes(role)) {\n      throw new Error(\"Invalid role provided in callback\");\n    }\n\n    // Store the user ID and set the service type\n    localStorage.setItem(\"deezer_user_id\", userId);\n    setServiceType(role, \"deezer\");\n\n    return { success: true, role };\n  } catch (error) {\n    console.error(\"Error handling Deezer callback:\", error);\n    return { success: false, role: \"source\" };\n  }\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;;AAsBO,MAAM,mBAAmB;IAC9B,MAAM,CAAC,SAAmB,CAAC,MAAM,EAAE,QAAQ;IAC3C,WAAW,CAAC,SAAmB,CAAC,MAAM,EAAE,OAAO,UAAU,CAAC;IAC1D,QAAQ,CAAC,SAAmB,CAAC,MAAM,EAAE,OAAO,OAAO,CAAC;IACpD,QAAQ,CAAC,SAAmB,CAAC,MAAM,EAAE,OAAO,OAAO,CAAC;IACpD,SAAS,CAAC,SAAmB,CAAC,MAAM,EAAE,OAAO,QAAQ,CAAC;AACxD;AAKO,MAAM,qBAAqB,OAAO;IACvC,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,CAAC,iBAAiB,EAAE,QAAQ;QACzD,MAAM,OAAoC,MAAM,SAAS,IAAI;QAE7D,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,AAAC,KAAwB,KAAK,IAAI;QACpD;QAEA,IAAI,WAAW,MAAM;YACnB,MAAM,IAAI,MAAM,KAAK,KAAK;QAC5B;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,MAAM,IAAI,MACR;IAEJ;AACF;AAKO,MAAM,oBAAoB,CAAC;IAChC,aAAa,OAAO,CAAC,kBAAkB;IACvC,IAAA,gKAAc,EAAC,UAAU;AAC3B;AAKO,MAAM,kBAAkB;IAC7B,OAAO,aAAa,OAAO,CAAC;AAC9B;AAKO,MAAM,oBAAoB;IAC/B,aAAa,UAAU,CAAC;IACxB,IAAA,+JAAa,EAAC,WAAW,gCAAgC;AAC3D;AAKO,MAAM,sBAAsB,CAAC;IAClC,aAAa,OAAO,CAAC,4BAA4B,KAAK,SAAS,CAAC;AAClE;AAKO,MAAM,oBAAoB;IAC/B,MAAM,WAAW,aAAa,OAAO,CAAC;IACtC,OAAO,WAAW,KAAK,KAAK,CAAC,YAAY;AAC3C;AAKO,MAAM,sBAAsB;IACjC,aAAa,UAAU,CAAC;AAC1B;AAKO,MAAM,iBAAiB;IAC5B,MAAM,cAAc,aAAa,OAAO,CAAC;IACzC,OAAO,gBAAgB;AACzB;AAKO,MAAM,uBAAuB,OAClC;IAEA,IAAI;QACF,MAAM,SAAS,IAAI,gBAAgB;QACnC,MAAM,SAAS,OAAO,GAAG,CAAC;QAC1B,MAAM,OAAO,OAAO,GAAG,CAAC;QAExB,IAAI,CAAC,QAAQ;YACX,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,CAAC,QAAQ,CAAC;YAAC;YAAU;SAAS,CAAC,QAAQ,CAAC,OAAO;YACjD,MAAM,IAAI,MAAM;QAClB;QAEA,6CAA6C;QAC7C,aAAa,OAAO,CAAC,kBAAkB;QACvC,IAAA,gKAAc,EAAC,MAAM;QAErB,OAAO;YAAE,SAAS;YAAM;QAAK;IAC/B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO;YAAE,SAAS;YAAO,MAAM;QAAS;IAC1C;AACF","debugId":null}},
    {"offset": {"line": 7283, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/deezer/api.ts"],"sourcesContent":["import { ITrack, ILibraryData, IAlbum, SearchResult, TransferResult } from \"@/types\";\nimport { getDeezerUserId } from \"./auth\";\nimport { retryWithExponentialBackoff, type RetryOptions } from \"@/lib/utils/retry\";\nimport { SERVICES } from \"@/config/services\";\n\n// Base URL for Deezer API from services configuration\nconst BASE_URL = SERVICES.deezer.apiBaseUrl;\n\n// Keep this for the handlers to use (legacy support)\nexport const DEEZER_API_BASE = BASE_URL;\n\n// Types shared between client and API routes\nexport interface DeezerAlbum {\n  id: number;\n  title: string;\n  link: string;\n  cover: string;\n  cover_small: string;\n  cover_medium: string;\n  cover_big: string;\n  cover_xl: string;\n  md5_image: string;\n  nb_tracks: number;\n  release_date: string;\n  record_type: string;\n  available: boolean;\n  tracklist: string;\n  explicit_lyrics: boolean;\n  time_add: number;\n  artist: {\n    id: number;\n    name: string;\n    picture: string;\n    picture_small: string;\n    picture_medium: string;\n    picture_big: string;\n    picture_xl: string;\n    tracklist: string;\n    type: string;\n  };\n  type: string;\n}\n\nexport interface DeezerPlaylist {\n  id: number;\n  title: string;\n  nb_tracks: number;\n  picture_medium: string;\n  duration: number;\n  creation_date: string;\n  is_loved_track?: boolean;\n  creator: {\n    id: number;\n    name: string;\n  };\n}\n\nexport interface DeezerTrack {\n  id: number;\n  title: string;\n  duration: number;\n  preview: string;\n  link: string;\n  artist: {\n    name: string;\n  };\n  album: {\n    title: string;\n    cover_small: string;\n  };\n}\n\nexport interface DeezerApiResponse<T> {\n  data?: T[];\n  total?: number;\n  error?: {\n    message: string;\n    type?: string;\n    code?: number;\n  };\n  next?: string;\n}\n\n// Define Deezer-specific retry options for all API calls\nconst DEEZER_RETRY_OPTIONS: RetryOptions = {\n  maxRetries: 5,\n  initialRetryDelay: 300, // Slightly faster retry than default\n  maxRetryDelay: 16000,\n  jitterFactor: 0.1,\n};\n\n/**\n * Fetches all playlists for a Deezer user with pagination support\n */\nexport async function fetchUserLibrary(): Promise<ILibraryData> {\n  const userId = getDeezerUserId();\n  if (!userId) throw new Error(\"No Deezer user ID found\");\n\n  // Fetch playlists and albums in parallel\n  const [allPlaylists, albums] = await Promise.all([\n    (async (): Promise<DeezerPlaylist[]> => {\n      let playlists: DeezerPlaylist[] = [];\n      let nextUrl: string | undefined = `/api/deezer/playlists/${userId}`;\n\n      // Fetch all pages of playlists with retry logic\n      while (nextUrl) {\n        const url: string = nextUrl; // Ensure url is string\n        // Use retryWithExponentialBackoff for robust error handling\n        const data: DeezerApiResponse<DeezerPlaylist> = await retryWithExponentialBackoff<\n          DeezerApiResponse<DeezerPlaylist>\n        >(() => fetch(url), DEEZER_RETRY_OPTIONS);\n\n        if (data.error) {\n          throw new Error(data.error?.message || \"Failed to fetch Deezer library\");\n        }\n\n        if (data.data) {\n          playlists = [...playlists, ...data.data];\n        }\n\n        // If we get a next URL from Deezer API, convert it to our API route\n        nextUrl = data.next\n          ? `/api/deezer/playlists/${userId}?${new URL(data.next).searchParams.toString()}`\n          : undefined;\n      }\n\n      return playlists;\n    })(),\n    fetchDeezerAlbums(),\n  ]);\n\n  // Find the loved tracks playlist\n  const lovedTracksPlaylist = allPlaylists.find(p => p.is_loved_track);\n\n  // Get the liked songs if the loved tracks playlist exists\n  const likedSongs = lovedTracksPlaylist\n    ? await fetchPlaylistTracks(lovedTracksPlaylist.id.toString())\n    : [];\n\n  // Filter out the loved tracks playlist from regular playlists\n  const playlists = allPlaylists\n    .filter(playlist => !playlist.is_loved_track)\n    .map(playlist => ({\n      id: playlist.id.toString(),\n      name: playlist.title,\n      trackCount: playlist.nb_tracks,\n      ownerId: userId,\n      artwork: playlist.picture_medium,\n      tracks: [], // We'll fetch tracks when needed\n    }));\n\n  return {\n    likedSongs,\n    albums,\n    playlists,\n  };\n}\n\n/**\n * Fetches tracks for a specific Deezer playlist with pagination support\n */\nexport async function fetchPlaylistTracks(\n  playlistId: string,\n  onProgress?: (tracks: ITrack[], progress: number) => void\n): Promise<ITrack[]> {\n  let allTracks: ITrack[] = [];\n  let nextUrl: string | undefined = `/api/deezer/playlists/${playlistId}/tracks`;\n  let total: number | undefined = undefined;\n\n  // Fetch all pages of tracks with retry logic\n  while (nextUrl) {\n    const url: string = nextUrl; // Ensure url is string\n    // Use retryWithExponentialBackoff for robust error handling\n    const data: DeezerApiResponse<DeezerTrack> = await retryWithExponentialBackoff<\n      DeezerApiResponse<DeezerTrack>\n    >(() => fetch(url), DEEZER_RETRY_OPTIONS);\n\n    if (data.error) {\n      throw new Error(data.error?.message || \"Failed to fetch Deezer playlist tracks\");\n    }\n\n    if (!data.data || !Array.isArray(data.data)) {\n      throw new Error(\"Invalid response format from Deezer API\");\n    }\n\n    // Set total from the first response\n    if (total === undefined && typeof data.total === \"number\") {\n      total = data.total;\n    }\n\n    // Transform tracks to our format\n    const tracks = data.data.map((track: DeezerTrack) => ({\n      id: track.id.toString(),\n      name: track.title,\n      artist: track.artist.name,\n      album: track.album.title,\n      duration: track.duration,\n      artwork: track.album.cover_small,\n      previewUrl: track.preview,\n      externalUrl: track.link,\n      service: \"deezer\" as const,\n    }));\n\n    allTracks = [...allTracks, ...tracks];\n\n    // Call onProgress after each page\n    if (onProgress && total) {\n      const progress = Math.min(allTracks.length / total, 1);\n      onProgress([...allTracks], progress);\n    }\n\n    // If we get a next URL from Deezer API, convert it to our API route\n    if (data.next) {\n      const nextDeezerUrl = new URL(data.next);\n      nextUrl = `/api/deezer/playlists/${playlistId}/tracks?${nextDeezerUrl.searchParams.toString()}`;\n    } else {\n      nextUrl = undefined;\n    }\n  }\n\n  return allTracks;\n}\n\n/**\n * Fetches all albums for a Deezer user with pagination support\n */\nexport async function fetchDeezerAlbums(): Promise<IAlbum[]> {\n  const userId = getDeezerUserId();\n  if (!userId) throw new Error(\"No Deezer user ID found\");\n\n  let allAlbums: DeezerAlbum[] = [];\n  let nextUrl: string | undefined = `/api/deezer/albums/${userId}`;\n\n  // Fetch all pages of albums with retry logic\n  while (nextUrl) {\n    const url: string = nextUrl; // Ensure url is string\n    // Use retryWithExponentialBackoff for robust error handling\n    const data: DeezerApiResponse<DeezerAlbum> = await retryWithExponentialBackoff<\n      DeezerApiResponse<DeezerAlbum>\n    >(() => fetch(url), DEEZER_RETRY_OPTIONS);\n\n    if (data.error) {\n      throw new Error(data.error?.message || \"Failed to fetch Deezer albums\");\n    }\n\n    if (!data.data || !Array.isArray(data.data)) {\n      throw new Error(\"Invalid response format from Deezer API\");\n    }\n\n    allAlbums = [...allAlbums, ...data.data];\n\n    // If we get a next URL from Deezer API, convert it to our API route\n    if (data.next) {\n      const nextDeezerUrl = new URL(data.next);\n      nextUrl = `/api/deezer/albums/${userId}?${nextDeezerUrl.searchParams.toString()}`;\n    } else {\n      nextUrl = undefined;\n    }\n  }\n\n  // Convert Deezer albums to our format\n  return allAlbums.map(album => ({\n    id: album.id.toString(),\n    name: album.title,\n    artist: album.artist.name,\n    artwork: album.cover_small,\n    trackCount: album.nb_tracks,\n    tracks: [], // We'll fetch tracks when needed\n    service: \"deezer\" as const,\n  }));\n}\n\n/**\n * Empty implementation for search - Deezer API not supported\n */\nexport async function search(\n  tracks: ITrack[],\n  onProgress?: (progress: number) => void\n): Promise<SearchResult> {\n  // Call onProgress with 100% since we're not doing any actual work\n  if (onProgress) {\n    onProgress(1);\n  }\n  return {\n    matched: 0,\n    unmatched: tracks.length,\n    total: tracks.length,\n    tracks: [],\n  };\n}\n\n/**\n * Empty implementation for searchAlbums - Deezer API not supported\n */\nexport async function searchAlbums(\n  albums: Array<IAlbum>,\n  onProgress?: (progress: number) => void\n): Promise<SearchResult> {\n  // Call onProgress with 100% since we're not doing any actual work\n  if (onProgress) {\n    onProgress(1);\n  }\n  return {\n    matched: 0,\n    unmatched: albums.length,\n    total: albums.length,\n    albums: [],\n  };\n}\n\n/**\n * Empty implementation for addTracksToLibrary - Deezer API not supported\n */\nexport async function addTracksToLibrary(tracks: ITrack[]): Promise<TransferResult> {\n  return {\n    added: 0,\n    failed: tracks.length,\n    total: tracks.length,\n    playlistId: null,\n  };\n}\n\n/**\n * Empty implementation for addAlbumsToLibrary - Deezer API not supported\n */\nexport async function addAlbumsToLibrary(albums: Set<IAlbum>): Promise<TransferResult> {\n  return {\n    added: 0,\n    failed: albums.size,\n    total: albums.size,\n    playlistId: null,\n  };\n}\n\n/**\n * Empty implementation for createPlaylistWithTracks - Deezer API not supported\n */\nexport async function createPlaylistWithTracks(\n  _name: string,\n  _tracks: ITrack[],\n  _description?: string\n): Promise<TransferResult> {\n  return {\n    added: 0,\n    failed: _tracks.length,\n    total: _tracks.length,\n    playlistId: null,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 7510, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/services/factory.ts"],"sourcesContent":["import { IMusicServiceProvider, MusicService, IServiceFactory } from \"@/types\";\nimport * as appleService from \"./apple/api\";\nimport * as spotifyService from \"./spotify/api\";\nimport * as youtubeService from \"./youtube/api\";\nimport * as deezerService from \"./deezer/api\";\n\nclass MusicServiceFactory implements IServiceFactory {\n  private providers: Record<MusicService, IMusicServiceProvider> = {\n    apple: appleService,\n    spotify: spotifyService,\n    youtube: youtubeService,\n    deezer: deezerService,\n  };\n\n  getProvider(service: MusicService): IMusicServiceProvider {\n    const provider = this.providers[service];\n    if (!provider) {\n      throw new Error(`No provider found for service: ${service}`);\n    }\n    return provider;\n  }\n}\n\nexport const musicServiceFactory = new MusicServiceFactory();\n\n// Keep track of playlists currently being fetched\nexport const fetchingPlaylists = new Set<string>();\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;AACA;;;;;AAEA,MAAM;IACI,YAAyD;QAC/D,OAAO;QACP,SAAS;QACT,SAAS;QACT,QAAQ;IACV,EAAE;IAEF,YAAY,OAAqB,EAAyB;QACxD,MAAM,WAAW,IAAI,CAAC,SAAS,CAAC,QAAQ;QACxC,IAAI,CAAC,UAAU;YACb,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS;QAC7D;QACA,OAAO;IACT;AACF;AAEO,MAAM,sBAAsB,IAAI;AAGhC,MAAM,oBAAoB,IAAI","debugId":null}},
    {"offset": {"line": 7545, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/contexts/LibraryContext.matchingActions.ts"],"sourcesContent":["import { QueueTask, LibraryAction } from \"@/types\";\n\n// Action creator for starting a matching task\nexport const matchingStart = (task: QueueTask): LibraryAction => ({\n  type: \"MATCHING_START\" as const,\n  payload: task,\n});\n\n// Action creator for updating matching progress\nexport const matchingProgress = (key: string, value: number): LibraryAction => ({\n  type: \"MATCHING_PROGRESS\" as const,\n  payload: { key, value },\n});\n\n// Action creator for matching error\nexport const matchingError = (error: string): LibraryAction => ({\n  type: \"MATCHING_ERROR\" as const,\n  payload: error,\n});\n\n// Action creator for completing a matching task\nexport const matchingComplete = (key: string): LibraryAction => ({\n  type: \"MATCHING_COMPLETE\" as const,\n  payload: key,\n});\n\n// Action creator for cancelling a matching task\nexport const matchingCancel = (type: string, id?: string): LibraryAction => ({\n  type: \"MATCHING_CANCEL\" as const,\n  payload: { type, id },\n});\n"],"names":[],"mappings":";;;;;;;;;;;;AAGO,MAAM,gBAAgB,CAAC,OAAmC,CAAC;QAChE,MAAM;QACN,SAAS;IACX,CAAC;AAGM,MAAM,mBAAmB,CAAC,KAAa,QAAiC,CAAC;QAC9E,MAAM;QACN,SAAS;YAAE;YAAK;QAAM;IACxB,CAAC;AAGM,MAAM,gBAAgB,CAAC,QAAiC,CAAC;QAC9D,MAAM;QACN,SAAS;IACX,CAAC;AAGM,MAAM,mBAAmB,CAAC,MAA+B,CAAC;QAC/D,MAAM;QACN,SAAS;IACX,CAAC;AAGM,MAAM,iBAAiB,CAAC,MAAc,KAA+B,CAAC;QAC3E,MAAM;QACN,SAAS;YAAE;YAAM;QAAG;IACtB,CAAC","debugId":null}},
    {"offset": {"line": 7587, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/hooks/useMatching.ts"],"sourcesContent":["import { useCallback, useRef } from \"react\";\nimport {\n  UseMatchingReturn,\n  ITrack,\n  IAlbum,\n  IPlaylist,\n  QueueTask,\n  MATCHING_STATUS,\n  MusicService,\n} from \"@/types\";\nimport { useLibrary } from \"@/contexts/LibraryContext\";\nimport { musicServiceFactory } from \"@/lib/services/factory\";\nimport {\n  matchingStart,\n  matchingProgress,\n  matchingError,\n  matchingComplete,\n  matchingCancel,\n} from \"@/contexts/LibraryContext.matchingActions\";\nimport { sentryLogger } from \"@/lib/utils/sentry-logger\";\n\n// This hook now uses global matching state from LibraryContext\nexport const useMatching = (): UseMatchingReturn => {\n  const { state, dispatch, actions } = useLibrary();\n  // Only keep queue and abortController local; all state is global\n  const queueRef = useRef<QueueTask[]>([]);\n  const isProcessingRef = useRef(false);\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  // Helper to get a unique task key for progress tracking\n  const getTaskKey = (task: QueueTask): string => {\n    if (task.type === \"playlist\") return `playlist:${task.playlist.id}`;\n    return task.type;\n  };\n\n  // Queue processor\n  const processQueue = useCallback(async (): Promise<void> => {\n    if (isProcessingRef.current || queueRef.current.length === 0) return;\n    isProcessingRef.current = true;\n    // Use action creator for matching start\n    dispatch(matchingStart(queueRef.current[0]));\n    const task = queueRef.current[0];\n    const taskKey = getTaskKey(task);\n    abortControllerRef.current = new AbortController();\n    const signal = abortControllerRef.current.signal;\n    try {\n      if (task.type === \"likedSongs\") {\n        // Cast targetService to MusicService for provider\n        const provider = musicServiceFactory.getProvider(task.targetService as MusicService);\n        // Filter out tracks that already have a targetId (already matched)\n        const tracksToMatch = task.tracks.filter(track => !track.targetId);\n        if (tracksToMatch.length === 0) {\n          // All tracks already matched, skip provider call\n          dispatch(matchingComplete(taskKey));\n          return;\n        }\n        // Set all to pending first (including already matched, for UI consistency)\n        const pendingSet = new Set(\n          Array.from(state.likedSongs ?? []).map(track => ({\n            ...track,\n            status: MATCHING_STATUS.PENDING,\n          }))\n        );\n        actions.setLikedSongs(pendingSet);\n        const result = await provider.search(tracksToMatch, progressValue => {\n          if (signal.aborted) throw new DOMException(\"Aborted\", \"AbortError\");\n          // Use action creator for progress\n          dispatch(\n            matchingProgress(\n              taskKey,\n              Math.round(progressValue < 1 ? progressValue * 100 : progressValue)\n            )\n          );\n        });\n        if (result.tracks) {\n          // Batch update: merge all result.tracks into state.likedSongs\n          const updatedTracksMap = new Map(result.tracks.map(track => [track.id, track]));\n          const updated = new Set(\n            Array.from(state.likedSongs ?? []).map(track =>\n              updatedTracksMap.has(track.id)\n                ? { ...track, ...updatedTracksMap.get(track.id) }\n                : track\n            )\n          );\n          actions.setLikedSongs(updated);\n        }\n        // Use action creator for complete\n        dispatch(matchingComplete(taskKey));\n      } else if (task.type === \"albums\") {\n        // Cast targetService to MusicService for provider\n        const provider = musicServiceFactory.getProvider(task.targetService as MusicService);\n        // Filter out albums that already have a targetId (already matched)\n        const albumsToMatch = task.albums.filter(album => !album.targetId);\n        if (albumsToMatch.length === 0) {\n          // All albums already matched, skip provider call\n          dispatch(matchingComplete(taskKey));\n          return;\n        }\n        // Set all to pending first (including already matched, for UI consistency)\n        const pendingSet = new Set(\n          Array.from(state.albums ?? []).map(album => ({\n            ...album,\n            status: MATCHING_STATUS.PENDING,\n          }))\n        );\n        actions.setAlbums(pendingSet);\n        const result = await provider.searchAlbums(albumsToMatch, progressValue => {\n          if (signal.aborted) throw new DOMException(\"Aborted\", \"AbortError\");\n          // Use action creator for progress\n          dispatch(\n            matchingProgress(\n              taskKey,\n              Math.round(progressValue < 1 ? progressValue * 100 : progressValue)\n            )\n          );\n        });\n        if (result.albums) {\n          // Batch update: merge all result.albums into state.albums\n          const updatedAlbumsMap = new Map(result.albums.map(album => [album.id, album]));\n          const updated = new Set(\n            Array.from(state.albums ?? []).map(album =>\n              updatedAlbumsMap.has(album.id)\n                ? { ...album, ...updatedAlbumsMap.get(album.id) }\n                : album\n            )\n          );\n          actions.setAlbums(updated);\n        }\n        // Use action creator for complete\n        dispatch(matchingComplete(taskKey));\n      } else if (task.type === \"playlist\") {\n        // Cast targetService to MusicService for provider\n        const provider = musicServiceFactory.getProvider(task.targetService as MusicService);\n        // Filter out tracks in the playlist that already have a targetId\n        const tracksToMatch = task.playlist.tracks.filter(track => !track.targetId);\n        if (tracksToMatch.length === 0) {\n          // All tracks already matched, skip provider call\n          dispatch(matchingComplete(taskKey));\n          return;\n        }\n        // Set all to pending first (including already matched, for UI consistency)\n        const playlistId = task.playlist.id;\n        const playlist = task.playlist;\n        if (playlist) {\n          // Use functional update to avoid stale state bugs when multiple playlists are queued\n          actions.setPlaylists(prev => {\n            const updated = new Map(prev ?? []);\n            const pendingTracks = playlist.tracks.map(track => ({\n              ...track,\n              status: MATCHING_STATUS.PENDING,\n            }));\n            updated.set(playlistId, { ...playlist, tracks: pendingTracks });\n            return updated;\n          });\n        }\n        const result = await provider.search(tracksToMatch, progressValue => {\n          if (signal.aborted) throw new DOMException(\"Aborted\", \"AbortError\");\n          // Use action creator for progress\n          dispatch(\n            matchingProgress(\n              taskKey,\n              Math.round(progressValue < 1 ? progressValue * 100 : progressValue)\n            )\n          );\n        });\n        if (result.tracks) {\n          // Batch update: merge all result.tracks into the playlist's tracks\n          // Use functional update to avoid stale state bugs when multiple playlists are queued\n          const playlist = task.playlist;\n          if (playlist) {\n            const updatedTracksMap = new Map(result.tracks.map(track => [track.id, track]));\n            actions.setPlaylists(prev => {\n              const updated = new Map(prev ?? []);\n              const updatedTracks = playlist.tracks.map(track =>\n                updatedTracksMap.has(track.id)\n                  ? { ...track, ...updatedTracksMap.get(track.id) }\n                  : track\n              );\n              updated.set(playlistId, { ...playlist, tracks: updatedTracks });\n              return updated;\n            });\n          }\n        }\n        // Use action creator for complete\n        dispatch(matchingComplete(taskKey));\n      }\n    } catch (err: unknown) {\n      if (err instanceof DOMException && err.name === \"AbortError\") {\n        // Do nothing, user cancelled\n      } else {\n        // Capture the error to Sentry with context\n        sentryLogger.captureException(err, {\n          tags: {\n            category: \"matching\",\n            taskType: task.type,\n            targetService: task.targetService,\n          },\n          extra: {\n            taskType: task.type,\n            targetService: task.targetService,\n            itemCount:\n              task.type === \"playlist\"\n                ? task.playlist.tracks.length\n                : task.type === \"albums\"\n                  ? task.albums.length\n                  : task.tracks.length,\n          },\n        });\n\n        const errorMessage = err instanceof Error ? err.message : \"Unknown error\";\n        dispatch(matchingError(errorMessage));\n      }\n    } finally {\n      queueRef.current.shift();\n      isProcessingRef.current = false;\n      abortControllerRef.current = null;\n      // If more tasks, process next\n      // Use setTimeout to defer to next event loop tick, ensuring isProcessingRef.current is reset\n      if (queueRef.current.length > 0) {\n        setTimeout(() => processQueue(), 0);\n      }\n    }\n  }, [actions, state.likedSongs, state.albums, dispatch]);\n\n  // Public API\n  const matchLikedSongs = useCallback(\n    async (tracks: ITrack[], targetService: MusicService) => {\n      if (!tracks.length) return;\n      queueRef.current.push({ type: \"likedSongs\", tracks, targetService });\n      processQueue();\n    },\n    [processQueue]\n  );\n\n  const matchAlbums = useCallback(\n    async (albums: IAlbum[], targetService: MusicService) => {\n      if (!albums.length) return;\n      queueRef.current.push({ type: \"albums\", albums, targetService });\n      processQueue();\n    },\n    [processQueue]\n  );\n\n  const matchPlaylistTracks = useCallback(\n    async (playlist: IPlaylist, targetService: MusicService) => {\n      if (!playlist.tracks.length) return;\n      queueRef.current.push({ type: \"playlist\", playlist, targetService });\n      processQueue();\n    },\n    [processQueue]\n  );\n\n  // Type guard for playlist tasks\n  function isPlaylistTask(task: QueueTask): task is Extract<QueueTask, { type: \"playlist\" }> {\n    return task.type === \"playlist\";\n  }\n\n  // Cancel a specific matching task (does not revert status)\n  const cancelMatching = useCallback(\n    (type: \"likedSongs\" | \"albums\" | \"playlist\", id?: string): void => {\n      // Check if the current task matches the cancel request\n      const currentTask = state.matching.currentTask;\n      const isCurrentTask =\n        currentTask &&\n        currentTask.type === type &&\n        (type !== \"playlist\" ||\n          (id && currentTask.type === \"playlist\" && currentTask.playlist.id === id));\n\n      if (isCurrentTask) {\n        // If cancelling the current task, only abort it.\n        // Do NOT filter the queue, let the finally block handle removal.\n        if (abortControllerRef.current) {\n          abortControllerRef.current.abort();\n        }\n      } else {\n        // If cancelling a queued (not running) task, filter it out from the queue.\n        queueRef.current = queueRef.current.filter(task => {\n          if (task.type !== type) return true;\n          if (type === \"playlist\" && id && isPlaylistTask(task)) return task.playlist.id !== id;\n          // Remove if matches\n          return false;\n        });\n      }\n      // Only dispatch matchingCancel for the affected task (once)\n      dispatch(matchingCancel(type, id));\n      // Note: processQueue will be called in processQueue's finally block if there are more tasks\n    },\n    [dispatch, state.matching.currentTask]\n  );\n\n  // Get progress for a given task type/id\n  const getProgress = useCallback(\n    (type: \"likedSongs\" | \"albums\" | \"playlist\", id?: string): number => {\n      const key = type === \"playlist\" && id ? `playlist:${id}` : type;\n      return state.matching.progress[key] ?? 0;\n    },\n    [state.matching.progress]\n  );\n\n  return {\n    isLoading: state.matching.isLoading,\n    error: state.matching.error,\n    matchLikedSongs,\n    matchAlbums,\n    matchPlaylistTracks,\n    cancelMatching,\n    getProgress,\n    currentTask: state.matching.currentTask,\n  };\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;AASA;AACA;AACA;AAOA;;;;;;;AAGO,MAAM,cAAc;IACzB,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,GAAG,IAAA,+JAAU;IAC/C,iEAAiE;IACjE,MAAM,WAAW,IAAA,8ZAAM,EAAc,EAAE;IACvC,MAAM,kBAAkB,IAAA,8ZAAM,EAAC;IAC/B,MAAM,qBAAqB,IAAA,8ZAAM,EAAyB;IAE1D,wDAAwD;IACxD,MAAM,aAAa,CAAC;QAClB,IAAI,KAAK,IAAI,KAAK,YAAY,OAAO,CAAC,SAAS,EAAE,KAAK,QAAQ,CAAC,EAAE,EAAE;QACnE,OAAO,KAAK,IAAI;IAClB;IAEA,kBAAkB;IAClB,MAAM,eAAe,IAAA,maAAW,EAAC;QAC/B,IAAI,gBAAgB,OAAO,IAAI,SAAS,OAAO,CAAC,MAAM,KAAK,GAAG;QAC9D,gBAAgB,OAAO,GAAG;QAC1B,wCAAwC;QACxC,SAAS,IAAA,oLAAa,EAAC,SAAS,OAAO,CAAC,EAAE;QAC1C,MAAM,OAAO,SAAS,OAAO,CAAC,EAAE;QAChC,MAAM,UAAU,WAAW;QAC3B,mBAAmB,OAAO,GAAG,IAAI;QACjC,MAAM,SAAS,mBAAmB,OAAO,CAAC,MAAM;QAChD,IAAI;YACF,IAAI,KAAK,IAAI,KAAK,cAAc;gBAC9B,kDAAkD;gBAClD,MAAM,WAAW,uKAAmB,CAAC,WAAW,CAAC,KAAK,aAAa;gBACnE,mEAAmE;gBACnE,MAAM,gBAAgB,KAAK,MAAM,CAAC,MAAM,CAAC,CAAA,QAAS,CAAC,MAAM,QAAQ;gBACjE,IAAI,cAAc,MAAM,KAAK,GAAG;oBAC9B,iDAAiD;oBACjD,SAAS,IAAA,uLAAgB,EAAC;oBAC1B;gBACF;gBACA,2EAA2E;gBAC3E,MAAM,aAAa,IAAI,IACrB,MAAM,IAAI,CAAC,MAAM,UAAU,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,QAAS,CAAC;wBAC/C,GAAG,KAAK;wBACR,QAAQ,oKAAe,CAAC,OAAO;oBACjC,CAAC;gBAEH,QAAQ,aAAa,CAAC;gBACtB,MAAM,SAAS,MAAM,SAAS,MAAM,CAAC,eAAe,CAAA;oBAClD,IAAI,OAAO,OAAO,EAAE,MAAM,IAAI,aAAa,WAAW;oBACtD,kCAAkC;oBAClC,SACE,IAAA,uLAAgB,EACd,SACA,KAAK,KAAK,CAAC,gBAAgB,IAAI,gBAAgB,MAAM;gBAG3D;gBACA,IAAI,OAAO,MAAM,EAAE;oBACjB,8DAA8D;oBAC9D,MAAM,mBAAmB,IAAI,IAAI,OAAO,MAAM,CAAC,GAAG,CAAC,CAAA,QAAS;4BAAC,MAAM,EAAE;4BAAE;yBAAM;oBAC7E,MAAM,UAAU,IAAI,IAClB,MAAM,IAAI,CAAC,MAAM,UAAU,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,QACrC,iBAAiB,GAAG,CAAC,MAAM,EAAE,IACzB;4BAAE,GAAG,KAAK;4BAAE,GAAG,iBAAiB,GAAG,CAAC,MAAM,EAAE,CAAC;wBAAC,IAC9C;oBAGR,QAAQ,aAAa,CAAC;gBACxB;gBACA,kCAAkC;gBAClC,SAAS,IAAA,uLAAgB,EAAC;YAC5B,OAAO,IAAI,KAAK,IAAI,KAAK,UAAU;gBACjC,kDAAkD;gBAClD,MAAM,WAAW,uKAAmB,CAAC,WAAW,CAAC,KAAK,aAAa;gBACnE,mEAAmE;gBACnE,MAAM,gBAAgB,KAAK,MAAM,CAAC,MAAM,CAAC,CAAA,QAAS,CAAC,MAAM,QAAQ;gBACjE,IAAI,cAAc,MAAM,KAAK,GAAG;oBAC9B,iDAAiD;oBACjD,SAAS,IAAA,uLAAgB,EAAC;oBAC1B;gBACF;gBACA,2EAA2E;gBAC3E,MAAM,aAAa,IAAI,IACrB,MAAM,IAAI,CAAC,MAAM,MAAM,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,QAAS,CAAC;wBAC3C,GAAG,KAAK;wBACR,QAAQ,oKAAe,CAAC,OAAO;oBACjC,CAAC;gBAEH,QAAQ,SAAS,CAAC;gBAClB,MAAM,SAAS,MAAM,SAAS,YAAY,CAAC,eAAe,CAAA;oBACxD,IAAI,OAAO,OAAO,EAAE,MAAM,IAAI,aAAa,WAAW;oBACtD,kCAAkC;oBAClC,SACE,IAAA,uLAAgB,EACd,SACA,KAAK,KAAK,CAAC,gBAAgB,IAAI,gBAAgB,MAAM;gBAG3D;gBACA,IAAI,OAAO,MAAM,EAAE;oBACjB,0DAA0D;oBAC1D,MAAM,mBAAmB,IAAI,IAAI,OAAO,MAAM,CAAC,GAAG,CAAC,CAAA,QAAS;4BAAC,MAAM,EAAE;4BAAE;yBAAM;oBAC7E,MAAM,UAAU,IAAI,IAClB,MAAM,IAAI,CAAC,MAAM,MAAM,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,QACjC,iBAAiB,GAAG,CAAC,MAAM,EAAE,IACzB;4BAAE,GAAG,KAAK;4BAAE,GAAG,iBAAiB,GAAG,CAAC,MAAM,EAAE,CAAC;wBAAC,IAC9C;oBAGR,QAAQ,SAAS,CAAC;gBACpB;gBACA,kCAAkC;gBAClC,SAAS,IAAA,uLAAgB,EAAC;YAC5B,OAAO,IAAI,KAAK,IAAI,KAAK,YAAY;gBACnC,kDAAkD;gBAClD,MAAM,WAAW,uKAAmB,CAAC,WAAW,CAAC,KAAK,aAAa;gBACnE,iEAAiE;gBACjE,MAAM,gBAAgB,KAAK,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,CAAA,QAAS,CAAC,MAAM,QAAQ;gBAC1E,IAAI,cAAc,MAAM,KAAK,GAAG;oBAC9B,iDAAiD;oBACjD,SAAS,IAAA,uLAAgB,EAAC;oBAC1B;gBACF;gBACA,2EAA2E;gBAC3E,MAAM,aAAa,KAAK,QAAQ,CAAC,EAAE;gBACnC,MAAM,WAAW,KAAK,QAAQ;gBAC9B,IAAI,UAAU;oBACZ,qFAAqF;oBACrF,QAAQ,YAAY,CAAC,CAAA;wBACnB,MAAM,UAAU,IAAI,IAAI,QAAQ,EAAE;wBAClC,MAAM,gBAAgB,SAAS,MAAM,CAAC,GAAG,CAAC,CAAA,QAAS,CAAC;gCAClD,GAAG,KAAK;gCACR,QAAQ,oKAAe,CAAC,OAAO;4BACjC,CAAC;wBACD,QAAQ,GAAG,CAAC,YAAY;4BAAE,GAAG,QAAQ;4BAAE,QAAQ;wBAAc;wBAC7D,OAAO;oBACT;gBACF;gBACA,MAAM,SAAS,MAAM,SAAS,MAAM,CAAC,eAAe,CAAA;oBAClD,IAAI,OAAO,OAAO,EAAE,MAAM,IAAI,aAAa,WAAW;oBACtD,kCAAkC;oBAClC,SACE,IAAA,uLAAgB,EACd,SACA,KAAK,KAAK,CAAC,gBAAgB,IAAI,gBAAgB,MAAM;gBAG3D;gBACA,IAAI,OAAO,MAAM,EAAE;oBACjB,mEAAmE;oBACnE,qFAAqF;oBACrF,MAAM,WAAW,KAAK,QAAQ;oBAC9B,IAAI,UAAU;wBACZ,MAAM,mBAAmB,IAAI,IAAI,OAAO,MAAM,CAAC,GAAG,CAAC,CAAA,QAAS;gCAAC,MAAM,EAAE;gCAAE;6BAAM;wBAC7E,QAAQ,YAAY,CAAC,CAAA;4BACnB,MAAM,UAAU,IAAI,IAAI,QAAQ,EAAE;4BAClC,MAAM,gBAAgB,SAAS,MAAM,CAAC,GAAG,CAAC,CAAA,QACxC,iBAAiB,GAAG,CAAC,MAAM,EAAE,IACzB;oCAAE,GAAG,KAAK;oCAAE,GAAG,iBAAiB,GAAG,CAAC,MAAM,EAAE,CAAC;gCAAC,IAC9C;4BAEN,QAAQ,GAAG,CAAC,YAAY;gCAAE,GAAG,QAAQ;gCAAE,QAAQ;4BAAc;4BAC7D,OAAO;wBACT;oBACF;gBACF;gBACA,kCAAkC;gBAClC,SAAS,IAAA,uLAAgB,EAAC;YAC5B;QACF,EAAE,OAAO,KAAc;YACrB,IAAI,eAAe,gBAAgB,IAAI,IAAI,KAAK,cAAc;YAC5D,6BAA6B;YAC/B,OAAO;gBACL,2CAA2C;gBAC3C,sKAAY,CAAC,gBAAgB,CAAC,KAAK;oBACjC,MAAM;wBACJ,UAAU;wBACV,UAAU,KAAK,IAAI;wBACnB,eAAe,KAAK,aAAa;oBACnC;oBACA,OAAO;wBACL,UAAU,KAAK,IAAI;wBACnB,eAAe,KAAK,aAAa;wBACjC,WACE,KAAK,IAAI,KAAK,aACV,KAAK,QAAQ,CAAC,MAAM,CAAC,MAAM,GAC3B,KAAK,IAAI,KAAK,WACZ,KAAK,MAAM,CAAC,MAAM,GAClB,KAAK,MAAM,CAAC,MAAM;oBAC5B;gBACF;gBAEA,MAAM,eAAe,eAAe,QAAQ,IAAI,OAAO,GAAG;gBAC1D,SAAS,IAAA,oLAAa,EAAC;YACzB;QACF,SAAU;YACR,SAAS,OAAO,CAAC,KAAK;YACtB,gBAAgB,OAAO,GAAG;YAC1B,mBAAmB,OAAO,GAAG;YAC7B,8BAA8B;YAC9B,6FAA6F;YAC7F,IAAI,SAAS,OAAO,CAAC,MAAM,GAAG,GAAG;gBAC/B,WAAW,IAAM,gBAAgB;YACnC;QACF;IACF,GAAG;QAAC;QAAS,MAAM,UAAU;QAAE,MAAM,MAAM;QAAE;KAAS;IAEtD,aAAa;IACb,MAAM,kBAAkB,IAAA,maAAW,EACjC,OAAO,QAAkB;QACvB,IAAI,CAAC,OAAO,MAAM,EAAE;QACpB,SAAS,OAAO,CAAC,IAAI,CAAC;YAAE,MAAM;YAAc;YAAQ;QAAc;QAClE;IACF,GACA;QAAC;KAAa;IAGhB,MAAM,cAAc,IAAA,maAAW,EAC7B,OAAO,QAAkB;QACvB,IAAI,CAAC,OAAO,MAAM,EAAE;QACpB,SAAS,OAAO,CAAC,IAAI,CAAC;YAAE,MAAM;YAAU;YAAQ;QAAc;QAC9D;IACF,GACA;QAAC;KAAa;IAGhB,MAAM,sBAAsB,IAAA,maAAW,EACrC,OAAO,UAAqB;QAC1B,IAAI,CAAC,SAAS,MAAM,CAAC,MAAM,EAAE;QAC7B,SAAS,OAAO,CAAC,IAAI,CAAC;YAAE,MAAM;YAAY;YAAU;QAAc;QAClE;IACF,GACA;QAAC;KAAa;IAGhB,gCAAgC;IAChC,SAAS,eAAe,IAAe;QACrC,OAAO,KAAK,IAAI,KAAK;IACvB;IAEA,2DAA2D;IAC3D,MAAM,iBAAiB,IAAA,maAAW,EAChC,CAAC,MAA4C;QAC3C,uDAAuD;QACvD,MAAM,cAAc,MAAM,QAAQ,CAAC,WAAW;QAC9C,MAAM,gBACJ,eACA,YAAY,IAAI,KAAK,QACrB,CAAC,SAAS,cACP,MAAM,YAAY,IAAI,KAAK,cAAc,YAAY,QAAQ,CAAC,EAAE,KAAK,EAAG;QAE7E,IAAI,eAAe;YACjB,iDAAiD;YACjD,iEAAiE;YACjE,IAAI,mBAAmB,OAAO,EAAE;gBAC9B,mBAAmB,OAAO,CAAC,KAAK;YAClC;QACF,OAAO;YACL,2EAA2E;YAC3E,SAAS,OAAO,GAAG,SAAS,OAAO,CAAC,MAAM,CAAC,CAAA;gBACzC,IAAI,KAAK,IAAI,KAAK,MAAM,OAAO;gBAC/B,IAAI,SAAS,cAAc,MAAM,eAAe,OAAO,OAAO,KAAK,QAAQ,CAAC,EAAE,KAAK;gBACnF,oBAAoB;gBACpB,OAAO;YACT;QACF;QACA,4DAA4D;QAC5D,SAAS,IAAA,qLAAc,EAAC,MAAM;IAC9B,4FAA4F;IAC9F,GACA;QAAC;QAAU,MAAM,QAAQ,CAAC,WAAW;KAAC;IAGxC,wCAAwC;IACxC,MAAM,cAAc,IAAA,maAAW,EAC7B,CAAC,MAA4C;QAC3C,MAAM,MAAM,SAAS,cAAc,KAAK,CAAC,SAAS,EAAE,IAAI,GAAG;QAC3D,OAAO,MAAM,QAAQ,CAAC,QAAQ,CAAC,IAAI,IAAI;IACzC,GACA;QAAC,MAAM,QAAQ,CAAC,QAAQ;KAAC;IAG3B,OAAO;QACL,WAAW,MAAM,QAAQ,CAAC,SAAS;QACnC,OAAO,MAAM,QAAQ,CAAC,KAAK;QAC3B;QACA;QACA;QACA;QACA;QACA,aAAa,MAAM,QAAQ,CAAC,WAAW;IACzC;AACF","debugId":null}},
    {"offset": {"line": 7878, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/IndeterminateCheckbox.tsx"],"sourcesContent":["import { FC, useRef, useEffect } from \"react\";\n\ninterface IndeterminateCheckboxProps {\n  selectedCount: number;\n  totalCount: number;\n  onChange: () => void;\n  onClick?: (e: React.MouseEvent) => void;\n  disabled?: boolean;\n  className?: string;\n  label: string;\n  testId?: string;\n}\n\nexport const IndeterminateCheckbox: FC<IndeterminateCheckboxProps> = ({\n  selectedCount,\n  totalCount,\n  onChange,\n  onClick,\n  disabled = false,\n  className = \"\",\n  label,\n  testId,\n}) => {\n  const checkboxRef = useRef<HTMLInputElement>(null);\n  const isIndeterminate = selectedCount > 0 && selectedCount < totalCount;\n  const isChecked = selectedCount === totalCount && totalCount > 0;\n\n  useEffect(() => {\n    if (checkboxRef.current) {\n      checkboxRef.current.indeterminate = isIndeterminate;\n    }\n  }, [isIndeterminate]);\n\n  return (\n    <div className=\"flex items-center\">\n      <input\n        ref={checkboxRef}\n        type=\"checkbox\"\n        className={`h-5 w-5 flex-shrink-0 cursor-pointer accent-[#8B7FFF] ${className}`}\n        checked={isChecked}\n        onChange={onChange}\n        onClick={onClick}\n        disabled={disabled}\n        aria-label={label}\n        data-testid={testId || `checkbox-${label.toLowerCase().replace(/\\s+/g, \"-\")}`}\n      />\n      <span className=\"sr-only fixed\">{label}</span>\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAAA;;;AAaO,MAAM,wBAAwD,CAAC,EACpE,aAAa,EACb,UAAU,EACV,QAAQ,EACR,OAAO,EACP,WAAW,KAAK,EAChB,YAAY,EAAE,EACd,KAAK,EACL,MAAM,EACP;IACC,MAAM,cAAc,IAAA,8ZAAM,EAAmB;IAC7C,MAAM,kBAAkB,gBAAgB,KAAK,gBAAgB;IAC7D,MAAM,YAAY,kBAAkB,cAAc,aAAa;IAE/D,IAAA,iaAAS,EAAC;QACR,IAAI,YAAY,OAAO,EAAE;YACvB,YAAY,OAAO,CAAC,aAAa,GAAG;QACtC;IACF,GAAG;QAAC;KAAgB;IAEpB,qBACE,6bAAC;QAAI,WAAU;;0BACb,6bAAC;gBACC,KAAK;gBACL,MAAK;gBACL,WAAW,CAAC,sDAAsD,EAAE,WAAW;gBAC/E,SAAS;gBACT,UAAU;gBACV,SAAS;gBACT,UAAU;gBACV,cAAY;gBACZ,eAAa,UAAU,CAAC,SAAS,EAAE,MAAM,WAAW,GAAG,OAAO,CAAC,QAAQ,MAAM;;;;;;0BAE/E,6bAAC;gBAAK,WAAU;0BAAiB;;;;;;;;;;;;AAGvC","debugId":null}},
    {"offset": {"line": 7934, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/ArtworkImage.tsx"],"sourcesContent":["import Image from \"next/image\";\n\ntype ArtworkType = \"liked\" | \"album\" | \"playlist\";\n\ninterface ArtworkImageProps {\n  src?: string | null;\n  alt: string;\n  /**\n   * Artwork size in pixels. Defaults to 48 if not provided.\n   */\n  size?: number;\n  type?: ArtworkType;\n  className?: string;\n  objectFit?: \"cover\" | \"contain\";\n  /**\n   * For albums grid: up to 4 artwork URLs to display as a grid.\n   */\n  multiSrc?: string[];\n}\n\nconst FALLBACK_CONFIGS = {\n  liked: {\n    bgColor: \"bg-red-100 dark:bg-red-900/30\",\n    iconColor: \"text-red-500\",\n    icon: (\n      <svg className=\"h-6 w-6\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n        <path\n          fillRule=\"evenodd\"\n          d=\"M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z\"\n          clipRule=\"evenodd\"\n        />\n      </svg>\n    ),\n  },\n  album: {\n    bgColor: \"bg-purple-100 dark:bg-purple-900/30\",\n    iconColor: \"text-purple-500\",\n    icon: (\n      <svg className=\"h-6 w-6\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n        <path d=\"M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm4 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z\" />\n      </svg>\n    ),\n  },\n  playlist: {\n    bgColor: \"bg-indigo-100 dark:bg-indigo-900/30\",\n    iconColor: \"text-indigo-500\",\n    icon: (\n      <svg className=\"h-6 w-6\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n        <path d=\"M2 4a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zm0 4a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zm1 3a1 1 0 100 2h14a1 1 0 100-2H3z\" />\n      </svg>\n    ),\n  },\n};\n\nexport const ArtworkImage: React.FC<ArtworkImageProps> = ({\n  src,\n  alt,\n  size = 48,\n  type = \"playlist\",\n  className = \"\",\n  objectFit = \"cover\",\n  multiSrc,\n}) => {\n  const baseClassName =\n    \"relative overflow-hidden rounded-md shadow-sm transition-transform duration-200\";\n  const finalClassName = `${baseClassName} ${className}`;\n\n  // Special grid for albums: up to 4 images\n  if (type === \"album\" && Array.isArray(multiSrc) && multiSrc.length > 1) {\n    // Only use up to 4 images\n    const images = multiSrc.slice(0, 4);\n    // Grid layout: 2x2 for 4, 1x2 for 2, 1x3 for 3\n    // Fallback to placeholder for missing images\n    return (\n      <div\n        style={{ width: size, height: size }}\n        className={`grid ${images.length > 2 ? \"grid-cols-2 grid-rows-2\" : \"grid-cols-2 grid-rows-1\"} gap-0.5 rounded-md bg-purple-100 dark:bg-purple-900/30 ${finalClassName}`}\n      >\n        {Array.from({ length: images.length < 4 ? images.length : 4 }).map((_, i) =>\n          images[i] ? (\n            <div key={i} className=\"relative h-full w-full\">\n              <Image\n                src={images[i]}\n                alt={alt + ` ${i + 1}`}\n                fill\n                className={`object-${objectFit} rounded-[2px]`}\n                sizes={`${Math.floor(size / 2)}px`}\n              />\n            </div>\n          ) : (\n            <div\n              key={i}\n              className=\"flex h-full w-full items-center justify-center rounded-[2px] bg-purple-100 dark:bg-purple-900/30\"\n            >\n              <span className=\"text-purple-300\">?</span>\n            </div>\n          )\n        )}\n      </div>\n    );\n  }\n\n  // Fallback to single image or icon\n  if (!src) {\n    const fallback = FALLBACK_CONFIGS[type];\n    return (\n      <div\n        style={{ width: size, height: size }}\n        className={`flex items-center justify-center ${fallback.bgColor} ${finalClassName}`}\n      >\n        <div className={fallback.iconColor}>{fallback.icon}</div>\n      </div>\n    );\n  }\n\n  return (\n    <div style={{ width: size, height: size }} className={finalClassName}>\n      <Image src={src} alt={alt} fill className={`object-${objectFit}`} sizes={`${size}px`} />\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAAA;;;AAoBA,MAAM,mBAAmB;IACvB,OAAO;QACL,SAAS;QACT,WAAW;QACX,oBACE,6bAAC;YAAI,WAAU;YAAU,MAAK;YAAe,SAAQ;sBACnD,cAAA,6bAAC;gBACC,UAAS;gBACT,GAAE;gBACF,UAAS;;;;;;;;;;;IAIjB;IACA,OAAO;QACL,SAAS;QACT,WAAW;QACX,oBACE,6bAAC;YAAI,WAAU;YAAU,MAAK;YAAe,SAAQ;sBACnD,cAAA,6bAAC;gBAAK,GAAE;;;;;;;;;;;IAGd;IACA,UAAU;QACR,SAAS;QACT,WAAW;QACX,oBACE,6bAAC;YAAI,WAAU;YAAU,MAAK;YAAe,SAAQ;sBACnD,cAAA,6bAAC;gBAAK,GAAE;;;;;;;;;;;IAGd;AACF;AAEO,MAAM,eAA4C,CAAC,EACxD,GAAG,EACH,GAAG,EACH,OAAO,EAAE,EACT,OAAO,UAAU,EACjB,YAAY,EAAE,EACd,YAAY,OAAO,EACnB,QAAQ,EACT;IACC,MAAM,gBACJ;IACF,MAAM,iBAAiB,GAAG,cAAc,CAAC,EAAE,WAAW;IAEtD,0CAA0C;IAC1C,IAAI,SAAS,WAAW,MAAM,OAAO,CAAC,aAAa,SAAS,MAAM,GAAG,GAAG;QACtE,0BAA0B;QAC1B,MAAM,SAAS,SAAS,KAAK,CAAC,GAAG;QACjC,+CAA+C;QAC/C,6CAA6C;QAC7C,qBACE,6bAAC;YACC,OAAO;gBAAE,OAAO;gBAAM,QAAQ;YAAK;YACnC,WAAW,CAAC,KAAK,EAAE,OAAO,MAAM,GAAG,IAAI,4BAA4B,0BAA0B,wDAAwD,EAAE,gBAAgB;sBAEtK,MAAM,IAAI,CAAC;gBAAE,QAAQ,OAAO,MAAM,GAAG,IAAI,OAAO,MAAM,GAAG;YAAE,GAAG,GAAG,CAAC,CAAC,GAAG,IACrE,MAAM,CAAC,EAAE,iBACP,6bAAC;oBAAY,WAAU;8BACrB,cAAA,6bAAC,uVAAK;wBACJ,KAAK,MAAM,CAAC,EAAE;wBACd,KAAK,MAAM,CAAC,CAAC,EAAE,IAAI,GAAG;wBACtB,IAAI;wBACJ,WAAW,CAAC,OAAO,EAAE,UAAU,cAAc,CAAC;wBAC9C,OAAO,GAAG,KAAK,KAAK,CAAC,OAAO,GAAG,EAAE,CAAC;;;;;;mBAN5B;;;;6EAUV,6bAAC;oBAEC,WAAU;8BAEV,cAAA,6bAAC;wBAAK,WAAU;kCAAkB;;;;;;mBAH7B;;;;;;;;;;IASjB;IAEA,mCAAmC;IACnC,IAAI,CAAC,KAAK;QACR,MAAM,WAAW,gBAAgB,CAAC,KAAK;QACvC,qBACE,6bAAC;YACC,OAAO;gBAAE,OAAO;gBAAM,QAAQ;YAAK;YACnC,WAAW,CAAC,iCAAiC,EAAE,SAAS,OAAO,CAAC,CAAC,EAAE,gBAAgB;sBAEnF,cAAA,6bAAC;gBAAI,WAAW,SAAS,SAAS;0BAAG,SAAS,IAAI;;;;;;;;;;;IAGxD;IAEA,qBACE,6bAAC;QAAI,OAAO;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,WAAW;kBACpD,cAAA,6bAAC,uVAAK;YAAC,KAAK;YAAK,KAAK;YAAK,IAAI;YAAC,WAAW,CAAC,OAAO,EAAE,WAAW;YAAE,OAAO,GAAG,KAAK,EAAE,CAAC;;;;;;;;;;;AAG1F","debugId":null}},
    {"offset": {"line": 8111, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/CircularProgress.tsx"],"sourcesContent":["import { FC, useEffect, useState } from \"react\";\n\ninterface CircularProgressProps {\n  progress: number; // 0 to 100\n  size?: number;\n  onComplete?: () => void;\n}\n\nexport const CircularProgress: FC<CircularProgressProps> = ({\n  progress,\n  size = 24,\n  onComplete,\n}) => {\n  const [showSuccess, setShowSuccess] = useState(false);\n  const [isVisible, setIsVisible] = useState(true);\n  const strokeWidth = 3;\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const normalizedProgress = Math.min(Math.max(progress, 0), 100) / 100;\n  const offset = circumference - normalizedProgress * circumference;\n\n  useEffect(() => {\n    let successTimer: NodeJS.Timeout;\n\n    if (progress >= 100) {\n      // Show success state immediately when progress is complete\n      setShowSuccess(true);\n      setIsVisible(true);\n\n      // Keep success state visible for 1 second\n      successTimer = setTimeout(() => {\n        if (onComplete) {\n          onComplete();\n        }\n        setIsVisible(false);\n      }, 1000);\n    } else {\n      setShowSuccess(false);\n      setIsVisible(true);\n    }\n\n    return () => {\n      if (successTimer) clearTimeout(successTimer);\n    };\n  }, [progress, onComplete]);\n\n  if (!isVisible) return null;\n\n  return (\n    <div\n      className={`absolute inset-0 flex items-center justify-center transition-opacity duration-300 ${isVisible ? \"opacity-100\" : \"opacity-0\"}`}\n      data-progress={Math.round(progress)}\n    >\n      <div className=\"rounded-full bg-black/30 p-1\">\n        <svg width={size} height={size} className=\"rotate-[-90deg] transform\">\n          <circle\n            className=\"text-zinc-600/30\"\n            strokeWidth={strokeWidth}\n            stroke=\"currentColor\"\n            fill=\"transparent\"\n            r={radius}\n            cx={size / 2}\n            cy={size / 2}\n          />\n          <circle\n            className={`transition-all duration-300 ease-in-out ${\n              showSuccess ? \"text-emerald-500\" : \"text-white\"\n            }`}\n            strokeWidth={strokeWidth}\n            strokeDasharray={circumference}\n            strokeDashoffset={offset}\n            stroke=\"currentColor\"\n            fill=\"transparent\"\n            r={radius}\n            cx={size / 2}\n            cy={size / 2}\n          />\n        </svg>\n      </div>\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAAA;;;AAQO,MAAM,mBAA8C,CAAC,EAC1D,QAAQ,EACR,OAAO,EAAE,EACT,UAAU,EACX;IACC,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,gaAAQ,EAAC;IAC/C,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,gaAAQ,EAAC;IAC3C,MAAM,cAAc;IACpB,MAAM,SAAS,CAAC,OAAO,WAAW,IAAI;IACtC,MAAM,gBAAgB,SAAS,IAAI,KAAK,EAAE;IAC1C,MAAM,qBAAqB,KAAK,GAAG,CAAC,KAAK,GAAG,CAAC,UAAU,IAAI,OAAO;IAClE,MAAM,SAAS,gBAAgB,qBAAqB;IAEpD,IAAA,iaAAS,EAAC;QACR,IAAI;QAEJ,IAAI,YAAY,KAAK;YACnB,2DAA2D;YAC3D,eAAe;YACf,aAAa;YAEb,0CAA0C;YAC1C,eAAe,WAAW;gBACxB,IAAI,YAAY;oBACd;gBACF;gBACA,aAAa;YACf,GAAG;QACL,OAAO;YACL,eAAe;YACf,aAAa;QACf;QAEA,OAAO;YACL,IAAI,cAAc,aAAa;QACjC;IACF,GAAG;QAAC;QAAU;KAAW;IAEzB,IAAI,CAAC,WAAW,OAAO;IAEvB,qBACE,6bAAC;QACC,WAAW,CAAC,kFAAkF,EAAE,YAAY,gBAAgB,aAAa;QACzI,iBAAe,KAAK,KAAK,CAAC;kBAE1B,cAAA,6bAAC;YAAI,WAAU;sBACb,cAAA,6bAAC;gBAAI,OAAO;gBAAM,QAAQ;gBAAM,WAAU;;kCACxC,6bAAC;wBACC,WAAU;wBACV,aAAa;wBACb,QAAO;wBACP,MAAK;wBACL,GAAG;wBACH,IAAI,OAAO;wBACX,IAAI,OAAO;;;;;;kCAEb,6bAAC;wBACC,WAAW,CAAC,wCAAwC,EAClD,cAAc,qBAAqB,cACnC;wBACF,aAAa;wBACb,iBAAiB;wBACjB,kBAAkB;wBAClB,QAAO;wBACP,MAAK;wBACL,GAAG;wBACH,IAAI,OAAO;wBACX,IAAI,OAAO;;;;;;;;;;;;;;;;;;;;;;AAMvB","debugId":null}},
    {"offset": {"line": 8211, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/musicApi.ts"],"sourcesContent":["import {\n  MusicService,\n  TransferResult,\n  IMusicServiceProvider,\n  ILibraryData,\n  ITrack,\n  IAlbum,\n} from \"@/types\";\nimport { musicServiceFactory } from \"./services/factory\";\nimport { isDeezerSource } from \"./services/deezer/auth\";\nimport { getYouTubeAuthData } from \"./services/youtube/auth\";\nimport { getSpotifyAuthData } from \"./services/spotify/auth\";\nimport { getAppleMusicAuthData } from \"./services/apple/auth\";\n\nasync function getCurrentService(\n  role: \"source\" | \"target\" = \"source\"\n): Promise<IMusicServiceProvider> {\n  const service = await getActiveService(role);\n  if (!service) {\n    throw new Error(`No active ${role} service found`);\n  }\n\n  return musicServiceFactory.getProvider(service);\n}\n\nasync function getActiveService(role: \"source\" | \"target\"): Promise<MusicService> {\n  try {\n    // Check Apple Music\n    const appleAuth = getAppleMusicAuthData(role);\n    if (appleAuth) return \"apple\";\n\n    // Check Spotify - needs special handling as it's async\n    try {\n      const spotifyAuth = await getSpotifyAuthData(role);\n      if (spotifyAuth !== null) return \"spotify\";\n    } catch (error) {\n      console.error(\"Error checking Spotify auth:\", error);\n    }\n\n    // Check YouTube\n    try {\n      const youtubeAuth = await getYouTubeAuthData(role);\n      if (youtubeAuth !== null) return \"youtube\";\n    } catch (error) {\n      console.error(\"Error checking YouTube auth:\", error);\n    }\n\n    // Special case for Deezer - only works as source\n    if (role === \"source\" && isDeezerSource()) return \"deezer\";\n\n    throw new Error(\"No active service found\");\n  } catch (error) {\n    console.error(\"Error getting active service:\", error);\n    throw new Error(\"Error getting active service\");\n  }\n}\n\nexport async function getSourceService(): Promise<MusicService> {\n  return await getActiveService(\"source\");\n}\n\nexport async function getTargetService(): Promise<MusicService> {\n  return await getActiveService(\"target\");\n}\n\nexport async function fetchUserLibrary(): Promise<ILibraryData> {\n  const provider = await getCurrentService(\"source\");\n  return provider.fetchUserLibrary();\n}\n\nexport async function fetchPlaylistTracks(\n  playlistId: string,\n  onProgress?: (tracks: ITrack[], progress: number) => void\n): Promise<ITrack[]> {\n  const provider = await getCurrentService(\"source\");\n  return provider.fetchPlaylistTracks(playlistId, onProgress);\n}\n\nexport async function addTracksToLibrary(tracks: ITrack[]): Promise<TransferResult> {\n  const provider = await getCurrentService(\"target\");\n  return provider.addTracksToLibrary(tracks);\n}\n\nexport async function createPlaylistWithTracks(\n  name: string,\n  tracks: ITrack[],\n  description?: string\n): Promise<TransferResult> {\n  const provider = await getCurrentService(\"target\");\n  return provider.createPlaylistWithTracks(name, tracks, description);\n}\n\nexport async function addAlbumsToLibrary(albums: Set<IAlbum>): Promise<TransferResult> {\n  const provider = await getCurrentService(\"target\");\n  return provider.addAlbumsToLibrary(albums);\n}\n\nexport async function getLibraryData(): Promise<ILibraryData> {\n  const provider = await getCurrentService(\"source\");\n  return provider.fetchUserLibrary();\n}\n\nexport async function getSourceLibrary(): Promise<ILibraryData> {\n  const sourceService = await getActiveService(\"source\");\n  if (!sourceService) {\n    throw new Error(\"No source service selected\");\n  }\n  return getLibraryData();\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAQA;AACA;AACA;AACA;AACA;;;;;;AAEA,eAAe,kBACb,OAA4B,QAAQ;IAEpC,MAAM,UAAU,MAAM,iBAAiB;IACvC,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM,CAAC,UAAU,EAAE,KAAK,cAAc,CAAC;IACnD;IAEA,OAAO,uKAAmB,CAAC,WAAW,CAAC;AACzC;AAEA,eAAe,iBAAiB,IAAyB;IACvD,IAAI;QACF,oBAAoB;QACpB,MAAM,YAAY,IAAA,+KAAqB,EAAC;QACxC,IAAI,WAAW,OAAO;QAEtB,uDAAuD;QACvD,IAAI;YACF,MAAM,cAAc,MAAM,IAAA,8KAAkB,EAAC;YAC7C,IAAI,gBAAgB,MAAM,OAAO;QACnC,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,gCAAgC;QAChD;QAEA,gBAAgB;QAChB,IAAI;YACF,MAAM,cAAc,MAAM,IAAA,8KAAkB,EAAC;YAC7C,IAAI,gBAAgB,MAAM,OAAO;QACnC,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,gCAAgC;QAChD;QAEA,iDAAiD;QACjD,IAAI,SAAS,YAAY,IAAA,yKAAc,KAAI,OAAO;QAElD,MAAM,IAAI,MAAM;IAClB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,MAAM,IAAI,MAAM;IAClB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,iBAAiB;AAChC;AAEO,eAAe;IACpB,OAAO,MAAM,iBAAiB;AAChC;AAEO,eAAe;IACpB,MAAM,WAAW,MAAM,kBAAkB;IACzC,OAAO,SAAS,gBAAgB;AAClC;AAEO,eAAe,oBACpB,UAAkB,EAClB,UAAyD;IAEzD,MAAM,WAAW,MAAM,kBAAkB;IACzC,OAAO,SAAS,mBAAmB,CAAC,YAAY;AAClD;AAEO,eAAe,mBAAmB,MAAgB;IACvD,MAAM,WAAW,MAAM,kBAAkB;IACzC,OAAO,SAAS,kBAAkB,CAAC;AACrC;AAEO,eAAe,yBACpB,IAAY,EACZ,MAAgB,EAChB,WAAoB;IAEpB,MAAM,WAAW,MAAM,kBAAkB;IACzC,OAAO,SAAS,wBAAwB,CAAC,MAAM,QAAQ;AACzD;AAEO,eAAe,mBAAmB,MAAmB;IAC1D,MAAM,WAAW,MAAM,kBAAkB;IACzC,OAAO,SAAS,kBAAkB,CAAC;AACrC;AAEO,eAAe;IACpB,MAAM,WAAW,MAAM,kBAAkB;IACzC,OAAO,SAAS,gBAAgB;AAClC;AAEO,eAAe;IACpB,MAAM,gBAAgB,MAAM,iBAAiB;IAC7C,IAAI,CAAC,eAAe;QAClB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 8316, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/hooks/useTransfer.ts"],"sourcesContent":["import { useState } from \"react\";\nimport { ISelectionState, IAlbum, IPlaylist, MusicService, TransferResult } from \"@/types\";\nimport { useMatching } from \"@/hooks/useMatching\";\nimport { useLibrary } from \"@/contexts/LibraryContext\";\nimport { addTracksToLibrary, addAlbumsToLibrary, createPlaylistWithTracks } from \"@/lib/musicApi\";\nimport { useParams } from \"next/navigation\";\nimport { useTransfer as useTransferContext } from \"@/contexts/TransferContext\";\n\ninterface TransferResults {\n  likedSongs?: TransferResult;\n  albums?: TransferResult;\n  playlists: Map<string, TransferResult>;\n}\n\ninterface UseTransferHookReturn {\n  handleStartTransfer: (selection: ISelectionState) => Promise<void>;\n  handleTransferPlaylist: (playlist: IPlaylist, selection: ISelectionState) => Promise<void>;\n  transferResults: TransferResults | null;\n  showSuccessModal: boolean;\n  setShowSuccessModal: (show: boolean) => void;\n  error: string | null;\n}\n\nexport function useTransfer(): UseTransferHookReturn {\n  const { state } = useLibrary();\n  useMatching();\n  const [transferResults, setTransferResults] = useState<TransferResults | null>(null);\n  const [showSuccessModal, setShowSuccessModal] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const { updateUsage, checkLimit } = useTransferContext();\n\n  const params = useParams();\n  const sourceService = params.source as MusicService;\n  const targetService = params.target as MusicService;\n\n  // Helper to count total tracks in a selection\n  const countSelectedTracks = (selection: ISelectionState): number => {\n    let count = 0;\n\n    // Count liked songs\n    count += Array.from(selection.likedSongs).filter(track => track.status === \"matched\").length;\n\n    // Count tracks in playlists\n    for (const [, selectedTracks] of Array.from(selection.playlists.entries())) {\n      count += Array.from(selectedTracks).filter(track => track.status === \"matched\").length;\n    }\n\n    // Count albums as tracks (this is a simplification)\n    // In a full implementation, we would count the actual tracks in each album\n    count += selection.albums.size;\n\n    return count;\n  };\n\n  const handleStartTransfer = async (selection: ISelectionState): Promise<void> => {\n    if (!state || !targetService) {\n      console.error(\"handleStartTransfer - missing required data\", { state, targetService });\n      setError(\"Target service not specified\");\n      return;\n    }\n\n    try {\n      // Count total tracks that will be transferred\n      const totalTracksToTransfer = countSelectedTracks(selection);\n\n      // Check against daily limit without updating usage\n      const canProceed = await checkLimit(totalTracksToTransfer);\n      if (!canProceed) {\n        return;\n      }\n\n      console.log(\"Starting transfer with selection:\", selection);\n\n      const results: TransferResults = {\n        playlists: new Map<string, TransferResult>(),\n      };\n\n      // Transfer liked songs\n      const matchedLikedSongs = Array.from(selection.likedSongs)\n        .filter(track => track.status === \"matched\" && track.targetId)\n        .map(track => ({\n          ...track,\n          targetId: track.targetId,\n        }));\n\n      if (matchedLikedSongs.length > 0) {\n        results.likedSongs = await addTracksToLibrary(matchedLikedSongs);\n      }\n\n      // Transfer matched albums\n      const albumsWithIds = Array.from(selection.albums)\n        .filter(album => album.status === \"matched\" && album.targetId)\n        .map(album => ({\n          ...album,\n          targetId: album.targetId,\n        }));\n\n      if (albumsWithIds.length > 0) {\n        console.log(\n          \"Transferring albums with IDs:\",\n          albumsWithIds.map(a => ({ name: a.name, targetId: a.targetId }))\n        );\n        const albumsSet = new Set<IAlbum>(albumsWithIds);\n        results.albums = await addAlbumsToLibrary(albumsSet);\n      }\n\n      // Transfer playlists\n      for (const [playlistId, selectedTracks] of Array.from(selection.playlists.entries())) {\n        if (!state.playlists) {\n          throw new Error(\"Playlists not initialized\");\n        }\n        const playlist = state.playlists.get(playlistId);\n        if (!playlist) {\n          throw new Error(`Playlist not found: ${playlistId}`);\n        }\n\n        console.log(\"Transferring playlist:\", playlist);\n\n        const matchedTracks = Array.from(selectedTracks)\n          .filter(track => track.status === \"matched\" && track.targetId)\n          .map(track => ({\n            ...track,\n            targetId: track.targetId,\n          }));\n\n        if (matchedTracks.length > 0) {\n          const result = await createPlaylistWithTracks(\n            playlist.name,\n            matchedTracks,\n            `Imported from ${sourceService} on ${new Date().toLocaleDateString()}`\n          );\n          results.playlists.set(playlistId, result);\n        }\n      }\n\n      // Update usage count in Redis after successful transfer\n      await updateUsage(totalTracksToTransfer);\n\n      console.log(\"Transfer completed successfully:\", results);\n      setTransferResults(results);\n      setShowSuccessModal(true);\n      console.log(\"Success modal should show now:\", { showModal: true });\n    } catch (err) {\n      console.error(\"handleStartTransfer - error:\", err);\n      setError(\"Failed to transfer tracks. Please try again.\");\n    }\n  };\n\n  const handleTransferPlaylist = async (\n    playlist: IPlaylist,\n    selection: ISelectionState\n  ): Promise<void> => {\n    if (!state || !targetService) {\n      console.error(\"handleTransferPlaylist - missing required data\", {\n        state,\n        targetService,\n      });\n      setError(\"Target service not specified\");\n      return;\n    }\n\n    try {\n      const selectedTracks = selection.playlists.get(playlist.id);\n      if (!selectedTracks || selectedTracks.size === 0) {\n        setError(\"No tracks selected for transfer\");\n        return;\n      }\n\n      const matchedTracks = Array.from(selectedTracks)\n        .filter(track => track.status === \"matched\" && track.targetId)\n        .map(track => ({\n          ...track,\n          targetId: track.targetId,\n        }));\n\n      if (matchedTracks.length === 0) {\n        setError(\"No matched tracks found for transfer\");\n        return;\n      }\n\n      // Check against daily limit without updating usage\n      const canProceed = await checkLimit(matchedTracks.length);\n      if (!canProceed) {\n        return;\n      }\n\n      const result = await createPlaylistWithTracks(\n        playlist.name,\n        matchedTracks,\n        `Imported from ${sourceService} on ${new Date().toLocaleDateString()}`\n      );\n\n      // Update usage count in Redis after successful transfer\n      await updateUsage(matchedTracks.length);\n\n      const results: TransferResults = {\n        playlists: new Map([[playlist.id, result]]),\n      };\n\n      setTransferResults(results);\n      setShowSuccessModal(true);\n    } catch (err) {\n      console.error(\"handleTransferPlaylist - error:\", err);\n      setError(\"Failed to transfer playlist. Please try again.\");\n    }\n  };\n\n  return {\n    handleStartTransfer,\n    handleTransferPlaylist,\n    transferResults,\n    showSuccessModal,\n    setShowSuccessModal,\n    error,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 8489, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/TransferSuccessModal.tsx"],"sourcesContent":["import { FC, useEffect } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport Dialog from \"./Dialog\";\nimport { getServiceById } from \"@/config/services\";\nimport { TransferResult } from \"@/types\";\nimport { ArtworkImage } from \"./ArtworkImage\";\nimport { ITrack, IAlbum, IPlaylist } from \"@/types\";\n\ninterface TransferSuccessModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  targetServiceId: string;\n  results: {\n    likedSongs?: TransferResult;\n    albums?: TransferResult;\n    playlists: Map<string, TransferResult>;\n  };\n  selectedData: {\n    likedSongs: ITrack[];\n    albums: IAlbum[];\n    playlists: Map<string, IPlaylist>;\n  };\n}\n\nexport const TransferSuccessModal: FC<TransferSuccessModalProps> = ({\n  isOpen,\n  onClose,\n  targetServiceId,\n  results,\n  selectedData,\n}) => {\n  // Log when the modal is rendered\n  useEffect(() => {\n    console.log(\"TransferSuccessModal rendered:\", {\n      isOpen,\n      targetServiceId,\n      hasResults: !!results,\n      resultsPlaylists: results?.playlists?.size || 0,\n      likedSongsResult: !!results?.likedSongs,\n      albumsResult: !!results?.albums,\n      hasSelectedData: {\n        likedSongs: selectedData?.likedSongs?.length || 0,\n        albums: selectedData?.albums?.length || 0,\n        playlists: selectedData?.playlists?.size || 0,\n      },\n    });\n\n    return () => {\n      console.log(\"TransferSuccessModal unmounting\");\n    };\n  }, [isOpen, targetServiceId, results, selectedData]);\n\n  const targetService = getServiceById(targetServiceId);\n\n  if (!targetService) {\n    console.log(\"Target service not found:\", targetServiceId);\n    return null;\n  }\n\n  const hasLikedSongs = results.likedSongs && results.likedSongs.playlistId;\n  const hasAlbums = results.albums && results.albums.playlistId;\n  const successfulPlaylists = Array.from(results.playlists.entries()).filter(\n    ([_, result]) => result.playlistId\n  );\n\n  const totalTransferred =\n    (results.likedSongs?.added || 0) +\n    (results.albums?.added || 0) +\n    Array.from(results.playlists.values()).reduce((sum, result) => sum + result.added, 0);\n\n  return createPortal(\n    <Dialog\n      isOpen={isOpen}\n      onClose={onClose}\n      title=\"Transfer Complete!\"\n      closeOnBackdropClick={false}\n    >\n      <div className=\"flex flex-col gap-6\">\n        <div className=\"flex items-center gap-4 rounded-lg bg-gradient-to-r from-indigo-500/10 to-indigo-600/5 p-6 text-indigo-600 dark:from-indigo-400/10 dark:to-indigo-500/5 dark:text-indigo-400\">\n          <div className=\"flex items-center gap-3\">\n            <svg\n              className=\"h-8 w-8\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\n              />\n            </svg>\n            <div className=\"flex items-center gap-3\">\n              <span className=\"text-xl font-medium\">Enjoy your {totalTransferred} tracks on</span>\n              <div className=\"flex items-center gap-2\">\n                <targetService.image className=\"h-8 w-8\" size={28} />\n                <span className=\"text-xl font-medium\" style={{ color: targetService.color }}>\n                  {targetService.name}\n                </span>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex flex-col gap-4\">\n          <h3 className=\"text-lg font-semibold text-zinc-800 dark:text-stone-200\">\n            Your transferred music is ready!\n          </h3>\n          <div className=\"flex flex-col gap-3\">\n            {hasLikedSongs && selectedData.likedSongs.length > 0 && (\n              <a\n                href={targetService.getPlaylistUrl(results.likedSongs!.playlistId!)}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"group flex items-center justify-between rounded-lg border border-gray-200 bg-white p-4 transition-all duration-200 hover:border-indigo-200 hover:bg-indigo-50/50 dark:border-gray-800 dark:bg-gray-900/50 dark:hover:border-indigo-900 dark:hover:bg-indigo-950/50\"\n              >\n                <div className=\"flex items-center gap-4\">\n                  <ArtworkImage\n                    src={selectedData.likedSongs[0]?.artwork}\n                    alt=\"Liked Songs\"\n                    type=\"liked\"\n                  />\n                  <div>\n                    <div className=\"font-medium text-gray-900 dark:text-white\">Liked Songs</div>\n                    <div className=\"text-sm text-gray-500 dark:text-gray-400\">\n                      {results.likedSongs?.added} songs transferred\n                    </div>\n                  </div>\n                </div>\n                <svg\n                  className=\"h-5 w-5 text-gray-400 transition-transform duration-200 group-hover:translate-x-1\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M9 5l7 7-7 7\"\n                  />\n                </svg>\n              </a>\n            )}\n\n            {hasAlbums && selectedData.albums.length > 0 && (\n              <a\n                href={targetService.getPlaylistUrl(results.albums!.playlistId!)}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"group flex items-center justify-between rounded-lg border border-gray-200 bg-white p-4 transition-all duration-200 hover:border-indigo-200 hover:bg-indigo-50/50 dark:border-gray-800 dark:bg-gray-900/50 dark:hover:border-indigo-900 dark:hover:bg-indigo-950/50\"\n              >\n                <div className=\"flex items-center gap-4\">\n                  <ArtworkImage src={selectedData.albums[0]?.artwork} alt=\"Albums\" type=\"album\" />\n                  <div>\n                    <div className=\"font-medium text-gray-900 dark:text-white\">Albums</div>\n                    <div className=\"text-sm text-gray-500 dark:text-gray-400\">\n                      {results.albums?.added} albums transferred\n                    </div>\n                  </div>\n                </div>\n                <svg\n                  className=\"h-5 w-5 text-gray-400 transition-transform duration-200 group-hover:translate-x-1\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M9 5l7 7-7 7\"\n                  />\n                </svg>\n              </a>\n            )}\n\n            {successfulPlaylists.map(([playlistId, result]) => {\n              const playlist = selectedData.playlists.get(playlistId);\n              if (!playlist || !result.playlistId) return null;\n\n              const tracks = playlist.tracks || [];\n              const firstTrack = tracks[0];\n\n              return (\n                <a\n                  key={playlistId}\n                  href={targetService.getPlaylistUrl(result.playlistId)}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"group flex items-center justify-between rounded-lg border border-gray-200 bg-white p-4 transition-all duration-200 hover:border-indigo-200 hover:bg-indigo-50/50 dark:border-gray-800 dark:bg-gray-900/50 dark:hover:border-indigo-900 dark:hover:bg-indigo-950/50\"\n                >\n                  <div className=\"flex items-center gap-4\">\n                    <ArtworkImage\n                      src={firstTrack?.artwork}\n                      alt={playlist.name || \"Playlist\"}\n                      type=\"playlist\"\n                    />\n                    <div>\n                      <div className=\"font-medium text-gray-900 dark:text-white\">\n                        {playlist.name || \"Playlist\"}\n                      </div>\n                      {/* <div className=\"text-sm text-gray-500 dark:text-gray-400\">\n                        {result.added} songs transferred\n                      </div> */}\n                    </div>\n                  </div>\n                  <svg\n                    className=\"h-5 w-5 text-gray-400 transition-transform duration-200 group-hover:translate-x-1\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    viewBox=\"0 0 24 24\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M9 5l7 7-7 7\"\n                    />\n                  </svg>\n                </a>\n              );\n            })}\n          </div>\n        </div>\n\n        <div className=\"flex justify-end\">\n          <button\n            onClick={onClose}\n            className=\"rounded-lg bg-indigo-600 px-6 py-2.5 text-white transition-all duration-200 hover:bg-indigo-700 hover:shadow-md dark:bg-indigo-500 dark:hover:bg-indigo-600\"\n          >\n            Close\n          </button>\n        </div>\n      </div>\n    </Dialog>,\n    document.body\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 8915, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/TransferButton.tsx"],"sourcesContent":["\"use client\";\n\nimport { useParams } from \"next/navigation\";\nimport { useLibrary } from \"@/contexts/LibraryContext\";\nimport { useMatching } from \"@/hooks/useMatching\";\nimport { useTransfer as useTransferHook } from \"@/hooks/useTransfer\";\nimport { useTransfer } from \"@/contexts/TransferContext\";\nimport { useState } from \"react\";\nimport { TransferSuccessModal } from \"./TransferSuccessModal\";\nimport { MusicService } from \"@/types\";\n\n// Track playlists that are currently being fetched\nexport const fetchingPlaylists = new Set<string>();\n\nexport function TransferButton() {\n  const { state } = useLibrary();\n  const { isLoading: isMatching } = useMatching();\n  const { userStatus: status } = useTransfer();\n  const {\n    handleStartTransfer,\n    transferResults,\n    showSuccessModal,\n    setShowSuccessModal,\n    error: transferError,\n  } = useTransferHook();\n  const [isTransferring, setIsTransferring] = useState(false);\n\n  // Dynamically check if any selected playlist is currently being fetched (no memo, always up-to-date)\n  const isFetchingPlaylists = Array.from(state.selectedItems.playlists).some(playlistId =>\n    fetchingPlaylists.has(playlistId)\n  );\n\n  // Get target service from URL parameters\n  const params = useParams();\n  const targetServiceId = params.target as MusicService;\n\n  // Check if any items are selected\n  const hasSelections =\n    state.selectedItems.tracks.size > 0 ||\n    state.selectedItems.albums.size > 0 ||\n    state.selectedItems.playlists.size > 0;\n\n  // Button is busy if any async operation is in progress\n  const isBusy = isTransferring || isMatching || isFetchingPlaylists;\n  // Disable if busy, completed, or nothing selected\n  const isDisabled = isBusy || !hasSelections;\n\n  // Determine button text based on state\n  const buttonText =\n    isMatching || isFetchingPlaylists\n      ? \"Finding Matches...\"\n      : isTransferring\n        ? \"Transferring...\"\n        : \"Start Transfer\";\n\n  // Format summary text of selected items\n  const getSummaryText = () => {\n    const parts = [];\n    if (state.selectedItems.tracks.size > 0) {\n      parts.push(`${state.selectedItems.tracks.size} liked tracks`);\n    }\n    if (state.selectedItems.albums.size > 0) {\n      parts.push(`${state.selectedItems.albums.size} albums`);\n    }\n    if (state.selectedItems.playlists.size > 0) {\n      parts.push(`${state.selectedItems.playlists.size} playlists`);\n    }\n    return parts.join(\", \");\n  };\n\n  // Prepare selected data for the success modal\n  const getSelectedData = () => {\n    const selectedLikedSongs = state.likedSongs\n      ? Array.from(state.likedSongs).filter(track => state.selectedItems.tracks.has(track.id))\n      : [];\n\n    const selectedAlbums = state.albums\n      ? Array.from(state.albums).filter(album => state.selectedItems.albums.has(album.id))\n      : [];\n\n    const selectedPlaylists = new Map();\n    if (state.playlists) {\n      for (const playlistId of state.selectedItems.playlists) {\n        const playlist = state.playlists.get(playlistId);\n        if (playlist) {\n          selectedPlaylists.set(playlistId, playlist);\n        }\n      }\n    }\n\n    return {\n      likedSongs: selectedLikedSongs,\n      albums: selectedAlbums,\n      playlists: selectedPlaylists,\n    };\n  };\n\n  // Handle button click\n  const handleClick = async () => {\n    if (!hasSelections) return;\n    setIsTransferring(true);\n\n    try {\n      // Create selection state from the selected items\n      const selection = {\n        likedSongs: new Set(\n          state.likedSongs\n            ? Array.from(state.likedSongs).filter(track => state.selectedItems.tracks.has(track.id))\n            : []\n        ),\n        albums: new Set(\n          state.albums\n            ? Array.from(state.albums).filter(album => state.selectedItems.albums.has(album.id))\n            : []\n        ),\n        playlists: new Map(),\n      };\n\n      // Add selected playlists to the selection\n      if (state.playlists) {\n        for (const playlistId of state.selectedItems.playlists) {\n          const playlist = state.playlists.get(playlistId);\n          if (playlist) {\n            selection.playlists.set(playlistId, new Set(playlist.tracks));\n          }\n        }\n      }\n\n      await handleStartTransfer(selection);\n    } finally {\n      setIsTransferring(false);\n    }\n  };\n\n  return (\n    <>\n      <div className=\"flex items-center gap-4\">\n        {status && (\n          <span className=\"text-sm text-gray-600 dark:text-gray-400\">\n            {status.availableToday} transfers left\n          </span>\n        )}\n        <button\n          className={`relative flex w-[240px] items-center justify-center gap-2 overflow-hidden whitespace-nowrap rounded-full px-6 py-3 text-base font-medium transition-all duration-200 ${\n            !isDisabled\n              ? \"transform cursor-pointer bg-gradient-to-r from-indigo-600 to-indigo-500 text-white hover:scale-[1.02] hover:shadow-lg hover:shadow-indigo-200/50 active:scale-[0.98] dark:hover:shadow-indigo-900/30\"\n              : \"cursor-not-allowed bg-gray-100 text-gray-400 dark:bg-gray-800 dark:text-gray-500\"\n          }`}\n          onClick={handleClick}\n          disabled={isDisabled}\n          aria-label={`${buttonText}${hasSelections ? ` - ${getSummaryText()}` : \"\"}`}\n          role=\"transfer-button\"\n          tabIndex={!isDisabled ? 0 : -1}\n        >\n          {/* Progress Overlay */}\n          {(isMatching || isTransferring || isFetchingPlaylists) && (\n            <div className=\"absolute inset-0 animate-[shimmer_2s_linear_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent bg-[length:200%_100%]\" />\n          )}\n          <span className=\"relative z-10 flex flex-col items-center justify-center\">\n            <span className=\"flex items-center justify-center gap-2\">\n              {isMatching || isTransferring || isFetchingPlaylists ? (\n                <>\n                  <div className=\"h-5 w-5 animate-spin rounded-full border-2 border-current border-t-transparent\" />\n                  {buttonText}\n                </>\n              ) : (\n                buttonText\n              )}\n            </span>\n          </span>\n        </button>\n      </div>\n\n      {showSuccessModal && transferResults && (\n        <TransferSuccessModal\n          isOpen={true}\n          onClose={() => setShowSuccessModal(false)}\n          targetServiceId={targetServiceId}\n          results={transferResults}\n          selectedData={getSelectedData()}\n        />\n      )}\n\n      {transferError && (\n        <div className=\"fixed bottom-24 left-0 right-0 mx-auto w-full max-w-md rounded-lg bg-red-50 p-4 text-red-800 shadow-lg dark:bg-red-900/30 dark:text-red-200\">\n          <p>{transferError}</p>\n        </div>\n      )}\n    </>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 9117, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/icons/LikedSongsIcon.tsx"],"sourcesContent":["import { FC, SVGProps } from \"react\";\n\n/**\n * LikedSongsIcon renders a heart SVG used for Liked Songs artwork and UI elements.\n * Accepts all standard SVG props for flexibility.\n */\nexport const LikedSongsIcon: FC<SVGProps<SVGSVGElement>> = ({ className = \"\", ...props }) => (\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    viewBox=\"0 0 24 24\"\n    fill=\"currentColor\"\n    aria-hidden=\"true\"\n    className={className}\n    {...props}\n  >\n    <path\n      fillRule=\"evenodd\"\n      d=\"M12.001 4.529c2.349-2.532 6.15-2.532 8.498 0 2.349 2.532 2.349 6.64 0 9.172l-7.071 7.627a1.25 1.25 0 01-1.854 0l-7.071-7.627c-2.349-2.532-2.349-6.64 0-9.172 2.348-2.532 6.149-2.532 8.498 0z\"\n      clipRule=\"evenodd\"\n    />\n  </svg>\n);\n"],"names":[],"mappings":";;;;;;AAMO,MAAM,iBAA8C,CAAC,EAAE,YAAY,EAAE,EAAE,GAAG,OAAO,iBACtF,6bAAC;QACC,OAAM;QACN,SAAQ;QACR,MAAK;QACL,eAAY;QACZ,WAAW;QACV,GAAG,KAAK;kBAET,cAAA,6bAAC;YACC,UAAS;YACT,GAAE;YACF,UAAS","debugId":null}},
    {"offset": {"line": 9148, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/layout/Sidebar.tsx"],"sourcesContent":["\"use client\";\n\nimport { FC } from \"react\";\nimport { useLibrary, useLibrarySelection } from \"@/contexts/LibraryContext\";\nimport { useMatching } from \"@/hooks/useMatching\";\nimport { IndeterminateCheckbox } from \"@/components/shared/IndeterminateCheckbox\";\nimport { ArtworkImage } from \"@/components/shared/ArtworkImage\";\nimport { CircularProgress } from \"@/components/shared/CircularProgress\";\nimport { useRouter, useParams } from \"next/navigation\";\nimport { MusicService, IPlaylist } from \"@/types\";\nimport { fetchPlaylistTracks } from \"@/lib/musicApi\";\nimport React from \"react\";\nimport { fetchingPlaylists } from \"@/components/shared/TransferButton\";\nimport { LikedSongsIcon } from \"@/components/icons/LikedSongsIcon\";\n\n// Main component\nexport const LibrarySidebar: FC = () => {\n  const { state, actions } = useLibrary();\n  const router = useRouter();\n  const params = useParams();\n  const source = params.source as MusicService;\n  const target = params.target as MusicService;\n  const { matchLikedSongs, matchAlbums, matchPlaylistTracks, cancelMatching } = useMatching();\n  const {\n    selectedItems,\n    selectAllTracks,\n    deselectAllTracks,\n    selectAllAlbums,\n    deselectAllAlbums,\n    selectPlaylist,\n    deselectPlaylist,\n  } = useLibrarySelection();\n\n  // Tracking map to handle async operations - this is no longer needed as a ref\n  // since we're using the shared fetchingPlaylists Set\n  const fetchingPlaylistsRef = React.useRef(new Set<string>());\n\n  if (!state.likedSongs || !state.albums || !state.playlists) return null;\n\n  // Calculate selection states\n  const likedSongsCount = state.likedSongs.size;\n  const selectedLikedSongsCount = selectedItems.tracks.size;\n\n  // Count unmatched liked songs\n  const unmatchedLikedSongsCount = Array.from(state.likedSongs).reduce((count, track) => {\n    return track.status === \"unmatched\" ? count + 1 : count;\n  }, 0);\n\n  const albumsCount = state.albums.size;\n  const selectedAlbumsCount = Array.from(state.albums).filter(album =>\n    selectedItems.albums.has(album.id)\n  ).length;\n\n  // Count unmatched albums\n  const unmatchedAlbumsCount = Array.from(state.albums).reduce((count, album) => {\n    return album.status === \"unmatched\" ? count + 1 : count;\n  }, 0);\n\n  // Handle selection toggles with matching\n  const handleLikedSongsToggle = () => {\n    if (selectedLikedSongsCount === likedSongsCount) {\n      deselectAllTracks();\n      cancelMatching(\"likedSongs\");\n    } else {\n      selectAllTracks();\n      matchLikedSongs(Array.from(state.likedSongs ?? []), target);\n    }\n  };\n\n  const handleAlbumsToggle = () => {\n    if (selectedAlbumsCount === albumsCount) {\n      deselectAllAlbums();\n      cancelMatching(\"albums\");\n    } else {\n      selectAllAlbums();\n      matchAlbums(Array.from(state.albums ?? []), target);\n    }\n  };\n\n  // complex but this allows us to have a very responsive UI\n  // and cancel matching quickly if the playlist is deselected\n  const handlePlaylistToggle = async (playlist: IPlaylist) => {\n    const playlistId = playlist.id;\n\n    if (selectedItems.playlists.has(playlistId)) {\n      // If deselecting, remove from selection and cancel matching\n      deselectPlaylist(playlistId);\n      cancelMatching(\"playlist\", playlistId);\n\n      // Mark as no longer being processed\n      fetchingPlaylistsRef.current.delete(playlistId);\n      fetchingPlaylists.delete(playlistId);\n    } else {\n      // Optimistically update UI by selecting the playlist immediately\n      selectPlaylist(playlistId);\n\n      // Add to our tracking set\n      fetchingPlaylistsRef.current.add(playlistId);\n      fetchingPlaylists.add(playlistId);\n\n      // Only fetch tracks if they don't exist\n      // TODO: Keep an eye on this as we could have playlists not fully fetched\n      if (!playlist.tracks || playlist.tracks.length === 0) {\n        try {\n          // Fetch tracks in the background\n          const tracks = await fetchPlaylistTracks(playlistId);\n\n          // After fetch completes, check if playlist is still being processed\n          if (tracks && fetchingPlaylistsRef.current.has(playlistId)) {\n            // Update the playlist in the library context\n            const updatedPlaylist = { ...playlist, tracks };\n            // Use updatePlaylist to only update the relevant playlist in the Map\n            // This avoids accidentally overwriting the entire playlists Map\n            actions.updatePlaylist(updatedPlaylist);\n\n            // Check if it's still selected in the UI before matching\n            if (fetchingPlaylistsRef.current.has(playlistId)) {\n              matchPlaylistTracks(updatedPlaylist, target);\n            }\n\n            // Remove from tracking set\n            fetchingPlaylistsRef.current.delete(playlistId);\n            fetchingPlaylists.delete(playlistId);\n          }\n        } catch (error) {\n          console.error(\"Error fetching playlist tracks:\", error);\n          // Clean up tracking on error\n          fetchingPlaylistsRef.current.delete(playlistId);\n          fetchingPlaylists.delete(playlistId);\n        }\n      } else {\n        // Always retrieve the latest playlist object from state before matching\n        // This ensures we use the freshest tracks array and avoid stale data\n        const latestPlaylist = state.playlists?.get(playlistId) || playlist;\n        matchPlaylistTracks(latestPlaylist, target);\n        // Remove from tracking set\n        fetchingPlaylistsRef.current.delete(playlistId);\n        fetchingPlaylists.delete(playlistId);\n      }\n    }\n  };\n\n  // Navigation handlers\n  const handleLikedSongsClick = () => {\n    router.push(`/library/${source}/${target}/liked`);\n  };\n\n  const handleAlbumsClick = () => {\n    router.push(`/library/${source}/${target}/albums`);\n  };\n\n  const handlePlaylistClick = (playlistId: string) => {\n    router.push(`/library/${source}/${target}/playlist/${playlistId}`);\n  };\n\n  // Use global matching state from context\n  const isMatching = state.matching.isLoading;\n  const currentTask = state.matching.currentTask;\n  const getProgress = (type: \"likedSongs\" | \"albums\" | \"playlist\", id?: string) => {\n    const key = type === \"playlist\" && id ? `playlist:${id}` : type;\n    return state.matching.progress[key] ?? 0;\n  };\n\n  // Helper function to check if a service is YouTube Music\n  // MusicService type: 'spotify' | 'apple' | 'youtube' | 'deezer' (see src/types/services.ts)\n  const isYouTubeService = (service: MusicService) => {\n    return service === \"youtube\";\n  };\n\n  return (\n    <div className=\"min-w-0 p-4\">\n      <div className=\"mb-4 mt-2\">\n        <h1 className=\"mb-1 text-xl font-bold text-zinc-800 dark:text-white\">Your library</h1>\n        <p className=\"text-sm text-zinc-600 dark:text-zinc-400\">Select items to transfer</p>\n      </div>\n\n      {/* Liked Songs Section */}\n      <div\n        // Add margin-bottom to separate from next item, and reduce vertical padding\n        className={`group mb-1 flex cursor-pointer items-center gap-4 rounded-lg px-2.5 py-2 transition-all duration-200\n            ${\n              selectedLikedSongsCount === likedSongsCount && likedSongsCount > 0\n                ? \"bg-indigo-100/60 group-hover:bg-indigo-200/80 dark:bg-indigo-900/40 dark:group-hover:bg-indigo-800/60\"\n                : \"hover:bg-indigo-100/50 dark:hover:bg-indigo-950/20\"\n            }`}\n        onClick={handleLikedSongsClick}\n        role=\"button\"\n        aria-label=\"View Liked Songs\"\n        data-testid=\"liked-songs-section\"\n      >\n        <div onClick={e => e.stopPropagation()} className=\"pl-2 lg:pl-0\">\n          <IndeterminateCheckbox\n            selectedCount={selectedLikedSongsCount}\n            totalCount={likedSongsCount}\n            onChange={handleLikedSongsToggle}\n            className=\"\"\n            label=\"Liked Songs\"\n            testId=\"liked-songs-checkbox\"\n          />\n        </div>\n        <div className=\"relative flex h-12 w-12 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-600 to-indigo-300\">\n          <LikedSongsIcon className=\"h-5 w-5 text-white\" />\n          {/* Show progress if matching liked songs */}\n          {currentTask && currentTask.type === \"likedSongs\" && isMatching && (\n            <CircularProgress\n              progress={getProgress(\"likedSongs\")}\n              data-testid=\"liked-songs-progress\"\n            />\n          )}\n        </div>\n        <div className=\"min-w-0\">\n          <p\n            className={`truncate font-normal text-zinc-600 group-hover:text-zinc-950 dark:text-zinc-300 dark:group-hover:text-zinc-100 ${\n              currentTask && currentTask.type === \"likedSongs\" && isMatching ? \"animate-pulse\" : \"\"\n            }`}\n          >\n            Liked Songs\n          </p>\n          <p className=\"truncate text-sm text-zinc-600 dark:text-zinc-400\">\n            {likedSongsCount} songs\n            {/* Show unmatched count if any */}\n            {unmatchedLikedSongsCount > 0 && (\n              <span className=\"ml-1 text-red-500 dark:text-red-400\">\n                • {unmatchedLikedSongsCount} unmatched\n              </span>\n            )}\n          </p>\n        </div>\n      </div>\n\n      {/* Only show Albums section if neither source nor target is YouTube Music */}\n      {/* YouTube Music API does not support adding albums to the user library as source or target */}\n      {!isYouTubeService(source) && !isYouTubeService(target) && (\n        <div\n          // Add margin-bottom to separate from next item, and reduce vertical padding\n          className={`group mb-1 flex cursor-pointer items-center gap-4 rounded-lg px-2.5 py-2 transition-all duration-200\n                ${\n                  selectedAlbumsCount === albumsCount && albumsCount > 0\n                    ? \"bg-indigo-100/60 group-hover:bg-indigo-200/80 dark:bg-indigo-900/40 dark:group-hover:bg-indigo-800/60\"\n                    : \"hover:bg-indigo-100/50 dark:hover:bg-indigo-950/20\"\n                }`}\n          onClick={handleAlbumsClick}\n          role=\"button\"\n          aria-label=\"View Albums\"\n          data-testid=\"albums-section\"\n        >\n          <div onClick={e => e.stopPropagation()} className=\"pl-2 lg:pl-0\">\n            <IndeterminateCheckbox\n              selectedCount={selectedAlbumsCount}\n              totalCount={albumsCount}\n              onChange={handleAlbumsToggle}\n              className=\"\"\n              label=\"Albums\"\n              testId=\"albums-checkbox\"\n            />\n          </div>\n          <div className=\"relative overflow-hidden rounded-lg\">\n            <ArtworkImage\n              src={Array.from(state.albums ?? [])[0]?.artwork}\n              multiSrc={Array.from(state.albums ?? [])\n                .slice(0, 4)\n                .map(a => a.artwork)\n                .filter((a): a is string => Boolean(a))}\n              alt=\"Albums artwork\"\n              type=\"album\"\n              className=\"rounded-lg\"\n            />\n            {/* Show progress if matching albums */}\n            {currentTask && currentTask.type === \"albums\" && isMatching && (\n              <CircularProgress progress={getProgress(\"albums\")} data-testid=\"albums-progress\" />\n            )}\n          </div>\n          <div className=\"min-w-0\">\n            <p\n              className={`truncate font-normal text-zinc-600 group-hover:text-zinc-950 dark:text-zinc-300 dark:group-hover:text-zinc-200 ${\n                currentTask && currentTask.type === \"albums\" && isMatching ? \"animate-pulse\" : \"\"\n              }`}\n            >\n              Albums\n            </p>\n            <p className=\"truncate text-sm text-zinc-600 dark:text-zinc-400\">\n              {albumsCount} albums\n              {/* Show unmatched count if any */}\n              {unmatchedAlbumsCount > 0 && (\n                <span className=\"ml-1 text-red-500 dark:text-red-400\">\n                  • {unmatchedAlbumsCount} unmatched\n                </span>\n              )}\n            </p>\n          </div>\n        </div>\n      )}\n\n      {/* Playlists Section */}\n      {Array.from(state.playlists?.values() ?? []).map((playlist, idx, arr) => (\n        <div\n          key={playlist.id}\n          // Add margin-bottom to separate from next item, except last; reduce vertical padding\n          className={`group flex cursor-pointer items-center gap-4 rounded-lg ${idx !== arr.length - 1 ? \"mb-1\" : \"\"} px-2.5 py-2 transition-all duration-200\n                ${\n                  selectedItems.playlists.has(playlist.id)\n                    ? \"bg-indigo-100/60 group-hover:bg-indigo-200/80 dark:bg-indigo-900/40 dark:group-hover:bg-indigo-800/60\"\n                    : \"hover:bg-indigo-100/50 dark:hover:bg-indigo-950/20\"\n                }`}\n          onClick={() => handlePlaylistClick(playlist.id)}\n          data-testid={`playlist-item-${playlist.id}`}\n        >\n          <div onClick={e => e.stopPropagation()} className=\"pl-2 lg:pl-0\">\n            <IndeterminateCheckbox\n              selectedCount={selectedItems.playlists.has(playlist.id) ? 1 : 0}\n              totalCount={1}\n              onChange={() => handlePlaylistToggle(playlist)}\n              label={playlist.name}\n              testId={`playlist-checkbox-${playlist.id}`}\n            />\n          </div>\n          <div className=\"relative overflow-hidden rounded-lg\">\n            <ArtworkImage\n              src={playlist.artwork}\n              alt={playlist.name}\n              type=\"playlist\"\n              className={`rounded-lg ${fetchingPlaylists.has(playlist.id) ? \"animate-pulse\" : \"\"}`}\n            />\n            {/* Show progress if matching this playlist */}\n            {currentTask &&\n              currentTask.type === \"playlist\" &&\n              currentTask.playlist.id === playlist.id &&\n              isMatching && (\n                <CircularProgress\n                  progress={getProgress(\"playlist\", playlist.id)}\n                  data-testid={`playlist-progress-${playlist.id}`}\n                />\n              )}\n          </div>\n          <div className=\"min-w-0 flex-1\">\n            <p\n              className={`truncate font-normal text-zinc-600 group-hover:text-zinc-950 dark:text-zinc-300 dark:group-hover:text-zinc-100 ${\n                (currentTask &&\n                  currentTask.type === \"playlist\" &&\n                  currentTask.playlist.id === playlist.id &&\n                  isMatching) ||\n                fetchingPlaylists.has(playlist.id)\n                  ? \"animate-pulse\"\n                  : \"\"\n              }`}\n              data-testid={`playlist-name-${playlist.id}`}\n              title={playlist.name}\n            >\n              {playlist.name}\n            </p>\n            <p\n              className=\"truncate text-sm text-zinc-600 dark:text-zinc-400\"\n              data-testid={`playlist-track-count-${playlist.id}`}\n            >\n              {playlist.tracks?.length || playlist.trackCount} tracks\n              {/* Show unmatched count if any */}\n              {playlist.tracks &&\n                playlist.tracks.length > 0 &&\n                (() => {\n                  // Count unmatched tracks for this playlist\n                  const unmatchedCount = playlist.tracks.reduce(\n                    (count, track) => (track.status === \"unmatched\" ? count + 1 : count),\n                    0\n                  );\n                  return unmatchedCount > 0 ? (\n                    <span className=\"ml-1 text-red-500 dark:text-red-400\">\n                      • {unmatchedCount} unmatched\n                    </span>\n                  ) : null;\n                })()}\n            </p>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 9646, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/components/shared/LoadingOverlay.tsx"],"sourcesContent":["import { NonnaLogo } from \"../icons/NonnaLogo\";\n\nexport const LoadingOverlay: React.FC = () => (\n  <div className=\"backdrop-blur-xs fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-black/60\">\n    {/*\n      Centered container for logo and spinner.\n      - relative: allows absolute positioning of spinner over logo\n      - w-48 h-48: fixed size for precise alignment\n    */}\n    <div className=\"relative flex h-52 w-52 items-center justify-center\">\n      {/* NonnaLogo: Cat with magnifying glass */}\n      <NonnaLogo className=\"text-white\" size={200} />\n      {/*\n        Spinner overlay:\n        - absolute: overlays spinner on logo\n        - left-[26%] top-[51%]: visually aligns spinner over magnifying glass (tweak as needed)\n        - translate-x-1/2 translate-y-1/2: center spinner on that point\n        - z-10: ensures spinner is above logo\n      */}\n      <div className=\"absolute left-[26.5%] top-[50.5%] z-10 -translate-x-1/2 -translate-y-1/2\">\n        <div className=\"h-11 w-11 animate-spin rounded-full border-4 border-indigo-100 border-b-indigo-100/10 border-l-indigo-100/70 border-r-indigo-100/40\" />\n      </div>\n    </div>\n    {/* Loading text directly below the logo/spinner, centered */}\n    <div className=\"mb-16 mt-2 text-center\">\n      <h2 className=\"animate-pulse text-xl font-normal text-white\">Loading your library</h2>\n      <p className=\"mt-2 text-sm text-indigo-200\">Just a moment while we get everything ready</p>\n    </div>\n  </div>\n);\n"],"names":[],"mappings":";;;;;AAAA;;;AAEO,MAAM,iBAA2B,kBACtC,6bAAC;QAAI,WAAU;;0BAMb,6bAAC;gBAAI,WAAU;;kCAEb,6bAAC,oKAAS;wBAAC,WAAU;wBAAa,MAAM;;;;;;kCAQxC,6bAAC;wBAAI,WAAU;kCACb,cAAA,6bAAC;4BAAI,WAAU;;;;;;;;;;;;;;;;;0BAInB,6bAAC;gBAAI,WAAU;;kCACb,6bAAC;wBAAG,WAAU;kCAA+C;;;;;;kCAC7D,6bAAC;wBAAE,WAAU;kCAA+B","debugId":null}},
    {"offset": {"line": 9723, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/lib/server/library.ts"],"sourcesContent":["import { MusicService, ILibraryData } from \"@/types\";\nimport { fetchUserLibrary } from \"@/lib/musicApi\";\n\ninterface InitialLibraryResult {\n  initialData: ILibraryData | null;\n  error: Error | null;\n}\n\n// This function can be imported and used in server components\nexport async function fetchInitialLibraryData(\n  sourceService: MusicService | undefined\n): Promise<InitialLibraryResult> {\n  try {\n    if (!sourceService) {\n      return {\n        initialData: null,\n        error: new Error(\"Source service not specified\"),\n      };\n    }\n\n    const initialData = await fetchUserLibrary();\n    return { initialData, error: null };\n  } catch (error) {\n    return {\n      initialData: null,\n      error: error instanceof Error ? error : new Error(\"Failed to load initial library data\"),\n    };\n  }\n}\n"],"names":[],"mappings":";;;;AACA;;AAQO,eAAe,wBACpB,aAAuC;IAEvC,IAAI;QACF,IAAI,CAAC,eAAe;YAClB,OAAO;gBACL,aAAa;gBACb,OAAO,IAAI,MAAM;YACnB;QACF;QAEA,MAAM,cAAc,MAAM,IAAA,yJAAgB;QAC1C,OAAO;YAAE;YAAa,OAAO;QAAK;IACpC,EAAE,OAAO,OAAO;QACd,OAAO;YACL,aAAa;YACb,OAAO,iBAAiB,QAAQ,QAAQ,IAAI,MAAM;QACpD;IACF;AACF","debugId":null}},
    {"offset": {"line": 9753, "column": 0}, "map": {"version":3,"sources":["file:///Users/tcosentino/projects/nonna.fm/apps/web/src/app/library/%5Bsource%5D/%5Btarget%5D/_components/LibraryClientContent.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState, useCallback } from \"react\";\nimport { LibrarySidebar } from \"@/components/layout/Sidebar\";\nimport { useLibrary } from \"@/contexts/LibraryContext\";\nimport type { IPlaylist } from \"@/types\";\nimport { LoadingOverlay } from \"@/components/shared/LoadingOverlay\";\nimport { MusicService } from \"@/types\";\nimport { authorizeAppleMusic } from \"@/lib/services/apple/api\";\nimport { fetchInitialLibraryData } from \"@/lib/server/library\";\nimport { usePathname } from \"next/navigation\";\nimport { useItemTitle } from \"@/contexts/ItemTitleContext\";\n\ninterface LibraryClientContentProps {\n  source: MusicService;\n  _target: MusicService;\n  children: React.ReactNode;\n}\n\nfunction LibraryContent({ source, _target, children }: LibraryClientContentProps) {\n  const { state, actions } = useLibrary();\n  const { setShowTitle } = useItemTitle();\n  const [isContentVisible, setIsContentVisible] = useState(false);\n  const pathname = usePathname();\n  const [mainEl, setMainEl] = useState<HTMLElement | null>(null);\n  const mainRef = useCallback((node: HTMLElement | null) => {\n    setMainEl(node);\n  }, []);\n\n  // Show content when route changes (i.e., when an item is selected)\n  useEffect(() => {\n    const isHome = pathname.endsWith(`${source}/${_target}`);\n    setIsContentVisible(!isHome);\n  }, [pathname, source, _target]);\n\n  // Effect to observe the h1 within the main content area\n  useEffect(() => {\n    if (!isContentVisible || !setShowTitle) {\n      setShowTitle(false);\n      return;\n    }\n\n    if (!mainEl) {\n      // Wait for main element to be set\n      return;\n    }\n\n    const scrollContainer = mainEl;\n    let intersectionObserver: IntersectionObserver | null = null;\n    let mutationObserver: MutationObserver | null = null;\n\n    function attachIntersectionObserver() {\n      const h1Element = scrollContainer.querySelector(\"h1\");\n\n      if (!h1Element) return false;\n      intersectionObserver = new IntersectionObserver(\n        ([entry]) => {\n          setShowTitle(!entry.isIntersecting);\n        },\n        {\n          root: scrollContainer,\n          rootMargin: \"0px\",\n          threshold: 0.1,\n        }\n      );\n      intersectionObserver.observe(h1Element);\n      return true;\n    }\n\n    // Try to attach immediately\n    if (!attachIntersectionObserver()) {\n      // If h1 is not present, observe for DOM changes\n      mutationObserver = new MutationObserver(() => {\n        if (attachIntersectionObserver()) {\n          // Once attached, disconnect mutation observer\n          if (mutationObserver) mutationObserver.disconnect();\n        }\n      });\n      mutationObserver.observe(scrollContainer, { childList: true, subtree: true });\n    }\n\n    return () => {\n      if (intersectionObserver) intersectionObserver.disconnect();\n      if (mutationObserver) mutationObserver.disconnect();\n    };\n  }, [isContentVisible, setShowTitle, mainEl]);\n\n  // Initialize library\n  useEffect(() => {\n    let mounted = true;\n\n    async function initLibrary() {\n      if (!source) return; // Don't initialize if source is not set\n\n      try {\n        actions.setLoading(true);\n\n        // Apple Musickit requires browser-side initialization\n        if (source === \"apple\") {\n          await authorizeAppleMusic(\"source\");\n        }\n\n        const { initialData, error } = await fetchInitialLibraryData(source);\n\n        // Check if component is still mounted before updating state\n        if (!mounted) return;\n\n        if (error) {\n          console.error(\"Error initializing library:\", error);\n          actions.setError(error.toString());\n        } else if (initialData) {\n          actions.updateLibrary({\n            likedSongs: new Set(initialData.likedSongs),\n            albums: new Set(initialData.albums),\n            playlists: new Map(initialData.playlists.map((p: IPlaylist) => [p.id, p])),\n          });\n        }\n      } catch (err) {\n        if (!mounted) return;\n        console.error(\"Failed to initialize library:\", err);\n        actions.setError(err instanceof Error ? err.message : \"Failed to initialize library\");\n      } finally {\n        if (mounted) {\n          actions.setLoading(false);\n        }\n      }\n    }\n\n    const isLibraryEmpty =\n      !state?.likedSongs?.size && !state?.albums?.size && !state?.playlists?.size;\n\n    if (isLibraryEmpty && source) {\n      initLibrary();\n    }\n\n    // Cleanup function to prevent state updates after unmount\n    return () => {\n      mounted = false;\n    };\n  }, [source, state?.likedSongs, state?.albums, state?.playlists, actions]);\n\n  if (state?.status?.isLoading) {\n    return (\n      <div className=\"flex h-full items-center justify-center\">\n        <LoadingOverlay />\n      </div>\n    );\n  }\n\n  if (state?.status?.error) {\n    return <div>Error: {state.status.error}</div>;\n  }\n\n  const isLibraryEmpty =\n    !state?.likedSongs?.size && !state?.albums?.size && !state?.playlists?.size;\n\n  if (isLibraryEmpty) {\n    return (\n      <div className=\"flex h-full items-center justify-center\">\n        <LoadingOverlay />\n      </div>\n    );\n  }\n\n  return (\n    // Main grid layout for sidebar and content area.\n    // Takes full height of its parent grid row.\n    // lg:grid-cols defines the two-column layout for desktop.\n    <div className=\"container mx-auto grid h-full lg:grid-cols-[25rem_1fr]\">\n      <aside\n        role=\"sidebar\"\n        aria-label=\"Library Selection\"\n        className={`overflow-y-auto transition-transform duration-200 lg:h-full lg:translate-x-0 lg:border-r lg:border-indigo-100/10 lg:dark:bg-transparent ${\n          isContentVisible\n            ? \"fixed inset-0 z-50 -translate-x-full lg:static lg:z-auto lg:translate-x-0\"\n            : \"relative z-40\"\n        }`}\n        // On mobile: fixed, full width, slides in/out\n        // On desktop: static, fixed width, always visible\n      >\n        <LibrarySidebar />\n      </aside>\n      <main\n        ref={mainRef}\n        role=\"main\"\n        aria-label=\"Selected Content\"\n        className={`z-40 h-full overflow-y-auto p-8 transition-transform duration-200 lg:translate-x-0 ${\n          isContentVisible ? \"translate-x-0\" : \"hidden lg:relative lg:block\"\n        }`}\n        // On mobile: hidden when aside is visible, shown otherwise\n        // On desktop: always visible\n      >\n        {children}\n      </main>\n    </div>\n  );\n}\n\nexport function LibraryClientContent(props: LibraryClientContentProps) {\n  return <LibraryContent {...props} />;\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}